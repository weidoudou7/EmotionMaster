import { BottomNavBar } from './BottomNavBar'
import { globalUserData } from '../models/userdata'
import http from '@ohos.net.http'

interface PlanetDataType {
  id: number;
  userId: number;
  name: string;
  description: string;
  level: number;
  image: string;
  ecoPercent: number;
  techPercent: number;
  culturePercent: number;
  talkHours: number;
  talkTarget: number;
  taskCount: number;
  taskTarget: number;
  explorePercent: number;
  unlockedRewards: string[];
  lockedRewards: string[];
  appearance: string;
  unlockedItems: string;
}

interface PlanetApiResponse {
  success: boolean;
  message: string;
  data: PlanetDataType;
}

@Entry
@Component
struct PlanetPage {
  private planetData: PlanetDataType = {
    id: 0,
    userId: 0,
    name: '',
    description: '',
    level: 0,
    image: '',
    ecoPercent: 0,
    techPercent: 0,
    culturePercent: 0,
    talkHours: 0,
    talkTarget: 0,
    taskCount: 0,
    taskTarget: 0,
    explorePercent: 0,
    unlockedRewards: [],
    lockedRewards: [],
    appearance: '',
    unlockedItems: ''
  }

  aboutToAppear(): void {
    let userUID = globalUserData.userUID
    let httpRequest = http.createHttp()
    httpRequest.request(
      `http://localhost:8080/planet/uid/${userUID}`,
      {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json'
        }
      }
    ).then((response) => {
      let resp = JSON.parse(response.result as string) as PlanetApiResponse
      if (resp.success) {
        this.planetData = resp.data
      } else {
        console.error(resp.message)
      }
    }).catch((err: Error) => {
      console.error('è¯·æ±‚å¤±è´¥', err)
    })
  }

  build() {
    Column() {
      Scroll() {
        Column({ space: 18 }) {
          // é¡¶éƒ¨æ ‡é¢˜
          Text('æˆ‘çš„æ˜Ÿçƒ')
            .fontSize(24).fontWeight(FontWeight.Bold)
            .fontColor('#222')
            .margin({ top: 18, left: 20, right: 20, bottom: 2 })
          Text('ä¸AIäº’åŠ¨ï¼Œè®©å®ƒèŒå£®æˆé•¿')
            .fontSize(13).fontColor('#888')
            .margin({ left: 20, right: 20, bottom: 8 })
          // æ˜Ÿçƒå›¾ç‰‡+ç­‰çº§
          Stack() {
            Image(this.planetData.image ?? '/resources/base/media/QQ1222.jpg')
              .width(140).height(140)
              .borderRadius(70)
              .shadow({ radius: 16, color: '#e0e6ff', offsetX: 0, offsetY: 6 })
            Text(`ç­‰çº§${this.planetData.level ?? ''}`)
              .fontSize(13).fontColor('#fff')
              .backgroundColor('#ffb400')
              .borderRadius(10)
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .position({ x: 100, y: 12 })
              .zIndex(1)
          }
          .align(Alignment.Center)
          // æ˜Ÿçƒåç§°å’Œç®€ä»‹
          Text(this.planetData.name ?? 'åŠ è½½ä¸­...')
            .fontSize(18).fontWeight(FontWeight.Bold)
            .alignSelf(ItemAlign.Center)
          Text(this.planetData.description ?? '')
            .fontSize(13).fontColor('#888')
            .alignSelf(ItemAlign.Center)
          // ä¸‰é¡¹å±æ€§
          Row({ space: 10 }) {
            AttrCard('ç”Ÿæ€ç³»ç»Ÿ', `${this.planetData.ecoPercent ?? 0}%`, '#4caf50', 'ğŸ”—')
            AttrCard('ç§‘æŠ€æ°´å¹³', `${this.planetData.techPercent ?? 0}%`, '#3f51b5', 'ğŸš€')
            AttrCard('æ–‡åŒ–å‘å±•', `${this.planetData.culturePercent ?? 0}%`, '#ab47bc', 'ğŸ“–')
          }
          .alignSelf(ItemAlign.Center)
          .margin({ top: 8, left: 8, right: 8 })
          // æˆé•¿è¿›åº¦
          Text('æˆé•¿è¿›åº¦').fontSize(16).fontWeight(FontWeight.Bold).margin({ left: 20, top: 16, bottom: 4 })
          Column({ space: 12 }) {
            ProgressItem('å½“å‰ç­‰çº§', `${this.planetData.level ?? ''}`, 0.75, `ç­‰çº§ ${this.planetData.level ?? ''}`, '75%åˆ°ç­‰çº§6', '#5a4fff')
            ProgressItem('æ€»å¯¹è¯æ—¶é•¿', `${this.planetData.talkHours ?? 0} å°æ—¶`, (this.planetData.talkHours ?? 0) / (this.planetData.talkTarget ?? 1), `ç›®æ ‡: ${this.planetData.talkTarget ?? 0} å°æ—¶`, '63%', '#00b386')
            ProgressItem('å®Œæˆä»»åŠ¡æ•°', `${this.planetData.taskCount ?? 0} ä¸ª`, (this.planetData.taskCount ?? 0) / (this.planetData.taskTarget ?? 1), `ç›®æ ‡: ${this.planetData.taskTarget ?? 0} ä¸ª`, '56%', '#ffb400')
            ProgressItem('æ¢ç´¢åº¦', `${this.planetData.explorePercent ?? 0}%`, (this.planetData.explorePercent ?? 0) / 100, 'ç›®æ ‡: 100%', `${this.planetData.explorePercent ?? 0}%`, '#5a4fff')
          }
          .margin({ left: 20, right: 20 })
          // æˆé•¿å¥–åŠ±
          // Text('æˆé•¿å¥–åŠ±').fontSize(15).fontWeight(FontWeight.Bold).margin({ left: 20, top: 12, bottom: 4 })
          // Row({ space: 10 }) {
          //   // å±•ç¤ºå·²è§£é”å¥–åŠ±
          //   for (let label of (this.planetData.unlockedRewards ?? [])) {
          //     RewardTag(label, true)
          //   }
          //   // å±•ç¤ºæœªè§£é”å¥–åŠ±
          //   for (let label of (this.planetData.lockedRewards ?? [])) {
          //     RewardTag(label, false)
          //   }
          // }
          // .margin({ left: 20, right: 20, bottom: 24 })
        }
        .backgroundColor('#fafbff')
      }
      BottomNavBar({ navIndex: 'planet' })
    }
    .width('100%')
    .height('100%')
  }
}

@Builder
function AttrCard(title: string, value: string, color: string, icon: string): void {
  Column({ space: 2 }) {
    Row() {
      Text(icon).fontSize(16)
      Text(title).fontSize(12).fontColor('#888').margin({ left: 2 })
    }
    Text(value).fontSize(15).fontWeight(FontWeight.Bold).fontColor(color)
  }
  .backgroundColor('#fff')
  .borderRadius(10)
  .padding({ left: 10, right: 10, top: 6, bottom: 6 })
  .shadow({ radius: 3, color: '#eee', offsetX: 0, offsetY: 1 })
}

@Builder
function ProgressItem(title: string, value: string, percent: number, subTitle: string, subValue: string, color: string): void {
  Column({ space: 2 }) {
    Row({ space: 8 }) {
      Text(title).fontSize(13)
      Text(value).fontSize(13).fontWeight(FontWeight.Bold).fontColor(color)
    }
    Progress({ value: percent * 100, total: 100 })
      .color(color)
      .height(7)
      .backgroundColor('#e0e0e0')
      .borderRadius(3)
    Row({ space: 8 }) {
      Text(subTitle).fontSize(11).fontColor('#888')
      Text(subValue).fontSize(11).fontColor('#888')
    }
  }
}

@Builder
function RewardTag(label: string, unlocked: boolean): void {
  Row() {
    Text(label)
      .fontSize(12)
      .fontColor(unlocked ? '#00b386' : '#888')
      .backgroundColor(unlocked ? '#e0ffe6' : '#f0f0f0')
      .borderRadius(7)
      .padding({ left: 8, right: 8, top: 3, bottom: 3 })
  }
}
