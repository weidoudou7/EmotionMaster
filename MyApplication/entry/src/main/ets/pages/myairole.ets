import { BusinessError } from '@kit.BasicServicesKit';
import { ApiService } from '../service/apiservice';
import { AiRole } from '../common/types';
import { getUserId } from '../common/constants';
import http from '@ohos.net.http'
import image from '@ohos.multimedia.image'
import { effectKit } from '@kit.ArkGraphics2D'

// å®šä¹‰ä½ç½®æ¥å£
interface Position {
  x: number;
  y: number;
}

@Entry
@Component
export struct MyAIRole {
  @State isLoading: boolean = false;
  @State aiRoles: AiRole[] = [];
  @State userAvatar: string = '';
  @State rotationAngle: number = 0; // æ—‹è½¬è§’åº¦
  @State isGathering: boolean = false; // æ˜¯å¦æ­£åœ¨èšé›†
  @State isSpreading: boolean = false; // æ˜¯å¦æ­£åœ¨æ‰©æ•£
  @State gatherProgress: number = 0; // èšé›†è¿›åº¦ (0-1)
  @State spreadProgress: number = 0; // æ‰©æ•£è¿›åº¦ (0-1)
  @State rolesOpacity: number = 1; // AIè§’è‰²é€æ˜åº¦ - åˆå§‹å€¼è®¾ä¸º1ç¡®ä¿å¯è§
  @State currentRoleIndex: number = 0; // å½“å‰æ˜¾ç¤ºçš„è§’è‰²ç»„ç´¢å¼•
  @State selectedRole: AiRole | null = null; // å½“å‰é€‰ä¸­çš„è§’è‰²
  @State lastClickTime: number = 0; // ä¸Šæ¬¡ç‚¹å‡»æ—¶é—´
  @State lastClickIndex: number = -1; // ä¸Šæ¬¡ç‚¹å‡»çš„è§’è‰²ç´¢å¼•
  @State selectedIndex: number = -1; // å½“å‰é€‰ä¸­çš„è§’è‰²ç´¢å¼•
  @State hoverIndex: number = -1; // å½“å‰æ‚¬åœçš„è§’è‰²ç´¢å¼•
  @State currentRoleStartIndex: number = 0; // å½“å‰æ˜¾ç¤ºçš„è§’è‰²èµ·å§‹ä¸‹æ ‡
  @State private arcRotation: number = 0
  @State private glowOpacity: number = 0.5
  @State private textOpacity: number = 0.8
  @State private lineScale: number = 1.0
  @State private mainColor: string = '#1a1a1a'
  @State private pixelMap: PixelMap | undefined = undefined

  // é¢„è®¡ç®—å…­ä¸ªä½ç½®ï¼ˆåœ†å½¢å¸ƒå±€ï¼‰
  private rolePositions: Position[] = [
    { x: 120, y: 0 },      // 0åº¦ - å³ä¾§
    { x: 60, y: 103.92 },  // 60åº¦ - å³ä¸‹
    { x: -60, y: 103.92 }, // 120åº¦ - å·¦ä¸‹
    { x: -120, y: 0 },     // 180åº¦ - å·¦ä¾§
    { x: -60, y: -103.92 }, // 240åº¦ - å·¦ä¸Š
    { x: 60, y: -103.92 }  // 300åº¦ - å³ä¸Š
  ];

  // è·å–å½“å‰è¦æ˜¾ç¤ºçš„6ä¸ªè§’è‰²
  private getCurrentRoles(): AiRole[] {
    if (!this.aiRoles || this.aiRoles.length === 0) return [];
    const roles: AiRole[] = [];
    for (let i = 0; i < 6; i++) {
      const idx = (this.currentRoleStartIndex + i) % this.aiRoles.length;
      roles.push(this.aiRoles[idx]);
    }
    return roles;
  }

  aboutToAppear() {
    console.log('ğŸš€ MyAIRoleé¡µé¢å¼€å§‹åŠ è½½');
    this.loadAIRoles();
    this.loadUserInfo();
    this.startRotation();
    this.startAnimations();
    
    // æ·»åŠ è°ƒè¯•ä¿¡æ¯
    console.log('ğŸ” åˆå§‹çŠ¶æ€æ£€æŸ¥:');
    console.log('  - rolesOpacity:', this.rolesOpacity);
    console.log('  - isGathering:', this.isGathering);
    console.log('  - isSpreading:', this.isSpreading);
    console.log('  - aiRolesé•¿åº¦:', this.aiRoles ? this.aiRoles.length : 'undefined');
  }

  // å¯åŠ¨æ—‹è½¬åŠ¨ç”»
  private startRotation() {
    // æ¯50æ¯«ç§’æ—‹è½¬1åº¦ï¼Œå®ç°å¹³æ»‘çš„æ—‹è½¬æ•ˆæœ
    setInterval(() => {
      if (!this.isGathering && !this.isSpreading) { // åªæœ‰åœ¨ä¸èšé›†ä¸”ä¸æ‰©æ•£æ—¶æ‰æ—‹è½¬
        this.rotationAngle += 1;
        if (this.rotationAngle >= 360) {
          this.rotationAngle = 0;
        }
      }
    }, 50);
  }

  // å¼€å§‹èšé›†åŠ¨ç”»
  private startGatheringAnimation() {
    if (this.isGathering || this.isSpreading) return; // é˜²æ­¢é‡å¤è§¦å‘
    
    this.isGathering = true;
    this.gatherProgress = 0;
    this.rolesOpacity = 1;
    
    // èšé›†åŠ¨ç”»ï¼š1ç§’å†…å®Œæˆ
    const duration = 1000; // 1ç§’
    const interval = 16; // çº¦60fps
    const steps = duration / interval;
    const progressStep = 1 / steps;
    
    const timer = setInterval(() => {
      this.gatherProgress += progressStep;
      
      if (this.gatherProgress >= 1) {
        this.gatherProgress = 1;
        this.rolesOpacity = 0;
        clearInterval(timer);
        
        // èšé›†å®Œæˆåå¼€å§‹æ‰©æ•£åŠ¨ç”»
        setTimeout(() => {
          this.startSpreadingAnimation();
        }, 300);
      } else {
        // è®¡ç®—é€æ˜åº¦ï¼šåœ¨èšé›†è¿‡ç¨‹ä¸­é€æ¸å˜é€æ˜
        this.rolesOpacity = 1 - this.gatherProgress;
      }
    }, interval);
  }

  // å¼€å§‹æ‰©æ•£åŠ¨ç”»
  private startSpreadingAnimation() {
    this.isGathering = false;
    this.isSpreading = true;
    this.spreadProgress = 0;
    this.rolesOpacity = 0;
    
    // åˆ‡æ¢åˆ°ä¸‹ä¸€ç»„è§’è‰²ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
    if (this.aiRoles && this.aiRoles.length > 6) {
      this.currentRoleIndex = (this.currentRoleIndex + 6) % this.aiRoles.length;
    }
    
    // æ‰©æ•£åŠ¨ç”»ï¼š1ç§’å†…å®Œæˆ
    const duration = 1000; // 1ç§’
    const interval = 16; // çº¦60fps
    const steps = duration / interval;
    const progressStep = 1 / steps;
    
    const timer = setInterval(() => {
      this.spreadProgress += progressStep;
      
      if (this.spreadProgress >= 1) {
        this.spreadProgress = 1;
        this.rolesOpacity = 1;
        clearInterval(timer);
        
        // æ‰©æ•£å®Œæˆåé‡ç½®çŠ¶æ€
        setTimeout(() => {
          this.isSpreading = false;
          this.spreadProgress = 0;
          this.gatherProgress = 0;
          this.rolesOpacity = 1; // ç¡®ä¿è§’è‰²å¯è§
          console.log('âœ… æ‰©æ•£åŠ¨ç”»å®Œæˆï¼Œé‡ç½®çŠ¶æ€:');
          console.log('  - isSpreading:', this.isSpreading);
          console.log('  - rolesOpacity:', this.rolesOpacity);
        }, 500);
      } else {
        // è®¡ç®—é€æ˜åº¦ï¼šåœ¨æ‰©æ•£è¿‡ç¨‹ä¸­é€æ¸å˜ä¸é€æ˜
        this.rolesOpacity = this.spreadProgress;
      }
    }, interval);
  }

  // è®¡ç®—æ—‹è½¬åçš„ä½ç½®
  private getRotatedPosition(index: number): Position {
    const basePosition = this.rolePositions[index];
    const angleRad = (this.rotationAngle + index * 60) * Math.PI / 180;
    const radius = 120; // æ—‹è½¬åŠå¾„
    
    return {
      x: Math.cos(angleRad) * radius,
      y: Math.sin(angleRad) * radius
    };
  }

  // è®¡ç®—èšé›†æ—¶çš„ä½ç½®ï¼ˆå‘ä¸­å¿ƒç§»åŠ¨ï¼‰
  private getGatheringPosition(index: number): Position {
    if (!this.isGathering) {
      return this.getRotatedPosition(index);
    }
    
    const startPos = this.getRotatedPosition(index);
    const centerPos: Position = { x: 0, y: 0 }; // ä¸­å¿ƒä½ç½®
    
    // çº¿æ€§æ’å€¼ï¼šä»èµ·å§‹ä½ç½®å‘ä¸­å¿ƒç§»åŠ¨
    return {
      x: startPos.x + (centerPos.x - startPos.x) * this.gatherProgress,
      y: startPos.y + (centerPos.y - startPos.y) * this.gatherProgress
    };
  }

  // è®¡ç®—æ‰©æ•£æ—¶çš„ä½ç½®ï¼ˆä»ä¸­å¿ƒå‘å¤–ç§»åŠ¨ï¼‰
  private getSpreadingPosition(index: number): Position {
    if (!this.isSpreading) {
      return this.getRotatedPosition(index);
    }
    
    const endPos = this.getRotatedPosition(index);
    const centerPos: Position = { x: 0, y: 0 }; // ä¸­å¿ƒä½ç½®
    
    // çº¿æ€§æ’å€¼ï¼šä»ä¸­å¿ƒä½ç½®å‘å¤–ç§»åŠ¨
    return {
      x: centerPos.x + (endPos.x - centerPos.x) * this.spreadProgress,
      y: centerPos.y + (endPos.y - centerPos.y) * this.spreadProgress
    };
  }

  // åŠ è½½ç”¨æˆ·ä¿¡æ¯
  async loadUserInfo() {
    try {
      const userId = getUserId();
      if (userId) {
        // è¿™é‡Œå¯ä»¥è°ƒç”¨APIè·å–ç”¨æˆ·å¤´åƒï¼Œæš‚æ—¶ä½¿ç”¨é»˜è®¤å¤´åƒ
        this.userAvatar = '';
        console.log('ğŸ‘¤ ç”¨æˆ·å¤´åƒå·²è®¾ç½®');
      }
    } catch (error) {
      console.error('âŒ åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
  }

  // åŠ è½½AIè§’è‰²æ•°æ®
  async loadAIRoles() {
    this.isLoading = true;
    try {
      // è·å–å…¨å±€ç”¨æˆ·ID
      const userId = getUserId();
      console.log('ğŸ¤– å¼€å§‹åŠ è½½ç”¨æˆ·AIè§’è‰²ï¼Œå…¨å±€ç”¨æˆ·ID:', userId);
      
      if (userId === null || userId <= 0) {
        console.error('âŒ å…¨å±€ç”¨æˆ·IDæ— æ•ˆ:', userId);
        console.error('âŒ è¯·å…ˆç™»å½•è·å–ç”¨æˆ·ID');
        this.aiRoles = [];
        return;
      }

      console.log('ğŸ¤– ä½¿ç”¨å…¨å±€ç”¨æˆ·ID:', userId);
      // è°ƒç”¨APIè·å–ç”¨æˆ·çš„AIè§’è‰²åˆ—è¡¨
      const roles = await ApiService.getUserAiRoles(userId);
      console.log('âœ… è·å–AIè§’è‰²åˆ—è¡¨æˆåŠŸ:', roles);
      console.log('âœ… è§’è‰²æ•°é‡:', roles ? roles.length : 0);
      console.log('âœ… è§’è‰²è¯¦æƒ…:', JSON.stringify(roles, null, 2));
      this.aiRoles = roles || [];
      console.log('âœ… è®¾ç½®aiRolesåï¼Œæ•°ç»„é•¿åº¦:', this.aiRoles.length);
      // è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªè§’è‰²å¹¶æå–ä¸»è‰²
      if (this.aiRoles.length > 0) {
        this.selectedRole = this.aiRoles[0];
        this.selectedIndex = 0;
        await this.updateMainColorBySelectedRole();
      }
      
    } catch (error) {
      console.error('âŒ åŠ è½½AIè§’è‰²å¤±è´¥:', error);
      console.error('âŒ é”™è¯¯è¯¦æƒ…:', JSON.stringify(error));
      // æ˜¾ç¤ºé”™è¯¯æç¤ºæˆ–ä½¿ç”¨é»˜è®¤æ•°æ®
      this.aiRoles = [];
    } finally {
      this.isLoading = false;
      console.log('âœ… åŠ è½½å®Œæˆï¼ŒisLoading:', this.isLoading, 'aiRolesé•¿åº¦:', this.aiRoles.length);
      
      // ç¡®ä¿è§’è‰²åœ¨æ­£å¸¸çŠ¶æ€ä¸‹å¯è§
      if (!this.isGathering && !this.isSpreading) {
        this.rolesOpacity = 1;
        console.log('âœ… è®¾ç½®rolesOpacityä¸º1ï¼Œç¡®ä¿è§’è‰²å¯è§');
      }
      
      // æ·»åŠ è°ƒè¯•ä¿¡æ¯
      console.log('ğŸ” åŠ è½½åçŠ¶æ€æ£€æŸ¥:');
      console.log('  - rolesOpacity:', this.rolesOpacity);
      console.log('  - isGathering:', this.isGathering);
      console.log('  - isSpreading:', this.isSpreading);
      console.log('  - currentRolesé•¿åº¦:', this.getCurrentRoles() ? this.getCurrentRoles().length : 'undefined');
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  formatTime(timeString: string): string {
    try {
      const date = new Date(timeString);
      return date.toLocaleDateString();
    } catch (error) {
      return 'æœªçŸ¥æ—¶é—´';
    }
  }

  private startAnimations() {
    // åœ†å¼§æ—‹è½¬åŠ¨ç”»
    setInterval(() => {
      this.arcRotation += 2
    }, 50)
    
    // çº¿æ¡ç¼©æ”¾åŠ¨ç”»
    setInterval(() => {
      this.lineScale = this.lineScale === 1.0 ? 1.1 : 1.0
    }, 1200)
    
    // å‘å…‰æ•ˆæœåŠ¨ç”»
    setInterval(() => {
      this.glowOpacity = this.glowOpacity === 0.5 ? 0.8 : 0.5
    }, 1000)
    
    // æ–‡å­—é€æ˜åº¦åŠ¨ç”»
    setInterval(() => {
      this.textOpacity = this.textOpacity === 0.8 ? 1.0 : 0.8
    }, 1500)
  }

  // é€‰ä¸­è§’è‰²æ—¶æå–ä¸»è‰²
  private async updateMainColorBySelectedRole() {
    if (this.selectedRole && this.selectedRole.avatarUrl) {
      await this.extractMainColorFromImage(this.selectedRole.avatarUrl)
    } else {
      this.mainColor = '#1a1a1a'
    }
  }

  async extractMainColorFromImage(url: string) {
    const httpRequest = http.createHttp()
    try {
      const response = await httpRequest.request(url, { method: http.RequestMethod.GET })
      if (response.responseCode === 200 && response.result) {
        let imageData: ArrayBuffer
        if (response.result instanceof ArrayBuffer) {
          imageData = response.result
        } else {
          this.mainColor = '#cccccc'
          return
        }
        const imageSource = image.createImageSource(imageData)
        const pixelMap = await imageSource.createPixelMap()
        this.pixelMap = pixelMap
        effectKit.createColorPicker(pixelMap, (err: Error | null, colorPicker: effectKit.ColorPicker | null) => {
          if (!err && colorPicker) {
            const color = colorPicker.getMainColorSync()
            const alpha = color.alpha.toString(16).padStart(2, '0')
            const red = color.red.toString(16).padStart(2, '0')
            const green = color.green.toString(16).padStart(2, '0')
            const blue = color.blue.toString(16).padStart(2, '0')
            this.mainColor = `#${alpha}${red}${green}${blue}`
          }
        })
      }
    } catch (error) {
      this.mainColor = '#cccccc'
    } finally {
      httpRequest.destroy()
    }
  }

  build() {
    Stack() {
      // æ·±è‰²æ¸å˜èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#000000', 0.0], ['#0a0a0a', 0.5], ['#1a1a1a', 1.0]]
        })
      
      // æ—‹è½¬çš„åœ†å¼§èƒŒæ™¯è£…é¥°
      Stack() {
        // å¤šä¸ªåŒå¿ƒåœ†å¼§è½¨é“
        ForEach([0, 1, 2, 3], (index: number) => {
          Stack() {
            // åœ†å¼§è½¨é“
            Column()
              .width(200 + index * 60)
              .height(200 + index * 60)
              .borderRadius((200 + index * 60) / 2)
              .border({ width: 1, color: `rgba(64, 64, 64, ${0.3 - index * 0.05})` })
              .position({ x: '50%', y: '50%' })
              .translate({ x: -(200 + index * 60) / 2, y: -(200 + index * 60) / 2 })
            
            // æ—‹è½¬çš„åœ†å¼§ç‚¹
            Column()
              .width(8)
              .height(8)
              .backgroundColor(`rgba(255, 255, 255, ${0.6 - index * 0.1})`)
              .borderRadius(4)
              .position({ x: '50%', y: '50%' })
              .translate({ 
                x: -4 + Math.cos((this.arcRotation + index * 90) * Math.PI / 180) * (100 + index * 30),
                y: -4 + Math.sin((this.arcRotation + index * 90) * Math.PI / 180) * (100 + index * 30)
              })
          }
        })
        
        // å¤–åœˆè£…é¥°ç‚¹
        ForEach([0, 1, 2, 3, 4, 5, 6, 7], (index: number) => {
          Column()
            .width(4)
            .height(4)
            .backgroundColor(`rgba(192, 192, 192, ${0.4 - index * 0.03})`)
            .borderRadius(2)
            .position({ x: '50%', y: '50%' })
            .translate({ 
              x: -2 + Math.cos((this.arcRotation * 0.5 + index * 45) * Math.PI / 180) * 160,
              y: -2 + Math.sin((this.arcRotation * 0.5 + index * 45) * Math.PI / 180) * 160
            })
        })
      }
      .width('100%')
      .height('100%')
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          // è¿”å›æŒ‰é’®
          Button('â†')
            .width(44)
            .height(44)
            .backgroundColor('rgba(255, 255, 255, 0.1)')
            .borderRadius(22)
            .fontColor('#ffffff')
            .fontSize(18)
            .onClick(() => {
              let uiContext: UIContext = this.getUIContext();
              let router = uiContext.getRouter();
              router.back();
            })
            
          // æ ‡é¢˜
          Text('æˆ‘çš„AIè§’è‰²')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ffffff')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
            .opacity(this.textOpacity)
          
          // åˆ›å»ºæŒ‰é’®
          Button('+')
            .width(44)
            .height(44)
            .backgroundColor('rgba(255, 255, 255, 0.1)')
            .borderRadius(22)
            .fontColor('#ffffff')
            .fontSize(20)
            .onClick(() => {
              let uiContext: UIContext = this.getUIContext();
              let router = uiContext.getRouter();
              router.pushUrl({ url: 'pages/CreateFigure' });
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 20, bottom: 20 })
        .justifyContent(FlexAlign.SpaceBetween)
        .alignItems(VerticalAlign.Center)

        // å†…å®¹åŒºåŸŸ
        Column() {
          if (this.isLoading) {
            // åŠ è½½çŠ¶æ€ - æŒ‰ç…§LoadingPageé£æ ¼
            Column() {
              // ä¸­å¿ƒåŠ¨ç”»åŒºåŸŸ
              Stack() {
                // å¤–åœˆå‘å…‰æ•ˆæœ
                Column()
                  .width(180)
                  .height(180)
                  .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.05})`)
                  .borderRadius(90)
                  .border({ width: 2, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.2})` })
                
                // å†…åœˆ
                Column()
                  .width(140)
                  .height(140)
                  .backgroundColor('rgba(255, 255, 255, 0.03)')
                  .borderRadius(70)
                  .border({ width: 1, color: 'rgba(255, 255, 255, 0.08)' })
                
                // ä¸­å¿ƒå›¾æ ‡
                Text('ğŸ¤–')
                  .fontSize(50)
                  .fontColor('#fff')
                  .opacity(this.textOpacity)
              }
              .margin({ bottom: 30 })
              
              Text('åŠ è½½ä¸­...')
                .fontSize(20)
                .fontWeight(FontWeight.Medium)
                .fontColor('#ffffff')
                .opacity(this.textOpacity)
            }
            .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else if (this.aiRoles.length === 0) {
            // ç©ºçŠ¶æ€ - æŒ‰ç…§LoadingPageé£æ ¼
            Column() {
              // ä¸­å¿ƒåŠ¨ç”»åŒºåŸŸ
              Stack() {
                // å¤–åœˆå‘å…‰æ•ˆæœ
                Column()
                  .width(180)
                  .height(180)
                  .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.05})`)
                  .borderRadius(90)
                  .border({ width: 2, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.2})` })
                
                // å†…åœˆ
                Column()
                  .width(140)
                  .height(140)
                  .backgroundColor('rgba(255, 255, 255, 0.03)')
                  .borderRadius(70)
                  .border({ width: 1, color: 'rgba(255, 255, 255, 0.08)' })
                
                // ä¸­å¿ƒå›¾æ ‡
                Text('ğŸ¤–')
                  .fontSize(50)
                  .fontColor('#fff')
                  .opacity(this.textOpacity)
              }
              .margin({ bottom: 30 })
              
              Text('è¿˜æ²¡æœ‰AIè§’è‰²')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#ffffff')
                .opacity(this.textOpacity)
                .margin({ bottom: 12 })
              
              Text('åˆ›å»ºä¸€ä¸ªAIè§’è‰²å¼€å§‹å¯¹è¯å§')
                .fontSize(16)
                .fontColor('rgba(255, 255, 255, 0.7)')
                .opacity(this.textOpacity)
                .margin({ bottom: 40 })
                .textAlign(TextAlign.Center)
              
              // åˆ›å»ºæŒ‰é’® - ç°ä»£åŒ–è®¾è®¡
              Button('åˆ›å»ºAIè§’è‰²')
                .width(180)
                .height(48)
                .backgroundColor('rgba(255, 255, 255, 0.1)')
                .borderRadius(24)
                .fontColor('#ffffff')
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .border({ width: 1, color: 'rgba(255, 255, 255, 0.2)' })
                .onClick(() => {
                  let uiContext: UIContext = this.getUIContext();
                  let router = uiContext.getRouter();
                  router.pushUrl({ url: 'pages/CreateFigure' });
                })
            }
            .width('100%')
            .height('100%')
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else {
            // åœ†å½¢å¸ƒå±€ï¼šä¸­å¿ƒç”¨æˆ·å¤´åƒï¼Œå‘¨å›´å…­ä¸ªAIè§’è‰²
            Stack() {
              // èƒŒæ™¯åœ†å½¢è½¨é“ - ç°ä»£åŒ–è®¾è®¡
              Column()
                .width(320)
                .height(320)
                .borderRadius(160)
                .border({ width: 2, color: 'rgba(255, 255, 255, 0.1)' })
                .backgroundColor('rgba(255, 255, 255, 0.02)')
              
              // ä¸­å¿ƒç”¨æˆ·å¤´åƒï¼ˆå¯ç‚¹å‡»ï¼‰
              Stack() {
                if (this.userAvatar && this.userAvatar.trim() !== '') {
                  Image(this.userAvatar)
                    .width(80)
                    .height(80)
                    .borderRadius(40)
                    .objectFit(ImageFit.Cover)
                } else {
                  Text('ğŸ‘¤')
                    .fontSize(36)
                    .fontColor('#ffffff')
                }
                
                // å‘å…‰æ•ˆæœ
                Circle()
                  .width(100)
                  .height(100)
                  .fill('rgba(255, 255, 255, 0.05)')
                  .stroke(`rgba(255, 255, 255, ${this.glowOpacity * 0.3})`)
                  .strokeWidth(2)
                  .position({ x: -10, y: -10 })
                  .animation({
                    duration: 2000,
                    curve: Curve.EaseInOut,
                    iterations: -1,
                    playMode: PlayMode.Alternate
                  })
                  .scale({ x: this.lineScale, y: this.lineScale })
                  .opacity(0.8)
              }
              .width(80)
              .height(80)
              .backgroundColor('rgba(255, 255, 255, 0.05)')
              .borderRadius(40)
              .border({ width: 2, color: 'rgba(255, 255, 255, 0.2)' })
              .shadow({ radius: 10, color: '#00000040', offsetX: 0, offsetY: 5 })
              .position({ x: '50%', y: '50%' })
              .translate({ x: -40, y: -40 })
              .onClick(() => {
                if (this.aiRoles && this.aiRoles.length > 0) {
                  this.currentRoleStartIndex = (this.currentRoleStartIndex + 6) % this.aiRoles.length;
                }
              })
              
              // å‘¨å›´å…­ä¸ªAIè§’è‰²åœ†åœˆ
              ForEach([0, 1, 2, 3, 4, 5], (index: number) => {
                if (this.getCurrentRoles().length > 0) {
                  Stack() {
                    // AIè§’è‰²å¤´åƒ
                    if (this.getCurrentRoles()[index] && this.getCurrentRoles()[index].avatarUrl && this.getCurrentRoles()[index].avatarUrl.trim() !== '') {
                      Image(this.getCurrentRoles()[index].avatarUrl)
                        .width(60)
                        .height(60)
                        .borderRadius(30)
                        .objectFit(ImageFit.Cover)
                    } else {
                      Text('ğŸ¤–')
                        .fontSize(24)
                        .fontColor('#ffffff')
                    }
                    
                    // é€‰ä¸­çŠ¶æ€æŒ‡ç¤ºå™¨
                    if (this.selectedIndex === index) {
                      Circle()
                        .width(80)
                        .height(80)
                        .fill('rgba(255, 255, 255, 0.1)')
                        .stroke(`rgba(255, 255, 255, ${this.glowOpacity * 0.6})`)
                        .strokeWidth(2)
                        .position({ x: -10, y: -10 })
                        .animation({
                          duration: 2000,
                          curve: Curve.EaseInOut,
                          iterations: -1,
                          playMode: PlayMode.Alternate
                        })
                        .scale({ x: 1.0, y: 1.0 })
                        .opacity(0.8)
                    }
                    
                    // æ‚¬åœæ•ˆæœæŒ‡ç¤ºå™¨
                    if (this.hoverIndex === index && this.selectedIndex !== index) {
                      Circle()
                        .width(75)
                        .height(75)
                        .fill('rgba(255, 255, 255, 0.05)')
                        .stroke('rgba(255, 255, 255, 0.3)')
                        .strokeWidth(1)
                        .position({ x: -7.5, y: -7.5 })
                        .animation({
                          duration: 1000,
                          curve: Curve.EaseInOut,
                          iterations: -1,
                          playMode: PlayMode.Alternate
                        })
                        .scale({ x: 1.0, y: 1.0 })
                        .opacity(0.6)
                    }
                  }
                  .width(60)
                  .height(60)
                  .backgroundColor(this.selectedIndex === index ? 'rgba(255, 255, 255, 0.15)' : 'rgba(255, 255, 255, 0.05)')
                  .borderRadius(30)
                  .border({ 
                    width: this.selectedIndex === index ? 3 : 1, 
                    color: this.selectedIndex === index ? `rgba(255, 255, 255, ${this.glowOpacity * 0.8})` : 'rgba(255, 255, 255, 0.2)' 
                  })
                  .shadow({ 
                    radius: this.selectedIndex === index ? 15 : 8, 
                    color: this.selectedIndex === index ? '#ffffff50' : '#00000030', 
                    offsetX: 0, 
                    offsetY: this.selectedIndex === index ? 8 : 3 
                  })
                  .position({ x: '50%', y: '50%' })
                  .translate({ 
                    x: this.isSpreading ? this.getSpreadingPosition(index).x - 30 : this.getGatheringPosition(index).x - 30, 
                    y: this.isSpreading ? this.getSpreadingPosition(index).y - 30 : this.getGatheringPosition(index).y - 30
                  })
                  .opacity(this.rolesOpacity)
                  .scale({ 
                    x: this.selectedIndex === index ? 1.1 : (this.hoverIndex === index ? 1.05 : 1.0), 
                    y: this.selectedIndex === index ? 1.1 : (this.hoverIndex === index ? 1.05 : 1.0) 
                  })
                  .animation({
                    duration: 200,
                    curve: Curve.EaseInOut
                  })
                  .onClick(() => {
                    const currentTime = Date.now();
                    const timeDiff = currentTime - this.lastClickTime;
                    const isSameRole = this.lastClickIndex === index;
                    if (timeDiff < 300 && isSameRole) {
                      const selectedRole = this.getCurrentRoles()[index];
                      let uiContext: UIContext = this.getUIContext();
                      let router = uiContext.getRouter();
                      router.pushUrl({ 
                        url: 'pages/chat',
                        params: {
                          figureImageUrl: selectedRole.avatarUrl || '',
                          figureName: selectedRole.roleName || '',
                          figureType: selectedRole.roleType || '',
                          description: selectedRole.roleDescription || '',
                          isFromCreateFigure: true,
                          createdAiRoleId: selectedRole.id || 0
                        }
                      });
                      this.lastClickTime = 0;
                      this.lastClickIndex = -1;
                    } else {
                      this.selectedRole = this.getCurrentRoles()[index];
                      this.selectedIndex = index;
                      this.lastClickTime = currentTime;
                      this.lastClickIndex = index;
                    }
                  })
                  .onHover((isHovered: boolean) => {
                    if (!this.isGathering && !this.isSpreading) {
                      this.hoverIndex = isHovered ? index : -1;
                    }
                  })
                }
              })
            }
            .width(320)
            .height(320)
            .margin({ top: 20, bottom: 30 })
            
            // AIè§’è‰²è¯¦ç»†ä¿¡æ¯å±•ç¤º
            Column() {
              if (this.selectedRole) {
                // æ˜¾ç¤ºé€‰ä¸­è§’è‰²çš„è¯¦ç»†ä¿¡æ¯
                Column() {
                  Text('è§’è‰²è¯¦æƒ…')
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ffffff')
                    .opacity(this.textOpacity)
                    .margin({ bottom: 25 })
                    .textAlign(TextAlign.Center)
                  
                  // è§’è‰²è¯¦ç»†ä¿¡æ¯å¡ç‰‡ - ç°ä»£åŒ–è®¾è®¡
                  Column() {
                    // è§’è‰²å¤´åƒå’ŒåŸºæœ¬ä¿¡æ¯
                    Row() {
                      // è§’è‰²å¤´åƒ
                      Stack() {
                        if (this.selectedRole.avatarUrl && this.selectedRole.avatarUrl.trim() !== '') {
                          Image(this.selectedRole.avatarUrl)
                            .width(90)
                            .height(90)
                            .borderRadius(45)
                            .objectFit(ImageFit.Cover)
                        } else {
                          Text('ğŸ¤–')
                            .fontSize(40)
                            .fontColor('#ffffff')
                            .width(90)
                            .height(90)
                            .textAlign(TextAlign.Center)
                            .backgroundColor('rgba(255, 255, 255, 0.1)')
                            .borderRadius(45)
                        }
                        
                        // å¤´åƒå‘å…‰æ•ˆæœ
                        Circle()
                          .width(110)
                          .height(110)
                          .fill('rgba(255, 255, 255, 0.05)')
                          .stroke(`rgba(255, 255, 255, ${this.glowOpacity * 0.3})`)
                          .strokeWidth(2)
                          .position({ x: -10, y: -10 })
                          .animation({
                            duration: 3000,
                            curve: Curve.EaseInOut,
                            iterations: -1,
                            playMode: PlayMode.Alternate
                          })
                          .scale({ x: 1.0, y: 1.0 })
                          .opacity(0.6)
                      }
                      .width(90)
                      .height(90)
                      .borderRadius(45)
                      .border({ width: 2, color: 'rgba(255, 255, 255, 0.2)' })
                      .shadow({ radius: 8, color: '#00000040', offsetX: 0, offsetY: 4 })
                      
                      // è§’è‰²åŸºæœ¬ä¿¡æ¯
                      Column() {
                        Text(this.selectedRole.roleName || 'æœªå‘½åè§’è‰²')
                          .fontSize(24)
                          .fontWeight(FontWeight.Bold)
                          .fontColor('#ffffff')
                          .opacity(this.textOpacity)
                          .margin({ bottom: 10 })
                          .textAlign(TextAlign.Start)
                        
                        if (this.selectedRole.roleType && this.selectedRole.roleType.trim() !== '') {
                          Text(this.selectedRole.roleType)
                            .fontSize(16)
                            .fontColor('rgba(255,255,255,0.8)')
                            .backgroundColor('rgba(255, 255, 255, 0.15)')
                            .borderRadius(20)
                            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                            .alignSelf(ItemAlign.Start)
                            .margin({ bottom: 10 })
                            .animation({
                              duration: 500,
                              curve: Curve.EaseInOut
                            })
                            .scale({ x: 1.0, y: 1.0 })
                        }
                        
                        if (this.selectedRole.createdAt) {
                          Text('åˆ›å»ºæ—¶é—´: ' + this.formatTime(this.selectedRole.createdAt))
                            .fontSize(14)
                            .fontColor('rgba(255,255,255,0.6)')
                            .textAlign(TextAlign.Start)
                        }
                      }
                      .layoutWeight(1)
                      .justifyContent(FlexAlign.Start)
                      .margin({ left: 20 })
                    }
                    .width('100%')
                    .margin({ bottom: 25 })
                    
                    // è§’è‰²æè¿°
                    if (this.selectedRole.roleDescription && this.selectedRole.roleDescription.trim() !== '') {
                      Text('è§’è‰²æè¿°:')
                        .fontSize(18)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#ffffff')
                        .opacity(this.textOpacity)
                        .margin({ bottom: 10 })
                        .textAlign(TextAlign.Start)
                      
                      Text(this.selectedRole.roleDescription)
                        .fontSize(16)
                        .fontColor('rgba(255,255,255,0.8)')
                        .textAlign(TextAlign.Start)
                        .margin({ bottom: 25 })
                        .maxLines(5)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                    }
                    
                    // æ“ä½œæŒ‰é’® - ç°ä»£åŒ–è®¾è®¡
                    Row() {
                      Button('å¼€å§‹èŠå¤©')
                        .width('48%')
                        .height(50)
                        .backgroundColor('rgba(255, 255, 255, 0.15)')
                        .borderRadius(25)
                        .fontSize(16)
                        .fontColor('#ffffff')
                        .fontWeight(FontWeight.Medium)
                        .border({ width: 1, color: 'rgba(255, 255, 255, 0.2)' })
                        .onClick(() => {
                          console.log('å¼€å§‹ä¸è§’è‰²èŠå¤©:', this.selectedRole?.roleName);
                          console.log('ä¼ é€’çš„è§’è‰²ä¿¡æ¯:', {
                            figureImageUrl: this.selectedRole?.avatarUrl,
                            figureName: this.selectedRole?.roleName,
                            figureType: this.selectedRole?.roleType,
                            description: this.selectedRole?.roleDescription,
                            isFromCreateFigure: true,
                            createdAiRoleId: this.selectedRole?.id
                          });
                          
                          let uiContext: UIContext = this.getUIContext();
                          let router = uiContext.getRouter();
                          router.pushUrl({ 
                            url: 'pages/chat',
                            params: {
                              figureImageUrl: this.selectedRole?.avatarUrl || '',
                              figureName: this.selectedRole?.roleName || '',
                              figureType: this.selectedRole?.roleType || '',
                              description: this.selectedRole?.roleDescription || '',
                              isFromCreateFigure: true,
                              createdAiRoleId: this.selectedRole?.id || 0
                            }
                          });
                        })
                        .animation({
                          duration: 200,
                          curve: Curve.EaseInOut
                        })
                        .scale({ x: 1.0, y: 1.0 })
                      
                      Button('å–æ¶ˆé€‰æ‹©')
                        .width('48%')
                        .height(50)
                        .backgroundColor('rgba(255, 255, 255, 0.08)')
                        .borderRadius(25)
                        .fontSize(16)
                        .fontColor('#ffffff')
                        .fontWeight(FontWeight.Medium)
                        .border({ width: 1, color: 'rgba(255, 255, 255, 0.15)' })
                        .margin({ left: '4%' })
                        .onClick(() => {
                          this.selectedRole = null;
                          this.selectedIndex = -1;
                          console.log('å–æ¶ˆé€‰æ‹©è§’è‰²');
                        })
                        .animation({
                          duration: 200,
                          curve: Curve.EaseInOut
                        })
                        .scale({ x: 1.0, y: 1.0 })
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.SpaceBetween)
                  }
                  .width('100%')
                  .padding({ left: 25, right: 25, top: 25, bottom: 25 })
                  .backgroundColor('rgba(255, 255, 255, 0.08)')
                  .borderRadius(20)
                  .border({ width: 1, color: 'rgba(255, 255, 255, 0.15)' })
                  .shadow({ radius: 15, color: '#00000050', offsetX: 0, offsetY: 8 })
                  .margin({ left: 20, right: 20 })
                  .animation({
                    duration: 500,
                    curve: Curve.EaseInOut
                  })
                  .scale({ x: 1.0, y: 1.0 })
                  .opacity(1)
                }
              } else {
                // æ˜¾ç¤ºæ‰€æœ‰è§’è‰²åˆ—è¡¨ - ç°ä»£åŒ–è®¾è®¡
                Column() {
                  Text('æˆ‘çš„AIè§’è‰²')
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ffffff')
                    .opacity(this.textOpacity)
                    .margin({ bottom: 15 })
                    .textAlign(TextAlign.Center)
                  
                  Text('ç‚¹å‡»ä¸Šæ–¹è§’è‰²æŸ¥çœ‹è¯¦æƒ…ï¼ŒåŒå‡»è¿›å…¥èŠå¤©')
                    .fontSize(16)
                    .fontColor('rgba(255,255,255,0.7)')
                    .opacity(this.textOpacity)
                    .margin({ bottom: 25 })
                    .textAlign(TextAlign.Center)
                  
                  ForEach(this.aiRoles, (role: AiRole, index: number) => {
                    Column() {
                      // è§’è‰²å¡ç‰‡ - ç°ä»£åŒ–è®¾è®¡
                      Row() {
                        // è§’è‰²å¤´åƒ
                        Stack() {
                          if (role.avatarUrl && role.avatarUrl.trim() !== '') {
                            Image(role.avatarUrl)
                              .width(70)
                              .height(70)
                              .borderRadius(35)
                              .objectFit(ImageFit.Cover)
                          } else {
                            Text('ğŸ¤–')
                              .fontSize(32)
                              .fontColor('#ffffff')
                              .width(70)
                              .height(70)
                              .textAlign(TextAlign.Center)
                              .backgroundColor('rgba(255, 255, 255, 0.1)')
                              .borderRadius(35)
                          }
                        }
                        .width(70)
                        .height(70)
                        .borderRadius(35)
                        .border({ width: 2, color: 'rgba(255, 255, 255, 0.2)' })
                        .shadow({ radius: 6, color: '#00000030', offsetX: 0, offsetY: 3 })
                        
                        // è§’è‰²ä¿¡æ¯
                        Column() {
                          Text(role.roleName || 'æœªå‘½åè§’è‰²')
                            .fontSize(20)
                            .fontWeight(FontWeight.Bold)
                            .fontColor('#ffffff')
                            .opacity(this.textOpacity)
                            .margin({ bottom: 8 })
                            .textAlign(TextAlign.Start)
                          
                          Text(role.roleDescription || 'æš‚æ— æè¿°')
                            .fontSize(16)
                            .fontColor('rgba(255,255,255,0.8)')
                            .textAlign(TextAlign.Start)
                            .maxLines(3)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .margin({ bottom: 10 })
                          
                          // è§’è‰²æ ‡ç­¾
                          if (role.roleType && role.roleType.trim() !== '') {
                            Text(role.roleType)
                              .fontSize(14)
                              .fontColor('rgba(255,255,255,0.7)')
                              .backgroundColor('rgba(255, 255, 255, 0.1)')
                              .borderRadius(16)
                              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                              .alignSelf(ItemAlign.Start)
                          }
                        }
                        .layoutWeight(1)
                        .justifyContent(FlexAlign.Start)
                        .margin({ left: 18 })
                        
                        // æ“ä½œæŒ‰é’®
                        Column() {
                          Button('èŠå¤©')
                            .width(70)
                            .height(36)
                            .backgroundColor('rgba(255, 255, 255, 0.15)')
                            .borderRadius(18)
                            .fontSize(14)
                            .fontColor('#ffffff')
                            .fontWeight(FontWeight.Medium)
                            .margin({ bottom: 10 })
                            .onClick(() => {
                              console.log('é€‰æ‹©è§’è‰²è¿›è¡ŒèŠå¤©:', role.roleName);
                              console.log('ä¼ é€’çš„è§’è‰²ä¿¡æ¯:', {
                                figureImageUrl: role.avatarUrl,
                                figureName: role.roleName,
                                figureType: role.roleType,
                                description: role.roleDescription,
                                isFromCreateFigure: true,
                                createdAiRoleId: role.id
                              });
                              
                              let uiContext: UIContext = this.getUIContext();
                              let router = uiContext.getRouter();
                              router.pushUrl({ 
                                url: 'pages/chat',
                                params: {
                                  figureImageUrl: role.avatarUrl || '',
                                  figureName: role.roleName || '',
                                  figureType: role.roleType || '',
                                  description: role.roleDescription || '',
                                  isFromCreateFigure: true,
                                  createdAiRoleId: role.id || 0
                                }
                              });
                            })
                            .animation({
                              duration: 200,
                              curve: Curve.EaseInOut
                            })
                            .scale({ x: 1.0, y: 1.0 })
                          
                          // åˆ›å»ºæ—¶é—´
                          if (role.createdAt) {
                            Text(this.formatTime(role.createdAt))
                              .fontSize(12)
                              .fontColor('rgba(255,255,255,0.5)')
                              .textAlign(TextAlign.Center)
                          }
                        }
                        .alignItems(HorizontalAlign.Center)
                      }
                      .width('100%')
                      .padding({ left: 20, right: 20, top: 20, bottom: 20 })
                      .backgroundColor('rgba(255, 255, 255, 0.08)')
                      .borderRadius(16)
                      .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
                      .shadow({ radius: 10, color: '#00000040', offsetX: 0, offsetY: 5 })
                      .margin({ left: 20, right: 20, bottom: 15 })
                      .animation({
                        duration: 300 + index * 100,
                        curve: Curve.EaseInOut
                      })
                      .scale({ x: 1.0, y: 1.0 })
                      .opacity(1)
                    }
                  })
                }
                .width('100%')
                .padding({ left: 20, right: 20 })
              }
            }
            .width('100%')
            .layoutWeight(1)
          }
        }
        .width('100%')
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.mainColor)
  }
}
