// infopage.ets
// å¯¼å…¥é¡µé¢è·¯ç”±æ¨¡å—
import { BusinessError } from '@kit.BasicServicesKit';
import promptAction from '@ohos.promptAction';
import { globalUserData } from '../models/userdata';
import { ApiService } from '../service/apiservice';
import { UserInfo, AvatarUploadRequest } from '../common/types';
import { Config } from '../common/config';
import { BottomNavBar } from './BottomNavBar';
import picker from '@ohos.file.picker';
import fs from '@ohos.file.fs';
import util from '@ohos.util';

@Entry
@Component
export struct InfoPage {
  @State userAvatar: Resource | string = $r("app.media.image"); // ç”¨æˆ·å¤´åƒ
  @State userName: string = globalUserData.userName; // ç”¨æˆ·åç§°
  @State userUID: string = globalUserData.userUID; // ç”¨æˆ·UID
  @State isPrivacyVisible: boolean = globalUserData.isPrivacyVisible; // ç”¨æˆ·éšç§æ˜¯å¦å¯è§
  @State showNameDialog: boolean = false; // æ˜¾ç¤ºåç§°ç¼–è¾‘å¯¹è¯æ¡†
  @State tempName: string = ''; // ä¸´æ—¶å­˜å‚¨ç¼–è¾‘çš„åç§°
  @State showSignatureDialog: boolean = false; // æ˜¾ç¤ºç­¾åç¼–è¾‘å¯¹è¯æ¡†
  @State tempSignature: string = ''; // ä¸´æ—¶å­˜å‚¨ç¼–è¾‘çš„ç­¾å
  @State showGenderDialog: boolean = false; // æ˜¾ç¤ºæ€§åˆ«é€‰æ‹©å¯¹è¯æ¡†
  @State tempGender: string = ''; // ä¸´æ—¶å­˜å‚¨é€‰æ‹©çš„æ€§åˆ«
  @State isLoading: boolean = false; // åŠ è½½çŠ¶æ€
  @State userInfo: UserInfo | null = null; // ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
  @State avatarScale: number = 1.0; // å¤´åƒç¼©æ”¾åŠ¨ç”»
  @State showPreviewDialog: boolean = false; // æ˜¾ç¤ºé¢„è§ˆå¯¹è¯æ¡†
  @State previewImage: string = ''; // é¢„è§ˆå›¾ç‰‡
  @State previewSeed: number = 0; // é¢„è§ˆç§å­
  @State isGeneratingPreview: boolean = false; // æ­£åœ¨ç”Ÿæˆé¢„è§ˆ
  @State isAvatarLoading: boolean = false; // å¤´åƒåŠ è½½çŠ¶æ€
  @State showAvatarViewer: boolean = false; // æ˜¾ç¤ºå¤´åƒæŸ¥çœ‹å™¨
  @State isUploadingAvatar: boolean = false; // æ­£åœ¨ä¸Šä¼ å¤´åƒ

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    // ä½¿ç”¨å…¨å±€æ•°æ®å¿«é€Ÿåˆå§‹åŒ–
    this.userName = globalUserData.userName;
    this.userUID = globalUserData.userUID;
    this.isPrivacyVisible = globalUserData.isPrivacyVisible;
    
    // å¼‚æ­¥åŠ è½½è¯¦ç»†ä¿¡æ¯
    this.loadUserInfoAsync();
  }

  // å¼‚æ­¥åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
  async loadUserInfoAsync() {
    try {
      console.log('ğŸ‘¤ [infopage] å¼€å§‹åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·UID:', this.userUID);
      
      const userInfo = await ApiService.getUserInfo(this.userUID);
      this.userInfo = userInfo;
      this.userName = userInfo.userName;
      this.isPrivacyVisible = userInfo.isPrivacyVisible;

      // å¤„ç†å¤´åƒæ˜¾ç¤º
      await this.updateAvatarDisplay(userInfo.userAvatar);
      
      console.log('ğŸ‘¤ [infopage] ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('ğŸ‘¤ [infopage] åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
    }
  }

  // æ›´æ–°å¤´åƒæ˜¾ç¤º
  async updateAvatarDisplay(avatarUrl: string | undefined) {
    console.log('ğŸ–¼ï¸ [infopage] å¼€å§‹æ›´æ–°å¤´åƒæ˜¾ç¤º');
    console.log('ğŸ–¼ï¸ [infopage] åŸå§‹å¤´åƒURL:', avatarUrl);
    
    if (avatarUrl && avatarUrl !== '' && avatarUrl !== '/avatars/default.png') {
      // å¦‚æœæœ‰åç«¯å¤´åƒï¼Œä½¿ç”¨åç«¯å¤´åƒ
      let processedAvatarUrl = avatarUrl;
      
      // å¤„ç†å¤´åƒURL - å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥å®Œæ•´URL
      if (avatarUrl.startsWith('/')) {
        const baseUrl = Config.getApiBaseUrl().replace('/api', '');
        processedAvatarUrl = baseUrl + avatarUrl;
        console.log('ğŸ–¼ï¸ [infopage] å¤„ç†åçš„å¤´åƒURL:', processedAvatarUrl);
      }
      
      this.userAvatar = processedAvatarUrl;
      console.log('ğŸ–¼ï¸ [infopage] å¤´åƒæ›´æ–°æˆåŠŸ');
    } else {
      // ä¸æ˜¾ç¤ºé»˜è®¤å¤´åƒï¼Œè®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²
      this.userAvatar = '';
      console.log('ğŸ–¼ï¸ [infopage] å¤´åƒä¸ºç©ºï¼Œä¸æ˜¾ç¤ºé»˜è®¤å¤´åƒ');
    }
  }

  // è·å–å¤´åƒURLï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
  getAvatarUrl(): string {
    if (typeof this.userAvatar === 'string') {
      return this.userAvatar;
    }
    return '';
  }

  // æ˜¾ç¤ºå¤´åƒæŸ¥çœ‹å™¨
  showAvatarViewerDialog() {
    this.showAvatarViewer = true;
  }

  // å…³é—­å¤´åƒæŸ¥çœ‹å™¨
  closeAvatarViewer() {
    this.showAvatarViewer = false;
  }

  // ç”Ÿæˆé¢„è§ˆå¤´åƒ
  async generatePreviewAvatar() {
    try {
      console.log('ğŸ‘ï¸ [infopage] å¼€å§‹ç”Ÿæˆé¢„è§ˆå¤´åƒ...');
      
      this.isGeneratingPreview = true;
      promptAction.showToast({ message: 'æ­£åœ¨ç”Ÿæˆé¢„è§ˆå¤´åƒ...' });

      // è°ƒç”¨åç«¯APIç”Ÿæˆé¢„è§ˆå¤´åƒ
      const previewResponse = await ApiService.generatePreviewAvatar(this.userUID);
      
      if (previewResponse && previewResponse.previewImage) {
        console.log('ğŸ‘ï¸ [infopage] é¢„è§ˆå¤´åƒç”ŸæˆæˆåŠŸ');
        console.log('ğŸ‘ï¸ [infopage] é¢„è§ˆç§å­:', previewResponse.previewSeed);
        
        // ä¿å­˜é¢„è§ˆä¿¡æ¯
        this.previewImage = previewResponse.previewImage;
        this.previewSeed = previewResponse.previewSeed;
        
        // æ˜¾ç¤ºé¢„è§ˆå¯¹è¯æ¡†
        this.showPreviewDialog = true;
        
        promptAction.showToast({ message: 'é¢„è§ˆå¤´åƒç”ŸæˆæˆåŠŸ' });
      } else {
        promptAction.showToast({ message: 'é¢„è§ˆå¤´åƒç”Ÿæˆå¤±è´¥' });
      }
    } catch (error) {
      console.error('ğŸ‘ï¸ [infopage] ç”Ÿæˆé¢„è§ˆå¤´åƒå¤±è´¥:', error);
      promptAction.showToast({ message: 'ç”Ÿæˆé¢„è§ˆå¤´åƒå¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isGeneratingPreview = false;
    }
  }

  // ç¡®è®¤å¹¶ä¿å­˜é¢„è§ˆå¤´åƒ
  async confirmPreviewAvatar() {
    try {
      console.log('ğŸ’¾ [infopage] å¼€å§‹ç¡®è®¤å¹¶ä¿å­˜é¢„è§ˆå¤´åƒ...');
      console.log('ğŸ’¾ [infopage] é¢„è§ˆç§å­:', this.previewSeed);
      
      this.isAvatarLoading = true;
      promptAction.showToast({ message: 'æ­£åœ¨ä¿å­˜å¤´åƒ...' });

      // è°ƒç”¨åç«¯APIç¡®è®¤å¹¶ä¿å­˜å¤´åƒ
      const newAvatarUrl = await ApiService.confirmPreviewAvatar(this.userUID, this.previewSeed);
      
      if (newAvatarUrl) {
        console.log('ğŸ’¾ [infopage] å¤´åƒç¡®è®¤å¹¶ä¿å­˜æˆåŠŸï¼ŒURL:', newAvatarUrl);
        
        // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
        await this.updateAvatarDisplay(newAvatarUrl);
        
        // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
        await this.loadUserInfoAsync();
        
        // å…³é—­é¢„è§ˆå¯¹è¯æ¡†
        this.showPreviewDialog = false;
        
        promptAction.showToast({ message: 'å¤´åƒä¿å­˜æˆåŠŸ' });
      } else {
        promptAction.showToast({ message: 'å¤´åƒä¿å­˜å¤±è´¥' });
      }
    } catch (error) {
      console.error('ğŸ’¾ [infopage] ç¡®è®¤é¢„è§ˆå¤´åƒå¤±è´¥:', error);
      promptAction.showToast({ message: 'å¤´åƒä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isAvatarLoading = false;
    }
  }

  // å–æ¶ˆé¢„è§ˆå¤´åƒ
  cancelPreviewAvatar() {
    console.log('âŒ [infopage] å–æ¶ˆé¢„è§ˆå¤´åƒ');
    this.showPreviewDialog = false;
    this.previewImage = '';
    this.previewSeed = 0;
  }

  // ç¼–è¾‘ç”¨æˆ·åç§°
  editUserName() {
    this.tempName = this.userName;
    this.showNameDialog = true;
  }

  // ç¡®è®¤ç¼–è¾‘ç”¨æˆ·åç§°
  async confirmEditName() {
    if (this.tempName.trim() !== '') {
      try {
        this.isLoading = true;
        const updatedUser = await ApiService.updateUserInfo(this.userUID, {
          userName: this.tempName.trim()
        });
        this.userName = updatedUser.userName;
        promptAction.showToast({ message: 'ç”¨æˆ·åç§°æ›´æ–°æˆåŠŸ' });
      } catch (error) {
        console.error('æ›´æ–°ç”¨æˆ·åç§°å¤±è´¥:', error);
        promptAction.showToast({ message: 'æ›´æ–°ç”¨æˆ·åç§°å¤±è´¥' });
      } finally {
        this.isLoading = false;
      }
    }
    this.showNameDialog = false;
  }

  // å–æ¶ˆç¼–è¾‘ç”¨æˆ·åç§°
  cancelEditName() {
    this.showNameDialog = false;
  }

  // åˆ‡æ¢éšç§å¯è§æ€§
  async togglePrivacy() {
    try {
      this.isLoading = true;
      const newPrivacyState = await ApiService.togglePrivacy(this.userUID);
      this.isPrivacyVisible = newPrivacyState;
      promptAction.showToast({
        message: this.isPrivacyVisible ? 'éšç§å·²éšè—' : 'éšç§å·²å¯è§'
      });
    } catch (error) {
      console.error('åˆ‡æ¢éšç§çŠ¶æ€å¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ‡æ¢éšç§çŠ¶æ€å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // ç¼–è¾‘ä¸ªæ€§ç­¾å
  editSignature() {
    this.tempSignature = this.userInfo?.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹~';
    this.showSignatureDialog = true;
  }

  // ç¡®è®¤ç¼–è¾‘ä¸ªæ€§ç­¾å
  async confirmEditSignature() {
    if (this.tempSignature.trim() !== '') {
      try {
        this.isLoading = true;
        const updatedUser = await ApiService.updateUserInfo(this.userUID, {
          signature: this.tempSignature.trim()
        });
        // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
        if (this.userInfo) {
          this.userInfo.signature = updatedUser.signature;
        }
        promptAction.showToast({ message: 'ä¸ªæ€§ç­¾åæ›´æ–°æˆåŠŸ' });
      } catch (error) {
        console.error('æ›´æ–°ä¸ªæ€§ç­¾åå¤±è´¥:', error);
        promptAction.showToast({ message: 'æ›´æ–°ä¸ªæ€§ç­¾åå¤±è´¥' });
      } finally {
        this.isLoading = false;
      }
    }
    this.showSignatureDialog = false;
  }

  // å–æ¶ˆç¼–è¾‘ä¸ªæ€§ç­¾å
  cancelEditSignature() {
    this.showSignatureDialog = false;
  }

  // ç¼–è¾‘æ€§åˆ«
  editGender() {
    this.tempGender = this.userInfo?.gender || 'æœªè®¾ç½®';
    this.showGenderDialog = true;
  }

  // ç¡®è®¤ç¼–è¾‘æ€§åˆ«
  async confirmEditGender() {
    if (this.tempGender !== 'æœªè®¾ç½®') {
      try {
        this.isLoading = true;
        const updatedUser = await ApiService.updateUserInfo(this.userUID, {
          gender: this.tempGender
        });
        // æ›´æ–°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
        if (this.userInfo) {
          this.userInfo.gender = updatedUser.gender;
        }
        promptAction.showToast({ message: 'æ€§åˆ«æ›´æ–°æˆåŠŸ' });
      } catch (error) {
        console.error('æ›´æ–°æ€§åˆ«å¤±è´¥:', error);
        promptAction.showToast({ message: 'æ›´æ–°æ€§åˆ«å¤±è´¥' });
      } finally {
        this.isLoading = false;
      }
    }
    this.showGenderDialog = false;
  }

  // å–æ¶ˆç¼–è¾‘æ€§åˆ«
  cancelEditGender() {
    this.showGenderDialog = false;
  }

  // é€‰æ‹©å¹¶ä¸Šä¼ æœ¬åœ°å›¾ç‰‡
  async selectAndUploadImage() {
    try {
      console.log('ğŸ“ [infopage] å¼€å§‹é€‰æ‹©æœ¬åœ°å›¾ç‰‡...');
      
      this.isUploadingAvatar = true;
      promptAction.showToast({ message: 'æ­£åœ¨é€‰æ‹©å›¾ç‰‡...' });

      // åˆ›å»ºå›¾ç‰‡é€‰æ‹©å™¨
      const photoPicker = new picker.PhotoViewPicker();
      const photoSelectOptions: picker.PhotoSelectOptions = {
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      };

      // é€‰æ‹©å›¾ç‰‡
      const photoView = await photoPicker.select(photoSelectOptions);
      const uris = photoView.photoUris;

      if (uris && uris.length > 0) {
        const uri = uris[0];
        console.log('ğŸ“ [infopage] é€‰æ‹©çš„å›¾ç‰‡URI:', uri);
        
        // è¯»å–å›¾ç‰‡æ–‡ä»¶
        const fileData: ArrayBuffer = await fs.readFile(uri);
        console.log('ğŸ“ [infopage] å›¾ç‰‡æ–‡ä»¶å¤§å°:', fileData.byteLength);
        
        // è½¬æ¢ä¸ºbase64
        const base64Data: string = this.arrayBufferToBase64(fileData);
        console.log('ğŸ“ [infopage] å›¾ç‰‡base64é•¿åº¦:', base64Data.length);
        
        // ä¸Šä¼ åˆ°åç«¯
        promptAction.showToast({ message: 'æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...' });
        
        const uploadData: AvatarUploadRequest = {
          avatarData: base64Data,
          fileName: `avatar_${Date.now()}.jpg`
        };
        const uploadResponse = await ApiService.uploadAvatar(this.userUID, uploadData);
        
        if (uploadResponse && uploadResponse.avatarUrl) {
          console.log('ğŸ“ [infopage] å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼ŒURL:', uploadResponse.avatarUrl);
          
          // æ›´æ–°æœ¬åœ°æ˜¾ç¤º
          await this.updateAvatarDisplay(uploadResponse.avatarUrl);
          
          // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
          await this.loadUserInfoAsync();
          
          promptAction.showToast({ message: 'å¤´åƒä¸Šä¼ æˆåŠŸ' });
        } else {
          promptAction.showToast({ message: 'å¤´åƒä¸Šä¼ å¤±è´¥' });
        }
      } else {
        console.log('ğŸ“ [infopage] æœªé€‰æ‹©å›¾ç‰‡');
        promptAction.showToast({ message: 'æœªé€‰æ‹©å›¾ç‰‡' });
      }
    } catch (error) {
      console.error('ğŸ“ [infopage] é€‰æ‹©æˆ–ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
      promptAction.showToast({ message: 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·é‡è¯•' });
    } finally {
      this.isUploadingAvatar = false;
    }
  }

  // ArrayBufferè½¬Base64
  arrayBufferToBase64(buffer: ArrayBuffer): string {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    // ä½¿ç”¨ArkTSå†…ç½®çš„base64ç¼–ç 
    return util.TextEncoder.create('utf-8').encode(binary).toString('base64');
  }

  build() {
    Stack() {
      // æ¸å˜èƒŒæ™¯
      Column() {
        Blank().width('100%').height('100%')
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [['#1a1a2e', 0.0], ['#16213e', 0.5], ['#0f3460', 1.0]]
          })
      }
      .width('100%')
      .height('100%')

      if (this.isLoading) {
        Column() {
          LoadingProgress().width(50).height(50)
          Text('å¤„ç†ä¸­...').fontSize(16).fontColor('#fff').margin({ top: 10 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      } else {
        // ä¸»ä½“å†…å®¹
        Scroll() {
          Column() {
            // é¡µé¢æ ‡é¢˜åŒºåŸŸ
            Row() {
              Button() {
                Image($r('app.media.return'))
                  .width(24)
                  .height(24)
                  .fillColor('#fff')
              }
              .width(40)
              .height(40)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(20)
              .margin({ right: 16 })
              .onClick(() => {
                let uiContext: UIContext = this.getUIContext();
                let router = uiContext.getRouter();
                router.back();
              })

              Text('ä¸ªäººä¿¡æ¯')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#fff')
            }
            .width('90%')
            .padding({ top: 20, bottom: 20 })
            .justifyContent(FlexAlign.Start)
            .margin({ bottom: 20 })

            // å¤´åƒå¡ç‰‡ - æ”¹ä¸ºå¤´åƒæŸ¥çœ‹å™¨æ ·å¼
            Column() {
              // å¤´åƒæ˜¾ç¤ºåŒºåŸŸ - åƒé¢„è§ˆå™¨ä¸€æ ·æ˜¾ç¤º
              Stack() {
                // å¤´åƒå›¾ç‰‡ - å¤§å°ºå¯¸æ˜¾ç¤º
                if (this.userAvatar && this.userAvatar !== '') {
                  Image(this.userAvatar)
                    .width(200)
                    .height(200)
                    .borderRadius(100)
                    .border({ width: 4, color: 'rgba(255,255,255,0.3)' })
                    .scale({ x: this.avatarScale, y: this.avatarScale })
                    .animation({
                      duration: 120,
                      curve: Curve.EaseInOut
                    })
                    .objectFit(ImageFit.Cover)
                    .onClick(() => {
                      this.avatarScale = 0.95;
                      setTimeout(() => {
                        this.avatarScale = 1.0;
                        this.showAvatarViewerDialog();
                      }, 120);
                    })
                } else {
                  // å¤´åƒä¸ºç©ºæ—¶æ˜¾ç¤ºå ä½ç¬¦
                  Column() {
                    Text('ğŸ‘¤')
                      .fontSize(80)
                      .fontColor('rgba(255,255,255,0.5)')
                  }
                  .width(200)
                  .height(200)
                  .borderRadius(100)
                  .backgroundColor('rgba(255,255,255,0.1)')
                  .border({ width: 4, color: 'rgba(255,255,255,0.3)' })
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .scale({ x: this.avatarScale, y: this.avatarScale })
                  .animation({
                    duration: 120,
                    curve: Curve.EaseInOut
                  })
                  .onClick(() => {
                    this.avatarScale = 0.95;
                    setTimeout(() => {
                      this.avatarScale = 1.0;
                      this.generatePreviewAvatar();
                    }, 120);
                  })
                }

                // åŠ è½½çŠ¶æ€é®ç½©
                if (this.isAvatarLoading || this.isUploadingAvatar) {
                  Column() {
                    LoadingProgress().width(40).height(40)
                    Text(this.isUploadingAvatar ? 'ä¸Šä¼ ä¸­...' : 'å¤„ç†ä¸­...')
                      .fontSize(14)
                      .fontColor('#fff')
                      .margin({ top: 8 })
                  }
                  .width(200)
                  .height(200)
                  .borderRadius(100)
                  .backgroundColor('rgba(0,0,0,0.5)')
                  .justifyContent(FlexAlign.Center)
                }

                // åˆ·æ–°æŒ‰é’® - æ‚¬æµ®åœ¨å¤´åƒä¸Š
                if (!this.isGeneratingPreview && !this.isAvatarLoading) {
                  Button() {
                    Image($r('app.media.return'))
                      .width(24)
                      .height(24)
                      .fillColor('#fff')
                  }
                  .width(48)
                  .height(48)
                  .backgroundColor('rgba(0,0,0,0.7)')
                  .borderRadius(24)
                  .border({ width: 2, color: '#fff' })
                  .position({ x: '85%', y: '85%' })
                  .translate({ x: -24, y: -24 })
                  .onClick(() => {
                    this.generatePreviewAvatar();
                  })
                }
              }
              .width(200)
              .height(200)
              .margin({ bottom: 20 })

              // å¤´åƒæ“ä½œæŒ‰é’®
              Row() {
                Button('æŸ¥çœ‹å¤§å›¾')
                  .width(80)
                  .height(40)
                  .backgroundColor('rgba(255,255,255,0.1)')
                  .fontColor('#fff')
                  .borderRadius(20)
                  .onClick(() => this.showAvatarViewerDialog())

                Button('ä¸Šä¼ å›¾ç‰‡')
                  .width(80)
                  .height(40)
                  .backgroundColor('rgba(255,255,255,0.15)')
                  .fontColor('#fff')
                  .borderRadius(20)
                  .margin({ left: 10 })
                  .onClick(() => this.selectAndUploadImage())

                Button('ç”Ÿæˆæ–°å¤´åƒ')
                  .width(80)
                  .height(40)
                  .backgroundColor('rgba(255,255,255,0.2)')
                  .fontColor('#fff')
                  .borderRadius(20)
                  .margin({ left: 10 })
                  .onClick(() => this.generatePreviewAvatar())
              }
              .justifyContent(FlexAlign.Center)
            }
            .width('90%')
            .padding(24)
            .backgroundColor('rgba(255,255,255,0.1)')
            .borderRadius(20)
            .margin({ bottom: 20 })

            // ç”¨æˆ·ä¿¡æ¯å¡ç‰‡åˆ—è¡¨
            Column({ space: 16 }) {
              // ç”¨æˆ·åç§°é¡¹
              Row() {
                Column() {
                  Text('ç”¨æˆ·åç§°')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#fff')
                    .margin({ bottom: 4 })
                  Text(this.userName)
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.7)')
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Image($r('app.media.selectNext'))
                  .width(20)
                  .height(20)
                  .fillColor('rgba(255,255,255,0.6)')
              }
              .width('100%')
              .padding(20)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(16)
              .onClick(() => this.editUserName())

              // æ€§åˆ«é¡¹
              Row() {
                Column() {
                  Text('æ€§åˆ«')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#fff')
                    .margin({ bottom: 4 })
                  Text(this.userInfo?.gender || 'æœªè®¾ç½®')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.7)')
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Image($r('app.media.selectNext'))
                  .width(20)
                  .height(20)
                  .fillColor('rgba(255,255,255,0.6)')
              }
              .width('100%')
              .padding(20)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(16)
              .onClick(() => this.editGender())

              // ä¸ªæ€§ç­¾åé¡¹
              Row() {
                Column() {
                  Text('ä¸ªæ€§ç­¾å')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#fff')
                    .margin({ bottom: 4 })
                  Text(this.userInfo?.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹~')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.7)')
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Image($r('app.media.selectNext'))
                  .width(20)
                  .height(20)
                  .fillColor('rgba(255,255,255,0.6)')
              }
              .width('100%')
              .padding(20)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(16)
              .onClick(() => this.editSignature())

              // éšç§è®¾ç½®é¡¹
              Row() {
                Column() {
                  Text('éšç§è®¾ç½®')
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#fff')
                    .margin({ bottom: 4 })
                  Text(this.isPrivacyVisible ? 'éšç§å¯è§' : 'éšç§éšè—')
                    .fontSize(14)
                    .fontColor(this.isPrivacyVisible ? 'rgba(255,255,255,0.7)' : 'rgba(255,107,107,0.8)')
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)

                Toggle({ type: ToggleType.Switch, isOn: !this.isPrivacyVisible })
                  .selectedColor('#4CAF50')
                  .switchPointColor('#fff')
                  .onChange((isOn: boolean) => {
                    this.togglePrivacy();
                  })
              }
              .width('100%')
              .padding(20)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(16)
            }
            .width('90%')
            .margin({ bottom: 40 })
          }
          .width('100%')
          .padding({ top: 10 })
        }
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Off)
        .width('100%')
        .height('100%')
      }

      // å¤´åƒæŸ¥çœ‹å™¨ - å…¨å±æ˜¾ç¤ºå¤´åƒ
      if (this.showAvatarViewer) {
        Stack({ alignContent: Alignment.Center }) {
          // åŠé€æ˜èƒŒæ™¯
          Column() {
            Blank()
              .width('100%')
              .height('100%')
              .backgroundColor('#000000')
              .opacity(0.9)
              .onClick(() => this.closeAvatarViewer())
          }
          .width('100%')
          .height('100%')

          // å¤´åƒæŸ¥çœ‹å™¨å†…å®¹
          Column() {
            // å…³é—­æŒ‰é’®
            Row() {
              Button() {
                Image($r('app.media.return'))
                  .width(24)
                  .height(24)
                  .fillColor('#fff')
              }
              .width(40)
              .height(40)
              .backgroundColor('rgba(0,0,0,0.5)')
              .borderRadius(20)
              .onClick(() => this.closeAvatarViewer())
            }
            .width('100%')
            .justifyContent(FlexAlign.End)
            .margin({ bottom: 20 })

            // å¤§å°ºå¯¸å¤´åƒæ˜¾ç¤º
            if (this.userAvatar && this.userAvatar !== '') {
              Image(this.userAvatar)
                .width(300)
                .height(300)
                .borderRadius(150)
                .border({ width: 6, color: 'rgba(255,255,255,0.3)' })
                .objectFit(ImageFit.Cover)
                .margin({ bottom: 20 })
            } else {
              // å¤´åƒä¸ºç©ºæ—¶æ˜¾ç¤ºå ä½ç¬¦
              Column() {
                Text('ğŸ‘¤')
                  .fontSize(120)
                  .fontColor('rgba(255,255,255,0.5)')
              }
              .width(300)
              .height(300)
              .borderRadius(150)
              .backgroundColor('rgba(255,255,255,0.1)')
              .border({ width: 6, color: 'rgba(255,255,255,0.3)' })
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
              .margin({ bottom: 20 })
            }

            // æ“ä½œæŒ‰é’®
            Row() {
              Button('ç”Ÿæˆæ–°å¤´åƒ')
                .width(120)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.2)')
                .fontColor('#fff')
                .borderRadius(22)
                .onClick(() => {
                  this.closeAvatarViewer();
                  setTimeout(() => {
                    this.generatePreviewAvatar();
                  }, 300);
                })
            }
            .justifyContent(FlexAlign.Center)
          }
          .width('90%')
          .padding(24)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }

      // ä¸ªæ€§ç­¾åç¼–è¾‘å¼¹çª—
      if (this.showSignatureDialog) {
        Stack({ alignContent: Alignment.Center }) {
          // åŠé€æ˜èƒŒæ™¯
          Column() {
            Blank()
              .width('100%')
              .height('100%')
              .backgroundColor('#000000')
              .opacity(0.6)
              .onClick(() => this.cancelEditSignature())
          }
          .width('100%')
          .height('100%')

          // å¼¹çª—å†…å®¹
          Column() {
            // æ ‡é¢˜
            Text('ç¼–è¾‘ä¸ªæ€§ç­¾å')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .margin({ bottom: 20 })

            // è¾“å…¥æ¡†
            TextInput({
              text: this.tempSignature,
              placeholder: 'è¯·è¾“å…¥ä¸ªæ€§ç­¾å...'
            })
              .width('100%')
              .height(120)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(12)
              .padding(16)
              .fontSize(16)
              .fontColor('#fff')
              .placeholderColor('rgba(255,255,255,0.5)')
              .textAlign(TextAlign.Start)
              .onChange((value: string) => {
                this.tempSignature = value;
              })
              .onSubmit((enterKey: EnterKeyType, event: SubmitEvent) => {
                this.confirmEditSignature();
              })

            // æŒ‰é’®åŒºåŸŸ
            Row() {
              Button('å–æ¶ˆ')
                .width(100)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.1)')
                .fontColor('#fff')
                .borderRadius(22)
                .onClick(() => this.cancelEditSignature())

              Button('ç¡®å®š')
                .width(100)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.2)')
                .fontColor('#fff')
                .borderRadius(22)
                .margin({ left: 20 })
                .onClick(() => this.confirmEditSignature())
            }
            .margin({ top: 20 })
            .justifyContent(FlexAlign.Center)
          }
          .width('85%')
          .padding(24)
          .backgroundColor('rgba(0,0,0,0.8)')
          .borderRadius(20)
          .backdropBlur(20)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }

      // åç§°ç¼–è¾‘å¼¹çª—
      if (this.showNameDialog) {
        Stack({ alignContent: Alignment.Center }) {
          // åŠé€æ˜èƒŒæ™¯
          Column() {
            Blank()
              .width('100%')
              .height('100%')
              .backgroundColor('#000000')
              .opacity(0.6)
              .onClick(() => this.cancelEditName())
          }
          .width('100%')
          .height('100%')

          // å¼¹çª—å†…å®¹
          Column() {
            // æ ‡é¢˜
            Text('ç¼–è¾‘ç”¨æˆ·åç§°')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .margin({ bottom: 20 })

            // è¾“å…¥æ¡†
            TextInput({
              text: this.tempName,
              placeholder: 'è¯·è¾“å…¥ç”¨æˆ·åç§°...'
            })
              .width('100%')
              .height(50)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(12)
              .padding(16)
              .fontSize(16)
              .fontColor('#fff')
              .placeholderColor('rgba(255,255,255,0.5)')
              .textAlign(TextAlign.Start)
              .onChange((value: string) => {
                this.tempName = value;
              })
              .onSubmit((enterKey: EnterKeyType, event: SubmitEvent) => {
                this.confirmEditName();
              })

            // æŒ‰é’®åŒºåŸŸ
            Row() {
              Button('å–æ¶ˆ')
                .width(100)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.1)')
                .fontColor('#fff')
                .borderRadius(22)
                .onClick(() => this.cancelEditName())

              Button('ç¡®å®š')
                .width(100)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.2)')
                .fontColor('#fff')
                .borderRadius(22)
                .margin({ left: 20 })
                .onClick(() => this.confirmEditName())
            }
            .margin({ top: 20 })
            .justifyContent(FlexAlign.Center)
          }
          .width('85%')
          .padding(24)
          .backgroundColor('rgba(0,0,0,0.8)')
          .borderRadius(20)
          .backdropBlur(20)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }

      // æ€§åˆ«é€‰æ‹©å¼¹çª—
      if (this.showGenderDialog) {
        Stack({ alignContent: Alignment.Center }) {
          // åŠé€æ˜èƒŒæ™¯
          Column() {
            Blank()
              .width('100%')
              .height('100%')
              .backgroundColor('#000000')
              .opacity(0.6)
              .onClick(() => this.cancelEditGender())
          }
          .width('100%')
          .height('100%')

          // å¼¹çª—å†…å®¹
          Column() {
            // æ ‡é¢˜
            Text('é€‰æ‹©æ€§åˆ«')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .margin({ bottom: 20 })

            // æ€§åˆ«é€‰é¡¹
            Column({ space: 12 }) {
              // ç”·
              Row() {
                Text('ç”·')
                  .fontSize(16)
                  .fontColor(this.tempGender === 'ç”·' ? '#fff' : 'rgba(255,255,255,0.7)')
                  .fontWeight(this.tempGender === 'ç”·' ? FontWeight.Bold : FontWeight.Normal)

                if (this.tempGender === 'ç”·') {
                  Image($r('app.media.selectNext'))
                    .width(20)
                    .height(20)
                    .fillColor('#fff')
                    .margin({ left: 'auto' })
                }
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .backgroundColor(this.tempGender === 'ç”·' ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.1)')
              .borderRadius(12)
              .onClick(() => {
                this.tempGender = 'ç”·';
              })

              // å¥³
              Row() {
                Text('å¥³')
                  .fontSize(16)
                  .fontColor(this.tempGender === 'å¥³' ? '#fff' : 'rgba(255,255,255,0.7)')
                  .fontWeight(this.tempGender === 'å¥³' ? FontWeight.Bold : FontWeight.Normal)

                if (this.tempGender === 'å¥³') {
                  Image($r('app.media.selectNext'))
                    .width(20)
                    .height(20)
                    .fillColor('#fff')
                    .margin({ left: 'auto' })
                }
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .backgroundColor(this.tempGender === 'å¥³' ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.1)')
              .borderRadius(12)
              .onClick(() => {
                this.tempGender = 'å¥³';
              })

              // å…¶ä»–
              Row() {
                Text('å…¶ä»–')
                  .fontSize(16)
                  .fontColor(this.tempGender === 'å…¶ä»–' ? '#fff' : 'rgba(255,255,255,0.7)')
                  .fontWeight(this.tempGender === 'å…¶ä»–' ? FontWeight.Bold : FontWeight.Normal)

                if (this.tempGender === 'å…¶ä»–') {
                  Image($r('app.media.selectNext'))
                    .width(20)
                    .height(20)
                    .fillColor('#fff')
                    .margin({ left: 'auto' })
                }
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .backgroundColor(this.tempGender === 'å…¶ä»–' ? 'rgba(255,255,255,0.2)' : 'rgba(255,255,255,0.1)')
              .borderRadius(12)
              .onClick(() => {
                this.tempGender = 'å…¶ä»–';
              })
            }
            .margin({ bottom: 20 })

            // æŒ‰é’®åŒºåŸŸ
            Row() {
              Button('å–æ¶ˆ')
                .width(100)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.1)')
                .fontColor('#fff')
                .borderRadius(22)
                .onClick(() => this.cancelEditGender())

              Button('ç¡®å®š')
                .width(100)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.2)')
                .fontColor('#fff')
                .borderRadius(22)
                .margin({ left: 20 })
                .onClick(() => this.confirmEditGender())
            }
            .justifyContent(FlexAlign.Center)
          }
          .width('85%')
          .backgroundColor('rgba(0,0,0,0.8)')
          .borderRadius(20)
          .padding(24)
          .backdropBlur(20)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }

      // å¤´åƒé¢„è§ˆå¼¹çª— - é‡å†™çš„é¢„è§ˆå¯¹è¯æ¡†
      if (this.showPreviewDialog) {
        Stack({ alignContent: Alignment.Center }) {
          // åŠé€æ˜èƒŒæ™¯
          Column() {
            Blank()
              .width('100%')
              .height('100%')
              .backgroundColor('#000000')
              .opacity(0.6)
              .onClick(() => this.cancelPreviewAvatar())
          }
          .width('100%')
          .height('100%')

          // å¼¹çª—å†…å®¹
          Column() {
            // æ ‡é¢˜
            Text('é¢„è§ˆæ–°å¤´åƒ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .margin({ bottom: 20 })

            // é¢„è§ˆå¤´åƒæ˜¾ç¤ºåŒºåŸŸ
            Stack() {
              if (this.previewImage) {
                Image(this.previewImage)
                  .width(200)
                  .height(200)
                  .borderRadius(100)
                  .border({ width: 4, color: 'rgba(255,255,255,0.3)' })
                  .objectFit(ImageFit.Cover)
              } else {
                Column() {
                  LoadingProgress().width(50).height(50)
                  Text('æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...').fontSize(16).fontColor('#fff').margin({ top: 10 })
                }
                .width(200)
                .height(200)
                .justifyContent(FlexAlign.Center)
              }
            }
            .margin({ bottom: 20 })

            // æç¤ºæ–‡å­—
            Text('è¿™æ˜¯æ‚¨çš„æ–°å¤´åƒé¢„è§ˆï¼Œç¡®è®¤åå°†ä¿å­˜åˆ°æ‚¨çš„è´¦æˆ·')
              .fontSize(14)
              .fontColor('rgba(255,255,255,0.7)')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 20 })

            // æŒ‰é’®åŒºåŸŸ
            Row() {
              Button('é‡æ–°ç”Ÿæˆ')
                .width(100)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.1)')
                .fontColor('#fff')
                .borderRadius(22)
                .onClick(() => {
                  this.showPreviewDialog = false;
                  setTimeout(() => {
                    this.generatePreviewAvatar();
                  }, 300);
                })

              Button('ç¡®è®¤ä½¿ç”¨')
                .width(100)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.2)')
                .fontColor('#fff')
                .borderRadius(22)
                .margin({ left: 20 })
                .onClick(() => this.confirmPreviewAvatar())
            }
            .justifyContent(FlexAlign.Center)
          }
          .width('85%')
          .backgroundColor('rgba(0,0,0,0.8)')
          .borderRadius(20)
          .padding(24)
          .backdropBlur(20)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }
    }
  }
} 