import router from '@ohos.router';

// å‹åŠ›è¯„ä¼°é—®é¢˜æ¥å£
interface AssessmentQuestion {
  id: number;
  question: string;
  category: string;
  options: AssessmentOption[];
}

interface AssessmentOption {
  value: number;
  text: string;
  description: string;
}

// è¯„ä¼°ç»“æœæ¥å£
interface AssessmentResult {
  totalScore: number;
  stressLevel: 'low' | 'moderate' | 'high' | 'severe';
  levelName: string;
  levelColor: string;
  levelDescription: string;
  recommendations: string[];
  categoryScores: CategoryScore[];
}

interface CategoryScore {
  category: string;
  score: number;
  maxScore: number;
  percentage: number;
  description: string;
}

interface ScoreCount {
  score: number;
  count: number;
}

// è·¯ç”±å‚æ•°æ¥å£
interface RouterParams {
  toolName?: string;
  toolType?: string;
}

// å‹åŠ›è¯„ä¼°é—®é¢˜åº“
const ASSESSMENT_QUESTIONS: AssessmentQuestion[] = [
  {
    id: 1,
    question: 'æœ€è¿‘ä¸€å‘¨ï¼Œä½ æ„Ÿåˆ°ç´§å¼ æˆ–ç„¦è™‘çš„é¢‘ç‡å¦‚ä½•ï¼Ÿ',
    category: 'æƒ…ç»ªçŠ¶æ€',
    options: [
      { value: 1, text: 'å‡ ä¹æ²¡æœ‰', description: 'å¾ˆå°‘æ„Ÿåˆ°ç´§å¼ ' },
      { value: 2, text: 'å¶å°”', description: 'æœ‰æ—¶ä¼šæ„Ÿåˆ°ç´§å¼ ' },
      { value: 3, text: 'ç»å¸¸', description: 'ç»å¸¸æ„Ÿåˆ°ç´§å¼ ' },
      { value: 4, text: 'æ€»æ˜¯', description: 'å‡ ä¹æ€»æ˜¯ç´§å¼ ' }
    ]
  },
  {
    id: 2,
    question: 'ä½ çš„ç¡çœ è´¨é‡å¦‚ä½•ï¼Ÿ',
    category: 'ç¡çœ è´¨é‡',
    options: [
      { value: 1, text: 'å¾ˆå¥½', description: 'ç¡çœ è´¨é‡ä¼˜ç§€' },
      { value: 2, text: 'ä¸€èˆ¬', description: 'ç¡çœ è´¨é‡ä¸€èˆ¬' },
      { value: 3, text: 'è¾ƒå·®', description: 'ç»å¸¸å¤±çœ æˆ–è´¨é‡å·®' },
      { value: 4, text: 'å¾ˆå·®', description: 'ä¸¥é‡ç¡çœ é—®é¢˜' }
    ]
  },
  {
    id: 3,
    question: 'ä½ æ„Ÿåˆ°èº«ä½“ç–²åŠ³çš„ç¨‹åº¦å¦‚ä½•ï¼Ÿ',
    category: 'èº«ä½“çŠ¶æ€',
    options: [
      { value: 1, text: 'ç²¾åŠ›å……æ²›', description: 'æ„Ÿè§‰å¾ˆæœ‰æ´»åŠ›' },
      { value: 2, text: 'è½»å¾®ç–²åŠ³', description: 'å¶å°”æ„Ÿåˆ°ç–²åŠ³' },
      { value: 3, text: 'æ˜æ˜¾ç–²åŠ³', description: 'ç»å¸¸æ„Ÿåˆ°ç–²åŠ³' },
      { value: 4, text: 'æåº¦ç–²åŠ³', description: 'æ€»æ˜¯æ„Ÿåˆ°ç–²æƒ«' }
    ]
  },
  {
    id: 4,
    question: 'ä½ å¯¹æ—¥å¸¸å·¥ä½œçš„ä¸“æ³¨åº¦å¦‚ä½•ï¼Ÿ',
    category: 'å·¥ä½œçŠ¶æ€',
    options: [
      { value: 1, text: 'éå¸¸ä¸“æ³¨', description: 'èƒ½å¤Ÿå¾ˆå¥½é›†ä¸­æ³¨æ„åŠ›' },
      { value: 2, text: 'æ¯”è¾ƒä¸“æ³¨', description: 'å¤§éƒ¨åˆ†æ—¶é—´èƒ½ä¸“æ³¨' },
      { value: 3, text: 'å®¹æ˜“åˆ†å¿ƒ', description: 'ç»å¸¸éš¾ä»¥é›†ä¸­æ³¨æ„åŠ›' },
      { value: 4, text: 'å¾ˆéš¾ä¸“æ³¨', description: 'å‡ ä¹æ— æ³•é›†ä¸­æ³¨æ„åŠ›' }
    ]
  },
  {
    id: 5,
    question: 'ä½ çš„äººé™…å…³ç³»æ»¡æ„åº¦å¦‚ä½•ï¼Ÿ',
    category: 'ç¤¾äº¤å…³ç³»',
    options: [
      { value: 1, text: 'å¾ˆæ»¡æ„', description: 'äººé™…å…³ç³»è‰¯å¥½' },
      { value: 2, text: 'æ¯”è¾ƒæ»¡æ„', description: 'äººé™…å…³ç³»ä¸€èˆ¬' },
      { value: 3, text: 'ä¸å¤ªæ»¡æ„', description: 'äººé™…å…³ç³»æœ‰äº›é—®é¢˜' },
      { value: 4, text: 'å¾ˆä¸æ»¡æ„', description: 'äººé™…å…³ç³»ç´§å¼ ' }
    ]
  },
  {
    id: 6,
    question: 'ä½ æ„Ÿåˆ°å‹åŠ›çš„ä¸»è¦æ¥æºæ˜¯ä»€ä¹ˆï¼Ÿ',
    category: 'å‹åŠ›æº',
    options: [
      { value: 1, text: 'å‡ ä¹æ²¡æœ‰å‹åŠ›', description: 'ç”Ÿæ´»å‹åŠ›å¾ˆå°' },
      { value: 2, text: 'å·¥ä½œå‹åŠ›', description: 'ä¸»è¦æ¥è‡ªå·¥ä½œ' },
      { value: 3, text: 'ç”Ÿæ´»å‹åŠ›', description: 'æ¥è‡ªç”Ÿæ´»å„æ–¹é¢' },
      { value: 4, text: 'å¤šé‡å‹åŠ›', description: 'å¤šä¸ªæ–¹é¢éƒ½æœ‰å‹åŠ›' }
    ]
  },
  {
    id: 7,
    question: 'ä½ å¤„ç†å‹åŠ›çš„èƒ½åŠ›å¦‚ä½•ï¼Ÿ',
    category: 'åº”å¯¹èƒ½åŠ›',
    options: [
      { value: 1, text: 'å¾ˆå¼º', description: 'èƒ½å¤Ÿå¾ˆå¥½å¤„ç†å‹åŠ›' },
      { value: 2, text: 'è¾ƒå¼º', description: 'å¤§éƒ¨åˆ†å‹åŠ›èƒ½å¤„ç†' },
      { value: 3, text: 'ä¸€èˆ¬', description: 'å¤„ç†å‹åŠ›èƒ½åŠ›æœ‰é™' },
      { value: 4, text: 'è¾ƒå¼±', description: 'å¾ˆéš¾å¤„ç†å‹åŠ›' }
    ]
  },
  {
    id: 8,
    question: 'ä½ è¿›è¡Œæ”¾æ¾æ´»åŠ¨çš„é¢‘ç‡å¦‚ä½•ï¼Ÿ',
    category: 'æ”¾æ¾æ´»åŠ¨',
    options: [
      { value: 1, text: 'æ¯å¤©éƒ½æœ‰', description: 'ç»å¸¸è¿›è¡Œæ”¾æ¾æ´»åŠ¨' },
      { value: 2, text: 'æ¯å‘¨å‡ æ¬¡', description: 'å¶å°”è¿›è¡Œæ”¾æ¾æ´»åŠ¨' },
      { value: 3, text: 'å¾ˆå°‘', description: 'å¾ˆå°‘è¿›è¡Œæ”¾æ¾æ´»åŠ¨' },
      { value: 4, text: 'ä»ä¸', description: 'ä»ä¸è¿›è¡Œæ”¾æ¾æ´»åŠ¨' }
    ]
  }
];

@Entry
@Component
struct FMAssessmentPage {
  @State currentStep: 'welcome' | 'assessment' | 'result' = 'welcome';
  @State currentQuestionIndex: number = 0;
  @State answers: Map<number, number> = new Map();
  @State selectedOption: number = -1;
  @State assessmentResult: AssessmentResult | null = null;
  @State progress: number = 0;
  @State showProgress: boolean = false;
  @State resultOpacity: number = 0;
  @State resultScale: number = 0.8;
  
  // åŠ¨ç”»çŠ¶æ€
  @State questionOpacity: number = 1;
  @State questionTranslateX: number = 0;
  @State optionScale: number = 1;
  @State optionOpacity: number = 1;

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as RouterParams;
    if (params && params.toolType === 'assessment') {
      this.currentStep = 'welcome';
    }
  }

  // å¼€å§‹è¯„ä¼°
  private startAssessment() {
    this.currentStep = 'assessment';
    this.currentQuestionIndex = 0;
    this.answers.clear();
    this.selectedOption = -1;
    this.progress = (1 / ASSESSMENT_QUESTIONS.length) * 100;
    this.showProgress = false;
  }

  // é€‰æ‹©ç­”æ¡ˆ
  private selectOption(questionId: number, optionValue: number) {
    this.selectedOption = optionValue;
    
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    animateTo({ duration: 150, curve: Curve.EaseOut }, () => {
      this.optionScale = 0.95;
      this.optionOpacity = 0.8;
    });
    
    setTimeout(() => {
      this.answers.set(questionId, optionValue);
      this.nextQuestion();
    }, 200);
  }

  // ä¸‹ä¸€é¢˜
  private nextQuestion() {
    if (this.currentQuestionIndex < ASSESSMENT_QUESTIONS.length - 1) {
      // åˆ‡æ¢é¢˜ç›®åŠ¨ç”»
      animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
        this.questionOpacity = 0;
        this.questionTranslateX = -50;
      });
      
      setTimeout(() => {
        this.currentQuestionIndex++;
        this.selectedOption = -1;
        this.progress = ((this.currentQuestionIndex + 1) / ASSESSMENT_QUESTIONS.length) * 100;
        
        // é‡ç½®åŠ¨ç”»çŠ¶æ€
        this.questionTranslateX = 50;
        animateTo({ duration: 300, curve: Curve.EaseIn }, () => {
          this.questionOpacity = 1;
          this.questionTranslateX = 0;
          this.optionScale = 1;
          this.optionOpacity = 1;
        });
      }, 300);
    } else {
      // å®Œæˆè¯„ä¼°
      this.completeAssessment();
    }
  }

  // å®Œæˆè¯„ä¼°
  private completeAssessment() {
    this.showProgress = true;
    
    // æ¨¡æ‹Ÿè®¡ç®—è¿‡ç¨‹
    setTimeout(() => {
      this.calculateResult();
      this.currentStep = 'result';
      
      // ç»“æœå±•ç¤ºåŠ¨ç”»
      setTimeout(() => {
        animateTo({ duration: 600, curve: Curve.EaseOut }, () => {
          this.resultOpacity = 1;
          this.resultScale = 1;
        });
      }, 100);
    }, 2000);
  }

  // è®¡ç®—ç»“æœ
  private calculateResult() {
    let totalScore = 0;
    const categoryScores: Map<string, ScoreCount> = new Map();
    
    // è®¡ç®—æ€»åˆ†å’Œåˆ†ç±»åˆ†æ•°
    this.answers.forEach((value, questionId) => {
      totalScore += value;
      const question = ASSESSMENT_QUESTIONS.find(q => q.id === questionId);
      if (question) {
        const category = question.category;
        let current = categoryScores.get(category);
        if (!current) {
          current = { score: 0, count: 0 } as ScoreCount;
        }
        current.score += value;
        current.count += 1;
        categoryScores.set(category, current);
      }
    });

    // ç¡®å®šå‹åŠ›æ°´å¹³
    let stressLevel: 'low' | 'moderate' | 'high' | 'severe';
    let levelName: string;
    let levelColor: string;
    let levelDescription: string;
    let recommendations: string[];

    if (totalScore <= 12) {
      stressLevel = 'low';
      levelName = 'è½»åº¦å‹åŠ›';
      levelColor = '#4CAF50';
      levelDescription = 'ä½ çš„å‹åŠ›æ°´å¹³è¾ƒä½ï¼Œæ•´ä½“çŠ¶æ€è‰¯å¥½ã€‚ç»§ç»­ä¿æŒå¥åº·çš„ç”Ÿæ´»æ–¹å¼ã€‚';
      recommendations = [
        'ä¿æŒè§„å¾‹çš„ä½œæ¯æ—¶é—´',
        'ç»§ç»­ç°æœ‰çš„æ”¾æ¾æ´»åŠ¨',
        'å®šæœŸè¿›è¡Œè½»åº¦è¿åŠ¨',
        'ä¸æœ‹å‹å®¶äººä¿æŒè”ç³»'
      ];
    } else if (totalScore <= 20) {
      stressLevel = 'moderate';
      levelName = 'ä¸­åº¦å‹åŠ›';
      levelColor = '#FF9800';
      levelDescription = 'ä½ ç›®å‰å¤„äºä¸­åº¦å‹åŠ›çŠ¶æ€ï¼Œéœ€è¦é€‚å½“å…³æ³¨å’Œè°ƒèŠ‚ã€‚';
      recommendations = [
        'å­¦ä¹ å‹åŠ›ç®¡ç†æŠ€å·§',
        'å¢åŠ æ”¾æ¾æ´»åŠ¨æ—¶é—´',
        'æ”¹å–„ç¡çœ è´¨é‡',
        'å¯»æ±‚ç¤¾äº¤æ”¯æŒ'
      ];
    } else if (totalScore <= 28) {
      stressLevel = 'high';
      levelName = 'é«˜åº¦å‹åŠ›';
      levelColor = '#F44336';
      levelDescription = 'ä½ çš„å‹åŠ›æ°´å¹³è¾ƒé«˜ï¼Œå»ºè®®é‡‡å–ç§¯æçš„åº”å¯¹æªæ–½ã€‚';
      recommendations = [
        'è€ƒè™‘å¯»æ±‚ä¸“ä¸šå¿ƒç†å’¨è¯¢',
        'å­¦ä¹ å†¥æƒ³å’Œå‘¼å¸ç»ƒä¹ ',
        'è°ƒæ•´å·¥ä½œç”Ÿæ´»å¹³è¡¡',
        'å»ºç«‹å¥åº·çš„åº”å¯¹æœºåˆ¶'
      ];
    } else {
      stressLevel = 'severe';
      levelName = 'ä¸¥é‡å‹åŠ›';
      levelColor = '#9C27B0';
      levelDescription = 'ä½ çš„å‹åŠ›æ°´å¹³å¾ˆé«˜ï¼Œå¼ºçƒˆå»ºè®®å¯»æ±‚ä¸“ä¸šå¸®åŠ©ã€‚';
      recommendations = [
        'ç«‹å³å¯»æ±‚ä¸“ä¸šå¿ƒç†å’¨è¯¢å¸ˆå¸®åŠ©',
        'ä¸åŒ»ç”Ÿè®¨è®ºå‹åŠ›ç®¡ç†æ–¹æ¡ˆ',
        'è€ƒè™‘è°ƒæ•´å·¥ä½œæˆ–ç”Ÿæ´»ç¯å¢ƒ',
        'å­¦ä¹ ç´§æ€¥å‹åŠ›ç¼“è§£æŠ€å·§'
      ];
    }

    // æ„å»ºåˆ†ç±»åˆ†æ•°
    const categoryScoreArray: CategoryScore[] = [];
    categoryScores.forEach((value, category) => {
      const maxScore = value.count * 4;
      const percentage = (value.score / maxScore) * 100;
      let description = '';
      
      if (percentage <= 25) description = 'çŠ¶æ€è‰¯å¥½';
      else if (percentage <= 50) description = 'éœ€è¦å…³æ³¨';
      else if (percentage <= 75) description = 'éœ€è¦æ”¹å–„';
      else description = 'éœ€è¦é‡è§†';
      
      categoryScoreArray.push({
        category,
        score: value.score,
        maxScore,
        percentage,
        description
      });
    });

    this.assessmentResult = {
      totalScore,
      stressLevel,
      levelName,
      levelColor,
      levelDescription,
      recommendations,
      categoryScores: categoryScoreArray
    };
  }

  // é‡æ–°è¯„ä¼°
  private restartAssessment() {
    this.currentStep = 'welcome';
    this.currentQuestionIndex = 0;
    this.answers.clear();
    this.selectedOption = -1;
    this.assessmentResult = null;
    this.progress = 0;
    this.showProgress = false;
    this.resultOpacity = 0;
    this.resultScale = 0.8;
  }

  // è¿”å›é¦–é¡µ
  private goHome() {
    router.back();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Image($r('app.media.back'))
          .width(24)
          //.shadow({ radius: 4, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 2 })
          .onClick(() => router.back())
        Text('å‹åŠ›è¯„ä¼°')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
        Blank().width(36)
      }
      .width('100%')
      .padding({ top: 16, left: 12, right: 12, bottom: 12 })

      // å†…å®¹åŒºåŸŸ
      if (this.currentStep === 'welcome') {
        this.BuildWelcomeView();
      } else if (this.currentStep === 'assessment') {
        this.BuildAssessmentView();
      } else if (this.currentStep === 'result') {
        this.BuildResultView();
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .expandSafeArea([SafeAreaType.SYSTEM])
  }

  @Builder
  BuildWelcomeView() {
    Column() {
      // æ¬¢è¿å¡ç‰‡
      Column() {
        Text('ğŸ§ ')
          .fontSize(48)
          .margin({ bottom: 16 })
        Text('å‹åŠ›è¯„ä¼°')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1976D2')
          .margin({ bottom: 8 })
        Text('é€šè¿‡ä¸“ä¸šé‡è¡¨è¯„ä¼°ä½ çš„å‹åŠ›æ°´å¹³')
          .fontSize(16)
          .fontColor('#666')
          .textAlign(TextAlign.Center)
          .margin({ bottom: 24 })
        
        // è¯„ä¼°è¯´æ˜
        Column() {
          Row() {
            Text('ğŸ“‹')
              .fontSize(20)
              .margin({ right: 12 })
            Text('8ä¸ªä¸“ä¸šé—®é¢˜')
              .fontSize(16)
              .fontColor('#333')
          }
          .margin({ bottom: 12 })
          
          Row() {
            Text('â±ï¸')
              .fontSize(20)
              .margin({ right: 12 })
            Text('çº¦3-5åˆ†é’Ÿå®Œæˆ')
              .fontSize(16)
              .fontColor('#333')
          }
          .margin({ bottom: 12 })
          
          Row() {
            Text('ğŸ”’')
              .fontSize(20)
              .margin({ right: 12 })
            Text('éšç§ä¿æŠ¤ï¼Œæ•°æ®å®‰å…¨')
              .fontSize(16)
              .fontColor('#333')
          }
        }
        .margin({ bottom: 32 })
        
        Button('å¼€å§‹è¯„ä¼°')
          .width('100%')
          .height(48)
          .backgroundColor('#1976D2')
          .fontColor('#fff')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .borderRadius(24)
          .onClick(() => this.startAssessment())
      }
      .backgroundColor('#fff')
      .borderRadius(20)
      .padding(24)
      .margin({ top: 40, left: 16, right: 16 })
      .shadow({ radius: 12, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 4 })
    }
    .margin({top:80})
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  BuildAssessmentView() {
    Column() {
      // è¿›åº¦æ¡
      Row() {
        Progress({ value: this.progress, total: 100 })
          .width('80%')
          .height(6)
          .color('#1976D2')
          .backgroundColor('#e0e0e0')
          .borderRadius(3)
        Text(`${this.currentQuestionIndex + 1}/${ASSESSMENT_QUESTIONS.length}`)
          .fontSize(14)
          .fontColor('#666')
          .margin({ left: 12 })
      }
      .padding({ left: 16, right: 16, top: 16, bottom: 24 })
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)

      // é—®é¢˜å¡ç‰‡
      if (this.showProgress) {
        // è®¡ç®—è¿›åº¦æ˜¾ç¤º
        Column() {
          Text('æ­£åœ¨åˆ†æç»“æœ...')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1976D2')
            .margin({ bottom: 16 })
          Progress({ value: 50, total: 100 })
            .width(200)
            .height(8)
            .color('#1976D2')
            .backgroundColor('#e0e0e0')
            .borderRadius(4)
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        Column() {
          // é—®é¢˜æ ‡é¢˜
          Text(ASSESSMENT_QUESTIONS[this.currentQuestionIndex].category)
            .fontSize(14)
            .fontColor('#1976D2')
            .backgroundColor('#E3F2FD')
            .borderRadius(12)
            .padding({ left: 12, right: 12, top: 4, bottom: 4 })
            .margin({ bottom: 16 })
          
          // é—®é¢˜å†…å®¹
          Text(ASSESSMENT_QUESTIONS[this.currentQuestionIndex].question)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 32 })
            .opacity(this.questionOpacity)
            .translate({ x: this.questionTranslateX })

          // é€‰é¡¹åˆ—è¡¨
          ForEach(ASSESSMENT_QUESTIONS[this.currentQuestionIndex].options, (option: AssessmentOption, index: number) => {
            Row() {
              Column() {
                Text(option.text)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor(this.selectedOption === option.value ? '#fff' : '#333')
                  .margin({ bottom: 4 })
                Text(option.description)
                  .fontSize(14)
                  .fontColor(this.selectedOption === option.value ? '#fff' : '#666')
              }
              .layoutWeight(1)
            }
            .width('100%')
            .padding(16)
            .backgroundColor(this.selectedOption === option.value ? '#1976D2' : '#fff')
            .borderRadius(12)
            .border({ width: this.selectedOption === option.value ? 0 : 1, color: '#e0e0e0' })
            .margin({ bottom: 12 })
            .shadow({ radius: 4, color: 'rgba(0,0,0,0.05)', offsetX: 0, offsetY: 2 })
            .scale({ x: this.optionScale, y: this.optionScale })
            .opacity(this.optionOpacity)
            .onClick(() => this.selectOption(ASSESSMENT_QUESTIONS[this.currentQuestionIndex].id, option.value))
          }, (option: AssessmentOption) => `${this.currentQuestionIndex}-${option.value}`)
        }
        .backgroundColor('#fff')
        .borderRadius(20)
        .padding(24)
        .margin({ left: 16, right: 16 })
        .shadow({ radius: 12, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 4 })
      }
    }
    .layoutWeight(1)
  }

  @Builder
  BuildResultView() {
    if (this.assessmentResult) {
      Scroll() {
        Column() {
          // ç»“æœå¡ç‰‡
          Column() {
            // å‹åŠ›æ°´å¹³æŒ‡ç¤ºå™¨
            Column() {
              Text(this.assessmentResult.levelName)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.assessmentResult.levelColor)
                .margin({ bottom: 8 })
              
              Row() {
                ForEach([1, 2, 3, 4], (level: number) => {
                  Blank()
                    .width(40)
                    .height(8)
                    .backgroundColor(level <= this.getStressLevelNumber(this.assessmentResult!.stressLevel) ? 
                      this.assessmentResult!.levelColor : '#e0e0e0')
                    .borderRadius(4)
                    .margin({ right: 8 })
                }, (level: number) => level.toString())
              }
              .margin({ bottom: 16 })
              
              Text(`æ€»åˆ†ï¼š${this.assessmentResult.totalScore}/32`)
                .fontSize(16)
                .fontColor('#666')
            }
            .margin({ bottom: 24 })

            // æè¿°
            Text(this.assessmentResult.levelDescription)
              .fontSize(16)
              .fontColor('#333')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 24 })

            // åˆ†ç±»åˆ†æ•°
            Column() {
              Text('è¯¦ç»†åˆ†æ')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333')
                .margin({ bottom: 16 })

              ForEach(this.assessmentResult.categoryScores, (category: CategoryScore) => {
                Column() {
                  Row() {
                    Text(category.category)
                      .fontSize(16)
                      .fontColor('#333')
                      .layoutWeight(1)
                    Text(category.description)
                      .fontSize(14)
                      .fontColor(this.getCategoryColor(category.percentage))
                  }
                  .margin({ bottom: 8 })

                  Progress({ value: category.percentage, total: 100 })
                    .width('100%')
                    .height(6)
                    .color(this.getCategoryColor(category.percentage))
                    .backgroundColor('#e0e0e0')
                    .borderRadius(3)
                }
                .margin({ bottom: 16 })
              }, (category: CategoryScore) => category.category)
            }
            .margin({ bottom: 24 })

            // å»ºè®®
            Column() {
              Text('ä¸ªæ€§åŒ–å»ºè®®')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333')
                .margin({ bottom: 16 })

              ForEach(this.assessmentResult.recommendations, (recommendation: string, index: number) => {
                Row() {
                  Text(`${index + 1}.`)
                    .fontSize(16)
                    .fontColor('#1976D2')
                    .fontWeight(FontWeight.Bold)
                    .margin({ right: 8 })
                  Text(recommendation)
                    .fontSize(16)
                    .fontColor('#333')
                    .layoutWeight(1)
                }
                .margin({ bottom: 12 })
              }, (recommendation: string) => recommendation)
            }
          }
          .backgroundColor('#fff')
          .borderRadius(20)
          .padding(24)
          .margin({ top: 16, left: 16, right: 16, bottom: 16 })
          .shadow({ radius: 12, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 4 })
          .opacity(this.resultOpacity)
          .scale({ x: this.resultScale, y: this.resultScale })

          // æ“ä½œæŒ‰é’®
          Row() {
            Button('é‡æ–°è¯„ä¼°')
              .layoutWeight(1)
              .height(48)
              .backgroundColor('#fff')
              .fontColor('#1976D2')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .borderRadius(24)
              .border({ width: 1, color: '#1976D2' })
              .margin({ right: 8 })
              .onClick(() => this.restartAssessment())

            Button('è¿”å›é¦–é¡µ')
              .layoutWeight(1)
              .height(48)
              .backgroundColor('#1976D2')
              .fontColor('#fff')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .borderRadius(24)
              .margin({ left: 8 })
              .onClick(() => this.goHome())
          }
          .padding({ left: 16, right: 16, bottom: 32 })
        }
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
  }

  // è·å–å‹åŠ›æ°´å¹³æ•°å­—
  private getStressLevelNumber(level: string): number {
    switch (level) {
      case 'low': return 1;
      case 'moderate': return 2;
      case 'high': return 3;
      case 'severe': return 4;
      default: return 1;
    }
  }

  // è·å–åˆ†ç±»é¢œè‰²
  private getCategoryColor(percentage: number): string {
    if (percentage <= 25) return '#4CAF50';
    if (percentage <= 50) return '#FF9800';
    if (percentage <= 75) return '#F44336';
    return '#9C27B0';
  }
} 