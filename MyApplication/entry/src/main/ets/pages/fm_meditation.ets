import router from '@ohos.router';

@Entry
@Component
struct FMMeditationPage {
  @State currentCard: number = 0
  @State cardOpacity: number = 1.0
  @State cardTranslateX: number = 0
  private themes: string[] = ['åŸºç¡€å†¥æƒ³', 'å‘¼å¸è§‰å¯Ÿ', 'èº«ä½“æ‰«æ', 'ç¡å‰æ”¾æ¾'];
  private themeDesc: string[] = [
    'é€‚åˆæ–°æ‰‹çš„åŸºç¡€å†¥æƒ³ï¼Œå¸®åŠ©ä½ å¿«é€Ÿè¿›å…¥çŠ¶æ€',
    'ä¸“æ³¨å‘¼å¸ï¼Œç¼“è§£ç„¦è™‘ä¸å‹åŠ›',
    'å…³æ³¨èº«ä½“æ„Ÿå—ï¼Œé‡Šæ”¾ç´§å¼ ',
    'åŠ©çœ å†¥æƒ³ï¼Œæ”¾æ¾èº«å¿ƒï¼Œå®‰ç„¶å…¥ç¡'
  ];
  private themeEmoji: string[] = ['ğŸ§˜â€â™‚ï¸', 'ğŸŒ¬ï¸', 'ğŸ›Œ', 'ğŸ˜´'];
  @State isPlaying: boolean = false;
  @State progress: number = 0.0;
  private timer: number = -1;
  private duration: number = 300; // 5åˆ†é’Ÿ
  private bgms: string[] = ['è‡ªç„¶é£', 'æµ·æµªå£°', 'é’¢ç´æ›²', 'æ— '];
  @State selectedBgm: number = 0;

  aboutToDisappear() {
    this.stopPlay();
  }

  private startPlay() {
    this.isPlaying = true;
    this.stopPlay();
    this.timer = setInterval(() => {
      if (this.progress < 1.0) {
        this.progress += 1 / this.duration;
      } else {
        this.stopPlay();
      }
    }, 1000);
  }

  private stopPlay() {
    if (this.timer !== -1) {
      clearInterval(this.timer);
      this.timer = -1;
    }
    this.isPlaying = false;
  }

  // åˆ‡æ¢å¡ç‰‡åŠ¨ç”»
  private switchCard(direction: 'left' | 'right') {
    animateTo({ duration: 200, curve: Curve.EaseOut }, () => {
      this.cardOpacity = 0;
      this.cardTranslateX = direction === 'left' ? -20 : 20;
    })
    setTimeout(() => {
      if (direction === 'left') {
        this.currentCard = (this.currentCard - 1 + this.themes.length) % this.themes.length;
      } else {
        this.currentCard = (this.currentCard + 1) % this.themes.length;
      }
      this.cardTranslateX = direction === 'left' ? 20 : -20;
      animateTo({ duration: 200, curve: Curve.EaseIn }, () => {
        this.cardOpacity = 1.0;
        this.cardTranslateX = 0;
      })
    }, 200)
  }

  private setCard(idx: number) {
    if (idx === this.currentCard) return;
    const direction = idx > this.currentCard ? 'right' : 'left';
    this.switchCard(direction);
  }

  build() {
    Column() {
      // è¿”å›æŒ‰é’®ï¼ˆæ‚¬æµ®å·¦ä¸Šè§’ï¼‰
      Row() {
        Button('<')
          .fontSize(20)
          .width(36)
          .height(36)
          .backgroundColor('#fff')
          .fontColor('#1976D2')
          .borderRadius(18)
          .shadow({ radius: 4, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 2 })
          .onClick(() => router.back())
      }
      .position({ x: 12, y: 8 })

      // é¡¶éƒ¨å¯åˆ‡æ¢å†¥æƒ³ä¸»é¢˜å¡ç‰‡
      Column() {
        Blank().height(15)
        Stack() {
          Stack() {
            // å¡ç‰‡å†…å®¹
            Column() {
              Row() {
                // å·¦ä¾§åˆ‡æ¢æŒ‰é’®
                Button('â€¹')
                  .fontSize(24)
                  .fontColor('#1976D2')
                  .backgroundColor('#E3F2FD')
                  .borderRadius(20)
                  .width(40)
                  .height(40)
                  .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 2 })
                  .onClick(() => this.switchCard('left'))
                // å¡ç‰‡å†…å®¹
                Column() {
                  Row() {
                    Text(this.themeEmoji[this.currentCard])
                      .fontSize(36)
                      .margin({ right: 12 })
                    Column() {
                      Text(this.themes[this.currentCard])
                        .fontSize(20)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#1976D2')
                      Text(this.themeDesc[this.currentCard])
                        .fontSize(15)
                        .fontColor('#1976D2')
                        .opacity(0.8)
                    }
                    .layoutWeight(1)
                  }
                  .margin({ bottom: 8 })
                  Text('5åˆ†é’Ÿæ­£å¿µå†¥æƒ³ï¼Œæ”¾æ¾èº«å¿ƒ')
                    .fontSize(13)
                    .fontColor('#1976D2')
                    .opacity(0.7)
                    .textAlign(TextAlign.Start)
                }
                .layoutWeight(1)
                .margin({ left: 16, right: 16 })
                // å³ä¾§åˆ‡æ¢æŒ‰é’®
                Button('â€º')
                  .fontSize(24)
                  .fontColor('#1976D2')
                  .backgroundColor('#E3F2FD')
                  .borderRadius(20)
                  .width(40)
                  .height(40)
                  .shadow({ radius: 4, color: 'rgba(0,0,0,0.1)', offsetX: 0, offsetY: 2 })
                  .onClick(() => this.switchCard('right'))
              }
              .width('100%')
              .alignItems(VerticalAlign.Center)
            }
            .backgroundColor('#E3F2FD')
            .borderRadius(16)
            .padding(20)
            .width('100%')
            .height(120)
            .opacity(this.cardOpacity)
            .translate({ x: this.cardTranslateX, y: 0 })
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.13)', offsetX: 0, offsetY: 4 })
          }
          // æŒ‡ç¤ºç‚¹
          Row() {
            Row() {
              ForEach(this.themes, (theme: string, idx: number) => {
                Blank()
                  .width(idx === this.currentCard ? 24 : 8)
                  .height(8)
                  .backgroundColor(idx === this.currentCard ? '#1976D2' : '#eee')
                  .borderRadius(4)
                  .margin({ right: 4 })
                  .animation({ duration: 300, curve: Curve.EaseInOut })
                  .onClick(() => { if (idx !== this.currentCard) this.setCard(idx) })
              }, (theme: string) => theme)
            }
            .layoutWeight(1)
          }
          .margin({ top: 12, bottom: 8 })
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)
        }
        .width('100%')
      }
      .width('100%')
      .height(200)
      .padding({ left: 0, right: 0, bottom: 0 })

      // ä»Šæ—¥å†¥æƒ³ç»Ÿè®¡
      Row() {
        Column() {
          Text('ç´¯è®¡å†¥æƒ³')
            .fontColor('#888').fontSize(13)
          Text('32 åˆ†é’Ÿ') // å¯åç»­åŠ¨æ€
            .fontColor('#1976D2').fontWeight(FontWeight.Bold).fontSize(18)
        }
        .margin({ right: 32 })
      }
      .width('100%')
      .margin({ bottom: 12 })

      // æ¸å˜åˆ†å‰²çº¿
      Rect().width('100%').height(2).backgroundColor('#E3F2FD').margin({ bottom: 16 })

      // å†¥æƒ³å¼•å¯¼è¯­åŒºåŠ æ’ç”»
      Row() {
        Image($r('app.media.fmhome_softMusic'))
          .width(56).height(56).borderRadius(16).margin({ right: 12 })
        Column() {
          Text('è¯·æ‰¾ä¸€ä¸ªå®‰é™èˆ’é€‚çš„ä½ç½®ï¼Œé—­ä¸Šçœ¼ç›ï¼Œè·Ÿéšå¼•å¯¼è¯­è¿›è¡Œå†¥æƒ³ã€‚')
            .fontColor('#388E3C')
            .fontSize(15)
            .margin({ bottom: 2 })
          Text('æ”¾æ¾èº«ä½“ï¼Œæ„Ÿå—æ¯ä¸€æ¬¡å‘¼å¸ã€‚')
            .fontColor('#888')
            .fontSize(13)
        }
      }
      .width('100%')
      .margin({ bottom: 20 })

      // æ’­æ”¾/æš‚åœæŒ‰é’®ä¸è¿›åº¦æ¡
      Row() {
        Button(this.isPlaying ? 'æš‚åœ' : 'å¼€å§‹')
          .fontColor('#fff')
          .backgroundColor('#4CAF50')
          .borderRadius(24)
          .fontSize(20)
          .padding({ left: 40, right: 40, top: 14, bottom: 14 })
          .onClick(() => {
            if (this.isPlaying) {
              this.stopPlay();
            } else {
              this.startPlay();
            }
          })
        Text(Math.floor(this.progress * this.duration) + 's / ' + this.duration + 's')
          .fontColor('#888')
          .fontSize(14)
          .margin({ left: 18 })
      }
      .margin({ bottom: 8 })
      // è¿›åº¦æ¡
      Progress({ value: this.progress })
        .width('85%')
        .color('#4CAF50')
        .backgroundColor('#E0E0E0')
        .margin({ bottom: 24 })
        .borderRadius(8)

      // èƒŒæ™¯éŸ³ä¹é€‰æ‹©åŒºç¾åŒ–
      Text('èƒŒæ™¯éŸ³ä¹')
        .fontSize(15)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1976D2')
        .margin({ bottom: 8 })
      Row() {
        ForEach(this.bgms, (bgm: string, idx: number) => {
          Row() {
            Text(
              bgm === 'è‡ªç„¶é£' ? 'ğŸƒ' : bgm === 'æµ·æµªå£°' ? 'ğŸŒŠ' : bgm === 'é’¢ç´æ›²' ? 'ğŸ¹' : 'ğŸ”‡'
            ).fontSize(18).margin({ right: 4 })
            Text(bgm).fontSize(13)
              .fontColor(this.selectedBgm === idx ? '#fff' : '#1976D2')
          }

          .backgroundColor(this.selectedBgm === idx ? '#1976D2' : '#E3F2FD')
          .borderRadius(16)
          .padding({ left: 14, right: 14, top: 6, bottom: 6 })
          .margin({ right: 10 })
          .onClick(() => this.selectedBgm = idx)
        }, (bgm: string) => bgm)
      }
      .margin({ bottom: 24 })

      // æ¸©é¦¨æç¤ºåŒºç¾åŒ–
      Row() {
        Text('ğŸ’¡').fontSize(18).margin({ right: 8 })
        Text('æ¸©é¦¨æç¤ºï¼šå†¥æƒ³è¿‡ç¨‹ä¸­å¦‚æœ‰æ‚å¿µï¼Œä¸å¿…ç„¦è™‘ï¼Œè½»è½»å°†æ³¨æ„åŠ›å¸¦å›å‘¼å¸å³å¯ã€‚')
          .fontColor('#888')
          .fontSize(13)
      }
      .backgroundColor('#F5F7FA')
      .borderRadius(12)
      .padding({ left: 16, right: 16, top: 10, bottom: 10 })
      .margin({ bottom: 32 })
    }
    .width('100%')
    .padding({ left: 20, right: 20, top: 0 })
    .backgroundColor('#F8F9FB')
  }
} 
