import { BusinessError } from '@kit.BasicServicesKit';
import { globalUserData } from '../models/userdata';
import { ApiService } from '../service/apiservice';
import { UserInfo, SearchUserResult } from '../common/types';
import promptAction from '@ohos.promptAction';
import { Config } from '../common/config';

@Entry
@Component
export struct SearchPage {
  @State searchText: string = ''; // æœç´¢æ–‡æœ¬
  @State isSearching: boolean = false; // æœç´¢çŠ¶æ€
  @State searchResult: SearchUserResult | null = null; // æœç´¢ç»“æœ
  @State hasSearched: boolean = false; // æ˜¯å¦å·²ç»æœç´¢è¿‡

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    console.log('ğŸš€ SearchPage é¡µé¢å¼€å§‹åŠ è½½');
    console.log('ğŸš€ å½“å‰APIåœ°å€:', Config.getApiBaseUrl());
  }

  // æœç´¢åŠŸèƒ½
  async performSearch() {
    if (this.searchText.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥UIDä»¥æŸ¥è¯¢ç”¨æˆ·' });
      return;
    }
    
    this.isSearching = true;
    this.hasSearched = true;
    
    try {
      promptAction.showToast({ message: `æ­£åœ¨æœç´¢ç”¨æˆ·: ${this.searchText}` });
      
      const result = await ApiService.searchUser(this.searchText.trim());
      
      if (result) {
        // å¤„ç†å¤´åƒURLæ‹¼æ¥
        if (result.userAvatar && result.userAvatar.startsWith('/')) {
          const apiBaseUrl = Config.getApiBaseUrl();
          const serverBaseUrl = apiBaseUrl.replace('/api', ''); // ç§»é™¤APIè·¯å¾„
          
          // æ£€æŸ¥å¹¶ä¿®æ­£é”™è¯¯çš„è·¯å¾„
          let correctedAvatarUrl = result.userAvatar;
          if (result.userAvatar.startsWith('/images/')) {
            console.log('ğŸ” [SearchPage] æ£€æµ‹åˆ°é”™è¯¯çš„/images/è·¯å¾„ï¼Œä¿®æ­£ä¸º/avatars/');
            correctedAvatarUrl = result.userAvatar.replace('/images/', '/avatars/');
          }
          
          const fullAvatarUrl = serverBaseUrl + correctedAvatarUrl;
          console.log('ğŸ” [SearchPage] æ‹¼æ¥åçš„å®Œæ•´å¤´åƒURL:', fullAvatarUrl);
          result.userAvatar = fullAvatarUrl;
        }
        
        this.searchResult = result;
        promptAction.showToast({ message: `æ‰¾åˆ°ç”¨æˆ·: ${result.userName}` });
      } else {
        this.searchResult = null;
        promptAction.showToast({ message: 'æœªæ‰¾åˆ°è¯¥ç”¨æˆ·' });
      }
    } catch (error) {
      console.error('æœç´¢å¤±è´¥:', error);
      promptAction.showToast({ message: `æœç´¢å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}` });
      this.searchResult = null;
    } finally {
      this.isSearching = false;
    }
  }

  // å…³æ³¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  onFollowClick() {
    promptAction.showToast({ message: 'å…³æ³¨åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­' });
  }

  // æŸ¥çœ‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  onViewClick() {
    promptAction.showToast({ message: 'æŸ¥çœ‹åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­' });
  }

  build() {
    Stack() {
      // æ¸å˜èƒŒæ™¯ - ä¸yourpageä¿æŒä¸€è‡´
      Column() {
        Blank().width('100%').height('100%')
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [['#1a1a2e', 0.0], ['#16213e', 0.3], ['#0f3460', 0.7], ['#533483', 1.0]]
          })
      }
      .width('100%')
      .height('100%')
      
      // è£…é¥°æ€§èƒŒæ™¯å…ƒç´  - ä¸yourpageä¿æŒä¸€è‡´
      Column() {
        // é¡¶éƒ¨è£…é¥°å…ƒç´ 
        Row() {
          Image($r('app.media.deroration_1'))
            .width(200)
            .height(200)
            .opacity(0.1)
            .position({ x: -100, y: -50 })
          Image($r('app.media.deroration_2'))
            .width(150)
            .height(150)
            .opacity(0.08)
            .position({ x: 300, y: -30 })
        }
        .width('100%')
        .height(60)
        
        Blank().layoutWeight(1)
        
        // åº•éƒ¨è£…é¥°å…ƒç´ 
        Row() {
          Image($r('app.media.deroration_3'))
            .width(180)
            .height(180)
            .opacity(0.08)
            .position({ x: -80, y: 20 })
          Image($r('app.media.deroration_4'))
            .width(120)
            .height(120)
            .opacity(0.1)
            .position({ x: 320, y: 40 })
        }
        .width('100%')
        .height(80)
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(1)
      
      // ä¸»ä½“å†…å®¹
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          // è¿”å›æŒ‰é’®
          Button() {
            Image($r('app.media.return'))
              .width(24)
              .height(24)
              .fillColor('#fff')
          }
          .width(40)
          .height(40)
          .backgroundColor('rgba(128,128,128,0)')
          .borderRadius(20)
          .margin({ left: 16 })
          .onClick(() => {
            let uiContext: UIContext = this.getUIContext();
            let router = uiContext.getRouter();
            router.back();
          })
          
          // é¡µé¢æ ‡é¢˜
          Text('æŸ¥æ‰¾')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#fff')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
            .margin({ right: 56 }) // ä¸ºè¿”å›æŒ‰é’®ç•™å‡ºç©ºé—´
        }
        .width('100%')
        .height(60)
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        
        // æœç´¢æ 
        Column() {
          Row() {
            // æœç´¢è¾“å…¥æ¡†
            TextInput({ placeholder: 'è¯·è¾“å…¥UIDä»¥æŸ¥è¯¢ç”¨æˆ·', text: this.searchText })
              .width('85%')
              .height(48)
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(24)
              .padding({ left: 20, right: 20 })
              .fontSize(16)
              .fontColor('#fff')
              .placeholderColor('rgba(255,255,255,0.5)')
              .onChange((value: string) => {
                this.searchText = value;
              })
              .onSubmit(() => {
                this.performSearch();
              })
            
            // æœç´¢æŒ‰é’®
            Button() {
              if (this.isSearching) {
                LoadingProgress()
                  .width(20)
                  .height(20)
                  .color('#fff')
              } else {
                Text('â†’')
                  .fontSize(20)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#fff')
              }
            }
            .width(48)
            .height(48)
            .backgroundColor('rgba(128,128,128,0.3)')
            .borderRadius(24)
            .margin({ left: 12 })
            .onClick(() => {
              this.performSearch();
            })
          }
          .width('90%')
          
          // æç¤ºæ–‡å­—
          Text('è¯·è¾“å…¥UIDä»¥æŸ¥è¯¢ç”¨æˆ·')
            .fontSize(12)
            .fontColor('rgba(255,255,255,0.6)')
            .textAlign(TextAlign.Start)
            .margin({ top: 8, left: '5%' })
        }
        .margin({ top: 20, bottom: 20 })
        
        // æœç´¢ç»“æœæ˜¾ç¤ºåŒºåŸŸ
        Column() {
          if (this.isSearching) {
            // æœç´¢ä¸­çŠ¶æ€
            Column() {
              LoadingProgress()
                .width(40)
                .height(40)
                .color('#fff')
              Text('æœç´¢ä¸­...')
                .fontSize(16)
                .fontColor('rgba(255,255,255,0.8)')
                .margin({ top: 16 })
            }
            .width('100%')
            .height(200)
            .justifyContent(FlexAlign.Center)
          } else if (this.hasSearched) {
            // æœç´¢ç»“æœ
            if (this.searchResult) {
              // æ‰¾åˆ°ç”¨æˆ·
              Column() {
                Text('æœç´¢ç»“æœ')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#fff')
                  .margin({ bottom: 16 })
                
                // ç”¨æˆ·å¡ç‰‡
                Row() {
                  // å·¦ä¾§ï¼šå¤´åƒ+ç”¨æˆ·å+UID å‚ç›´æ’åˆ—
                  Column() {
                    // å¤´åƒ
                    Image(this.searchResult.userAvatar || $r('app.media.image'))
                      .width(60)
                      .height(60)
                      .borderRadius(30)
                      .backgroundColor('rgba(255,255,255,0.1)')
                      .border({ width: 2, color: 'rgba(255,255,255,0.3)' })
                      .margin({ bottom: 8 })
                    
                    // ç”¨æˆ·å
                    Text(this.searchResult.userName)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#fff')
                      .textAlign(TextAlign.Center)
                      .margin({ bottom: 4 })
                    
                    // UID
                    Text(`UID: ${this.searchResult.userUID}`)
                      .fontSize(12)
                      .fontColor('rgba(255,255,255,0.6)')
                      .textAlign(TextAlign.Center)
                  }
                  .alignItems(HorizontalAlign.Center)
                  .layoutWeight(1)
                  
                  // å³ä¾§ï¼šæŒ‰é’®å‚ç›´æ’åˆ—
                  Column() {
                    Button('å…³æ³¨')
                      .width(60)
                      .height(32)
                      .fontSize(12)
                      .backgroundColor('rgba(128,128,128,0.3)')
                      .fontColor('#fff')
                      .borderRadius(16)
                      .margin({ bottom: 8 })
                      .onClick(() => {
                        this.onFollowClick();
                      })
                    
                    Button('æŸ¥çœ‹')
                      .width(60)
                      .height(32)
                      .fontSize(12)
                      .backgroundColor('rgba(128,128,128,0.3)')
                      .fontColor('#fff')
                      .borderRadius(16)
                      .onClick(() => {
                        this.onViewClick();
                      })
                  }
                  .alignItems(HorizontalAlign.Center)
                  .justifyContent(FlexAlign.Center)
                }
                .width('100%')
                .padding(16)
                .backgroundColor('rgba(255,255,255,0.08)')
                .borderRadius(16)
                .border({ width: 1, color: 'rgba(255,255,255,0.1)' })
              }
              .width('90%')
            } else {
              // æœªæ‰¾åˆ°ç”¨æˆ·
              Column() {
                Image($r('app.media.menu_icon'))
                  .width(80)
                  .height(80)
                  .opacity(0.3)
                  .margin({ bottom: 16 })
                Text('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·')
                  .fontSize(16)
                  .fontColor('rgba(255,255,255,0.5)')
                  .textAlign(TextAlign.Center)
                Text('è¯·æ£€æŸ¥UIDæ˜¯å¦æ­£ç¡®')
                  .fontSize(14)
                  .fontColor('rgba(255,255,255,0.4)')
                  .textAlign(TextAlign.Center)
                  .margin({ top: 8 })
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
            }
          } else {
            // é»˜è®¤çŠ¶æ€
            Column() {
              Image($r('app.media.menu_icon'))
                .width(80)
                .height(80)
                .opacity(0.3)
                .margin({ bottom: 16 })
              Text('è¾“å…¥UIDå¼€å§‹æœç´¢')
                .fontSize(16)
                .fontColor('rgba(255,255,255,0.5)')
                .textAlign(TextAlign.Center)
            }
            .width('100%')
            .height(200)
            .justifyContent(FlexAlign.Center)
          }
        }
        .width('90%')
        .layoutWeight(1)
        .backgroundColor('rgba(255,255,255,0.05)')
        .borderRadius(16)
        .padding(20)
        
        // åº•éƒ¨ç©ºç™½
        Blank()
          .height(40)
      }
      .width('100%')
      .height('100%')
      .zIndex(2)
    }
  }
} 