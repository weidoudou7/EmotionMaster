import { BottomNavBar } from './BottomNavBar';
import router from '@ohos.router';

interface ChatMessage {
  id: number;
  isMe: boolean; // æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯
  avatar: Resource; // å¤´åƒèµ„æº
  content: string; // æ¶ˆæ¯å†…å®¹
  time: string; // å‘é€æ—¶é—´
  type?: 'text' | 'voice'; // æ–°å¢æ¶ˆæ¯ç±»å‹
  duration?: number; // è¯­éŸ³æ—¶é•¿ï¼Œå•ä½ç§’
}

@Entry
@Component
struct Chat {
  @State private chatData: ChatMessage[] = [
    // æ¨¡æ‹Ÿå›¾ç‰‡ä¸­çš„æ¶ˆæ¯æ•°æ®
    { id: 1, isMe: false, avatar: $r('app.media.splash'), content: 'ç®€ä»‹ å°é»„ï¼šå¬è¯´ç­é‡Œä¼šæ¥2ä¸ªæ–°åŒå­¦ã€‚å°é»‘ï¼šè°çŸ¥é“å‘¢ï¼Œå¸Œæœ›ä¸ä¼šæ¥ä¸€ä¸ªç»¿èŒ¶ã€‚ï¼ˆå°è“çœ‹ä¹¦ï¼‰å°ç²‰ï¼šå¸Œæœ›ä¼šæ¥ä¸€ä¸ªå¥³å­©å­å§ï¼è¿™æ ·æˆ‘åˆèƒ½å¤šå¥½æœ‹å‹ã€‚å°çº¢ï¼šä¸æ‰“æˆ‘å¦¹å¦¹ğŸ˜€å°±è¡Œã€‚ï¼ˆå°ç»¿ç¡è§‰ï¼‰è¿™æ—¶èŒ¶èŒ¶èµ°è¿›äº†è¿›æ¥ï¼‰å¤§å®¶å¥½~æˆ‘å«èŒ¶èŒ¶ã€‚ï¼ˆå…¶ä»–äººéƒ½è¦åäº†', time: '10:30' }, // TODO: æ›¿æ¢ä¸ºå®é™…çš„ user_avatar å›¾ç‰‡èµ„æº
    { id: 2, isMe: false, avatar: $r('app.media.splash'), content: '16\"\n(å°é»„) å¬è¯´ç­é‡Œä¼šæ¥2ä¸ªæ–°åŒå­¦ã€‚\n(å°é»‘) è°çŸ¥é“å‘¢ï¼Œå¸Œæœ›ä¸ä¼šæ¥ä¸€ä¸ªç»¿èŒ¶ã€‚\n(å°è“çœ‹ä¹¦) (å°ç²‰) å¸Œæœ›ä¼šæ¥ä¸€ä¸ªå¥³å­©å­å§ï¼è¿™æ ·æˆ‘åˆ\nèƒ½å¤šå¥½æœ‹å‹ã€‚(å°çº¢) ä¸æ‰“æˆ‘å¦¹å¦¹ğŸ˜€\nå°±è¡Œã€‚(å°ç»¿ç¡è§‰) (è¿™æ—¶èŒ¶èŒ¶èµ°\näº†è¿›æ¥) å¤§å®¶å¥½~æˆ‘å«èŒ¶èŒ¶ã€‚(å…¶\nä»–äººéƒ½å‘•åäº†', time: '10:32', type: 'voice', duration: 16 }, // TODO: æ›¿æ¢ä¸ºå®é™…çš„ user_avatar å›¾ç‰‡èµ„æº
    { id: 3, isMe: true, avatar: $r('app.media.splash'), content: 'å¥½çš„ï¼Œæ”¶åˆ°ï¼', time: '10:33' }, // TODO: æ›¿æ¢ä¸ºå®é™…çš„ my_avatar å›¾ç‰‡èµ„æº
  ];

  @State private inputText: string = '';
  @State private bgImage: Resource = $r('app.media.planet1'); // TODO: æ›¿æ¢ä¸ºå®é™…çš„ chat_bg å›¾ç‰‡èµ„æº
  @State private agentName: string = 'å…­å°åª (æœ‰...'; // æ™ºèƒ½ä½“æ˜µç§°
  @State private agentSubInfo: string = '5.7ä¸‡ è¿æ¥è€…'; // æ™ºèƒ½ä½“å‰¯ä¿¡æ¯
  @State private agentAvatar: Resource = $r('app.media.splash'); // TODO: æ›¿æ¢ä¸ºå®é™…çš„ agent_avatar å›¾ç‰‡èµ„æº

  @State private scrollOffset: number = 0; // æ»šåŠ¨åç§»é‡
  @State private isHeaderCompact: boolean = false; // é¡¶éƒ¨æ æ˜¯å¦ç´§å‡‘

  private sendMessage() {
    if (this.inputText.trim() === '') return;

    const newMessage: ChatMessage = {
      id: this.chatData.length + 1,
      isMe: true,
      avatar: $r('app.media.splash'), // TODO: æ›¿æ¢ä¸ºå®é™…çš„ my_avatar å›¾ç‰‡èµ„æº
      content: this.inputText,
      time: new Date().toLocaleTimeString().slice(0, 5) // è·å–å½“å‰æ—¶é—´ï¼ˆå¦‚ "14:20"ï¼‰
    };

    this.chatData = [...this.chatData, newMessage];
    this.inputText = ''; // æ¸…ç©ºè¾“å…¥æ¡†
  }

  build() {
    Stack() {
      // å…¨å±èƒŒæ™¯å›¾ç‰‡ (Z-index: 0)
      Image(this.bgImage)
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)
        .position({ x: 0, y: 0 })
        .zIndex(0)
        .align(Alignment.TopStart) // ç¡®ä¿å›¾ç‰‡ä»å·¦ä¸Šè§’å¼€å§‹å¡«å……
        .expandSafeArea([SafeAreaType.SYSTEM],[SafeAreaEdge.TOP,SafeAreaEdge.BOTTOM])

      Column() {
        // é¡¶éƒ¨ä¿¡æ¯æ  (Z-index: 1)
        Row() {
          // å·¦ä¾§ï¼šæ™ºèƒ½ä½“å¤´åƒå’Œåç§°/è¿æ¥è€…ä¿¡æ¯
          Row() {
            Image(this.agentAvatar)
              .width(this.isHeaderCompact ? 24 : 30).height(this.isHeaderCompact ? 24 : 30).borderRadius(this.isHeaderCompact ? 12 : 24)
              .margin({ right: this.isHeaderCompact ? 4 : 6 })

            Column() {
              Text(this.agentName)
                .fontSize(this.isHeaderCompact ? 12 : 14).fontWeight(FontWeight.Bold).fontColor(Color.White)
                .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
              Text(this.agentSubInfo)
                .fontSize(this.isHeaderCompact ? 8 : 10).fontColor(Color.White).opacity(this.isHeaderCompact ? 0.5 : 0.8)
            }
            .alignItems(HorizontalAlign.Start)


            Image($r('app.media.plus_icon')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ plus_icon å›¾ç‰‡èµ„æº
              .width(this.isHeaderCompact ? 18 : 25).height(this.isHeaderCompact ? 18 : 25) // ç¼©å°å›¾ç‰‡


          }
          .alignItems(VerticalAlign.Center)
          .padding(this.isHeaderCompact ? { left: 2, right: 5, top: 2, bottom: 2 } : { left: 2, right: 10, top: 5, bottom: 5 })
          .borderRadius(this.isHeaderCompact ? 24 : 35)
          .backgroundColor('rgba(255,255,255,0.2)')


          Button() {
            Row() {
              Image($r('app.media.message_icon')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ message_icon å›¾ç‰‡èµ„æº
                .width(this.isHeaderCompact ? 16 : 18).height(this.isHeaderCompact ? 16 : 18).margin({ right: 4 }) // ç¼©å°å›¾ç‰‡
            }
            .alignItems(VerticalAlign.Center)
            .height('100%')
          }
          .height(this.isHeaderCompact ? 28 : 32).borderRadius(this.isHeaderCompact ? 14 : 16) // ç¼©å°æŒ‰é’®é«˜åº¦
          .backgroundColor('rgba(255,255,255,0.2)')
          .padding(this.isHeaderCompact ? { left: 6, right: 4 } : { left: 8, right: 6})
          .margin({ left: this.isHeaderCompact ? 6 : 8 }) // è°ƒæ•´ä¸ºå·¦ä¾§é—´è·

          Blank() // å æ®å‰©ä½™ç©ºé—´ï¼Œå°†å³ä¾§æŒ‰é’®æ¨åˆ°æœ€å³è¾¹

          // å³ä¾§æŒ‰é’®ç»„
          Row() {
            // èœå•æŒ‰é’®
            Button() {
              Image($r('app.media.menu_icon')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ menu_icon å›¾ç‰‡èµ„æº
                .width(this.isHeaderCompact ? 18 : 20).height(this.isHeaderCompact ? 18 : 20) // ç¼©å°å›¾ç‰‡
            }
            .height(this.isHeaderCompact ? 28 : 32).borderRadius(this.isHeaderCompact ? 14 : 16) // ç¼©å°æŒ‰é’®é«˜åº¦
            .backgroundColor('rgba(255,255,255,0.2)')
            .padding(this.isHeaderCompact ? { left: 6, right: 6, top: 4, bottom: 4 } : { left: 10, right: 10,top:6,bottom:8}) // æ·»åŠ å·¦å³å†…è¾¹è·ï¼Œä½¿å…¶å˜ä¸ºæ¤­åœ†å½¢
          }
          .alignItems(VerticalAlign.Center)
        }
        .width('96%') // è°ƒæ•´å®½åº¦
        .height(this.isHeaderCompact ? 48 : 64) // åŠ¨æ€é«˜åº¦
        .padding(this.isHeaderCompact ? { left: 8, right: 8, top: 4, bottom: 4 } : { left: 8, right: 8, top: 10, bottom: 10 }) // åŠ¨æ€padding
        .margin({ top: this.isHeaderCompact ? 10 : 20, bottom: 10 }) // è°ƒæ•´é¡¶éƒ¨margin
        .alignItems(VerticalAlign.Center)
        .justifyContent(FlexAlign.SpaceBetween) // æ”¹å˜å¸ƒå±€æ–¹å¼
        .zIndex(1)

        // èŠå¤©æ¶ˆæ¯åˆ—è¡¨ (Z-index: 1)
        List({ space: 8 }) {
          ForEach(this.chatData, (item: ChatMessage) => {
            ListItem() {
              if (item.isMe) {
                this.MyMessage(item) // å³ä¾§ï¼ˆè‡ªå·±å‘é€ï¼‰
              } else {
                this.FriendMessage(item) // å·¦ä¾§ï¼ˆå¥½å‹å‘é€ï¼‰
              }
            }
          }, (item: ChatMessage) => item.id.toString())
        }
        .width('100%')
        .layoutWeight(1) // å æ®å‰©ä½™å‚ç›´ç©ºé—´
        .padding({ left: 12, right: 12, top: 0, bottom: 10 }) // åˆ—è¡¨æœ¬èº«çš„padding
        .zIndex(1)

        // åº•éƒ¨è¾“å…¥åŒºåŸŸ (Z-index: 4)
        Row() {
          // å·¦ä¾§è¯­éŸ³æŒ‰é’®
          Image($r('app.media.voice_icon')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ ic_voice å›¾ç‰‡èµ„æº
            .width(26).height(26)
            .margin({ right: 8 })

          // è¾“å…¥æ¡†
          TextInput({
            text: this.inputText,
            placeholder: 'å‘é€æ¶ˆæ¯ç»™' + this.agentName
          })
            .type(InputType.Normal)
            .placeholderColor('#aaa')
            .fontColor(Color.White)
            .fontSize(16)
            .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´
            .height(48)
            .borderWidth(0) // è®¾ç½®è¾¹æ¡†å®½åº¦ä¸º0ï¼Œç§»é™¤è¾¹æ¡†
            //.backgroundColor('rgba(255,255,255,0.2)')
            //.borderRadius(24)
            .padding({ left: 16, right: 16 })
            .margin({ right: 8 })
            .onChange((text: string) => {
              this.inputText = text;
            })

          // å³ä¾§åŠ å·æŒ‰é’® (ç”¨äºæ›´å¤šåŠŸèƒ½)
          Image($r('app.media.ic_add_circle')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ ic_add_circle å›¾ç‰‡èµ„æº
            .width(30).height(30)
            .onClick(() => {
              if (this.inputText.trim().length > 0) {
                this.sendMessage();
              } else {
                console.log('æ‰“å¼€æ›´å¤šåŠŸèƒ½é¢æ¿'); // å¾…å®ç°
              }
            })
            .margin({ right: 8 })

          // æ–°å¢å‘é€æŒ‰é’®ï¼ˆå›¾æ ‡æ›¿æ¢ï¼‰
          Image($r('app.media.send_icon'))
            .width(26).height(26)
            .opacity(this.inputText.trim().length > 0 ? 1 : 0.4) // æœ‰å†…å®¹é«˜äº®ï¼Œæ— å†…å®¹å˜æ·¡
            .onClick(() => {
              if (this.inputText.trim().length > 0) {
                this.sendMessage();
              }
            })
        }
        .height(50)
        .width('100%')
        .padding({ left: 24, right: 24, top: 8, bottom: 8 }) // è°ƒæ•´åº•éƒ¨è¾“å…¥åŒºåŸŸçš„å·¦å³é—´è·
        .backgroundColor('rgba(0,0,0,0.3)') // åº•éƒ¨è¾“å…¥åŒºèƒŒæ™¯è‰²
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        .zIndex(4)
        .borderRadius(35)
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.SpaceBetween) // é¡¶éƒ¨åº•éƒ¨å†…å®¹åˆ†å¼€
      .alignItems(HorizontalAlign.Center)
      .padding({ left:8,right:8, bottom: 30 }) // ç§»é™¤top padding


      // åº•éƒ¨å¯¼èˆªæ  (Z-index: 3)
      Column() {
        // Blank() // ç§»é™¤ Blank()
        BottomNavBar({ navIndex: 'chat' })
      }
      .width('100%')
      // .height('100%') // ç§»é™¤æ­¤å±æ€§
      // .justifyContent(FlexAlign.End) // ç§»é™¤æ­¤å±æ€§
      .alignItems(HorizontalAlign.Center)
      .zIndex(3) // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
      .align(Alignment.Bottom) // ç¡®ä¿å¯¹é½åˆ° Stack çš„åº•éƒ¨
    }
  }

  // å¥½å‹æ¶ˆæ¯ç»„ä»¶ï¼ˆå·¦ä¾§ï¼‰
  @Builder
  FriendMessage(item: ChatMessage) {
    Row() {
      // Image(item.avatar) // è¿™é‡Œçš„ avatar å·²ç»ä» chatData é‡Œä¼ å…¥ï¼Œæ‰€ä»¥ä¸å†é‡å¤æ›¿æ¢ $r
      //   .width(40).height(40).borderRadius(20)
      //   .margin({ right: 8 })

      Column() {
        // è¯­éŸ³æ—¶é•¿æ˜¾ç¤º (å¦‚æœæ¶ˆæ¯ç±»å‹æ˜¯è¯­éŸ³)
        if (item.type === 'voice' && item.duration) {
          Column() { // æ–°å¢çš„Columnä½œä¸ºè¯­éŸ³æ¶ˆæ¯æ°”æ³¡
            Row() {
              Image($r('app.media.splash')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ voice_play_icon å›¾ç‰‡èµ„æº
                .width(20).height(20).margin({ right: 4 })
              Text(`${item.duration}"`)
                .fontSize(16).fontColor(Color.White)
            }
            .width(item.duration * 6 + 60) // æ¨¡æ‹Ÿè¯­éŸ³æ¡é•¿åº¦éšæ—¶é—´å˜åŒ–
            .height(40)
            .alignItems(VerticalAlign.Center)
            .padding({ left: 10, right: 10, bottom: 12 }) // è°ƒæ•´åº•éƒ¨padding

            // Text(item.time) // å·²åˆ é™¤
            //   .fontSize(12).fontColor(Color.White)
            //   .opacity(0.7)
            //   .padding({ left: 10, right: 10, bottom: 8, top: 0 }) // è°ƒæ•´æ—¶é—´æ–‡æœ¬çš„padding
          }
          .backgroundColor('#1a1a1a') // è¯­éŸ³æ¡èƒŒæ™¯è‰²è°ƒæ•´ä¸ºæµ…é»‘è‰²
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start) // æ°”æ³¡å†…å†…å®¹å·¦å¯¹é½
          .constraintSize({ maxWidth: '70%' }) // é™åˆ¶æ•´ä¸ªæ°”æ³¡çš„æœ€å¤§å®½åº¦
        } else { // æ–‡æœ¬æ¶ˆæ¯
          Column() { // æ–°å¢çš„Columnä½œä¸ºæ–‡æœ¬æ¶ˆæ¯æ°”æ³¡
            Text(item.content)
              .fontSize(16)
              .fontColor('#eaeaea')
              .padding({ left: 12, right: 12, top: 12, bottom: 12 }) // è°ƒæ•´å†…å®¹æ–‡æœ¬çš„padding
            // Text(item.time) // å·²åˆ é™¤
            //   .fontSize(12).fontColor(Color.White)
            //   .opacity(0.7)
            //   .padding({ left: 12, right: 12, bottom: 8, top: 0 }) // è°ƒæ•´æ—¶é—´æ–‡æœ¬çš„padding
          }
          .backgroundColor('#1a1a1a') // æ¶ˆæ¯æ°”æ³¡èƒŒæ™¯è‰²è°ƒæ•´ä¸ºæµ…é»‘è‰²
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start) // æ°”æ³¡å†…å†…å®¹å·¦å¯¹é½
          .constraintSize({ maxWidth: '70%' }) // é™åˆ¶æ•´ä¸ªæ°”æ³¡çš„æœ€å¤§å®½åº¦
        }
      }
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .justifyContent(FlexAlign.Start)
    .alignItems(VerticalAlign.Top) // é¡¶éƒ¨å¯¹é½
    .padding({ left: 10, right: 10 })
  }

  // æˆ‘çš„æ¶ˆæ¯ç»„ä»¶ï¼ˆå³ä¾§ï¼‰
  @Builder
  MyMessage(item: ChatMessage) {
    Row() {
      Column() {
        // è¯­éŸ³æ—¶é•¿æ˜¾ç¤º (å¦‚æœæ¶ˆæ¯ç±»å‹æ˜¯è¯­éŸ³)
        if (item.type === 'voice' && item.duration) {
          Column() { // æ–°å¢çš„Columnä½œä¸ºè¯­éŸ³æ¶ˆæ¯æ°”æ³¡
            Row() {
              Text(`${item.duration}"`)
                .fontSize(16).fontColor(Color.Black)
              Image($r('app.media.splash')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ voice_play_icon å›¾ç‰‡èµ„æº
                .width(20).height(20).margin({ left: 4 })
            }
            .width(item.duration * 6 + 60) // æ¨¡æ‹Ÿè¯­éŸ³æ¡é•¿åº¦éšæ—¶é—´å˜åŒ–
            .height(40)
            .alignItems(VerticalAlign.Center)
            .padding({ left: 10, right: 10, bottom: 12 }) // è°ƒæ•´åº•éƒ¨padding

            // Text(item.time) // å·²åˆ é™¤
            //   .fontSize(12).fontColor(Color.Black)
            //   .opacity(0.7)
            //   .padding({ left: 10, right: 10, bottom: 8, top: 0 }) // è°ƒæ•´æ—¶é—´æ–‡æœ¬çš„padding
          }
          .backgroundColor('#f9cb82') // è¯­éŸ³æ¡èƒŒæ™¯è‰²è°ƒæ•´ä¸ºä¸é‚£ä¹ˆé»„çš„é‡‘è‰²
          .borderRadius(8)
          .alignItems(HorizontalAlign.End) // æ°”æ³¡å†…å†…å®¹å³å¯¹é½
          .constraintSize({ maxWidth: '70%' }) // é™åˆ¶æ•´ä¸ªæ°”æ³¡çš„æœ€å¤§å®½åº¦
        } else {
          Column() { // æ–°å¢çš„Columnä½œä¸ºæ–‡æœ¬æ¶ˆæ¯æ°”æ³¡
            Text(item.content)
              .fontSize(16)
              .fontColor(Color.Black)
              .padding({ left: 12, right: 12, top: 12, bottom: 12 }) // è°ƒæ•´å†…å®¹æ–‡æœ¬çš„padding
            // Text(item.time) // å·²åˆ é™¤
            //   .fontSize(12).fontColor(Color.Black)
            //   .opacity(0.7)
            //   .padding({ left: 12, right: 12, bottom: 8, top: 0 }) // è°ƒæ•´æ—¶é—´æ–‡æœ¬çš„padding
          }
          .backgroundColor('#E8C838') // æ¶ˆæ¯æ°”æ³¡èƒŒæ™¯è‰²è°ƒæ•´ä¸ºä¸é‚£ä¹ˆé»„çš„é‡‘è‰²
          .borderRadius(8)
          .alignItems(HorizontalAlign.End) // æ°”æ³¡å†…å†…å®¹å³å¯¹é½
          .constraintSize({ maxWidth: '70%' }) // é™åˆ¶æ•´ä¸ªæ°”æ³¡çš„æœ€å¤§å®½åº¦
        }
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .justifyContent(FlexAlign.End)
    .alignItems(VerticalAlign.Top) // é¡¶éƒ¨å¯¹é½
    .padding({ left: 10, right: 10 })
  }
}

