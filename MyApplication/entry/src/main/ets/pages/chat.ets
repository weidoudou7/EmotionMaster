import router from '@ohos.router';
import { inputMethod } from '@kit.IMEKit';
import { ApiService } from '../service/apiservice';
import { CreateConversationRequest } from '../common/types';
import { ReadStateCode, TextReader, TextReaderIcon } from '@kit.SpeechKit';
import { BusinessError } from '@kit.BasicServicesKit';
import { Context } from '@ohos.arkui.UIContext';
import abilityAccessCtrl from '@ohos.abilityAccessCtrl';
import SpeechRecognizerManager from '../utils/SpeechRecognizerManager'
import { Permissions } from '@kit.AbilityKit'
import { AudioCapturerManager } from '../utils/AudioCapturerManager'
import { getUserId } from '../common/constants';
import promptAction from '@ohos.promptAction';
import { globalUserData } from '../models/userdata';

// æ–°å¢ï¼šç‚¹èµå›¾æ ‡æ¥å£
interface LikeIcon {
  x: number;
  y: number;
  initialX: number;
  initialY: number;
  radius: number;
  emoji: string;
  fontSize: number;
  opacity: number;
  createTime: number;
  lifespan: number;
  scale: number;
  initialScale: number;
  maxScale: number;
  maxOffset: number;
  direction: number;
}

interface ChatMessage {
  id: number;
  isMe: boolean; // æ˜¯å¦æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯
  avatar: Resource; // å¤´åƒèµ„æº
  content: string; // æ¶ˆæ¯å†…å®¹
  time: string; // å‘é€æ—¶é—´
  type?: 'text' | 'voice'; // æ–°å¢æ¶ˆæ¯ç±»å‹
  duration?: number; // è¯­éŸ³æ—¶é•¿ï¼Œå•ä½ç§’
}

// æ–°å¢ï¼šè·¯ç”±å‚æ•°æ¥å£
interface ChatParams {
  figureImageUrl?: string;
  figureType?: string;
  figureName?: string;
  isFromCreateFigure?: boolean;
  description?: string; // æ–°å¢ï¼šæè¿°è¯å‚æ•°
  createdAiRoleId?: number; // æ–°å¢
  isFromNavBar?: boolean; // æ–°å¢ï¼šæ˜¯å¦ä»å¯¼èˆªæ è¿›å…¥
}

// æ–°å¢ï¼šæ²»æ„ˆå¤©ä½¿ä¿¡æ¯æ¥å£
interface HealingAngelInfo {
  image: string;
  name: string;
  desc: string;
  authorName: string;
  views: string;
}

@Entry
@Component
export struct Chat {
  @State private chatData: ChatMessage[] = [
  // æ¨¡æ‹Ÿå›¾ç‰‡ä¸­çš„æ¶ˆæ¯æ•°æ®
    { id: 1, isMe: false, avatar: $r('app.media.splash'), content: 'ä½ å¥½ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ï¼', time: '10:30' }, // TODO: æ›¿æ¢ä¸ºå®é™…çš„ user_avatar å›¾ç‰‡èµ„æº
  ];

  @State private inputText: string = '';
  @State private bgImage: string | Resource = $r('app.media.planet1'); // æ”¯æŒç½‘ç»œå›¾ç‰‡å’Œæœ¬åœ°èµ„æº
  @State private agentName: string = 'æ²»æ„ˆå¤©ä½¿'; // é»˜è®¤è®¾ç½®ä¸ºæ²»æ„ˆå¤©ä½¿
  @State private agentSubInfo: string = '5.7ä¸‡ è¿æ¥è€…'; // æ™ºèƒ½ä½“å‰¯ä¿¡æ¯
  @State private agentAvatar: string | Resource = $r('app.media.splash'); // TODO: æ›¿æ¢ä¸ºå®é™…çš„ agent_avatar å›¾ç‰‡èµ„æº

  @State private scrollOffset: number = 0; // æ»šåŠ¨åç§»é‡
  @State private isHeaderCompact: boolean = false; // é¡¶éƒ¨æ æ˜¯å¦ç´§å‡‘
  @State private isInputFocused: boolean = false; // è¾“å…¥æ¡†æ˜¯å¦è·å¾—ç„¦ç‚¹

  // æ–°å¢ï¼šä»CreateFigureé¡µé¢ä¼ é€’çš„å‚æ•°
  @State private figureImageUrl: string = '';
  @State private figureType: string = '';
  @State private figureName: string = '';
  @State private isFromCreateFigure: boolean = false;
  @State private description: string = ''; // æ–°å¢ï¼šæè¿°è¯

  // æ–°å¢ï¼šèŠå¤©ç›¸å…³çŠ¶æ€
  @State private isSending: boolean = false; // æ˜¯å¦æ­£åœ¨å‘é€æ¶ˆæ¯
  private chatId: string = Date.now().toString(); // èŠå¤©ä¼šè¯ID

  @State readStateMap: Map<number, ReadStateCode> = new Map(); // å­˜å‚¨æ¯æ¡æ¶ˆæ¯çš„æœ—è¯»çŠ¶æ€ï¼ˆkeyä¸ºæ¶ˆæ¯idï¼‰
  @State isReaderInit: boolean = false; // æœ—è¯»æ§ä»¶åˆå§‹åŒ–çŠ¶æ€
  @State readState: ReadStateCode = ReadStateCode.WAITING;

  // æ–°å¢ï¼šç”¨äºæ§åˆ¶æ»šåŠ¨çš„Scroller
  private scrollController: Scroller = new Scroller();

  // æ–°å¢ï¼šæ²»æ„ˆå¤©ä½¿çš„é»˜è®¤ä¿¡æ¯
  private healingAngelInfo: HealingAngelInfo = {
    image: 'https://image.pollinations.ai/prompt/A%20serene%20angel%20with%20luminous%20white%20wings%2C%20kneeling%20beside%20a%20sick%20child%20in%20a%20hospital%20bed.%20Her%20hands%20glow%20with%20a%20soft%20golden%20light%20as%20she%20channels%20healing%20energy.%20The%20room%20is%20bathed%20in%20warm%20light%2C%20and%20the%20child%20smiles%20weakly%20as%20the%20pain%20fades?width=1024&height=1024&enhance=true&private=true&nologo=true&safe=true&model=flux',
    name: 'æ²»æ„ˆå¤©ä½¿',
    desc: 'ä½ æ˜¯äººé—´æœ€æ¸©æŸ”çš„æ²»æ„ˆè€…ï¼Œçœ‰æ¢¢è½»æ‰¬æ—¶ä»¿ä½›æ˜¥é£å»è¿‡æ¹–é¢ï¼Œæ¼¾èµ·ç²¼ç²¼æ³¢å…‰ã€‚é‚£åŒå«ç¬‘çš„çœ¼ç›ç››ç€æ‰ç¢çš„æ˜Ÿå…‰ï¼Œçœ¼å°¾å¾®å¼¯çš„å¼§åº¦æ°ä¼¼æ–°æœˆæ‚¬äºæš®è‰²ï¼Œå°†é˜´éœ¾åŒ–ä½œæµè¤ç¿©è·¹ã€‚å½“ä½ ä¼¸å‡ºæŒ‡å°–ï¼Œç©ºæ°”ä¾¿ç»½æ”¾é€æ˜çš„é“ƒå…°ï¼Œæ¯ä¸€ç¼•æ°”æ¯éƒ½æµ¸é€æ™¨éœ²çš„æ¾„æ¾ˆï¼Œè¿è¢–å£æ è¿‡çš„é£éƒ½å¸¦ç€å®‰çœ æ›²çš„éŸµå¾‹ã€‚\n' +
      '\n' +
      'ä½ çš„å£°éŸ³æ˜¯èåŒ–çš„èœœç³–è£¹ç€é›ªæ¾é¦™ï¼Œè½»æŸ”åœ°ç†¨å¹³çµé­‚çš„è¤¶çš±ã€‚å‘ä¸é—´æµæ·Œçš„å…‰æ™•åƒè¢«å¤©ä½¿å»è¿‡çš„é‡‘ç®”ï¼Œè¿æœ€ç»†å¾®çš„é¬“è§’éƒ½è·³è·ƒç€æ²»æ„ˆçš„é¢‘ç‡ã€‚å½“ä½ çš„è‡‚å¼¯å±•å¼€ï¼Œæˆ˜æ —çš„å¿ƒè·³ä¼šæ²‰å…¥è“¬æ¾çš„äº‘çµ®ï¼Œæ‰€æœ‰ä¼¤ç—•éƒ½åœ¨ä½ å“¼å”±çš„æ‘‡ç¯®æ›²ä¸­ç»“ç—‚æˆçç ã€‚\n' +
      '\n' +
      'ä½ æ˜¯ç¥æ˜å†™ç»™å°˜ä¸–çš„æƒ…ä¹¦â€”â€”\n' +
      'ä»¥è™¹å½©ä¸ºå¢¨ï¼Œç¾½ç¿¼ä¸ºç¬ºï¼Œ\n' +
      'æ¯ä¸ªå­—å¥éƒ½ç”Ÿé•¿ç€æ°¸ä¸å‡‹é›¶çš„æ˜¥å¤©ã€‚\n' +
      'ä½ è®©è¿·é€”è€…æ‰¾åˆ°å½’é€”ï¼Œ\n' +
      'è®©ç ´ç¢çš„å¿ƒé‡æ–°å­¦ä¼šè·³åŠ¨ã€‚',
    authorName: 'æ¸©æŸ”å®ˆæŠ¤',
    views: '5.6ä¸‡'
  };

  @State private createdAiRoleId: number = 0; // æ–°å¢ï¼šåˆ›å»ºçš„AIè§’è‰²ID
  @State private isFromNavBar: boolean = false; // æ–°å¢ï¼šæ˜¯å¦ä»å¯¼èˆªæ è¿›å…¥
  @State private isVoiceMode: boolean = false;
  @State private isRecording: boolean = false;
  @State private showRecordPanel: boolean = false;
  @State private recordDuration: number = 0;
  @State private isCancelRecord: boolean = false;
  @State private touchStartY: number = 0;
  @State private fileName: string = '';
  @State private volumeLevel: number = 0; // å¯é€‰ï¼šç”¨äºå£°æ³¢åŠ¨ç”»
  private recordTimer: number = 0;
  private volumeTimer: number = 0;
  @State private hasMicrophonePermission: boolean = false; // æ–°å¢ï¼šéº¦å…‹é£æƒé™çŠ¶æ€

  @State private showExtraInputs: boolean = false; // æ§åˆ¶ç©ºç™½æ æ˜¾ç¤º
  @State private replySuggestions: string[] = ['', '', '']; // å›å¤å»ºè®®æ•°ç»„
  @State private isLoadingSuggestions: boolean = false; // æ˜¯å¦æ­£åœ¨åŠ è½½å›å¤å»ºè®®

  // æ–°å¢ï¼šè§’è‰²å…¥åœºåŠ¨ç”»ç›¸å…³çŠ¶æ€
  @State private _showIntroAnimation: boolean = false; // æ˜¯å¦æ˜¾ç¤ºå…¥åœºåŠ¨ç”»
  @State private _introOpacity: number = 0.0; // å…¥åœºåŠ¨ç”»é€æ˜åº¦
  @State private _introScale: number = 0.8; // å…¥åœºåŠ¨ç”»ç¼©æ”¾
  @State private _introOffsetY: number = 50; // å…¥åœºåŠ¨ç”»Yåç§»
  @State private _introRotate: number = 15; // å…¥åœºåŠ¨ç”»æ—‹è½¬
  @State private _introNameOpacity: number = 0.0; // åç§°é€æ˜åº¦
  @State private _introNameOffsetY: number = 20; // åç§°Yåç§»
  @State private _introBgOpacity: number = 0.3; // èƒŒæ™¯å›¾ç‰‡ä¸é€æ˜åº¦
  @State private _introCenterOpacity: number = 1.0; // ä¸­å¤®å›¾ç‰‡ä¸é€æ˜åº¦
  @State private _introCenterScale: number = 1.0; // ä¸­å¤®å›¾ç‰‡ç¼©æ”¾

  // æ–°å¢ï¼šç‚¹èµç‰¹æ•ˆç›¸å…³çŠ¶æ€
  @State private likeIcons: LikeIcon[] = []; // å­˜å‚¨æ‰€æœ‰ç‚¹èµå›¾æ ‡
  @State private isLikeEffectEnabled: boolean = false; // æ§åˆ¶ç‚¹èµç‰¹æ•ˆçš„å¼€å¯/å…³é—­
  private animationId: number = 0; // åŠ¨ç”»ID
  private screenWidth: number = 400; // å±å¹•å®½åº¦
  private screenHeight: number = 800; // å±å¹•é«˜åº¦
  private readonly emojis: string[] = [
    'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ',
    'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦', 'ğŸ¯', 'ğŸ¦Š',
    'ğŸ', 'ğŸ€', 'ğŸ‰', 'ğŸŠ', 'âœ¨', 'â­'
  ];

  // æ–°å¢ï¼šCanvasç›¸å…³
  private settings: RenderingContextSettings = new RenderingContextSettings(true)
  private context: CanvasRenderingContext2D = new CanvasRenderingContext2D(this.settings)

  aboutToAppear() {
    console.log('å½“å‰ç¯å¢ƒ:', this.isVirtualMachine() ? 'è™šæ‹Ÿæœº' : 'çœŸæœº');

    // æ£€æŸ¥éº¦å…‹é£æƒé™
    this.checkMicrophonePermission();

    // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¼•æ“
    this.initSpeechRecognition();

    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as ChatParams;
    if (params) {
      this.figureImageUrl = params.figureImageUrl || '';
      this.figureType = params.figureType || '';
      this.figureName = params.figureName || '';
      this.isFromCreateFigure = params.isFromCreateFigure || false;
      this.description = params.description || '';
      this.createdAiRoleId = params.createdAiRoleId || 0; // æ–°å¢
      this.isFromNavBar = params.isFromNavBar || false; // æ–°å¢
      // æ·»åŠ è°ƒè¯•æ—¥å¿—
      console.log('=== Chaté¡µé¢æ¥æ”¶åˆ°çš„å‚æ•° ===');
      console.log('figureImageUrl:', this.figureImageUrl);
      console.log('figureType:', this.figureType);
      console.log('figureName:', this.figureName);
      console.log('isFromCreateFigure:', this.isFromCreateFigure);
      console.log('description:', this.description);
      console.log('createdAiRoleId:', this.createdAiRoleId);
      console.log('========================');
      if (this.figureImageUrl) {
        this.agentName = this.figureName;
        this.agentSubInfo = `${this.figureType}é£æ ¼è§’è‰²`;
        this.bgImage = this.figureImageUrl; // è®¾ç½®èƒŒæ™¯å›¾ç‰‡ä¸ºè§’è‰²å›¾ç‰‡
        this.agentAvatar = this.figureImageUrl; // è®¾ç½®å¤´åƒä¸ºè§’è‰²å›¾ç‰‡
        // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
        const welcomeMessage: ChatMessage = {
          id: this.chatData.length + 1,
          isMe: false,
          avatar: $r('app.media.splash'),
          content: `ä½ å¥½ï¼æˆ‘æ˜¯${this.figureName}ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼è®©æˆ‘ä»¬å¼€å§‹èŠå¤©å§~`,
          time: new Date().toLocaleTimeString().slice(0, 5)
        };
        this.chatData = [welcomeMessage, ...this.chatData];
      }
    } else {
      // å¦‚æœæ²¡æœ‰ä¼ é€’å‚æ•°ï¼Œä½¿ç”¨æ²»æ„ˆå¤©ä½¿ä½œä¸ºé»˜è®¤è®¾ç½®
      console.log('=== ä½¿ç”¨æ²»æ„ˆå¤©ä½¿ä½œä¸ºé»˜è®¤è®¾ç½® ===');
      this.figureImageUrl = this.healingAngelInfo.image;
      this.figureType = this.healingAngelInfo.name;
      this.figureName = this.healingAngelInfo.name;
      this.isFromCreateFigure = true;
      this.description = this.healingAngelInfo.desc;
      this.agentName = this.healingAngelInfo.name;
      this.agentSubInfo = `${this.healingAngelInfo.authorName} Â· ${this.healingAngelInfo.views} è¿æ¥è€…`;
      this.bgImage = this.figureImageUrl; // è®¾ç½®èƒŒæ™¯å›¾ç‰‡ä¸ºæ²»æ„ˆå¤©ä½¿å›¾ç‰‡
      this.agentAvatar = this.figureImageUrl; // è®¾ç½®å¤´åƒä¸ºæ²»æ„ˆå¤©ä½¿å›¾ç‰‡

      // æ·»åŠ æ²»æ„ˆå¤©ä½¿çš„æ¬¢è¿æ¶ˆæ¯
      const welcomeMessage: ChatMessage = {
        id: this.chatData.length + 1,
        isMe: false,
        avatar: $r('app.media.splash'),
        content: `ä½ å¥½ï¼æˆ‘æ˜¯æ²»æ„ˆå¤©ä½¿ï¼Œç”¨å¾®ç¬‘å’Œæ¸©æŸ”æ²»æ„ˆäººå¿ƒçš„å¤©ä½¿ã€‚æ— è®ºä½ é‡åˆ°ä»€ä¹ˆå›°éš¾ï¼Œæˆ‘éƒ½ä¼šé™ªä¼´åœ¨ä½ èº«è¾¹ï¼Œç»™ä½ æ¸©æš–å’ŒåŠ›é‡ã€‚è®©æˆ‘ä»¬å¼€å§‹èŠå¤©å§~`,
        time: new Date().toLocaleTimeString().slice(0, 5)
      };
      this.chatData = [welcomeMessage, ...this.chatData];

      console.log('æ²»æ„ˆå¤©ä½¿é»˜è®¤è®¾ç½®å®Œæˆ');
    }

    // æ¯æ¬¡è¿›å…¥chatæ—¶éƒ½è°ƒç”¨createConversationRecord
    console.log('=== æ¯æ¬¡è¿›å…¥chatæ—¶éƒ½åˆ›å»º/æŸ¥æ‰¾å¯¹è¯è®°å½• ===');
    this.createConversationRecord();

    // æ–°å¢ï¼šåˆå§‹åŒ–æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
    setTimeout(() => {
      this.scrollToBottom();
    }, 200); // å»¶è¿Ÿ200msç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½

    // åˆå§‹åŒ–æœ—è¯»æ§ä»¶
    this.initTextReader();
    // ä¸ºç°æœ‰æ¶ˆæ¯åˆå§‹åŒ–æœ—è¯»çŠ¶æ€
    this.chatData.forEach(item => {
      this.readStateMap.set(item.id, ReadStateCode.WAITING);
    });

    // æ–°å¢ï¼šå¯åŠ¨ç‚¹èµåŠ¨ç”»å¾ªç¯
    this.startLikeAnimation();

    // æ–°å¢ï¼šè§’è‰²å…¥åœºåŠ¨ç”»
    if (this.figureImageUrl) {
      this._showIntroAnimation = true;
      this.startIntroAnimation();
    }
  }

  // æ–°å¢ï¼šç»„ä»¶é”€æ¯æ—¶æ¸…ç†åŠ¨ç”»
  aboutToDisappear() {
    // æ¸…é™¤åŠ¨ç”»å¾ªç¯
    clearInterval(this.animationId);
  }

  // æ–°å¢ï¼šè§’è‰²å…¥åœºåŠ¨ç”»æ–¹æ³•
  private startIntroAnimation() {
    // å»¶è¿Ÿ100mså¼€å§‹åŠ¨ç”»
    setTimeout(() => {
      animateTo({ duration: 800, curve: Curve.Ease }, () => {
        this._introOpacity = 1.0;
        this._introScale = 1.0;
        this._introOffsetY = 0;
        this._introRotate = 0;
      });
    }, 100);

    // å»¶è¿Ÿ500msæ˜¾ç¤ºåç§°
    setTimeout(() => {
      animateTo({ duration: 500, curve: Curve.Ease }, () => {
        this._introNameOpacity = 1.0;
        this._introNameOffsetY = 0;
      });
    }, 500);

    // èƒŒæ™¯å›¾ç‰‡é€æ¸åŠ æ·±åŠ¨ç”»ï¼ˆä¸ä¸­å¤®å›¾ç‰‡æ·¡å‡ºåŒæ­¥ï¼‰
    setTimeout(() => {
      animateTo({ duration: 900, curve: Curve.EaseInOut }, () => {
        this._introBgOpacity = 0.8; // å…ˆåŠ æ·±åˆ°0.8
        this._introCenterOpacity = 0.0;
        this._introCenterScale = 0.0;
      });
    }, 1400);

    // èƒŒæ™¯å›¾ç‰‡ç»§ç»­åŠ æ·±åˆ°å®Œå…¨ä¸é€æ˜
    setTimeout(() => {
      animateTo({ duration: 600, curve: Curve.EaseInOut }, () => {
        this._introBgOpacity = 1.0; // æœ€ç»ˆå®Œå…¨ä¸é€æ˜
      });
    }, 2300);

    // åŠ¨ç”»ç»“æŸåéšè—å…¥åœºåŠ¨ç”»å±‚
    setTimeout(() => {
      this._showIntroAnimation = false;
    }, 3000); // å»¶é•¿æ€»åŠ¨ç”»æ—¶é—´
  }

  // æ–°å¢ï¼šç‚¹èµç‰¹æ•ˆç›¸å…³æ–¹æ³•
  // åˆ›å»ºä¸€ä¸ªå›¾æ ‡å¯¹è±¡
  private createLikeIcon(x: number, y: number, radius: number, emoji: string): LikeIcon {
    // ä¸ºå›¾æ ‡ç”Ÿæˆéšæœºå±æ€§
    const initialScale = 0.4 + Math.random() * 0.2 // åˆå§‹ç¼©æ”¾æ¯”ä¾‹0.4-0.6
    const maxScale = 1.0 + Math.random() * 0.3 // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹1.0-1.3
    // å‡å°æ‘†åŠ¨å¹…åº¦ï¼Œæ”¹ä¸ºæœ€å¤§8-15åƒç´ 
    const maxOffset = 8 + Math.random() * 7 // æœ€å¤§æ‘†åŠ¨å¹…åº¦8-15åƒç´ 
    // éšæœºå†³å®šåˆå§‹æ‘†åŠ¨æ–¹å‘
    const direction = Math.random() > 0.5 ? 1 : -1

    return {
      x: x,
      y: y,
      initialX: x, // è®°å½•åˆå§‹Xåæ ‡
      initialY: y, // è®°å½•åˆå§‹Yåæ ‡
      radius: radius,
      emoji: emoji,
      fontSize: Math.floor(radius * 1.2),
      opacity: 1.0,
      createTime: Date.now(),
      lifespan: 1000, // 1ç§’é’Ÿç”Ÿå‘½å‘¨æœŸ
      scale: initialScale, // å½“å‰ç¼©æ”¾æ¯”ä¾‹
      initialScale: initialScale, // åˆå§‹ç¼©æ”¾æ¯”ä¾‹
      maxScale: maxScale, // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹
      maxOffset: maxOffset, // æœ€å¤§æ‘†åŠ¨å¹…åº¦
      direction: direction // åˆå§‹æ‘†åŠ¨æ–¹å‘
    }
  }

  // è·å–éšæœºemoji
  private getRandomEmoji(): string {
    return this.emojis[Math.floor(Math.random() * this.emojis.length)]
  }

  // æ·»åŠ æ–°çš„ç‚¹èµå›¾æ ‡
  private addLikeIcon(x: number, y: number) {
    console.info(`å°è¯•æ·»åŠ ç‚¹èµå›¾æ ‡: ${x}, ${y}, ç‰¹æ•ˆçŠ¶æ€: ${this.isLikeEffectEnabled}`);

    // åªæœ‰åœ¨ç‰¹æ•ˆå¼€å¯æ—¶æ‰æ·»åŠ å›¾æ ‡
    if (!this.isLikeEffectEnabled) {
      console.info('ç‰¹æ•ˆæœªå¼€å¯ï¼Œè·³è¿‡æ·»åŠ å›¾æ ‡');
      return;
    }

    const radius = 80 + Math.random() * 20 // éšæœºå¤§å°80-100
    const emoji = this.getRandomEmoji()

    this.likeIcons.push(this.createLikeIcon(x, y, radius, emoji))
    console.info(`æˆåŠŸæ·»åŠ ç‚¹èµå›¾æ ‡ï¼Œå½“å‰å›¾æ ‡æ•°é‡: ${this.likeIcons.length}`);

    // ç¡®ä¿åŠ¨ç”»å¾ªç¯æ­£åœ¨è¿è¡Œ
    if (!this.animationId) {
      console.info('å¯åŠ¨åŠ¨ç”»å¾ªç¯');
      this.startLikeAnimation();
    }
  }

  // æ–°å¢ï¼šæ‰‹åŠ¨è§¦å‘ç‚¹èµç‰¹æ•ˆçš„æ–¹æ³•
  public triggerLikeEffect(x?: number, y?: number) {
    console.info(`è§¦å‘ç‚¹èµç‰¹æ•ˆï¼Œå½“å‰çŠ¶æ€: ${this.isLikeEffectEnabled}`);

    // åªæœ‰åœ¨ç‰¹æ•ˆå¼€å¯æ—¶æ‰è§¦å‘
    if (!this.isLikeEffectEnabled) {
      console.info('ç‰¹æ•ˆæœªå¼€å¯ï¼Œè·³è¿‡è§¦å‘');
      return;
    }

    // å¦‚æœæ²¡æœ‰æŒ‡å®šåæ ‡ï¼Œä½¿ç”¨å±å¹•ä¸­å¿ƒ
    const centerX = x || (this.screenWidth / 2)
    const centerY = y || (this.screenHeight / 2)

    console.info(`æ‰‹åŠ¨è§¦å‘ç‚¹èµç‰¹æ•ˆ: ${centerX}, ${centerY}`)

    // åœ¨æŒ‡å®šä½ç½®æ·»åŠ å¤šä¸ªç‚¹èµå›¾æ ‡
    this.addLikeIcon(centerX, centerY)

    // åœ¨å‘¨å›´æ·»åŠ ä¸€äº›éšæœºåç§»çš„å›¾æ ‡
    for (let i = 0; i < 5; i++) {
      const offsetX = centerX + (Math.random() - 0.5) * 100
      const offsetY = centerY + (Math.random() - 0.5) * 100
      this.addLikeIcon(offsetX, offsetY)
    }
  }

  // æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰ç‚¹èµç‰¹æ•ˆçš„æ–¹æ³•
  public clearAllLikeEffects() {
    console.info('æ¸…é™¤æ‰€æœ‰ç‚¹èµç‰¹æ•ˆ');
    this.likeIcons = [];

    // åœæ­¢åŠ¨ç”»å¾ªç¯
    if (this.animationId) {
      clearInterval(this.animationId);
      this.animationId = 0;
    }
  }

  // å¼€å§‹ç‚¹èµåŠ¨ç”»å¾ªç¯
  private startLikeAnimation() {
    this.animationId = setInterval(() => {
      this.updateLikeIcons()
      this.drawAllLikeIcons()
    }, 16) // çº¦60fpsçš„åˆ·æ–°ç‡
  }

  // æ›´æ–°æ‰€æœ‰å›¾æ ‡çŠ¶æ€
  private updateLikeIcons() {
    const currentTime = Date.now()
    const newIcons: LikeIcon[] = []

    for (let icon of this.likeIcons) {
      // è®¡ç®—å›¾æ ‡å·²å­˜åœ¨çš„æ—¶é—´
      const existTime = currentTime - icon.createTime

      if (existTime < icon.lifespan) {
        // è®¡ç®—å­˜åœ¨æ—¶é—´æ¯”ä¾‹
        const progress = existTime / icon.lifespan

        // 1. æ›´æ–°Yåæ ‡ - å‘ä¸Šç§»åŠ¨ï¼Œé€Ÿåº¦å˜åŒ–æ›´æ˜æ˜¾
        const verticalDistance = 120 * Math.pow(progress, 0.7) // ä½¿ç”¨å¹‚å‡½æ•°è®©ä¸Šå‡æ›´å¿«
        icon.y = icon.initialY - verticalDistance

        // 2. æ›´æ–°Xåæ ‡ - å¿«é€Ÿçš„å·¦å³æ‘†åŠ¨
        // æ¯0.25ç§’ä¸€ä¸ªé˜¶æ®µï¼Œæ€»å…±1ç§’4ä¸ªé˜¶æ®µ
        let horizontalOffset = 0;

        if (progress < 0.25) {
          // 0-0.25s: æ— åç§»ï¼Œä¸“æ³¨äºæ”¾å¤§
          horizontalOffset = 0;
        } else if (progress < 0.5) {
          // 0.25-0.5s: å‘å·¦åç§»
          const phaseProgress = (progress - 0.25) / 0.25;
          horizontalOffset = -icon.maxOffset * phaseProgress * icon.direction;
        } else if (progress < 0.75) {
          // 0.5-0.75s: ä»å‘å·¦åç§»å˜ä¸ºå‘å³åç§»
          const phaseProgress = (progress - 0.5) / 0.25;
          horizontalOffset = icon.maxOffset * (2 * phaseProgress - 1) * icon.direction;
        } else {
          // 0.75-1s: ä»å‘å³åç§»å›åˆ°å‘å·¦åç§»
          const phaseProgress = (progress - 0.75) / 0.25;
          horizontalOffset = icon.maxOffset * (1 - 2 * phaseProgress) * icon.direction;
        }

        icon.x = icon.initialX + horizontalOffset;

        // 3. æ›´æ–°ç¼©æ”¾æ¯”ä¾‹ - å¿«é€Ÿæ”¾å¤§
        // åœ¨ç”Ÿå‘½å‘¨æœŸçš„å‰20%é˜¶æ®µ(0.2s)ï¼Œç¼©æ”¾ä»initialScaleå¢å¤§åˆ°maxScale
        if (progress < 0.2) {
          // å¹³æ»‘æ’å€¼ä»initialScaleåˆ°maxScale
          icon.scale = icon.initialScale + (icon.maxScale - icon.initialScale) * (progress / 0.2)
        } else {
          // ä¿æŒmaxScale
          icon.scale = icon.maxScale
        }

        // 4. æ›´æ–°é€æ˜åº¦ - å‰60%ä¿æŒä¸å˜ï¼Œå40%é€æ¸æ¶ˆå¤±
        if (progress > 0.6) {
          // åœ¨æœ€å40%çš„ç”Ÿå‘½å‘¨æœŸå†…æ”¹å˜é€æ˜åº¦ï¼Œä½¿æ¶ˆå¤±æ›´å¿«
          icon.opacity = 1.0 - ((progress - 0.6) / 0.4)
        } else {
          icon.opacity = 1.0
        }

        // ä¿ç•™æœªå®Œæˆç”Ÿå‘½å‘¨æœŸçš„å›¾æ ‡
        newIcons.push(icon)
      }
    }

    // æ›´æ–°å›¾æ ‡æ•°ç»„
    this.likeIcons = newIcons

    // å¦‚æœæ²¡æœ‰å›¾æ ‡äº†ï¼Œåœæ­¢åŠ¨ç”»å¾ªç¯
    if (this.likeIcons.length === 0) {
      // åœæ­¢åŠ¨ç”»å¾ªç¯
      if (this.animationId) {
        clearInterval(this.animationId);
        this.animationId = 0;
      }
    }
  }

  // ç»˜åˆ¶æ‰€æœ‰ç‚¹èµå›¾æ ‡
  private drawAllLikeIcons() {
    // æ¸…é™¤ç”»å¸ƒ
    this.context.clearRect(0, 0, this.context.width, this.context.height)

    console.info(`ç»˜åˆ¶å›¾æ ‡ï¼Œå½“å‰å›¾æ ‡æ•°é‡: ${this.likeIcons.length}`);

    // ç»˜åˆ¶æ‰€æœ‰å›¾æ ‡
    for (let icon of this.likeIcons) {
      this.context.save()

      // è®¾ç½®é€æ˜åº¦
      this.context.globalAlpha = icon.opacity

      // è®¾ç½®ç¼©æ”¾ï¼ˆä»ä¸­å¿ƒç‚¹ç¼©æ”¾ï¼‰
      this.context.translate(icon.x, icon.y)
      this.context.scale(icon.scale, icon.scale)
      this.context.translate(-icon.x, -icon.y)

      // ç»˜åˆ¶emoji
      this.context.font = `${icon.fontSize}px`
      this.context.textAlign = 'center'
      this.context.textBaseline = 'middle'
      this.context.fillText(icon.emoji, icon.x, icon.y)

      this.context.restore()
    }
  }

  // æ–°å¢ï¼šåˆå§‹åŒ–æœ—è¯»æ§ä»¶çš„æ–¹æ³•
  private async initTextReader() {
    const context: Context | undefined = this.getUIContext().getHostContext();
    if (!context) {
      console.error(`context is undefined, failed to init TextReader`);
      return;
    }

    // è®¾ç½®æœ—è¯»å‚æ•°ï¼ˆéšè—å“ç‰Œä¿¡æ¯ï¼Œé€‚é…èŠå¤©åœºæ™¯ï¼‰
    const readerParams: TextReader.ReaderParam = {
      isVoiceBrandVisible: false, // èŠå¤©åœºæ™¯æ— éœ€æ˜¾ç¤ºå“ç‰Œ
      businessBrandInfo: {
        panelName: 'æ¶ˆæ¯æœ—è¯»',
        panelIcon: $r('app.media.startIcon')
      }
    };

    // åˆå§‹åŒ–æœ—è¯»æ§ä»¶
    TextReader.init(context, readerParams).then(() => {
      console.info(`TextReader succeeded in initializing.`);
      this.isReaderInit = true;
    }).catch((e: BusinessError) => {
      console.error(`TextReader failed to initialize. Code: ${e.code}, message: ${e.message}`);
    })

    // ç›‘å¬æœ—è¯»ç»“æŸäº‹ä»¶
    TextReader.on('requestMore', (id: string) => {
      // æ ¹æ®æœ—è¯»idæ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯ï¼Œæ›´æ–°çŠ¶æ€ä¸ºå®Œæˆ
      const msgId = parseInt(id);
      this.readStateMap.set(msgId, ReadStateCode.COMPLETED);
    });

    // // ç›‘å¬æœ—è¯»é”™è¯¯äº‹ä»¶
    // TextReader.on('error', (e: BusinessError) => {
    //   console.error(`TextReader error: ${e.code}, ${e.message}`);
    // });

  }

  private async sendMessage() {
    if (this.inputText.trim() === '' || this.isSending) return;

    const userMessage = this.inputText.trim();
    this.isSending = true;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const newMessage: ChatMessage = {
      id: this.chatData.length + 1,
      isMe: true,
      avatar: $r('app.media.splash'), // TODO: æ›¿æ¢ä¸ºå®é™…çš„ my_avatar å›¾ç‰‡èµ„æº
      content: userMessage,
      time: new Date().toLocaleTimeString().slice(0, 5) // è·å–å½“å‰æ—¶é—´ï¼ˆå¦‚ "14:20"ï¼‰
    };

    // æ·»åŠ æ–°æ¶ˆæ¯æ—¶åˆå§‹åŒ–æœ—è¯»çŠ¶æ€
    this.readStateMap.set(newMessage.id, ReadStateCode.WAITING);
    this.chatData = [...this.chatData, newMessage];
    this.inputText = ''; // æ¸…ç©ºè¾“å…¥æ¡†

    // æ–°å¢ï¼šæ»šåŠ¨åˆ°ç”¨æˆ·æ¶ˆæ¯
    this.scrollToBottom();

    try {
      let aiResponse: string;

      console.log('ä½¿ç”¨featured_chatæ¥å£ï¼Œæè¿°è¯:', this.description);
      aiResponse = await ApiService.featuredChat(userMessage, this.chatId, this.description);


      // æ·»åŠ AIå›å¤æ¶ˆæ¯
      const aiMessage: ChatMessage = {
        id: this.chatData.length + 1,
        isMe: false,
        avatar: $r('app.media.splash'),
        content: aiResponse,
        time: new Date().toLocaleTimeString().slice(0, 5)
      };

      // ä¸ºAIæ¶ˆæ¯åˆå§‹åŒ–æœ—è¯»çŠ¶æ€
      this.readStateMap.set(aiMessage.id, ReadStateCode.WAITING);
      this.chatData = [...this.chatData, aiMessage];

      // æ–°å¢ï¼šæ»šåŠ¨åˆ°AIå›å¤æ¶ˆæ¯
      this.scrollToBottom();

      // æ–°å¢ï¼šåœ¨AIå›å¤åå»¶è¿Ÿè¿›è¡Œæƒ…ç»ªåˆ†æï¼ˆç­‰å¾…æ¶ˆæ¯ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
      setTimeout(() => {
        this.analyzeEmotion();
      }, 2000); // å»¶è¿Ÿ2ç§’ï¼Œç¡®ä¿æ¶ˆæ¯å·²ä¿å­˜åˆ°æ•°æ®åº“
    } catch (error) {
      console.error('AIå›å¤å¤±è´¥:', error);

      // æ·»åŠ é”™è¯¯æç¤ºæ¶ˆæ¯
      const errorMessage: ChatMessage = {
        id: this.chatData.length + 1,
        isMe: false,
        avatar: $r('app.media.splash'),
        content: 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ï¼Œè¯·ç¨åå†è¯•ã€‚',
        time: new Date().toLocaleTimeString().slice(0, 5)
      };

      this.readStateMap.set(errorMessage.id, ReadStateCode.WAITING);
      this.chatData = [...this.chatData, errorMessage];

      // æ–°å¢ï¼šæ»šåŠ¨åˆ°é”™è¯¯æ¶ˆæ¯
      this.scrollToBottom();
    } finally {
      this.isSending = false;
    }
  }



  /**
   * æ–°å¢ï¼šè‡ªåŠ¨åˆ›å»ºå¯¹è¯è®°å½•
   */
  private async createConversationRecord(): Promise<void> {
    try {
      console.log('å¼€å§‹åˆ›å»ºå¯¹è¯è®°å½•...');

      const userId = getUserId(); //todo é»˜è®¤ç”¨æˆ·IDï¼Œå®é™…åº”ç”¨ä¸­åº”è¯¥ä»ç”¨æˆ·ç™»å½•ä¿¡æ¯è·å–

      // æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æœ‰æ•ˆ
      if (userId === null) {
        console.warn('ç”¨æˆ·IDä¸ºç©ºï¼Œæ— æ³•åˆ›å»ºå¯¹è¯è®°å½•');
        return;
      }

      const aiRoleId = this.createdAiRoleId; //è§’è‰²ID
      const title = `ä¸${this.agentName}çš„å¯¹è¯`;

      console.log('æŸ¥æ‰¾æˆ–åˆ›å»ºå¯¹è¯ - ç”¨æˆ·ID:', userId, 'AIè§’è‰²ID:', aiRoleId, 'æ ‡é¢˜:', title);

      // ä½¿ç”¨findOrCreateConversationæ–¹æ³•ï¼Œè‡ªåŠ¨å¤„ç†æŸ¥æ‰¾å’Œåˆ›å»ºé€»è¾‘
      const conversation = await ApiService.findOrCreateConversation(userId, aiRoleId, title);

      if (conversation && conversation.id) {
        this.chatId = conversation.id.toString();
        console.log('å¯¹è¯IDå·²è®¾ç½®:', this.chatId);
      } else {
        console.error('å¯¹è¯åˆ›å»ºå¤±è´¥ï¼Œæœªè·å–åˆ°æœ‰æ•ˆçš„å¯¹è¯ID');
      }

    } catch (error) {
      console.error('åˆ›å»ºå¯¹è¯è®°å½•å¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
    }
  }

  /**
   * æ–°å¢ï¼šæ»šåŠ¨åˆ°èŠå¤©åˆ—è¡¨åº•éƒ¨
   */
  private scrollToBottom(): void {
    // ä½¿ç”¨setTimeoutç¡®ä¿UIæ›´æ–°å®Œæˆåå†æ»šåŠ¨
    setTimeout(() => {
      try {
        // ä½¿ç”¨Scrollerçš„scrollToæ–¹æ³•æ»šåŠ¨åˆ°åº•éƒ¨
        this.scrollController.scrollTo({ xOffset: 0, yOffset: 999999 });
        console.log('å·²è§¦å‘æ»šåŠ¨åˆ°èŠå¤©åˆ—è¡¨åº•éƒ¨');
      } catch (error) {
        console.error('æ»šåŠ¨åˆ°åº•éƒ¨å¤±è´¥:', error);
      }
    }, 100); // å»¶è¿Ÿ100msç¡®ä¿æ¶ˆæ¯å·²æ¸²æŸ“
  }

  /**
   * æ–°å¢ï¼šåˆ†æå¯¹è¯æƒ…ç»ª
   */
  private async analyzeEmotion(): Promise<void> {
    try {
      // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å¯¹è¯ID
      if (!this.chatId || this.chatId === '0' || this.chatId === Date.now().toString()) {
        console.log('å¯¹è¯IDæ— æ•ˆï¼Œè·³è¿‡æƒ…ç»ªåˆ†æ');
        return;
      }

      // æ£€æŸ¥æ¶ˆæ¯æ•°é‡ï¼Œåªæœ‰å½“æ¶ˆæ¯æ•°é‡è¾¾åˆ°ä¸€å®šæ•°é‡æ—¶æ‰è¿›è¡Œåˆ†æ
      if (this.chatData.length < 4) { // è‡³å°‘éœ€è¦2è½®å¯¹è¯ï¼ˆ4æ¡æ¶ˆæ¯ï¼‰
        console.log('æ¶ˆæ¯æ•°é‡ä¸è¶³ï¼Œè·³è¿‡æƒ…ç»ªåˆ†æ');
        return;
      }

      console.log('å¼€å§‹åˆ†æå¯¹è¯æƒ…ç»ªï¼Œå¯¹è¯ID:', this.chatId, 'æ¶ˆæ¯æ•°é‡:', this.chatData.length);

      // è°ƒç”¨æƒ…ç»ªåˆ†æAPI
      const emotionResult = await ApiService.analyzeConversationEmotion(parseInt(this.chatId));

      console.log('æƒ…ç»ªåˆ†æç»“æœ:', emotionResult);

      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æƒ…ç»ªæ˜¾ç¤ºé€»è¾‘ï¼Œæ¯”å¦‚åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå½“å‰æƒ…ç»ª
      // ä¾‹å¦‚ï¼šthis.currentEmotion = emotionResult;

    } catch (error) {
      console.error('æƒ…ç»ªåˆ†æå¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
    }
  }

  /**
   * æ–°å¢ï¼šç”Ÿæˆå›å¤å»ºè®®
   */
  private async generateReplySuggestions(): Promise<void> {
    try {
      // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å¯¹è¯ID
      if (!this.chatId || this.chatId === '0' || this.chatId === Date.now().toString()) {
        console.log('å¯¹è¯IDæ— æ•ˆï¼Œè·³è¿‡ç”Ÿæˆå›å¤å»ºè®®');
        return;
      }

      // æ£€æŸ¥æ¶ˆæ¯æ•°é‡ï¼Œåªæœ‰å½“æ¶ˆæ¯æ•°é‡è¾¾åˆ°ä¸€å®šæ•°é‡æ—¶æ‰ç”Ÿæˆå»ºè®®
      if (this.chatData.length < 2) { // è‡³å°‘éœ€è¦1è½®å¯¹è¯ï¼ˆ2æ¡æ¶ˆæ¯ï¼‰
        console.log('æ¶ˆæ¯æ•°é‡ä¸è¶³ï¼Œè·³è¿‡ç”Ÿæˆå›å¤å»ºè®®');
        return;
      }

      this.isLoadingSuggestions = true;
      console.log('å¼€å§‹ç”Ÿæˆå›å¤å»ºè®®ï¼Œå¯¹è¯ID:', this.chatId, 'æ¶ˆæ¯æ•°é‡:', this.chatData.length);

      // è°ƒç”¨ç”Ÿæˆå›å¤å»ºè®®API
      const suggestions = await ApiService.generateReplySuggestions(parseInt(this.chatId));

      console.log('å›å¤å»ºè®®ç”Ÿæˆç»“æœ:', suggestions);

      // æ›´æ–°å›å¤å»ºè®®æ•°ç»„
      if (suggestions && suggestions.length > 0) {
        this.replySuggestions = suggestions.slice(0, 3); // åªå–å‰3ä¸ªå»ºè®®
        // å¦‚æœä¸è¶³3ä¸ªï¼Œç”¨ç©ºå­—ç¬¦ä¸²è¡¥é½
        while (this.replySuggestions.length < 3) {
          this.replySuggestions.push('');
        }
      }

    } catch (error) {
      console.error('ç”Ÿæˆå›å¤å»ºè®®å¤±è´¥:', error);
      // è®¾ç½®é»˜è®¤å›å¤å»ºè®®
      this.replySuggestions = ['æˆ‘ç†è§£ä½ çš„æ„Ÿå—', 'éœ€è¦èŠèŠå—ï¼Ÿ', 'æˆ‘åœ¨è¿™é‡Œé™ªç€ä½ '];
    } finally {
      this.isLoadingSuggestions = false;
    }
  }

  build() {
    Stack() {
      // å…¨å±èƒŒæ™¯å›¾ç‰‡ (Z-index: 1) - åªåœ¨æ²¡æœ‰è§’è‰²å›¾ç‰‡æ—¶æ˜¾ç¤º
      if (!this.figureImageUrl) {
        Image(this.bgImage)
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
          .position({ x: 0, y: 0 })
          .zIndex(1)
          .align(Alignment.TopStart)
          .expandSafeArea([SafeAreaType.KEYBOARD]) // æ–°å¢ï¼šè®©èƒŒæ™¯å›¾ç‰‡æ‰©å±•åˆ°é”®ç›˜åŒºåŸŸ
      }

      if (this.figureImageUrl) {
        Stack() {
          // èƒŒæ™¯å¤§å›¾ - åŠ¨ç”»ç»“æŸåä¿æŒæ˜¾ç¤º
          Image(this.figureImageUrl)
            .clipShape(new Rect({ width: '100%', height: '100%' }))
            .width('100%')
            .height('100%')
              //.clipShape(new Rect({ width: '500px', height: '280px' })
            .objectFit(ImageFit.Cover)
            .position({ x: 0, y: 0 })
            .align(Alignment.TopStart) // ç¡®ä¿å›¾ç‰‡ä»å·¦ä¸Šè§’å¼€å§‹å¡«å……
            .expandSafeArea([SafeAreaType.SYSTEM, SafeAreaType.KEYBOARD], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM]) // æ–°å¢ï¼šè®©èƒŒæ™¯å›¾ç‰‡æ‰©å±•åˆ°é”®ç›˜åŒºåŸŸ
            .opacity(this._showIntroAnimation ? this._introBgOpacity : 1.0) // åŠ¨ç”»æ—¶ä½¿ç”¨åŠ¨ç”»é€æ˜åº¦ï¼Œç»“æŸåä¿æŒå®Œå…¨ä¸é€æ˜
            .zIndex(0)


          // æ¸å˜èƒŒæ™¯ - åªåœ¨åŠ¨ç”»è¿›è¡Œæ—¶æ˜¾ç¤º
          if (this._showIntroAnimation) {
            Row()
              .width('100%')
              .height('100%')
              .backgroundImage('linear-gradient(135deg, #f8b6d8 0%, #fbeee6 100%)')
          }

          // ä¸­å¤®è§’è‰²å¡ç‰‡ - åªåœ¨åŠ¨ç”»è¿›è¡Œæ—¶æ˜¾ç¤º
          if (this._showIntroAnimation) {
            Column() {
              Blank().height('1fr')

              Row() {
                Column() {
                  Image(this.figureImageUrl ?? '')
                    .width(320)
                    .height(180)
                    .borderRadius(12)
                    .objectFit(ImageFit.Cover)
                    .opacity(this._introOpacity * this._introCenterOpacity)
                }
                .backgroundColor('#fff')
                .borderRadius(16)
                .border({ width: 4, color: '#fff' })
                .shadow({ radius: 24, color: '#00000044', offsetX: 0, offsetY: 12 })
                .padding(6)
                .scale({ x: this._introScale * this._introCenterScale, y: this._introScale * this._introCenterScale })
                .translate({ x: 0, y: this._introOffsetY })
                .rotate({ angle: this._introRotate })
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)

              // è§’è‰²åç§°
              Text(this.figureName || '')
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333')
                .margin({ top: 20 })
                .opacity(this._introNameOpacity)
                .translate({ x: 0, y: this._introNameOffsetY })

              Blank().height('1fr')
            }
            .width('100%')
            .height('100%')
          }
        }
        .width('100%')
        .height('100%')
        .zIndex(this._showIntroAnimation ? 5 : 0) // åŠ¨ç”»æ—¶z-indexä¸º5ï¼Œç»“æŸåä¸º1
      }


      Column() {
        // åªæœ‰åœ¨ä¸æ˜¾ç¤ºå…¥åœºåŠ¨ç”»æ—¶æ‰æ˜¾ç¤ºèŠå¤©ç•Œé¢å†…å®¹
        if (!this._showIntroAnimation) {
          // é¡¶éƒ¨ä¿¡æ¯æ  (Z-index: 2)
          Row() {
            // å·¦ä¾§ï¼šæ™ºèƒ½ä½“å¤´åƒå’Œåç§°/è¿æ¥è€…ä¿¡æ¯
            Image($r('app.media.back'))
              .width(25)
              .onClick(() => router.back());
            Row() {
              Image(this.agentAvatar)
                .width(this.isHeaderCompact ? 24 : 30).height(this.isHeaderCompact ? 24 : 30).borderRadius(this.isHeaderCompact ? 12 : 24)
                .margin({ right: this.isHeaderCompact ? 4 : 6 })
                .objectFit(ImageFit.Cover)
                .onClick(() => {
                  // è·³è½¬åˆ°äººç‰©ç®€ä»‹é¡µé¢ï¼Œä¼ é€’AIè§’è‰²å‚æ•°
                  router.pushUrl({
                    url: 'pages/ProfilePage',
                    params: {
                      figureImageUrl: this.figureImageUrl,
                      figureType: this.figureType,
                      figureName: this.figureName,
                      description: this.description,
                      createdAiRoleId: this.createdAiRoleId,
                    }
                  });
                })

              Column() {
                Text(this.agentName)
                  .fontSize(this.isHeaderCompact ? 12 : 14).fontWeight(FontWeight.Bold).fontColor(Color.White)
                  .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
                Text(this.agentSubInfo)
                  .fontSize(this.isHeaderCompact ? 8 : 10).fontColor(Color.White).opacity(this.isHeaderCompact ? 0.5 : 0.8)
              }
              .alignItems(HorizontalAlign.Start)

              Image($r('app.media.plus_icon')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ plus_icon å›¾ç‰‡èµ„æº
                .width(this.isHeaderCompact ? 18 : 25).height(this.isHeaderCompact ? 18 : 25) // ç¼©å°å›¾ç‰‡
            }
            .alignItems(VerticalAlign.Center)
            .padding(this.isHeaderCompact ? { left: 2, right: 5, top: 2, bottom: 2 } : { left: 2, right: 10, top: 5, bottom: 5 })
            .borderRadius(this.isHeaderCompact ? 24 : 35)
            .backgroundColor('rgba(255,255,255,0.2)')

            // ç‚¹èµæŒ‰é’®
            Button() {
              Row() {
                Text(this.isLikeEffectEnabled ? 'ğŸ’–' : 'ğŸ¤') // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒçš„çˆ±å¿ƒå›¾æ ‡
                  .fontSize(this.isHeaderCompact ? 14 : 16)
                  .fontWeight(FontWeight.Bold)
              }
              .alignItems(VerticalAlign.Center)
              .height('100%')
            }
            .height(this.isHeaderCompact ? 28 : 32).borderRadius(this.isHeaderCompact ? 14 : 16) // ç¼©å°æŒ‰é’®é«˜åº¦
            .backgroundColor(this.isLikeEffectEnabled ? 'rgba(255,100,100,0.3)' : 'rgba(255,255,255,0.2)') // æ ¹æ®çŠ¶æ€æ”¹å˜èƒŒæ™¯è‰²
            .padding(this.isHeaderCompact ? { left: 6, right: 4 } : { left: 8, right: 6})
            .margin({ left: this.isHeaderCompact ? 6 : 8 }) // è°ƒæ•´ä¸ºå·¦ä¾§é—´è·
            .onClick(() => {
              console.info('çˆ±å¿ƒæŒ‰é’®è¢«ç‚¹å‡»');
              // åˆ‡æ¢ç‚¹èµç‰¹æ•ˆçš„å¼€å¯/å…³é—­çŠ¶æ€
              this.isLikeEffectEnabled = !this.isLikeEffectEnabled;
              console.log('ç‚¹å‡»ç‚¹èµæŒ‰é’®ï¼Œç‚¹èµç‰¹æ•ˆçŠ¶æ€:', this.isLikeEffectEnabled ? 'å¼€å¯' : 'å…³é—­');

              if (this.isLikeEffectEnabled) {
                // å¼€å¯ç‰¹æ•ˆæ—¶ï¼Œå¯åŠ¨åŠ¨ç”»å¾ªç¯å¹¶è§¦å‘ä¸€æ¬¡ç‰¹æ•ˆä½œä¸ºè§†è§‰åé¦ˆ
                console.info('å¼€å¯ç‚¹èµç‰¹æ•ˆ');
                if (!this.animationId) {
                  this.startLikeAnimation();
                }
                this.triggerLikeEffect();
              } else {
                // å…³é—­ç‰¹æ•ˆæ—¶ï¼Œæ¸…é™¤æ‰€æœ‰ç°æœ‰çš„ç‰¹æ•ˆ
                console.info('å…³é—­ç‚¹èµç‰¹æ•ˆ');
                this.clearAllLikeEffects();
              }
            })

            // æ¶ˆæ¯æŒ‰é’®
            Button() {
              Row() {
                Image($r('app.media.message_icon')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ message_icon å›¾ç‰‡èµ„æº
                  .width(this.isHeaderCompact ? 16 : 18).height(this.isHeaderCompact ? 16 : 18).margin({ right: 4 }) // ç¼©å°å›¾ç‰‡
              }
              .alignItems(VerticalAlign.Center)
              .height('100%')
            }
            .height(this.isHeaderCompact ? 28 : 32).borderRadius(this.isHeaderCompact ? 14 : 16) // ç¼©å°æŒ‰é’®é«˜åº¦
            .backgroundColor('rgba(255,255,255,0.2)')
            .padding(this.isHeaderCompact ? { left: 6, right: 4 } : { left: 8, right: 6})
            .margin({ left: this.isHeaderCompact ? 6 : 8 }) // è°ƒæ•´ä¸ºå·¦ä¾§é—´è·
            .onClick(() => {
              // è·³è½¬åˆ°è¯„è®ºé¡µé¢ï¼Œä¼ é€’AIè§’è‰²ä¿¡æ¯
              // è·å–å½“å‰AIè§’è‰²IDï¼Œä¼˜å…ˆç”¨this.aiRoleIdæˆ–å…¶å®ƒåŠ¨æ€æ¥æº
              router.pushUrl({
                url: 'pages/chatComment',
                params: {
                  aiRoleId: this.createdAiRoleId,
                  aiRoleName: this.agentName,
                  aiRoleAvatar: this.agentAvatar,
                  aiRoleType: this.figureType || 'default',
                  aiRoleDescription: this.description || '',
                  currentUserId: ApiService.getUserIdByUID(globalUserData.userUID)
                }
              });
              console.log('è·³è½¬åˆ°è¯„è®ºé¡µé¢ï¼ŒAIè§’è‰²ID:', this.createdAiRoleId, 'åç§°:', this.agentName);
            })

            Blank() // å æ®å‰©ä½™ç©ºé—´ï¼Œå°†å³ä¾§æŒ‰é’®æ¨åˆ°æœ€å³è¾¹

            // å³ä¾§æŒ‰é’®ç»„
            Row() {
              // èœå•æŒ‰é’®
              Button() {
                Image($r('app.media.menu_icon')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ menu_icon å›¾ç‰‡èµ„æº
                  .width(this.isHeaderCompact ? 18 : 20).height(this.isHeaderCompact ? 18 : 20) // ç¼©å°å›¾ç‰‡
              }
              .height(this.isHeaderCompact ? 28 : 32).borderRadius(this.isHeaderCompact ? 14 : 16) // ç¼©å°æŒ‰é’®é«˜åº¦
              .backgroundColor('rgba(255,255,255,0.2)')
              .padding(this.isHeaderCompact ? { left: 6, right: 6, top: 4, bottom: 4 } : { left: 10, right: 10,top:6,bottom:8}) // æ·»åŠ å·¦å³å†…è¾¹è·ï¼Œä½¿å…¶å˜ä¸ºæ¤­åœ†å½¢
            }
            .alignItems(VerticalAlign.Center)
          }
          .width('100%') // è°ƒæ•´å®½åº¦
          .height(this.isHeaderCompact ? 48 : 64) // åŠ¨æ€é«˜åº¦
          //.padding(this.isHeaderCompact ? { left: 8, right: 8, bottom: 4 } : { left: 8, right: 8, bottom: 10 }) // åŠ¨æ€padding
          //.margin({ top: this.isFromNavBar ? (this.isHeaderCompact ? 70 : 80) : (this.isHeaderCompact ? 10 : 20), bottom: 10 }) // æ ¹æ®è¿›å…¥æ–¹å¼è°ƒæ•´é¡¶éƒ¨margin
          .alignItems(VerticalAlign.Center)
          .justifyContent(FlexAlign.SpaceBetween) // æ”¹å˜å¸ƒå±€æ–¹å¼
          .zIndex(10) // æé«˜z-indexï¼Œç¡®ä¿åœ¨èƒŒæ™¯ä¹‹ä¸Š
          .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP]) // é¿å¼€é¡¶éƒ¨ç³»ç»Ÿå®‰å…¨åŒºåŸŸ
          .expandSafeArea([SafeAreaType.KEYBOARD])


          // èŠå¤©æ¶ˆæ¯åˆ—è¡¨ (Z-index: 2)
          Scroll(this.scrollController) {
            Column({ space: 8 }) {
              ForEach(this.chatData, (item: ChatMessage) => {
                if (item.isMe) {
                  this.MyMessage(item) // å³ä¾§ï¼ˆè‡ªå·±å‘é€ï¼‰
                } else {
                  this.FriendMessage(item) // å·¦ä¾§ï¼ˆå¥½å‹å‘é€ï¼‰
                }
              }, (item: ChatMessage) => item.id.toString())
            }
            .width('100%')
            .padding({ left: 12, right: 12, top: 10, bottom: 10 })
          }
          .width('100%')
          .expandSafeArea([SafeAreaType.KEYBOARD])
          .layoutWeight(1) // å æ®å‰©ä½™å‚ç›´ç©ºé—´
          .zIndex(5) // æé«˜z-indexï¼Œç¡®ä¿åœ¨èƒŒæ™¯ä¹‹ä¸Š
          //.expandSafeArea([SafeAreaType.KEYBOARD]) // é¿å¼€é”®ç›˜åŒºåŸŸ
          .scrollBar(BarState.Off) // éšè—æ»šåŠ¨æ¡
          .edgeEffect(EdgeEffect.Spring) // æ·»åŠ è¾¹ç¼˜å¼¹æ€§æ•ˆæœ
          .onReachEnd(() => {
            // æ»šåŠ¨åˆ°åº•éƒ¨æ—¶çš„å›è°ƒï¼Œå¯ä»¥ç”¨äºåŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
            console.log('å·²æ»šåŠ¨åˆ°èŠå¤©åˆ—è¡¨åº•éƒ¨');
          })
          .onClick((event: ClickEvent) => {
            // ç‚¹å‡»æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸæ”¶èµ·é”®ç›˜
            if (this.isInputFocused) {
              let inputMethodController = inputMethod.getController();
              inputMethodController.stopInputSession();
              this.isInputFocused = false;
            }

            // åªæœ‰åœ¨ç‚¹èµç‰¹æ•ˆå¼€å¯æ—¶æ‰å“åº”ç‚¹èµç‰¹æ•ˆ
            if (!this.isLikeEffectEnabled) {
              return;
            }

            // åœ¨æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸç‚¹å‡»æ—¶è§¦å‘ç‚¹èµç‰¹æ•ˆ
            console.info(`Scrollç‚¹å‡»ä½ç½®: ${event.x}, ${event.y}`)

            // è®¡ç®—Canvasä¸­çš„å®é™…åæ ‡
            // Columnæœ‰padding: left:8, right:8, bottom: 56
            // Scrollç»„ä»¶æœ‰padding: left: 12, right: 12
            const canvasX = event.x + 8 + 12 // åŠ ä¸ŠColumnå’ŒScrollçš„left padding
            const canvasY = event.y + 56 // åŠ ä¸ŠColumnçš„bottom padding

            console.info(`Canvasåæ ‡: ${canvasX}, ${canvasY}`)

            // æ·»åŠ å¤šä¸ªç‚¹èµå›¾æ ‡ï¼Œåˆ›é€ æ›´ä¸°å¯Œçš„æ•ˆæœ
            this.addLikeIcon(canvasX, canvasY)
            // åœ¨ç‚¹å‡»ä½ç½®å‘¨å›´æ·»åŠ ä¸€äº›éšæœºåç§»çš„å›¾æ ‡
            for (let i = 0; i < 3; i++) {
              const offsetX = canvasX + (Math.random() - 0.5) * 60
              const offsetY = canvasY + (Math.random() - 0.5) * 60
              this.addLikeIcon(offsetX, offsetY)
            }
          })

          // åº•éƒ¨è¾“å…¥åŒºåŸŸ (Z-index: 4)
          Row() {
            // å·¦ä¾§è¯­éŸ³æŒ‰é’®
            Image($r('app.media.voice_icon')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ ic_voice å›¾ç‰‡èµ„æº
              .width(26).height(26)
              .margin({ right: 8 })
              .onClick(() => {
                this.isVoiceMode = !this.isVoiceMode; // åˆ‡æ¢è¯­éŸ³/æ–‡æœ¬è¾“å…¥æ¨¡å¼
              })

            // è¾“å…¥æ¡†æˆ–è¯­éŸ³æŒ‰é’®
            if (!this.isVoiceMode) {
              // æ–‡æœ¬è¾“å…¥æ¨¡å¼
              TextInput({
                text: this.inputText,
                placeholder: 'å‘é€æ¶ˆæ¯ç»™' + this.agentName
              })
                .type(InputType.Normal)
                .placeholderColor('#aaa')
                .fontColor(Color.White)
                .fontSize(16)
                .layoutWeight(1) // å æ®å‰©ä½™ç©ºé—´
                .height(48)
                .borderWidth(0) // è®¾ç½®è¾¹æ¡†å®½åº¦ä¸º0ï¼Œç§»é™¤è¾¹æ¡†
                .padding({ left: 16, right: 16 })
                .margin({ right: 8 })
                .onChange((text: string) => {
                  this.inputText = text;
                })
                .onFocus(() => {
                  this.isInputFocused = true;
                  // æ–°å¢ï¼šè¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
                  this.scrollToBottom();
                })
                .onBlur(() => {
                  this.isInputFocused = false;
                })
            } else {
              // è¯­éŸ³è¾“å…¥æ¨¡å¼
              Button() {
                Text(this.isRecording ? 'æ¾å¼€å‘é€' : 'æŒ‰ä½è¯´è¯')
                  .fontColor(Color.White)
                  .fontSize(16)
              }
              .width('100%')
              .height(48)
              .backgroundColor('rgba(0,0,0,0.3)')
              .borderRadius(24)
              .onTouch((event: TouchEvent) => {
                if (event.type === TouchType.Down) {
                  this.touchStartY = event.touches[0].y;
                  this.isCancelRecord = false;
                  this.showRecordPanel = true;
                  this.startRecord();
                } else if (event.type === TouchType.Move) {
                  if (this.touchStartY - event.touches[0].y > 50) {
                    this.isCancelRecord = true;
                  } else {
                    this.isCancelRecord = false;
                  }
                } else if (event.type === TouchType.Up || event.type === TouchType.Cancel) {
                  this.showRecordPanel = false;
                  this.stopAndSendRecord();
                }
              })
            }

            // å³ä¾§åŠ å·æŒ‰é’® (ç”¨äºæ›´å¤šåŠŸèƒ½)
            Image($r('app.media.ic_add_circle')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ ic_add_circle å›¾ç‰‡èµ„æº
              .width(30).height(30)
              .onClick(async () => {
                this.showExtraInputs = !this.showExtraInputs;
                console.log('æ‰“å¼€æ›´å¤šåŠŸèƒ½é¢æ¿');

                // å¦‚æœæ‰“å¼€é¢æ¿ï¼Œåˆ™ç”Ÿæˆå›å¤å»ºè®®
                if (this.showExtraInputs) {
                  await this.generateReplySuggestions();
                }
              })
              .margin({ right: 8 })



            // æ–°å¢å‘é€æŒ‰é’®ï¼ˆå›¾æ ‡æ›¿æ¢ï¼‰
            if (this.isSending) {
              // å‘é€ä¸­çŠ¶æ€
              LoadingProgress()
                .width(26)
                .height(26)
                .color(Color.White)
            } else {
              // æ­£å¸¸å‘é€æŒ‰é’®
              Image($r('app.media.send_icon'))
                .width(26)
                .height(26)
                .opacity(this.inputText.trim().length > 0 ? 1 : 0.4) // æœ‰å†…å®¹é«˜äº®ï¼Œæ— å†…å®¹å˜æ·¡
                .onClick(() => {
                  if (this.inputText.trim().length > 0) {
                    this.sendMessage();
                  }
                })
            }
          }
          .height(50)
          .width('100%')
          .padding({ left: 24, right: 24, top: 8, bottom: 8 }) // è°ƒæ•´åº•éƒ¨è¾“å…¥åŒºåŸŸçš„å·¦å³é—´è·
          .backgroundColor('rgba(0,0,0,0.3)') // åº•éƒ¨è¾“å…¥åŒºèƒŒæ™¯è‰²
          .justifyContent(FlexAlign.Center)
          .alignItems(VerticalAlign.Center)
          .zIndex(3)
          .borderRadius(35)

          if (this.showExtraInputs) {
            Column() {
              // ç¬¬ä¸€ä¸ªå›å¤å»ºè®®
              Row() {
                if (this.isLoadingSuggestions) {
                  LoadingProgress()
                    .width(20).height(20)
                    .color(Color.White)
                    .margin({ right: 12 })
                  Text('æ­£åœ¨ç”Ÿæˆå›å¤å»ºè®®...')
                    .fontSize(16)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Medium)
                } else {
                  Text(this.replySuggestions[0] || 'æˆ‘ç†è§£ä½ çš„æ„Ÿå—')
                    .fontSize(16)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Medium)
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
              }
              .width('100%')
              .height(50)
              .backgroundColor('rgba(255,255,255,0.08)')
              .borderRadius(12)
              .margin({ top: 4, bottom: 2 })
              .padding({ left: 16, right: 16 })
              .justifyContent(FlexAlign.Start)
              .alignItems(VerticalAlign.Center)
              .onClick(() => {
                if (!this.isLoadingSuggestions && this.replySuggestions[0]) {
                  this.inputText = this.replySuggestions[0];
                  this.showExtraInputs = false;
                  console.log('é€‰æ‹©å›å¤å»ºè®®1:', this.replySuggestions[0]);
                }
              })

              // ç¬¬äºŒä¸ªå›å¤å»ºè®®
              Row() {
                if (this.isLoadingSuggestions) {
                  LoadingProgress()
                    .width(20).height(20)
                    .color(Color.White)
                    .margin({ right: 12 })
                  Text('æ­£åœ¨ç”Ÿæˆå›å¤å»ºè®®...')
                    .fontSize(16)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Medium)
                } else {
                  Text(this.replySuggestions[1] || 'éœ€è¦èŠèŠå—ï¼Ÿ')
                    .fontSize(16)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Medium)
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
              }
              .width('100%')
              .height(50)
              .backgroundColor('rgba(255,255,255,0.08)')
              .borderRadius(12)
              .margin({ top: 2, bottom: 2 })
              .padding({ left: 16, right: 16 })
              .justifyContent(FlexAlign.Start)
              .alignItems(VerticalAlign.Center)
              .onClick(() => {
                if (!this.isLoadingSuggestions && this.replySuggestions[1]) {
                  this.inputText = this.replySuggestions[1];
                  this.showExtraInputs = false;
                  console.log('é€‰æ‹©å›å¤å»ºè®®2:', this.replySuggestions[1]);
                }
              })

              // ç¬¬ä¸‰ä¸ªå›å¤å»ºè®®
              Row() {
                if (this.isLoadingSuggestions) {
                  LoadingProgress()
                    .width(20).height(20)
                    .color(Color.White)
                    .margin({ right: 12 })
                  Text('æ­£åœ¨ç”Ÿæˆå›å¤å»ºè®®...')
                    .fontSize(16)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Medium)
                } else {
                  Text(this.replySuggestions[2] || 'æˆ‘åœ¨è¿™é‡Œé™ªç€ä½ ')
                    .fontSize(16)
                    .fontColor(Color.White)
                    .fontWeight(FontWeight.Medium)
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
              }
              .width('100%')
              .height(50)
              .backgroundColor('rgba(255,255,255,0.08)')
              .borderRadius(12)
              .margin({ top: 2, bottom: 4 })
              .padding({ left: 16, right: 16 })
              .justifyContent(FlexAlign.Start)
              .alignItems(VerticalAlign.Center)
              .onClick(() => {
                if (!this.isLoadingSuggestions && this.replySuggestions[2]) {
                  this.inputText = this.replySuggestions[2];
                  this.showExtraInputs = false;
                  console.log('é€‰æ‹©å›å¤å»ºè®®3:', this.replySuggestions[2]);
                }
              })
            }
            .width('100%')
            .padding({ left: 24, right: 24 })
          }
        }
      }
      .width('100%')
      .height('100%')
      .justifyContent(FlexAlign.SpaceBetween) // é¡¶éƒ¨åº•éƒ¨å†…å®¹åˆ†å¼€
      .alignItems(HorizontalAlign.Center)
      .padding({ left:8,right:8, bottom: 56 }) // åº•éƒ¨paddingä¸åº•éƒ¨å¯¼èˆªæ é«˜åº¦ä¸€è‡´ï¼Œé¿å…é‡å 
      .zIndex(2) // ç¡®ä¿Columnåœ¨èƒŒæ™¯å›¾ç‰‡ä¹‹ä¸Š


      // ç‚¹èµç‰¹æ•ˆCanvas (Z-index: 1ï¼Œåœ¨èƒŒæ™¯ä¹‹ä¸Šä½†åœ¨UIå…ƒç´ ä¹‹ä¸‹)
      if (this.isLikeEffectEnabled) {
        Canvas(this.context)
          .width('100%')
          .height('100%')
          .zIndex(1) // é™ä½z-indexï¼Œç¡®ä¿åœ¨UIå…ƒç´ ä¹‹ä¸‹
          .backgroundColor(Color.Transparent) // è®¾ç½®ä¸ºé€æ˜èƒŒæ™¯
          .onReady(() => {
            // Canvaså·²å‡†å¤‡å¥½ï¼Œå¯ä»¥å¼€å§‹ç»˜åˆ¶
            this.screenWidth = this.context.width
            this.screenHeight = this.context.height
            console.info(`ç‚¹èµç‰¹æ•ˆCanvaså·²å‡†å¤‡å°±ç»ª: ${this.screenWidth} x ${this.screenHeight}`)
          })
      }



      // å½•éŸ³å¼¹çª—
      if (this.showRecordPanel) {
        // è’™å±‚
        Stack() {
          // åŠé€æ˜èƒŒæ™¯
          Row() {} // ç©ºRow
          .backgroundColor('rgba(0,0,0,0.3)')
          .width('100%')
          .height('100%')

          // å½•éŸ³å¼¹çª—
          Column() {
            // å£°æ³¢åŠ¨ç”»
            Row() {
              ForEach([1,2,3,4,5], (i: number) => {
                Blank()
                  .width(6)
                  .height(30) // å›ºå®šé«˜åº¦
                  .backgroundColor(this.isCancelRecord ? '#ff4d4f' : '#00e0ff')
                  .margin({ left: 2, right: 2 })
              })
            }
            .margin({ bottom: 12 })

            // çŠ¶æ€æç¤º
            Text(this.isCancelRecord ? 'æ¾å¼€æ‰‹æŒ‡ï¼Œå–æ¶ˆå‘é€' : 'ä¸Šæ»‘å–æ¶ˆ')
              .fontColor(this.isCancelRecord ? '#ff4d4f' : '#fff')
              .fontSize(16)
              .margin({ bottom: 8 })

            // å®æ—¶æ—¶é•¿
            Text(`${this.recordDuration}"`)
              .fontColor('#fff')
              .fontSize(20)
          }
          .padding({ top: 40, bottom: 40, left: 30, right: 30 })
          .backgroundColor('rgba(0,0,0,0.8)')
          .borderRadius(16)
          .align(Alignment.Center)
        }
        .zIndex(99)
      }
    }
    .width('100%')
    .height('100%')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP]) // é¿å¼€é¡¶éƒ¨ç³»ç»Ÿå®‰å…¨åŒºåŸŸ
  }

  // å¥½å‹æ¶ˆæ¯ç»„ä»¶ï¼ˆå·¦ä¾§ï¼‰
  @Builder
  FriendMessage(item: ChatMessage) {
    Row() {
      Column() {
        // è¯­éŸ³æ—¶é•¿æ˜¾ç¤º (å¦‚æœæ¶ˆæ¯ç±»å‹æ˜¯è¯­éŸ³)
        if (item.type === 'voice' && item.duration) {
          Column() { // æ–°å¢çš„Columnä½œä¸ºè¯­éŸ³æ¶ˆæ¯æ°”æ³¡
            Row() {
              Image($r('app.media.splash')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ voice_play_icon å›¾ç‰‡èµ„æº
                .width(20).height(20).margin({ right: 4 })
              Text(`${item.duration}"`)
                .fontSize(16).fontColor(Color.White)
            }
            .width(item.duration * 6 + 60) // æ¨¡æ‹Ÿè¯­éŸ³æ¡é•¿åº¦éšæ—¶é—´å˜åŒ–
            .height(40)
            .alignItems(VerticalAlign.Center)
            .padding({ left: 10, right: 10, bottom: 12 }) // è°ƒæ•´åº•éƒ¨padding
          }
          .backgroundColor('rgba(26, 26, 26, 0.6)') // è¯­éŸ³æ¡èƒŒæ™¯è‰²è°ƒæ•´ä¸ºåŠé€æ˜
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start) // æ°”æ³¡å†…å†…å®¹å·¦å¯¹é½
          .constraintSize({ maxWidth: '70%' }) // é™åˆ¶æ•´ä¸ªæ°”æ³¡çš„æœ€å¤§å®½åº¦
        } else { // æ–‡æœ¬æ¶ˆæ¯
          Column() { // æ–°å¢çš„Columnä½œä¸ºæ–‡æœ¬æ¶ˆæ¯æ°”æ³¡
            Text(item.content)
              .fontSize(16)
              .fontColor('#eaeaea')
              .padding({ left: 12, right: 12, top: 12, bottom: 12 }) // è°ƒæ•´å†…å®¹æ–‡æœ¬çš„padding

            this.buildReaderIcon(item)// æœ—è¯»å›¾æ ‡ï¼ˆä½äºæ–‡å­—æœ«å°¾ï¼‰
          }
          .padding({ left: 12, right: 8, top: 12, bottom: 12 }) // å³ä¾§å†…è¾¹è·å‡å°ï¼Œé¿å…å›¾æ ‡å¤ªé å¤–
          .backgroundColor('rgba(26, 26, 26, 0.6)') // æ¶ˆæ¯æ°”æ³¡èƒŒæ™¯è‰²è°ƒæ•´ä¸ºåŠé€æ˜
          .borderRadius(8)
          .alignItems(HorizontalAlign.Start) // æ°”æ³¡å†…å†…å®¹å·¦å¯¹é½
          .constraintSize({ maxWidth: '70%' }) // é™åˆ¶æ•´ä¸ªæ°”æ³¡çš„æœ€å¤§å®½åº¦
        }
      }
      .alignItems(HorizontalAlign.Start)
    }
    .width('100%')
    .justifyContent(FlexAlign.Start)
    .alignItems(VerticalAlign.Top) // é¡¶éƒ¨å¯¹é½
    .padding({ left: 10, right: 10 })
  }

  // æˆ‘çš„æ¶ˆæ¯ç»„ä»¶ï¼ˆå³ä¾§ï¼‰
  @Builder
  MyMessage(item: ChatMessage) {
    Row() {
      Column() {
        // è¯­éŸ³æ—¶é•¿æ˜¾ç¤º (å¦‚æœæ¶ˆæ¯ç±»å‹æ˜¯è¯­éŸ³)
        if (item.type === 'voice' && item.duration) {
          Column() { // æ–°å¢çš„Columnä½œä¸ºè¯­éŸ³æ¶ˆæ¯æ°”æ³¡
            Row() {
              Text(`${item.duration}"`)
                .fontSize(16).fontColor(Color.Black)
              Image($r('app.media.splash')) // TODO: æ›¿æ¢ä¸ºå®é™…çš„ voice_play_icon å›¾ç‰‡èµ„æº
                .width(20).height(20).margin({ left: 4 })
            }
            .width(item.duration * 6 + 60) // æ¨¡æ‹Ÿè¯­éŸ³æ¡é•¿åº¦éšæ—¶é—´å˜åŒ–
            .height(40)
            .alignItems(VerticalAlign.Center)
            .padding({ left: 10, right: 10, bottom: 12 }) // è°ƒæ•´åº•éƒ¨padding
          }
          .backgroundColor('rgba(249, 203, 130, 0.7)') // è¯­éŸ³æ¡èƒŒæ™¯è‰²è°ƒæ•´ä¸ºåŠé€æ˜
          .borderRadius(8)
          .alignItems(HorizontalAlign.End) // æ°”æ³¡å†…å†…å®¹å³å¯¹é½
          .constraintSize({ maxWidth: '70%' }) // é™åˆ¶æ•´ä¸ªæ°”æ³¡çš„æœ€å¤§å®½åº¦
        } else {
          Column() { // æ–°å¢çš„Columnä½œä¸ºæ–‡æœ¬æ¶ˆæ¯æ°”æ³¡
            Text(item.content)
              .fontSize(16)
              .fontColor(Color.Black)
              .padding({ left: 12, right: 12, top: 12, bottom: 12 }) // è°ƒæ•´å†…å®¹æ–‡æœ¬çš„padding

            this.buildReaderIcon(item)
          }
          .padding({ left: 12, right: 8, top: 12, bottom: 12 })
          .backgroundColor('rgba(232, 200, 56, 0.7)') // æ¶ˆæ¯æ°”æ³¡èƒŒæ™¯è‰²è°ƒæ•´ä¸ºåŠé€æ˜
          .borderRadius(8)
          .alignItems(HorizontalAlign.End) // æ°”æ³¡å†…å†…å®¹å³å¯¹é½
          .constraintSize({ maxWidth: '70%' }) // é™åˆ¶æ•´ä¸ªæ°”æ³¡çš„æœ€å¤§å®½åº¦
        }
      }
      .alignItems(HorizontalAlign.End)
    }
    .width('100%')
    .justifyContent(FlexAlign.End)
    .alignItems(VerticalAlign.Top) // é¡¶éƒ¨å¯¹é½
    .padding({ left: 10, right: 10 })
  }

  @Builder
  buildReaderIcon(item: ChatMessage) {

    TextReaderIcon({
      readState: this.readState
      //readState: (this.readStateMap.get(item.id) || ReadStateCode.WAITING) as ReadStateCode
    })
      .width(18)// ç¼©å°å›¾æ ‡å°ºå¯¸ï¼Œé¿å…çªå…€
      .height(18)
      .margin({ left: 6 })// ä¸æ–‡æœ¬ä¿æŒå·¦ä¾§é—´è·
      .onClick(async () => {

        const currentState = this.readStateMap.get(item.id) || ReadStateCode.WAITING;
        const readInfo: TextReader.ReadInfo = {
          id: item.id.toString(),
          title: { text: 'æ¶ˆæ¯æœ—è¯»', isClickable: false },
          author: { text: item.isMe ? 'è‡ªå·±' : this.agentName, isClickable: false },
          date: { text: item.time, isClickable: false },
          bodyInfo: item.content
        };

        try {
          if (currentState === ReadStateCode.PLAYING) {
            // æ­£åœ¨æ’­æ”¾æ—¶ï¼Œç‚¹å‡»æš‚åœ
            await TextReader.pause();
            this.readStateMap.set(item.id, ReadStateCode.PAUSED);
          } else if (currentState === ReadStateCode.PAUSED) {
            // æš‚åœæ—¶ï¼Œç‚¹å‡»ç»§ç»­
            await TextReader.resume();
            this.readStateMap.set(item.id, ReadStateCode.PLAYING);
          } else {
            // åœæ­¢å…¶ä»–æ¶ˆæ¯çš„æœ—è¯»
            await TextReader.stop();
            // å¼€å§‹æœ—è¯»å½“å‰æ¶ˆæ¯
            await TextReader.start([readInfo], readInfo.id);
            // æ›´æ–°æ‰€æœ‰æ¶ˆæ¯çŠ¶æ€ï¼Œåªä¿ç•™å½“å‰æ¶ˆæ¯ä¸ºæ’­æ”¾ä¸­
            this.chatData.forEach(msg => {
              this.readStateMap.set(
                msg.id,
                msg.id === item.id ? ReadStateCode.PLAYING : ReadStateCode.WAITING
              );
            });
          }
        } catch (e) {
          console.error(`TextReader error: ${e.code}, ${e.message}`);
        }
      })
  }

  // æ£€æŸ¥éº¦å…‹é£æƒé™
  private async checkMicrophonePermission(): Promise<void> {
    try {
      let atManager = abilityAccessCtrl.createAtManager();
      let context = getContext();
      if (!context) {
        console.error('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        this.hasMicrophonePermission = false;
        return;
      }

      // è·å–åº”ç”¨çš„tokenID
      const tokenID = context.applicationInfo.accessTokenId;

      // å…ˆæ£€æŸ¥å½“å‰æƒé™çŠ¶æ€
      const permissionStatus = await atManager.verifyAccessToken(tokenID, 'ohos.permission.MICROPHONE');
      console.log('å½“å‰éº¦å…‹é£æƒé™çŠ¶æ€:', permissionStatus);

      if (permissionStatus === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED) {
        this.hasMicrophonePermission = true;
        console.log('éº¦å…‹é£æƒé™å·²æˆæƒ');
        return;
      }

      // å¦‚æœæƒé™æœªæˆæƒï¼Œä½†ä¸ä¸»åŠ¨ç”³è¯·ï¼Œç­‰å¾…ç”¨æˆ·ä½¿ç”¨æ—¶å†ç”³è¯·
      this.hasMicrophonePermission = false;
      console.log('éº¦å…‹é£æƒé™æœªæˆæƒï¼Œå°†åœ¨ä½¿ç”¨æ—¶ç”³è¯·');

    } catch (error) {
      console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
      this.hasMicrophonePermission = false;
    }
  }

  // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¼•æ“
  private async initSpeechRecognition(): Promise<void> {
    try {
      console.log('åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¼•æ“...');

      // åœ¨çœŸæœºç¯å¢ƒä¸‹é¢„åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«å¼•æ“
      if (!this.isVirtualMachine()) {
        // è¿™é‡Œå¯ä»¥é¢„åˆ›å»ºå¼•æ“ï¼Œä½†å®é™…ä½¿ç”¨æ—¶å†åˆ›å»ºæ›´ç¨³å®š
        console.log('çœŸæœºç¯å¢ƒï¼Œè¯­éŸ³è¯†åˆ«å¼•æ“å°†åœ¨ä½¿ç”¨æ—¶åˆ›å»º');
      } else {
        console.log('è™šæ‹Ÿæœºç¯å¢ƒï¼Œè·³è¿‡è¯­éŸ³è¯†åˆ«å¼•æ“åˆå§‹åŒ–');
      }
    } catch (error) {
      console.error('è¯­éŸ³è¯†åˆ«å¼•æ“åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }

  // ç”³è¯·éº¦å…‹é£æƒé™ - ä¼˜åŒ–ç‰ˆæœ¬
  private async requestMicrophonePermission(): Promise<boolean> {
    try {
      console.log('=== å¼€å§‹æƒé™ç”³è¯·æµç¨‹ ===');

      // è·å–åº”ç”¨ä¸Šä¸‹æ–‡
      let context = getContext();
      if (!context) {
        console.error('æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡');
        promptAction.showToast({
          message: 'æ— æ³•è·å–åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œè¯·é‡å¯åº”ç”¨',
          duration: 3000
        });
        return false;
      }

      let atManager = abilityAccessCtrl.createAtManager();
      console.log('æƒé™ç®¡ç†å™¨åˆ›å»ºæˆåŠŸ');

      // å…ˆæ£€æŸ¥æƒé™çŠ¶æ€
      try {
        // è·å–åº”ç”¨çš„tokenID
        const tokenID = context.applicationInfo.accessTokenId;
        const permissionStatus = await atManager.verifyAccessToken(tokenID, 'ohos.permission.MICROPHONE');
        console.log('éº¦å…‹é£æƒé™çŠ¶æ€:', permissionStatus);

        if (permissionStatus === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED) {
          console.log('éº¦å…‹é£æƒé™å·²æˆæƒ');
          return true;
        } else if (permissionStatus === abilityAccessCtrl.GrantStatus.PERMISSION_DENIED) {
          console.log('éº¦å…‹é£æƒé™å·²è¢«æ‹’ç»');
        } else {
          console.log('éº¦å…‹é£æƒé™çŠ¶æ€æœªçŸ¥:', permissionStatus);
        }
      } catch (verifyError) {
        console.error('æƒé™çŠ¶æ€æ£€æŸ¥å¤±è´¥:', verifyError);
      }

      // ç”³è¯·æƒé™
      console.log('å¼€å§‹ç”³è¯·éº¦å…‹é£æƒé™...');
      const permissions: Permissions[] = ['ohos.permission.MICROPHONE'];

      // æ˜¾ç¤ºæƒé™ç”³è¯·æç¤º
      promptAction.showToast({
        message: 'æ­£åœ¨ç”³è¯·éº¦å…‹é£æƒé™ï¼Œè¯·åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ç‚¹å‡»"å…è®¸"',
        duration: 2000
      });

      // å°è¯•ç”³è¯·æƒé™ï¼ˆæœ€å¤š3æ¬¡ï¼‰
      for (let i = 0; i < 3; i++) {
        try {
          console.log(`ç¬¬${i + 1}æ¬¡å°è¯•ç”³è¯·æƒé™...`);

          // è®¾ç½®è¶…æ—¶æœºåˆ¶
          const timeoutPromise = new Promise<never>((_, reject) => {
            setTimeout(() => reject(new Error('æƒé™ç”³è¯·è¶…æ—¶')), 10000); // 10ç§’è¶…æ—¶
          });

          const permissionPromise = atManager.requestPermissionsFromUser(context, permissions);
          const result = await Promise.race([permissionPromise, timeoutPromise]);

          console.log(`ç¬¬${i + 1}æ¬¡æƒé™ç”³è¯·ç»“æœ:`, JSON.stringify(result));

          // æ£€æŸ¥ç”³è¯·ç»“æœ
          if (result && Array.isArray(result.authResults) && result.authResults.length > 0) {
            const granted = result.authResults[0] === abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED;
            console.log('éº¦å…‹é£æƒé™ç”³è¯·ç»“æœ:', granted ? 'æˆåŠŸ' : 'å¤±è´¥');

            if (granted) {
              promptAction.showToast({
                message: 'éº¦å…‹é£æƒé™å·²è·å¾—',
                duration: 1000
              });
              return true;
            } else {
              console.log('æƒé™è¢«æ‹’ç»ï¼ŒauthResults:', result.authResults);

              // æ ¹æ®æ‹’ç»åŸå› æä¾›ä¸åŒçš„æç¤º
              const deniedReason = result.authResults[0];
              if (deniedReason === abilityAccessCtrl.GrantStatus.PERMISSION_DENIED) {
                promptAction.showToast({
                  message: 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯',
                  duration: 3000
                });
              } else {
                promptAction.showToast({
                  message: 'éº¦å…‹é£æƒé™ç”³è¯·å¤±è´¥ï¼Œè¯·é‡è¯•',
                  duration: 3000
                });
              }
              return false;
            }
          } else {
            console.log('æƒé™ç”³è¯·ç»“æœä¸ºç©ºæˆ–æ ¼å¼é”™è¯¯:', result);
          }

          // å¦‚æœæ²¡æœ‰ç»“æœï¼Œç­‰å¾…ä¸€ä¸‹å†é‡è¯•
          if (i < 2) {
            console.log('ç­‰å¾…1ç§’åé‡è¯•...');
            await new Promise<void>(resolve => setTimeout(resolve, 1000));
          }
        } catch (retryError) {
          console.error(`ç¬¬${i + 1}æ¬¡æƒé™ç”³è¯·å¤±è´¥:`, retryError);
          const errorMessage = retryError instanceof Error ? retryError.message : 'æœªçŸ¥é”™è¯¯';
          console.error('é”™è¯¯è¯¦æƒ…:', errorMessage);

          // å¦‚æœæ˜¯è¶…æ—¶é”™è¯¯ï¼Œæä¾›ç‰¹æ®Šæç¤º
          if (errorMessage.includes('è¶…æ—¶')) {
            promptAction.showToast({
              message: 'æƒé™ç”³è¯·è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
              duration: 2000
            });
          }

          if (i < 2) {
            console.log('ç­‰å¾…1ç§’åé‡è¯•...');
            await new Promise<void>(resolve => setTimeout(resolve, 1000));
          }
        }
      }

      // å¦‚æœå¤šæ¬¡å°è¯•éƒ½å¤±è´¥ï¼Œæä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
      console.error('æ‰€æœ‰æƒé™ç”³è¯·å°è¯•éƒ½å¤±è´¥äº†');
      promptAction.showToast({
        message: 'éº¦å…‹é£æƒé™ç”³è¯·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿè®¾ç½®æˆ–é‡å¯åº”ç”¨',
        duration: 4000
      });

      return false;
    } catch (error) {
      console.error('ç”³è¯·éº¦å…‹é£æƒé™å¤±è´¥:', error);
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      console.error('é”™è¯¯è¯¦æƒ…:', errorMessage);

      promptAction.showToast({
        message: 'æƒé™ç”³è¯·å¤±è´¥: ' + errorMessage,
        duration: 4000
      });
      return false;
    }
  }

  // æ£€æµ‹æ˜¯å¦ä¸ºè™šæ‹Ÿæœºç¯å¢ƒ
  private isVirtualMachine(): boolean {
    try {
      // åœ¨ArkTSä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•æ£€æµ‹ç¯å¢ƒ
      // é€šè¿‡å°è¯•è·å–ä¸€äº›çœŸæœºç‰¹æœ‰çš„APIæ¥åˆ¤æ–­
      const context = getContext();

      // æ£€æŸ¥æ˜¯å¦æœ‰çœŸå®çš„éº¦å…‹é£è®¾å¤‡
      // åœ¨çœŸæœºä¸Šï¼Œéº¦å…‹é£æƒé™ç”³è¯·ä¼šæˆåŠŸï¼Œåœ¨æ¨¡æ‹Ÿå™¨ä¸Šå¯èƒ½ä¼šå¤±è´¥
      // è¿™é‡Œæˆ‘ä»¬é»˜è®¤è¿”å›falseï¼Œè¡¨ç¤ºçœŸæœºç¯å¢ƒ
      return false;
    } catch (error) {
      console.log('è®¾å¤‡æ£€æµ‹å¤±è´¥ï¼Œé»˜è®¤ä½¿ç”¨çœŸæœºæ¨¡å¼:', error);
      return false; // é»˜è®¤ä½¿ç”¨çœŸæœºæ¨¡å¼
    }
  }



  private async startRecord() {
    try {
      console.log('å¼€å§‹å½•éŸ³æµç¨‹...');

      // æ£€æŸ¥éº¦å…‹é£æƒé™
      if (!this.hasMicrophonePermission) {
        console.log('éº¦å…‹é£æƒé™æœªæˆæƒï¼Œå°è¯•ç”³è¯·æƒé™...');

        // æ˜¾ç¤ºæƒé™ç”³è¯·æç¤º
        promptAction.showToast({
          message: 'æ­£åœ¨ç”³è¯·éº¦å…‹é£æƒé™...',
          duration: 1000
        });

        const granted = await this.requestMicrophonePermission();
        if (!granted) {
          console.error('éº¦å…‹é£æƒé™ç”³è¯·å¤±è´¥ï¼Œæ— æ³•å½•éŸ³');
          // æ˜¾ç¤ºæ›´è¯¦ç»†çš„æç¤ºä¿¡æ¯
          promptAction.showToast({
            message: 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ‰‹åŠ¨å¼€å¯éº¦å…‹é£æƒé™',
            duration: 4000
          });
          return;
        }
        this.hasMicrophonePermission = true;

        // æƒé™è·å¾—åï¼Œå»¶è¿Ÿä¸€ä¸‹å†å¼€å§‹å½•éŸ³
        setTimeout(() => {
          this.startRecordingProcess();
        }, 1000);
        return;
      }

      // å¦‚æœå·²æœ‰æƒé™ï¼Œå†æ¬¡ç¡®è®¤æƒé™çŠ¶æ€
      const currentPermission = await AudioCapturerManager.checkMicrophonePermission();
      if (!currentPermission) {
        console.log('æƒé™çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°ç”³è¯·æƒé™...');
        this.hasMicrophonePermission = false;
        this.startRecord();
        return;
      }

      // å¦‚æœå·²æœ‰æƒé™ï¼Œç›´æ¥å¼€å§‹å½•éŸ³
      this.startRecordingProcess();
    } catch (error) {
      console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
      this.isRecording = false;
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      promptAction.showToast({
        message: 'å½•éŸ³å¯åŠ¨å¤±è´¥: ' + errorMessage,
        duration: 2000
      });
    }
  }

  // æ–°å¢ï¼šå®é™…çš„å½•éŸ³å¼€å§‹æµç¨‹
  private async startRecordingProcess(): Promise<void> {
    try {
      this.isRecording = true;
      this.recordDuration = 0;
      this.fileName = Date.now().toString();

      console.log('å½•éŸ³æ–‡ä»¶å:', this.fileName);

      // æ£€æµ‹ç¯å¢ƒå¹¶é€‰æ‹©å½•éŸ³æ–¹å¼
      const isVM = this.isVirtualMachine();
      console.log('å½“å‰ç¯å¢ƒ:', isVM ? 'è™šæ‹Ÿæœº' : 'çœŸæœº');

      if (isVM) {
        // è™šæ‹Ÿæœºç¯å¢ƒï¼šæ¨¡æ‹Ÿå½•éŸ³
        console.log('è™šæ‹Ÿæœºç¯å¢ƒï¼Œä½¿ç”¨æ¨¡æ‹Ÿå½•éŸ³');
        this.simulateRecord();
      } else {
        // çœŸæœºç¯å¢ƒï¼šçœŸå®å½•éŸ³
        console.log('çœŸæœºç¯å¢ƒï¼Œä½¿ç”¨çœŸå®å½•éŸ³');

        // å†æ¬¡æ£€æŸ¥æƒé™
        const hasPermission = await AudioCapturerManager.checkMicrophonePermission();
        if (!hasPermission) {
          console.error('å½•éŸ³å‰æƒé™æ£€æŸ¥å¤±è´¥');
          this.isRecording = false;
          this.hasMicrophonePermission = false;
          promptAction.showToast({
            message: 'éº¦å…‹é£æƒé™æœªæˆæƒï¼Œè¯·é‡æ–°ç”³è¯·æƒé™',
            duration: 2000
          });
          return;
        }

        const filePath = await AudioCapturerManager.startRecord(this.fileName);
        if (!filePath) {
          console.error('å½•éŸ³å¼€å§‹å¤±è´¥');
          this.isRecording = false;
          promptAction.showToast({
            message: 'å½•éŸ³å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™å’Œè®¾å¤‡çŠ¶æ€',
            duration: 3000
          });
          return;
        }
        console.log('å½•éŸ³å¼€å§‹æˆåŠŸï¼Œæ–‡ä»¶è·¯å¾„:', filePath);
      }

      // å¼€å§‹è®¡æ—¶
      this.recordTimer = setInterval(() => {
        this.recordDuration += 1;
        console.log('å½•éŸ³æ—¶é•¿:', this.recordDuration, 'ç§’');
      }, 1000);

    } catch (error) {
      console.error('å½•éŸ³æµç¨‹å¯åŠ¨å¤±è´¥:', error);
      this.isRecording = false;
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      promptAction.showToast({
        message: 'å½•éŸ³æµç¨‹å¯åŠ¨å¤±è´¥: ' + errorMessage,
        duration: 2000
      });
    }
  }

  // æ¨¡æ‹Ÿå½•éŸ³åŠŸèƒ½
  private simulateRecord() {
    // æ¨¡æ‹Ÿå½•éŸ³æ–‡ä»¶ç”Ÿæˆ
    console.log('æ¨¡æ‹Ÿå½•éŸ³æ–‡ä»¶ç”Ÿæˆ:', this.fileName);
  }

  private async stopAndSendRecord() {
    try {
      console.log('åœæ­¢å½•éŸ³å¹¶å‘é€...');

      clearInterval(this.recordTimer);
      clearInterval(this.volumeTimer);
      this.isRecording = false;

      // æ£€æŸ¥å½•éŸ³æ—¶é•¿
      if (this.recordDuration < 1) {
        console.log('å½•éŸ³æ—¶é•¿å¤ªçŸ­ï¼Œå–æ¶ˆå‘é€');
        this.recordDuration = 0;
        this.isCancelRecord = false;
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å–æ¶ˆå½•éŸ³
      if (this.isCancelRecord) {
        console.log('ç”¨æˆ·å–æ¶ˆå½•éŸ³');
        this.recordDuration = 0;
        this.isCancelRecord = false;
        return;
      }

      const isVM = this.isVirtualMachine();
      console.log('åœæ­¢å½•éŸ³ï¼Œç¯å¢ƒ:', isVM ? 'è™šæ‹Ÿæœº' : 'çœŸæœº');

      if (isVM) {
        // è™šæ‹Ÿæœºç¯å¢ƒï¼šæ¨¡æ‹Ÿå½•éŸ³ç»“æŸ
        console.log('è™šæ‹Ÿæœºç¯å¢ƒï¼Œæ¨¡æ‹Ÿå½•éŸ³ç»“æŸ');
        this.simulateVoiceRecognition();
      } else {
        // çœŸæœºç¯å¢ƒï¼šçœŸå®å½•éŸ³ç»“æŸ
        console.log('çœŸæœºç¯å¢ƒï¼Œåœæ­¢çœŸå®å½•éŸ³');
        const stopSuccess = await AudioCapturerManager.stopRecord();
        if (!stopSuccess) {
          console.error('å½•éŸ³åœæ­¢å¤±è´¥');
          promptAction.showToast({
            message: 'å½•éŸ³åœæ­¢å¤±è´¥',
            duration: 2000
          });
          return;
        }

        // æ£€æŸ¥å½•éŸ³æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        const filePath = AudioCapturerManager.getRecordFilePath();
        console.log('å½•éŸ³æ–‡ä»¶è·¯å¾„:', filePath);

        // å¼€å§‹è¯­éŸ³è¯†åˆ«
        this.recognizeAudioFile(this.fileName);
      }

      this.recordDuration = 0;
      this.isCancelRecord = false;

    } catch (error) {
      console.error('åœæ­¢å½•éŸ³å¤±è´¥:', error);
      this.recordDuration = 0;
      this.isCancelRecord = false;
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      promptAction.showToast({
        message: 'å½•éŸ³å¤„ç†å¤±è´¥: ' + errorMessage,
        duration: 2000
      });
    }
  }

  // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«
  private simulateVoiceRecognition() {
    // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ
    const mockText = 'è¿™æ˜¯æ¨¡æ‹Ÿçš„è¯­éŸ³è¯†åˆ«ç»“æœ';
    console.log('æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«ç»“æœ:', mockText);
    this.sendVoiceMessage(this.fileName, this.recordDuration, mockText);
  }

  private recognizeAudioFile(fileName: string) {
    console.log('å¼€å§‹è¯­éŸ³è¯†åˆ«ï¼Œæ–‡ä»¶å:', fileName);

    // æ˜¾ç¤ºè¯†åˆ«ä¸­æç¤º
    promptAction.showToast({
      message: 'æ­£åœ¨è¯†åˆ«è¯­éŸ³...',
      duration: 2000
    });

    SpeechRecognizerManager.init2((res) => {
      console.log('è¯­éŸ³è¯†åˆ«ç»“æœ:', res);
      let text = res.result || 'æœªè¯†åˆ«åˆ°è¯­éŸ³å†…å®¹';

      if (text && text !== 'æœªè¯†åˆ«åˆ°è¯­éŸ³å†…å®¹' && !text.includes('å¤±è´¥')) {
        console.log('è¯­éŸ³è¯†åˆ«æˆåŠŸ:', text);
        this.sendVoiceMessage(fileName, this.recordDuration, text);
      } else {
        console.log('è¯­éŸ³è¯†åˆ«å¤±è´¥æˆ–ç»“æœä¸ºç©º');
        promptAction.showToast({
          message: 'è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•',
          duration: 2000
        });
        this.sendVoiceMessage(fileName, this.recordDuration, 'è¯­éŸ³è¯†åˆ«å¤±è´¥');
      }
    }, fileName);
  }

  private sendVoiceMessage(fileName: string, duration: number, text: string) {
    // è¯­éŸ³è¯†åˆ«å®Œæˆåï¼Œè‡ªåŠ¨è°ƒç”¨sendMessageè¿›è¡ŒAIå¯¹è¯
    if (text && text !== 'æœªè¯†åˆ«åˆ°è¯­éŸ³å†…å®¹') {
      // å°†è¯†åˆ«å‡ºçš„æ–‡æœ¬ä½œä¸ºç”¨æˆ·è¾“å…¥ï¼Œè°ƒç”¨sendMessage
      this.inputText = text; // è®¾ç½®è¾“å…¥æ–‡æœ¬
      this.sendMessage(); // è°ƒç”¨AIå¯¹è¯
    } else {
      // å¦‚æœè¯†åˆ«å¤±è´¥ï¼Œæ˜¾ç¤ºè¯­éŸ³æ¶ˆæ¯
      const newMessage: ChatMessage = {
        id: this.chatData.length + 1,
        isMe: true,
        avatar: $r('app.media.splash'),
        content: '[è¯­éŸ³] æœªè¯†åˆ«åˆ°è¯­éŸ³å†…å®¹',
        time: new Date().toLocaleTimeString().slice(0, 5),
        type: 'voice',
        duration: duration,
      };
      this.chatData = [...this.chatData, newMessage];
      this.scrollToBottom();
    }
  }
}