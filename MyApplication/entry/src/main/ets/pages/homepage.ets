// homepage.ets - è¶…çº§åŠ¨æ€é¡µé¢
import { BottomNavBar } from './BottomNavBar';
import { ApiService } from '../service/apiservice';
import { globalUserData } from '../models/userdata';
import { Dynamic } from '../models/aidata';

@Entry
@Component
export struct HomePage {
  @State dynamics: Dynamic[] = [] // åŠ¨æ€åˆ—è¡¨
  @State isLoading: boolean = false // åŠ è½½çŠ¶æ€
  @State isRefreshing: boolean = false // åˆ·æ–°çŠ¶æ€
  @State currentPage: number = 1 // å½“å‰é¡µç 
  @State hasMore: boolean = true // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
  @State errorMessage: string = '' // é”™è¯¯ä¿¡æ¯
  private pageSize: number = 10 // æ¯é¡µæ•°é‡

  aboutToAppear() {
    this.loadDynamics(true)
  }

  // åŠ è½½åŠ¨æ€æ•°æ®
  async loadDynamics(isRefresh: boolean = false) {
    if (this.isLoading) return

    try {
      this.isLoading = true
      this.errorMessage = ''

      if (isRefresh) {
        this.currentPage = 1
        this.hasMore = true
      }

      console.log('ğŸ”„ å¼€å§‹åŠ è½½åŠ¨æ€ï¼Œé¡µç :', this.currentPage)
      
      const newDynamics = await ApiService.getAllPublicDynamics(this.currentPage, this.pageSize)
      console.log('âœ… è·å–åˆ°åŠ¨æ€æ•°æ®:', newDynamics.length, 'æ¡')

      if (isRefresh) {
        this.dynamics = newDynamics
      } else {
        this.dynamics = [...this.dynamics, ...newDynamics]
      }

      // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
      this.hasMore = newDynamics.length === this.pageSize
      
      if (!isRefresh && this.hasMore) {
        this.currentPage++
      }

      console.log('ğŸ“Š å½“å‰åŠ¨æ€æ€»æ•°:', this.dynamics.length, 'æ˜¯å¦è¿˜æœ‰æ›´å¤š:', this.hasMore)
    } catch (error) {
      console.error('âŒ åŠ è½½åŠ¨æ€å¤±è´¥:', error)
      this.errorMessage = error instanceof Error ? error.message : 'åŠ è½½å¤±è´¥'
    } finally {
      this.isLoading = false
      this.isRefreshing = false
    }
  }

  // ä¸‹æ‹‰åˆ·æ–°
  onRefresh() {
    console.log('ğŸ”„ è§¦å‘ä¸‹æ‹‰åˆ·æ–°')
    this.isRefreshing = true
    this.loadDynamics(true)
  }

  // ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onLoadMore() {
    if (this.hasMore && !this.isLoading) {
      console.log('ğŸ“¥ è§¦å‘ä¸Šæ‹‰åŠ è½½æ›´å¤š')
      this.loadDynamics(false)
    }
  }

  // å¯¼èˆªåˆ°å‘å¸ƒåŠ¨æ€é¡µé¢
  navigateToPublish() {
    let uiContext: UIContext = this.getUIContext();
    let router = uiContext.getRouter();
    router.pushUrl({ url: 'pages/DynamicList' });
  }

  // å¯¼èˆªåˆ°ä¸ªäººé¡µé¢
  navigateToProfile() {
    let uiContext: UIContext = this.getUIContext();
    let router = uiContext.getRouter();
    router.pushUrl({ url: 'pages/yourpage' });
  }

  // æ ¼å¼åŒ–æ—¶é—´
  formatTime(timeString: string): string {
    if (!timeString) return ''
    
    try {
      const date = new Date(timeString)
      const now = new Date()
      const diff = now.getTime() - date.getTime()
      
      const minutes = Math.floor(diff / (1000 * 60))
      const hours = Math.floor(diff / (1000 * 60 * 60))
      const days = Math.floor(diff / (1000 * 60 * 60 * 24))
      
      if (minutes < 1) return 'åˆšåˆš'
      if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`
      if (hours < 24) return `${hours}å°æ—¶å‰`
      if (days < 7) return `${days}å¤©å‰`
      
      return date.toLocaleDateString()
    } catch (error) {
      return timeString
    }
  }

  // åŠ¨æ€å¡ç‰‡ç»„ä»¶
  @Builder
  DynamicCard(dynamic: Dynamic) {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯è¡Œ
      Row() {
        Image(dynamic.userAvatar || '/common/media/default.png')
          .width(40)
          .height(40)
          .borderRadius(20)
          .margin({ right: 12 })
        
        Column() {
          Text(dynamic.userName || 'åŒ¿åç”¨æˆ·')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333333')
          
          Text(this.formatTime(dynamic.createTime))
            .fontSize(12)
            .fontColor('#999999')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)
        
        // æ›´å¤šæŒ‰é’®
        Button('â‹¯')
          .fontSize(20)
          .fontColor('#999999')
          .backgroundColor(Color.Transparent)
          .width(32)
          .height(32)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      
      // åŠ¨æ€å†…å®¹
      if (dynamic.content) {
        Text(dynamic.content)
          .fontSize(15)
          .fontColor('#333333')
          .lineHeight(22)
          .textAlign(TextAlign.Start)
          .width('100%')
          .padding({ left: 16, right: 16, bottom: 8 })
      }
      
      // å›¾ç‰‡å†…å®¹
      if (dynamic.images && dynamic.images.length > 0) {
        Grid() {
          ForEach(dynamic.images, (image: string, index: number) => {
            GridItem() {
              Image(image)
                .width('100%')
                .height(120)
                .borderRadius(8)
                .objectFit(ImageFit.Cover)
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr')
        .columnsGap(4)
        .rowsGap(4)
        .padding({ left: 16, right: 16, bottom: 8 })
      }
      
      // è¯é¢˜æ ‡ç­¾
      if (dynamic.topicTags && dynamic.topicTags.length > 0) {
        Flex({ wrap: FlexWrap.Wrap }) {
          ForEach(dynamic.topicTags, (tag: string) => {
            Text(`#${tag}`)
              .fontSize(12)
              .fontColor('#0D9FFB')
              .backgroundColor('#F0F8FF')
              .padding({ left: 8, right: 8, top: 4, bottom: 4 })
              .borderRadius(12)
              .margin({ right: 8, bottom: 4 })
          })
        }
        .padding({ left: 16, right: 16, bottom: 8 })
      }
      
      // æ“ä½œæŒ‰é’®è¡Œ
      Row() {
        // ç‚¹èµæŒ‰é’®
        Row() {
          Text('â¤ï¸')
            .fontSize(16)
            .margin({ right: 4 })
          Text(dynamic.likeCount?.toString() || '0')
            .fontSize(14)
            .fontColor('#666666')
        }
        .onClick(() => {
          // TODO: å®ç°ç‚¹èµåŠŸèƒ½
          console.log('ç‚¹èµåŠ¨æ€:', dynamic.id)
        })
        
        // è¯„è®ºæŒ‰é’®
        Row() {
          Text('ğŸ’¬')
            .fontSize(16)
            .margin({ right: 4 })
          Text(dynamic.commentCount?.toString() || '0')
            .fontSize(14)
            .fontColor('#666666')
        }
        .margin({ left: 24 })
        .onClick(() => {
          // TODO: å®ç°è¯„è®ºåŠŸèƒ½
          console.log('è¯„è®ºåŠ¨æ€:', dynamic.id)
        })
        
        // åˆ†äº«æŒ‰é’®
        Row() {
          Text('ğŸ“¤')
            .fontSize(16)
            .margin({ right: 4 })
          Text('åˆ†äº«')
            .fontSize(14)
            .fontColor('#666666')
        }
        .margin({ left: 24 })
        .onClick(() => {
          // TODO: å®ç°åˆ†äº«åŠŸèƒ½
          console.log('åˆ†äº«åŠ¨æ€:', dynamic.id)
        })
      }
      .width('100%')
      .padding({ left: 16, right: 16, bottom: 12 })
      .justifyContent(FlexAlign.Start)
    }
    .backgroundColor(Color.White)
    .borderRadius(12)
    .margin({ bottom: 12 })
    .shadow({ radius: 4, color: '#00000010', offsetX: 0, offsetY: 2 })
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Text('åŠ¨æ€å¹¿åœº')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          
          Blank()
          
          // å‘å¸ƒæŒ‰é’®
          Button('å‘å¸ƒ')
            .fontSize(14)
            .fontColor(Color.White)
            .backgroundColor('#0D9FFB')
            .borderRadius(16)
            .padding({ left: 16, right: 16, top: 6, bottom: 6 })
            .onClick(() => {
              this.navigateToPublish()
            })
          
          // ä¸ªäººä¸­å¿ƒæŒ‰é’®
          Button() {
            Image(globalUserData.userAvatar || '/common/media/default.png')
              .width(32)
              .height(32)
              .borderRadius(16)
          }
          .backgroundColor(Color.Transparent)
          .margin({ left: 12 })
          .onClick(() => {
            this.navigateToProfile()
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor(Color.White)
        .shadow({ radius: 2, color: '#00000010', offsetX: 0, offsetY: 1 })
        
        // åŠ¨æ€åˆ—è¡¨
        Refresh({ refreshing: $$this.isRefreshing, offset: 120, friction: 100 }) {
          List() {
            // åŠ¨æ€å¡ç‰‡
            ForEach(this.dynamics, (dynamic: Dynamic) => {
              ListItem() {
                this.DynamicCard(dynamic)
              }
            })
            
            // åŠ è½½æ›´å¤šæŒ‡ç¤ºå™¨
            if (this.isLoading && this.dynamics.length > 0) {
              ListItem() {
                Row() {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                    .margin({ right: 8 })
                  Text('åŠ è½½ä¸­...')
                    .fontSize(14)
                    .fontColor('#999999')
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .padding({ top: 20, bottom: 20 })
              }
            }
            
            // æ²¡æœ‰æ›´å¤šæ•°æ®æç¤º
            if (!this.hasMore && this.dynamics.length > 0) {
              ListItem() {
                Text('æ²¡æœ‰æ›´å¤šåŠ¨æ€äº†')
                  .fontSize(14)
                  .fontColor('#999999')
                  .width('100%')
                  .textAlign(TextAlign.Center)
                  .padding({ top: 20, bottom: 20 })
              }
            }
            
            // ç©ºçŠ¶æ€
            if (!this.isLoading && this.dynamics.length === 0 && !this.errorMessage) {
              ListItem() {
                Column() {
                  Text('ğŸ“')
                    .fontSize(80)
                    .margin({ bottom: 16 })
                  Text('æš‚æ— åŠ¨æ€')
                    .fontSize(16)
                    .fontColor('#999999')
                  Text('å¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€å§ï¼')
                    .fontSize(14)
                    .fontColor('#CCCCCC')
                    .margin({ top: 8 })
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .padding({ top: 100, bottom: 100 })
              }
            }
            
            // é”™è¯¯çŠ¶æ€
            if (this.errorMessage) {
              ListItem() {
                Column() {
                  Text('âŒ')
                    .fontSize(80)
                    .margin({ bottom: 16 })
                  Text('åŠ è½½å¤±è´¥')
                    .fontSize(16)
                    .fontColor('#FF4D4F')
                  Text(this.errorMessage)
                    .fontSize(14)
                    .fontColor('#999999')
                    .margin({ top: 8 })
                  Button('é‡è¯•')
                    .fontSize(14)
                    .fontColor(Color.White)
                    .backgroundColor('#0D9FFB')
                    .borderRadius(16)
                    .padding({ left: 24, right: 24, top: 8, bottom: 8 })
                    .margin({ top: 16 })
                    .onClick(() => {
                      this.loadDynamics(true)
                    })
                }
                .width('100%')
                .justifyContent(FlexAlign.Center)
                .padding({ top: 100, bottom: 100 })
              }
            }
          }
          .width('100%')
          .height('100%')
          .padding({ left: 16, right: 16 })
          .onReachEnd(() => {
            this.onLoadMore()
          })
        }
        .onRefreshing(() => {
          this.onRefresh()
        })
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F5F5F5')
      
      // åº•éƒ¨å¯¼èˆªæ 
      BottomNavBar({ currentIndex: 0 })
    }
  }
}