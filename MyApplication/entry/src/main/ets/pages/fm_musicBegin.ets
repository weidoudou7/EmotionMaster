import router from '@ohos.router';
import { BusinessError } from '@kit.BasicServicesKit';
import promptAction from '@ohos.promptAction';

// éŸ³ä¹ä¿¡æ¯æ¥å£
interface MusicInfo {
  id: string;
  title: string;
  artist: string;
  album: string;
  duration: number; // æ€»æ—¶é•¿ï¼ˆç§’ï¼‰
  coverImage: Resource;
  audioUrl: string;
  lyrics?: string[];
}

// æ’­æ”¾åˆ—è¡¨é¡¹æ¥å£
interface PlaylistItem {
  id: string;
  title: string;
  artist: string;
  duration: number;
  isPlaying: boolean;
}

@Entry
@Component
struct FMMusicBegin {
  @State currentMusic: MusicInfo | null = null;
  @State isPlaying: boolean = false;
  @State currentTime: number = 0; // å½“å‰æ’­æ”¾æ—¶é—´ï¼ˆç§’ï¼‰
  @State volume: number = 0.7; // éŸ³é‡ 0-1
  @State showPlaylist: boolean = false;
  @State repeatMode: 'none' | 'one' | 'all' = 'none'; // æ’­æ”¾æ¨¡å¼
  @State shuffleMode: boolean = false; // éšæœºæ’­æ”¾
  @State showLyrics: boolean = false; // æ˜¯å¦æ˜¾ç¤ºæ­Œè¯
  @State currentLyricIndex: number = 0; // å½“å‰æ­Œè¯ç´¢å¼•
  
  // ä»è·¯ç”±å‚æ•°è·å–éŸ³ä¹ä¿¡æ¯
  @State musicId: string = '';
  @State musicTitle: string = '';
  @State musicArtist: string = '';
  @State musicCover: Resource = $r('app.media.fmhome_fashionMusic');

  // æ¨¡æ‹Ÿæ’­æ”¾åˆ—è¡¨
  private playlist: PlaylistItem[] = [
    { id: '1', title: 'å¤œæ›²', artist: 'å‘¨æ°ä¼¦', duration: 240, isPlaying: false },
    { id: '2', title: 'ç¨»é¦™', artist: 'å‘¨æ°ä¼¦', duration: 210, isPlaying: false },
    { id: '3', title: 'é’èŠ±ç“·', artist: 'å‘¨æ°ä¼¦', duration: 235, isPlaying: false },
    { id: '4', title: 'èŠèŠ±å°', artist: 'å‘¨æ°ä¼¦', duration: 245, isPlaying: false },
    { id: '5', title: 'å‘å¦‚é›ª', artist: 'å‘¨æ°ä¼¦', duration: 230, isPlaying: false }
  ];

  // æ¨¡æ‹Ÿæ­Œè¯
  private lyrics: string[] = [
    'å¤œæ›² - å‘¨æ°ä¼¦',
    '',
    'ä¸ºä½ å¼¹å¥è§é‚¦çš„å¤œæ›²',
    'çºªå¿µæˆ‘æ­»å»çš„çˆ±æƒ…',
    'è€Œæˆ‘ä¸ºä½ éšå§“åŸ‹å',
    'åœ¨æœˆå…‰ä¸‹å¼¹ç´',
    '',
    'å¯¹ä½ å¿ƒè·³çš„æ„Ÿåº”',
    'è¿˜æ˜¯å¦‚æ­¤æ¸©çƒ­äº²è¿‘',
    'æ€€å¿µä½ é‚£é²œçº¢çš„å”‡å°',
    '',
    'é‚£äº›æ–­ç¿…çš„èœ»èœ“',
    'æ•£è½åœ¨è¿™æ£®æ—',
    'è€Œæˆ‘çš„çœ¼ç›',
    'æ²¡æœ‰ä¸æ¯«åŒæƒ…',
    '',
    'å¤±å»ä½ æ³ªæ°´æ··æµŠä¸æ¸…',
    'å¤±å»ä½ æˆ‘è¿ç¬‘å®¹éƒ½æœ‰é˜´å½±',
    'é£åœ¨é•¿æ»¡é’è‹”çš„å±‹é¡¶',
    'å˜²ç¬‘æˆ‘çš„ä¼¤å¿ƒ',
    '',
    'åƒä¸€å£æ²¡æœ‰æ°´çš„æ¯äº•',
    'æˆ‘ç”¨å‡„ç¾çš„å­—å‹',
    'æç»˜åæ‚”è«åŠçš„é‚£çˆ±æƒ…'
  ];

  aboutToAppear() {
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as Record<string, string>;
    this.musicId = params?.musicId || '1';
    this.musicTitle = params?.musicTitle || 'å¤œæ›²';
    this.musicArtist = params?.musicArtist || 'å‘¨æ°ä¼¦';
    
    // æ ¹æ®éŸ³ä¹ç±»å‹è®¾ç½®å°é¢
    const musicType = params?.musicType || 'fashion';
    switch(musicType) {
      case 'fashion':
        this.musicCover = $r('app.media.fmhome_fashionMusic');
        break;
      case 'classic':
        this.musicCover = $r('app.media.fmhome_classicMusic');
        break;
      case 'soft':
        this.musicCover = $r('app.media.fmhome_softMusic');
        break;
    }

    // åˆå§‹åŒ–å½“å‰éŸ³ä¹ä¿¡æ¯
    this.currentMusic = {
      id: this.musicId,
      title: this.musicTitle,
      artist: this.musicArtist,
      album: 'ä¸“è¾‘åç§°',
      duration: 240,
      coverImage: this.musicCover,
      audioUrl: '',
      lyrics: this.lyrics
    } as MusicInfo;

    // æ›´æ–°æ’­æ”¾åˆ—è¡¨çŠ¶æ€
    this.updatePlaylistStatus();
  }

  // æ›´æ–°æ’­æ”¾åˆ—è¡¨çŠ¶æ€
  updatePlaylistStatus() {
    this.playlist = this.playlist.map(item => {
      return {
        id: item.id,
        title: item.title,
        artist: item.artist,
        duration: item.duration,
        isPlaying: item.id === this.musicId
      } as PlaylistItem;
    });
  }

  // æ’­æ”¾/æš‚åœ
  togglePlay() {
    this.isPlaying = !this.isPlaying;
    if (this.isPlaying) {
      this.startPlayback();
    } else {
      this.pausePlayback();
    }
  }

  // å¼€å§‹æ’­æ”¾
  startPlayback() {
    // æ¨¡æ‹Ÿæ’­æ”¾è¿›åº¦æ›´æ–°
    this.simulatePlayback();
  }

  // æš‚åœæ’­æ”¾
  pausePlayback() {
    // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šæš‚åœéŸ³é¢‘æ’­æ”¾
    console.log('æš‚åœæ’­æ”¾');
  }

  // æ¨¡æ‹Ÿæ’­æ”¾è¿›åº¦
  simulatePlayback() {
    if (this.isPlaying && this.currentTime < (this.currentMusic?.duration || 0)) {
      setTimeout(() => {
        this.currentTime += 1;
        this.updateLyricIndex();
        this.simulatePlayback();
      }, 1000);
    }
  }

  // æ›´æ–°æ­Œè¯ç´¢å¼•
  updateLyricIndex() {
    if (this.currentMusic?.lyrics) {
      // ç®€å•çš„æ­Œè¯åŒæ­¥é€»è¾‘
      const progress = this.currentTime / (this.currentMusic.duration || 1);
      const newIndex = Math.floor(progress * this.currentMusic.lyrics.length);
      if (newIndex !== this.currentLyricIndex && newIndex < this.currentMusic.lyrics.length) {
        this.currentLyricIndex = newIndex;
      }
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  // åˆ‡æ¢æ’­æ”¾æ¨¡å¼
  toggleRepeatMode() {
    switch(this.repeatMode) {
      case 'none':
        this.repeatMode = 'one';
        break;
      case 'one':
        this.repeatMode = 'all';
        break;
      case 'all':
        this.repeatMode = 'none';
        break;
    }
  }

  // åˆ‡æ¢éšæœºæ’­æ”¾
  toggleShuffle() {
    this.shuffleMode = !this.shuffleMode;
  }

  // ä¸Šä¸€é¦–
  previousTrack() {
    const currentIndex = this.playlist.findIndex(item => item.id === this.musicId);
    if (currentIndex > 0) {
      const prevTrack = this.playlist[currentIndex - 1];
      this.musicId = prevTrack.id;
      this.musicTitle = prevTrack.title;
      this.musicArtist = prevTrack.artist;
      this.currentTime = 0;
      this.updatePlaylistStatus();
    }
  }

  // ä¸‹ä¸€é¦–
  nextTrack() {
    const currentIndex = this.playlist.findIndex(item => item.id === this.musicId);
    if (currentIndex < this.playlist.length - 1) {
      const nextTrack = this.playlist[currentIndex + 1];
      this.musicId = nextTrack.id;
      this.musicTitle = nextTrack.title;
      this.musicArtist = nextTrack.artist;
      this.currentTime = 0;
      this.updatePlaylistStatus();
    }
  }

  build() {
    Stack() {
      // èƒŒæ™¯æ¸å˜
      Column() {
        Blank()
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#2d2d2d')

      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Button('â€¹')
            .fontSize(24)
            .fontColor('#fff')
            .backgroundColor('rgba(255,255,255,0.1)')
            .borderRadius(20)
            .width(40)
            .height(40)
            .onClick(() => router.back())

          Column() {
            Text(this.musicTitle)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#fff')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
            Text(this.musicArtist)
              .fontSize(14)
              .fontColor('#ccc')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
          .layoutWeight(1)
          .margin({ left: 16, right: 16 })

          Button('â‹®')
            .fontSize(20)
            .fontColor('#fff')
            .backgroundColor('rgba(255,255,255,0.1)')
            .borderRadius(20)
            .width(40)
            .height(40)
            .onClick(() => {
              this.showPlaylist = !this.showPlaylist;
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 16 })

        // ä¸»è¦å†…å®¹åŒºåŸŸ
        Column() {
          // ä¸“è¾‘å°é¢
          Stack() {
            Image(this.musicCover)
              .width(280)
              .height(280)
              .borderRadius(20)
              .objectFit(ImageFit.Cover)
              .shadow({ radius: 20, color: 'rgba(0,0,0,0.3)', offsetX: 0, offsetY: 10 })

            // æ’­æ”¾çŠ¶æ€æŒ‡ç¤º
            if (this.isPlaying) {
              Column() {
                Text('â™ª')
                  .fontSize(48)
                  .fontColor('#fff')
                  .backgroundColor('rgba(0,0,0,0.5)')
                  .borderRadius(24)
                  .width(48)
                  .height(48)
                  .textAlign(TextAlign.Center)
              }
              .position({ x: '50%', y: '50%' })
              .translate({ x: -24, y: -24 })
            }
          }
          .margin({ top: 40, bottom: 40 })

          // éŸ³ä¹ä¿¡æ¯
          Column() {
            Text(this.musicTitle)
              .fontSize(24)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 8 })

            Text(this.musicArtist)
              .fontSize(16)
              .fontColor('#ccc')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 24 })
          }

          // è¿›åº¦æ¡
          Column() {
            Row() {
              Text(this.formatTime(this.currentTime))
                .fontSize(12)
                .fontColor('#999')
              Slider({
                value: this.currentTime,
                min: 0,
                max: this.currentMusic?.duration || 100,
                step: 1
              })
                .width('100%')
                .layoutWeight(1)
                .margin({ left: 12, right: 12 })
                .onChange((value: number) => {
                  this.currentTime = value;
                })
              Text(this.formatTime(this.currentMusic?.duration || 0))
                .fontSize(12)
                .fontColor('#999')
            }
            .width('100%')
            .alignItems(VerticalAlign.Center)
          }
          .margin({ bottom: 32 })

          // æ§åˆ¶æŒ‰é’®
          Row() {
            // æ’­æ”¾æ¨¡å¼
            Button(this.repeatMode === 'none' ? 'ğŸ”' : this.repeatMode === 'one' ? 'ğŸ”‚' : 'ğŸ”')
              .fontSize(20)
              .fontColor(this.repeatMode !== 'none' ? '#0D9FFB' : '#ccc')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(20)
              .width(40)
              .height(40)
              .onClick(() => this.toggleRepeatMode())

            // ä¸Šä¸€é¦–
            Button('â®')
              .fontSize(24)
              .fontColor('#fff')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(25)
              .width(50)
              .height(50)
              .margin({ left: 16 })
              .onClick(() => this.previousTrack())

            // æ’­æ”¾/æš‚åœ
            Button(this.isPlaying ? 'â¸' : 'â–¶')
              .fontSize(32)
              .fontColor('#fff')
              .backgroundColor('#0D9FFB')
              .borderRadius(35)
              .width(70)
              .height(70)
              .margin({ left: 16, right: 16 })
              .onClick(() => this.togglePlay())

            // ä¸‹ä¸€é¦–
            Button('â­')
              .fontSize(24)
              .fontColor('#fff')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(25)
              .width(50)
              .height(50)
              .margin({ right: 16 })
              .onClick(() => this.nextTrack())

            // éšæœºæ’­æ”¾
            Button('ğŸ”€')
              .fontSize(20)
              .fontColor(this.shuffleMode ? '#0D9FFB' : '#ccc')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(20)
              .width(40)
              .height(40)
              .onClick(() => this.toggleShuffle())
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .alignItems(VerticalAlign.Center)
          .margin({ bottom: 32 })

          // åº•éƒ¨åŠŸèƒ½æŒ‰é’®
          Row() {
            Button('ğŸ’¬')
              .fontSize(20)
              .fontColor('#ccc')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(20)
              .width(40)
              .height(40)
              .onClick(() => {
                this.showLyrics = !this.showLyrics;
              })

            Button('â¤ï¸')
              .fontSize(20)
              .fontColor('#ccc')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(20)
              .width(40)
              .height(40)
              .margin({ left: 16 })
              .onClick(() => {
                promptAction.showToast({ message: 'å·²æ·»åŠ åˆ°æ”¶è—' });
              })

            Button('ğŸ“¤')
              .fontSize(20)
              .fontColor('#ccc')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(20)
              .width(40)
              .height(40)
              .margin({ left: 16 })
              .onClick(() => {
                promptAction.showToast({ message: 'åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­' });
              })

            Button('ğŸ“')
              .fontSize(20)
              .fontColor('#ccc')
              .backgroundColor('rgba(255,255,255,0.1)')
              .borderRadius(20)
              .width(40)
              .height(40)
              .margin({ left: 16 })
              .onClick(() => {
                promptAction.showToast({ message: 'è¯„è®ºåŠŸèƒ½å¼€å‘ä¸­' });
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
        }
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
      }
      .width('100%')
      .height('100%')

      // æ’­æ”¾åˆ—è¡¨å¼¹çª—
      if (this.showPlaylist) {
        Column() {
          // åŠé€æ˜èƒŒæ™¯
          Blank()
            .width('100%')
            .height('100%')
            .backgroundColor('#000000')
            .opacity(0.5)
            .onClick(() => {
              this.showPlaylist = false;
            })

          // æ’­æ”¾åˆ—è¡¨å†…å®¹
          Column() {
            // æ ‡é¢˜æ 
            Row() {
              Text('æ’­æ”¾åˆ—è¡¨')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#fff')
              Button('Ã—')
                .fontSize(20)
                .fontColor('#fff')
                .backgroundColor('rgba(255,255,255,0.1)')
                .borderRadius(15)
                .width(30)
                .height(30)
                .onClick(() => {
                  this.showPlaylist = false;
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .alignItems(VerticalAlign.Center)
            .padding({ left: 16, right: 16, top: 16, bottom: 16 })

            // æ’­æ”¾åˆ—è¡¨
            List() {
              ForEach(this.playlist, (item: PlaylistItem) => {
                ListItem() {
                  Row() {
                    Column() {
                      Text(item.title)
                        .fontSize(16)
                        .fontColor(item.isPlaying ? '#0D9FFB' : '#fff')
                        .fontWeight(item.isPlaying ? FontWeight.Bold : FontWeight.Normal)
                      Text(item.artist)
                        .fontSize(14)
                        .fontColor('#ccc')
                        .margin({ top: 4 })
                    }
                    .layoutWeight(1)

                    if (item.isPlaying) {
                      Text('â™ª')
                        .fontSize(16)
                        .fontColor('#0D9FFB')
                        .margin({ right: 8 })
                    }

                    Text(this.formatTime(item.duration))
                      .fontSize(14)
                      .fontColor('#999')
                  }
                  .width('100%')
                  .padding({ top: 12, bottom: 12 })
                  .onClick(() => {
                    this.musicId = item.id;
                    this.musicTitle = item.title;
                    this.musicArtist = item.artist;
                    this.currentTime = 0;
                    this.updatePlaylistStatus();
                    this.showPlaylist = false;
                  })
                }
              })
            }
            .width('100%')
            .layoutWeight(1)
            .padding({ left: 16, right: 16 })
          }
          .width('100%')
          .height('60%')
          .backgroundColor('#2d2d2d')
          .borderRadius({ topLeft: 20, topRight: 20 })
          .position({ x: 0, y: '40%' })
        }
        .width('100%')
        .height('100%')
      }

      // æ­Œè¯å¼¹çª—
      if (this.showLyrics) {
        Column() {
          // åŠé€æ˜èƒŒæ™¯
          Blank()
            .width('100%')
            .height('100%')
            .backgroundColor('#000000')
            .opacity(0.5)
            .onClick(() => {
              this.showLyrics = false;
            })

          // æ­Œè¯å†…å®¹
          Column() {
            // æ ‡é¢˜æ 
            Row() {
              Text('æ­Œè¯')
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor('#fff')
              Button('Ã—')
                .fontSize(20)
                .fontColor('#fff')
                .backgroundColor('rgba(255,255,255,0.1)')
                .borderRadius(15)
                .width(30)
                .height(30)
                .onClick(() => {
                  this.showLyrics = false;
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .alignItems(VerticalAlign.Center)
            .padding({ left: 16, right: 16, top: 16, bottom: 16 })

            // æ­Œè¯åˆ—è¡¨
            List() {
              ForEach(this.currentMusic?.lyrics || [], (lyric: string, index: number) => {
                ListItem() {
                  Text(lyric)
                    .fontSize(index === this.currentLyricIndex ? 18 : 16)
                    .fontColor(index === this.currentLyricIndex ? '#0D9FFB' : '#ccc')
                    .fontWeight(index === this.currentLyricIndex ? FontWeight.Bold : FontWeight.Normal)
                    .textAlign(TextAlign.Center)
                    .width('100%')
                    .padding({ top: 8, bottom: 8 })
                }
              })
            }
            .width('100%')
            .layoutWeight(1)
            .padding({ left: 16, right: 16 })
          }
          .width('100%')
          .height('80%')
          .backgroundColor('#2d2d2d')
          .borderRadius({ topLeft: 20, topRight: 20 })
          .position({ x: 0, y: '20%' })
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
  }
} 