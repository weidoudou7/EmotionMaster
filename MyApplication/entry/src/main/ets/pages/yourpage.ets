//yourpage.ets
// å¯¼å…¥é¡µé¢è·¯ç”±æ¨¡å—
import { BusinessError } from '@kit.BasicServicesKit';
import { globalUserData } from '../models/userdata';
import { ApiService } from '../service/apiservice';
import { UserInfo, UserStats, Dynamic } from '../common/types';
import promptAction from '@ohos.promptAction';
import preferences from '@ohos.data.preferences';
import { Config } from '../common/config';

@Entry
@Component
export struct YourPage {
  @State yourname: string = globalUserData.userName; //ç”¨æˆ·åç§°
  @State UID: string = globalUserData.userUID; //ç”¨æˆ·UID
  @State ooo: boolean = globalUserData.isPrivacyVisible; //ç”¨æˆ·éšç§
  @State message: string = 'Image';
  @State avatarScale: number = 1.0; // å¤´åƒç¼©æ”¾åŠ¨ç”»
  @State isLoading: boolean = false; // åŠ è½½çŠ¶æ€
  @State userInfo: UserInfo | null = null; // ç”¨æˆ·ä¿¡æ¯
  @State userStats: UserStats | null = null; // ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
  @State selectedTab: string = 'dynamic' // å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µï¼šdynamic æˆ– attic
  @State selectedAtticTab: string = 'æ™ºèƒ½ä½“' // å½“å‰é€‰ä¸­çš„é˜æ¥¼æ ‡ç­¾é¡µ
  @State cardScale: number = 1.0; // å¡ç‰‡ç¼©æ”¾åŠ¨ç”»
  @State latestDynamic: Dynamic | null = null; // æœ€æ–°åŠ¨æ€

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    // ä½¿ç”¨å…¨å±€æ•°æ®å¿«é€Ÿåˆå§‹åŒ–ï¼Œé¿å…ç­‰å¾…API
    this.yourname = globalUserData.userName;
    this.UID = globalUserData.userUID;
    this.ooo = globalUserData.isPrivacyVisible;
    
    // å¼‚æ­¥åŠ è½½è¯¦ç»†ä¿¡æ¯ï¼Œä¸é˜»å¡é¡µé¢æ˜¾ç¤º
    this.loadUserInfoAsync();
    this.loadUserStatsAsync();
    this.loadLatestDynamicAsync();
  }

  // å¼‚æ­¥åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
  async loadUserInfoAsync() {
    try {
      const userInfo = await ApiService.getUserInfo(this.UID);
      this.userInfo = userInfo;
      this.yourname = userInfo.userName;
      this.UID = userInfo.userUID;
      this.ooo = userInfo.isPrivacyVisible;
      
      // å¤„ç†å¤´åƒURLæ‹¼æ¥
      if (userInfo.userAvatar && userInfo.userAvatar.startsWith('/')) {
        const apiBaseUrl = Config.getApiBaseUrl();
        const serverBaseUrl = apiBaseUrl.replace('/api', ''); // ç§»é™¤APIè·¯å¾„
        
        // æ£€æŸ¥å¹¶ä¿®æ­£é”™è¯¯çš„è·¯å¾„
        let correctedAvatarUrl = userInfo.userAvatar;
        if (userInfo.userAvatar.startsWith('/images/')) {
          console.log('ğŸ‘¤ [YourPage] æ£€æµ‹åˆ°é”™è¯¯çš„/images/è·¯å¾„ï¼Œä¿®æ­£ä¸º/avatars/');
          correctedAvatarUrl = userInfo.userAvatar.replace('/images/', '/avatars/');
        }
        
        const fullAvatarUrl = serverBaseUrl + correctedAvatarUrl;
        console.log('ğŸ‘¤ [YourPage] æ‹¼æ¥åçš„å®Œæ•´å¤´åƒURL:', fullAvatarUrl);
        this.userInfo.userAvatar = fullAvatarUrl;
      }
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
    }
  }

  // å¼‚æ­¥åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
  async loadUserStatsAsync() {
    try {
      const userStats = await ApiService.getUserStats(this.UID);
      this.userStats = userStats;
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œå› ä¸ºç»Ÿè®¡ä¿¡æ¯ä¸æ˜¯æ ¸å¿ƒåŠŸèƒ½
    }
  }

  // å¼‚æ­¥åŠ è½½æœ€æ–°åŠ¨æ€ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
  async loadLatestDynamicAsync() {
    try {
      const context = getContext(this);
      const preferencesHelper = await preferences.getPreferences(context, 'userData');
      const latestDynamicStr = await preferencesHelper.get('latestDynamic', '') as string;
      
      if (latestDynamicStr) {
        this.latestDynamic = JSON.parse(latestDynamicStr);
      }
    } catch (error) {
      console.error('åŠ è½½æœ€æ–°åŠ¨æ€å¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œå› ä¸ºåŠ¨æ€ä¿¡æ¯ä¸æ˜¯æ ¸å¿ƒåŠŸèƒ½
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  formatTime(timeString: string): string {
    const date = new Date(timeString);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (minutes < 1) return 'åˆšåˆš';
    if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
    if (hours < 24) return `${hours}å°æ—¶å‰`;
    if (days < 7) return `${days}å¤©å‰`;
    
    return date.toLocaleDateString();
  }

  // ä¸ªäººèµ„æ–™è¯¦æƒ…åˆ‡æ¢é¡µé¢è°ƒå‡ºçš„æ„å»ºå‡½æ•°
  @Builder
  build() {
    Stack() {
      // æ¸å˜èƒŒæ™¯
      Column() {
        Blank().width('100%').height('100%')
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [['#1a1a2e', 0.0], ['#16213e', 0.3], ['#0f3460', 0.7], ['#533483', 1.0]]
          })
      }
      .width('100%')
      .height('100%')
      
      // è£…é¥°æ€§èƒŒæ™¯å…ƒç´ 
      Column() {
        // é¡¶éƒ¨è£…é¥°å…ƒç´ 
        Row() {
          Image($r('app.media.deroration_1'))
            .width(200)
            .height(200)
            .opacity(0.1)
            .position({ x: -100, y: -50 })
          Image($r('app.media.deroration_2'))
            .width(150)
            .height(150)
            .opacity(0.08)
            .position({ x: 300, y: -30 })
        }
        .width('100%')
        .height(60)
        
        Blank().layoutWeight(1)
        
        // åº•éƒ¨è£…é¥°å…ƒç´ 
        Row() {
          Image($r('app.media.deroration_3'))
            .width(180)
            .height(180)
            .opacity(0.08)
            .position({ x: -80, y: 20 })
          Image($r('app.media.deroration_4'))
            .width(120)
            .height(120)
            .opacity(0.1)
            .position({ x: 320, y: 40 })
        }
        .width('100%')
        .height(80)
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(1)
      
      // ä¸»ä½“å†…å®¹
      Scroll() {
        Column() {
          // ä¸ŠåŠéƒ¨åˆ†ï¼šä¸ªäººä¿¡æ¯å¡ç‰‡
          Column() {
            // 1. å¤´åƒ+åç§°+UID å¡ç‰‡åŒºåŸŸï¼ˆåŒ…å«å³ä¾§æŒ‰é’®ï¼‰
            Row() {
              // å·¦ä¾§ï¼šå¤´åƒ+åç§°+UID å¡ç‰‡
              Stack() {
                // å¡ç‰‡
                Row() {
                  // å¤´åƒ
                  Image(this.userInfo?.userAvatar ? this.userInfo.userAvatar : $r("app.media.image"))
                    .width(80)
                    .height(80)
                    .borderRadius(40)
                    .margin({ top: 2, right: 20 })
                    .backgroundColor('rgba(255,255,255,0.1)')
                    .border({ width: 2, color: 'rgba(255,255,255,0.3)' })
                    .scale({ x: this.avatarScale, y: this.avatarScale })
                    .animation({
                      duration: 120,
                      curve: Curve.EaseInOut
                    })
                    .onClick(() => {
                      this.avatarScale = 0.92;
                      setTimeout(() => {
                        this.avatarScale = 1.0;
                        let uiContext: UIContext = this.getUIContext();
                        let router = uiContext.getRouter();
                        router.pushUrl({ url: 'pages/infopage' });
                      }, 120);
                    })
                  // åç§°å’ŒUID
                  Column() {
                    Text(this.yourname)
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#fff')
                      .margin({ bottom: 2 })
                      .textAlign(TextAlign.Start)
                    Text(`UID: ${this.UID}`)
                      .fontSize(13)
                      .fontColor('rgba(255,255,255,0.6)')
                      .margin({ bottom: 4 })
                      .textAlign(TextAlign.Start)
                    Text(`æ€§åˆ«: ${this.userInfo?.gender || 'æœªè®¾ç½®'}`)
                      .fontSize(13)
                      .fontColor('rgba(255,255,255,0.6)')
                      .textAlign(TextAlign.Start)
                  }
                  .alignItems(HorizontalAlign.Start)
                  .width('70%')
                }
                .width('100%')
                .scale({ x: this.cardScale, y: this.cardScale })
                .animation({
                  duration: 200,
                  curve: Curve.EaseInOut
                })
                .onClick(() => {
                  this.cardScale = 0.98;
                  setTimeout(() => {
                    this.cardScale = 1.0;
                  }, 200);
                })
              }
              .width('70%')
              .padding({ left: 16 })
              
              // å³ä¾§å°å¡ç‰‡
              Column() {
                // è®¾ç½®æŒ‰é’®
                Button() {
                  Image($r('app.media.setting'))
                    .width(28)
                    .height(28)
                    .fillColor('#fff')
                }
                .width(48)
                .height(23)
                .backgroundColor('rgba(128,128,128,0)')
                .borderRadius(24)
                .margin({ bottom: 4 })
                .onClick(() => {
                  let uiContext: UIContext = this.getUIContext();
                  let router = uiContext.getRouter();
                  router.pushUrl({ url: 'pages/infopage' });
                })
                
                // åŠ¨æ€æŒ‰é’®
                Button() {
                  Image($r('app.media.dynamic'))
                    .width(28)
                    .height(28)
                    .fillColor('#fff')
                }
                .width(48)
                .height(48)
                .backgroundColor('rgba(128,128,128,0)')
                .borderRadius(24)
                .margin({ bottom: 4 })
                .onClick(() => {
                  let uiContext: UIContext = this.getUIContext();
                  let router = uiContext.getRouter();
                  router.pushUrl({ url: 'pages/DynamicList' });
                })
              }
              .width('20%')
              .height('100%')
              .justifyContent(FlexAlign.End)
              .alignItems(HorizontalAlign.Center)
            }
            .width('90%')
            .height(100)
            .margin({ top: 12, bottom: 2 })
            
            // 2. ä¸ªæ€§ç­¾åå’Œç¤¾äº¤ä¿¡æ¯
            Row() {
              // å·¦ä¾§ï¼šä¸ªæ€§ç­¾å
              Column() {
                // ä¸ªæ€§ç­¾å
                Column() {
                  Text('ä¸ªæ€§ç­¾å')
                    .fontSize(15)
                    .fontColor('#fff')
                    .margin({ bottom: 8 })
                  Text(this.userInfo?.signature || 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡ç•™ä¸‹~')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.8)')
                    .textAlign(TextAlign.Start)
                    .maxLines(2)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                }
                .alignItems(HorizontalAlign.Start)
                .margin({ bottom: 4 })
                
                // ç¤¾äº¤ä¿¡æ¯æŒ‰é’®
                Row() {
                  // æŸ¥æ‰¾æŒ‰é’®æ”¾åœ¨æœ€å‰é¢
                  Button('æŸ¥æ‰¾')
                    .width(80)
                    .height(28)
                    .fontSize(10)
                    .backgroundColor('rgba(0,128,255,0)')
                    .fontColor('#fff')
                    .borderRadius(14)
                    .margin({ right: 8 })
                    .onClick(() => {
                      let uiContext: UIContext = this.getUIContext();
                      let router = uiContext.getRouter();
                      router.pushUrl({ url: 'pages/searchpage' });
                    })
                  
                  ForEach([
                    `å…³æ³¨:${this.userStats?.followingCount || 0}`,
                    `ç²‰ä¸:${this.userStats?.followerCount || 0}`,
                    `å¥½å‹:${this.userStats?.friendCount || 0}`
                  ], (label: string, index: number) => {
                    Button(label)
                      .width(62)
                      .height(28)
                      .fontSize(10)
                      .backgroundColor('rgba(128,128,128,0)')
                      .fontColor('#fff')
                      .borderRadius(14)
                      .margin({ right: 6 })
                      .onClick(() => {
                        promptAction.showToast({ message: 'å¥½å‹åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­' });
                      })
                  })
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
              }
              .width('70%')
              .padding({ left: 16 })
              
              // å³ä¾§ç©ºç™½åŒºåŸŸï¼Œä¿æŒä¸å¤´åƒå¡ç‰‡å¸ƒå±€ä¸€è‡´
              Blank()
                .width('20%')
            }
            .width('90%')
            .margin({ bottom: 2 })
            
            // 3. åº•éƒ¨ä¸¤ä¸ªæŒ‰é’®
            Row() {
              // å·¦ä¾§ï¼šæŒ‰é’®åŒºåŸŸ
              Row() {
                Column() {
                  Button('æˆ‘çš„é˜æ¥¼')
                    .fontSize(15)
                    .backgroundColor('rgba(128,128,128,0)')
                    .fontColor('#fff')
                    .borderRadius(20)
                    .onClick(() => {
                      this.selectedTab = 'attic';
                    })
                  if (this.selectedTab === 'attic') {
                    Divider()
                      .width(80)
                      .height(2)
                      .color('#fff')
                      .margin({ top: 2 })
                  }
                }
                .margin({ right: 12 })
                
                Column() {
                  Button('æˆ‘çš„åŠ¨æ€')
                    .fontSize(15)
                    .backgroundColor('rgba(128,128,128,0)')
                    .fontColor('#fff')
                    .borderRadius(20)
                    .onClick(() => {
                      this.selectedTab = 'dynamic';
                    })
                  if (this.selectedTab === 'dynamic') {
                    Divider()
                      .width(80)
                      .height(2)
                      .color('#fff')
                      .margin({ top: 2 })
                  }
                }
              }
              .width('70%')
              .padding({ left: 16 })
              .justifyContent(FlexAlign.Start)
              
              // å³ä¾§ç©ºç™½åŒºåŸŸ
              Blank()
                .width('20%')
            }
            .width('90%')
            .margin({ bottom: 2 })
            
            // 4. é˜æ¥¼å†…å®¹æ˜¾ç¤º
            Column() {
              if (this.selectedTab === 'attic') {
                // é˜æ¥¼äº”ä¸ªæ ‡ç­¾é¡µå¯¼èˆªæ ï¼ˆæ”¯æŒæ»‘åŠ¨ï¼‰
                Scroll() {
                  Row() {
                    ForEach(["æ™ºèƒ½ä½“", "æ•…äº‹", "æ—¶åˆ»", "ç¾¤èŠ", "è®°å¿†ç°¿"], (tab: string, index: number) => {
                      Column() {
                        Button(tab)
                          .fontSize(12)
                          .backgroundColor('rgba(128,128,128,0)')
                          .fontColor('#fff')
                          .borderRadius(12)
                          .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                          .onClick(() => {
                            this.selectedAtticTab = tab;
                          })
                        if (this.selectedAtticTab === tab) {
                          Divider()
                            .width(40)
                            .height(2)
                            .color('#fff')
                            .margin({ top: 2 })
                        }
                      }
                      .margin({ right: 12 })
                    })
                  }
                  .width('100%')
                }
                .scrollable(ScrollDirection.Horizontal)
                .scrollBar(BarState.Off)
                .width('100%')
                .margin({ bottom: 8 })
                
                // é˜æ¥¼å†…å®¹æ˜¾ç¤ºåŒºåŸŸ
                Column() {
                  Text('æ²¡æœ‰å¯ç”¨çš„å†…å®¹')
                    .fontSize(16)
                    .fontColor('rgba(255,255,255,0.5)')
                    .textAlign(TextAlign.Center)
                }
                .width('100%')
                .height(120)
                .backgroundColor('rgba(255,255,255,0.08)')
                .borderRadius(16)
                .justifyContent(FlexAlign.Center)
              } else if (this.selectedTab === 'dynamic') {
                // åŠ¨æ€é¢„è§ˆå†…å®¹
                Column() {
                  Text('æˆ‘çš„åŠ¨æ€')
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#fff')
                    .margin({ bottom: 16 })
                  
                  // æœ€è¿‘ä¸€æ¡åŠ¨æ€é¢„è§ˆ
                  if (this.latestDynamic) {
                    Column() {
                      Text(this.latestDynamic.content.length > 50 ? 
                        this.latestDynamic.content.substring(0, 50) + '...' : 
                        this.latestDynamic.content)
                        .fontSize(14)
                        .fontColor('rgba(255,255,255,0.8)')
                        .textAlign(TextAlign.Start)
                        .margin({ bottom: 8 })
                      Text(this.formatTime(this.latestDynamic.createTime))
                        .fontSize(12)
                        .fontColor('rgba(255,255,255,0.5)')
                        .textAlign(TextAlign.Start)
                    }
                    .width('100%')
                    .height(120)
                    .backgroundColor('rgba(255,255,255,0.08)')
                    .borderRadius(16)
                    .padding(16)
                    .justifyContent(FlexAlign.Start)
                    .onClick(() => {
                      let uiContext: UIContext = this.getUIContext();
                      let router = uiContext.getRouter();
                      router.pushUrl({ url: 'pages/DynamicList' });
                    })
                  } else {
                    Column() {
                      Text('è¿˜æ²¡æœ‰å‘å¸ƒè¿‡åŠ¨æ€')
                        .fontSize(14)
                        .fontColor('rgba(255,255,255,0.6)')
                        .textAlign(TextAlign.Center)
                      Text('ç‚¹å‡»å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€å§')
                        .fontSize(12)
                        .fontColor('rgba(255,255,255,0.4)')
                        .textAlign(TextAlign.Center)
                        .margin({ top: 8 })
                    }
                    .width('100%')
                    .height(120)
                    .backgroundColor('rgba(255,255,255,0.08)')
                    .borderRadius(16)
                    .padding(16)
                    .justifyContent(FlexAlign.Center)
                    .onClick(() => {
                      let uiContext: UIContext = this.getUIContext();
                      let router = uiContext.getRouter();
                      router.pushUrl({ url: 'pages/DynamicList' });
                    })
                  }
                }
                .width('100%')
              }
            }
            .width('90%')
            .height('50%')
            .margin({ bottom: 4 })
          }
          .width('100%')
        }
        .width('100%')
        .padding({ top: 0 })
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Off)
      .width('100%')
      .height('100%')
      .zIndex(2)
    }
  }
} 