//yourpage.ets
// å¯¼å…¥é¡µé¢è·¯ç”±æ¨¡å—
import { BusinessError } from '@kit.BasicServicesKit';
import { globalUserData } from '../models/userdata';
import { ApiService } from '../service/apiservice';
import { UserInfo, UserStats, Dynamic } from '../common/types';
import { Config } from '../common/config';
import promptAction from '@ohos.promptAction';
import preferences from '@ohos.data.preferences';

@Entry
@Component
export struct YourPage {
  @State yourname: string = globalUserData.userName; //ç”¨æˆ·åç§°
  @State UID: string = globalUserData.userUID; //ç”¨æˆ·UID
  @State ooo: boolean = globalUserData.isPrivacyVisible; //ç”¨æˆ·éšç§
  @State message: string = 'Image';
  @State avatarScale: number = 1.0; // å¤´åƒç¼©æ”¾åŠ¨ç”»
  @State isLoading: boolean = false; // åŠ è½½çŠ¶æ€
  @State userInfo: UserInfo | null = null; // ç”¨æˆ·ä¿¡æ¯
  @State userStats: UserStats | null = null; // ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
  @State selectedTab: string = 'dynamic' // å½“å‰é€‰ä¸­çš„æ ‡ç­¾é¡µï¼šdynamic æˆ– attic
  @State selectedAtticTab: string = 'æ™ºèƒ½ä½“' // å½“å‰é€‰ä¸­çš„é˜æ¥¼æ ‡ç­¾é¡µ
  @State cardScale: number = 1.0; // å¡ç‰‡ç¼©æ”¾åŠ¨ç”»
  @State latestDynamic: Dynamic | null = null; // æœ€æ–°åŠ¨æ€
  @State lastClickTime: number = 0; // ä¸Šæ¬¡ç‚¹å‡»æ—¶é—´ï¼Œç”¨äºåŒå‡»æ£€æµ‹
  @State userAvatar: Resource | string = $r("app.media.image"); // ç”¨æˆ·å¤´åƒ
  @State showAvatarViewer: boolean = false; // æ˜¾ç¤ºå¤´åƒæŸ¥çœ‹å™¨
  @State lastAtticClickTime: number = 0; // é˜æ¥¼æ ‡ç­¾ä¸Šæ¬¡ç‚¹å‡»
  // é“¶æ²³ç³»åŠ¨ç”»çŠ¶æ€
  @State arcRotation: number = 0 // åœ†å¼§æ—‹è½¬è§’åº¦
  @State starTwinkle: number = 0 // æ˜Ÿæ˜Ÿé—ªçƒæ•ˆæœ
  @State glowOpacity: number = 0.5 // å‘å…‰æ•ˆæœé€æ˜åº¦
  @State textOpacity: number = 0.8 // æ–‡å­—é€æ˜åº¦
  @State nebulaOpacity: number = 0.3 // æ˜Ÿäº‘é€æ˜åº¦

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    // ä½¿ç”¨å…¨å±€æ•°æ®å¿«é€Ÿåˆå§‹åŒ–ï¼Œé¿å…ç­‰å¾…API
    this.yourname = globalUserData.userName;
    this.UID = globalUserData.userUID;
    this.ooo = globalUserData.isPrivacyVisible;
    
    // å¯åŠ¨é“¶æ²³ç³»åŠ¨ç”»
    this.startGalaxyAnimations();
    
    // å¼‚æ­¥åŠ è½½è¯¦ç»†ä¿¡æ¯ï¼Œä¸é˜»å¡é¡µé¢æ˜¾ç¤º
    this.loadUserInfoAsync();
    this.loadUserStatsAsync();
    this.loadLatestDynamicAsync();
  }

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
  onPageShow() {
    // åˆ·æ–°ç”¨æˆ·ä¿¡æ¯ï¼Œç¡®ä¿å¤´åƒæ˜¯æœ€æ–°çš„
    this.loadUserInfoAsync();
  }

  // é“¶æ²³ç³»åŠ¨ç”»
  private startGalaxyAnimations() {
    // åœ†å¼§æ—‹è½¬åŠ¨ç”»
    setInterval(() => {
      this.arcRotation += 1.5
    }, 50)
    
    // æ˜Ÿæ˜Ÿé—ªçƒåŠ¨ç”»
    setInterval(() => {
      this.starTwinkle += 0.1
    }, 100)
    
    // å‘å…‰æ•ˆæœåŠ¨ç”»
    setInterval(() => {
      this.glowOpacity = this.glowOpacity === 0.5 ? 0.8 : 0.5
    }, 1200)
    
    // æ–‡å­—é€æ˜åº¦åŠ¨ç”»
    setInterval(() => {
      this.textOpacity = this.textOpacity === 0.8 ? 1.0 : 0.8
    }, 1800)
    
    // æ˜Ÿäº‘é€æ˜åº¦åŠ¨ç”»
    setInterval(() => {
      this.nebulaOpacity = this.nebulaOpacity === 0.3 ? 0.6 : 0.3
    }, 3000)
  }

  // å¼‚æ­¥åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
  async loadUserInfoAsync() {
    try {
      console.log('ğŸ‘¤ [yourpage] å¼€å§‹åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨æˆ·UID:', this.UID);
      
      const userInfo = await ApiService.getUserInfo(this.UID);
      this.userInfo = userInfo;
      this.yourname = userInfo.userName;
      this.UID = userInfo.userUID;
      this.ooo = userInfo.isPrivacyVisible;

      // æ›´æ–°å¤´åƒæ˜¾ç¤º
      await this.updateAvatarDisplay(userInfo.userAvatar);
      
      console.log('ğŸ‘¤ [yourpage] ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆ');
    } catch (error) {
      console.error('ğŸ‘¤ [yourpage] åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
    }
  }

  // æ›´æ–°å¤´åƒæ˜¾ç¤º
  async updateAvatarDisplay(avatarUrl: string | undefined) {
    console.log('ğŸ–¼ï¸ [yourpage] å¼€å§‹æ›´æ–°å¤´åƒæ˜¾ç¤º');
    console.log('ğŸ–¼ï¸ [yourpage] åŸå§‹å¤´åƒURL:', avatarUrl);
    
    if (avatarUrl && avatarUrl !== '/avatars/default.png' && avatarUrl !== '') {
      // å¦‚æœæœ‰åç«¯å¤´åƒï¼Œä½¿ç”¨åç«¯å¤´åƒ
      let processedAvatarUrl = avatarUrl;
      
      // å¤„ç†å¤´åƒURL - å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥å®Œæ•´URL
      if (avatarUrl.startsWith('/')) {
        const baseUrl = Config.getApiBaseUrl().replace('/api', '');
        processedAvatarUrl = baseUrl + avatarUrl;
        console.log('ğŸ–¼ï¸ [yourpage] å¤„ç†åçš„å¤´åƒURL:', processedAvatarUrl);
      }
      
      this.userAvatar = processedAvatarUrl;
      console.log('ğŸ–¼ï¸ [yourpage] å¤´åƒæ›´æ–°æˆåŠŸ');
    } else {
      // ä½¿ç”¨é»˜è®¤å¤´åƒ
      this.userAvatar = $r("app.media.image");
      console.log('ğŸ–¼ï¸ [yourpage] ä½¿ç”¨é»˜è®¤å¤´åƒ');
    }
  }

  // è·å–å¤´åƒURLï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
  getAvatarUrl(): Resource | string {
    return this.userAvatar;
  }

  // æ˜¾ç¤ºå¤´åƒæŸ¥çœ‹å™¨
  showAvatarViewerDialog() {
    this.showAvatarViewer = true;
  }

  // å…³é—­å¤´åƒæŸ¥çœ‹å™¨
  closeAvatarViewer() {
    this.showAvatarViewer = false;
  }

  // å¼‚æ­¥åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
  async loadUserStatsAsync() {
    try {
      const userStats = await ApiService.getUserStats(this.UID);
      this.userStats = userStats;
    } catch (error) {
      console.error('åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œå› ä¸ºç»Ÿè®¡ä¿¡æ¯ä¸æ˜¯æ ¸å¿ƒåŠŸèƒ½
    }
  }

  // å¼‚æ­¥åŠ è½½æœ€æ–°åŠ¨æ€ï¼ˆä¸é˜»å¡é¡µé¢æ˜¾ç¤ºï¼‰
  async loadLatestDynamicAsync() {
    try {
      const context = getContext(this);
      const preferencesHelper = await preferences.getPreferences(context, 'userData');
      const latestDynamicStr = await preferencesHelper.get('latestDynamic', '') as string;
      
      if (latestDynamicStr) {
        this.latestDynamic = JSON.parse(latestDynamicStr);
      }
    } catch (error) {
      console.error('åŠ è½½æœ€æ–°åŠ¨æ€å¤±è´¥:', error);
      // ä¸æ˜¾ç¤ºé”™è¯¯æç¤ºï¼Œå› ä¸ºåŠ¨æ€ä¿¡æ¯ä¸æ˜¯æ ¸å¿ƒåŠŸèƒ½
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  formatTime(timeString: string): string {
    const date = new Date(timeString);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (minutes < 1) return 'åˆšåˆš';
    if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
    if (hours < 24) return `${hours}å°æ—¶å‰`;
    if (days < 7) return `${days}å¤©å‰`;
    
    return date.toLocaleDateString();
  }

  // ä¸ªäººèµ„æ–™è¯¦æƒ…åˆ‡æ¢é¡µé¢è°ƒå‡ºçš„æ„å»ºå‡½æ•°
  @Builder
  build() {
    Stack() {
      // æ·±è‰²æ¸å˜èƒŒæ™¯ - æ”¹ä¸ºçº¯é»‘è‰²ä¸»é¢˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#000000', 0.0], ['#0a0a0a', 0.5], ['#1a1a1a', 1.0]]
        })
      
      // æ—‹è½¬çš„åœ†å¼§èƒŒæ™¯ - æ”¹ä¸ºé»‘è‰²ç³»è£…é¥°
      Stack() {
        // å¤šä¸ªåŒå¿ƒåœ†å¼§è½¨é“
        ForEach([0, 1, 2, 3], (index: number) => {
          Stack() {
            // åœ†å¼§è½¨é“ - æ”¹ä¸ºæ·±ç°è‰²
            Column()
              .width(250 + index * 60)
              .height(250 + index * 60)
              .borderRadius((250 + index * 60) / 2)
              .border({ width: 1, color: `rgba(64, 64, 64, ${0.3 - index * 0.05})` })
              .position({ x: '50%', y: '50%' })
              .translate({ x: -(250 + index * 60) / 2, y: -(250 + index * 60) / 2 })
            
            // æ—‹è½¬çš„åœ†å¼§ç‚¹ - æ”¹ä¸ºç™½è‰²ç³»
            Column()
              .width(6)
              .height(6)
              .backgroundColor(`rgba(255, 255, 255, ${0.6 - index * 0.1})`)
              .borderRadius(3)
              .position({ x: '50%', y: '50%' })
              .translate({ 
                x: -3 + Math.cos((this.arcRotation + index * 90) * Math.PI / 180) * (125 + index * 30),
                y: -3 + Math.sin((this.arcRotation + index * 90) * Math.PI / 180) * (125 + index * 30)
              })
          }
        })
        
        // å¤–åœˆè£…é¥°ç‚¹ - æ”¹ä¸ºé“¶è‰²ç³»
        ForEach([0, 1, 2, 3, 4, 5], (index: number) => {
          Column()
            .width(6)
            .height(6)
            .backgroundColor(`rgba(192, 192, 192, ${0.4 - index * 0.05})`)
            .borderRadius(3)
            .position({ x: '50%', y: '50%' })
            .translate({ 
              x: -3 + Math.cos((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120,
              y: -3 + Math.sin((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120
            })
        })
      }
      .width('100%')
      .height('100%')
      
      // ä¸»ä½“å†…å®¹
      Scroll() {
        Column() {
          // ä¸ŠåŠéƒ¨åˆ†ï¼šä¸ªäººä¿¡æ¯å¡ç‰‡
          Column() {
            // 1. å¤´åƒ+åç§°+UID å¡ç‰‡åŒºåŸŸï¼ˆåŒ…å«å³ä¾§æŒ‰é’®ï¼‰
            Row() {
              // å·¦ä¾§ï¼šå¤´åƒ+åç§°+UID å¡ç‰‡
              Stack() {
                // å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
                Column()
                  .width('100%')
                  .height('auto')
                  .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
                  .borderRadius(20)
                  .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
                
                Row() {
                  // å¤´åƒ - æ”¹ä¸ºé¢„è§ˆå™¨æ ·å¼æ˜¾ç¤º
                  Stack() {
                    // å¤´åƒå›¾ç‰‡ - å¤§å°ºå¯¸æ˜¾ç¤º
                    Image(this.getAvatarUrl())
                      .width(120)
                      .height(120)
                      .borderRadius(60)
                      .backgroundColor('rgba(255,255,255,0.1)')
                      .border({ width: 3, color: 'rgba(255,255,255,0.3)' })
                      .scale({ x: this.avatarScale, y: this.avatarScale })
                      .animation({
                        duration: 120,
                        curve: Curve.EaseInOut
                      })
                      .objectFit(ImageFit.Cover)
                      .onClick(() => {
                        this.avatarScale = 0.92;
                        setTimeout(() => {
                          this.avatarScale = 1.0;
                          this.showAvatarViewerDialog();
                        }, 120);
                      })
                  }
                  .margin({ top: 2, right: 20 })
                  
                  // åç§°å’ŒUID
                  Column() {
                    Text(this.yourname)
                      .fontSize(24)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#fff')
                      .opacity(this.textOpacity)
                      .margin({ bottom: 2 })
                      .textAlign(TextAlign.Start)
                    Text(`UID: ${this.UID}`)
                      .fontSize(13)
                      .fontColor('rgba(255,255,255,0.6)')
                      .opacity(this.textOpacity)
                      .margin({ bottom: 4 })
                      .textAlign(TextAlign.Start)
                    Text(`æ€§åˆ«: ${this.userInfo?.gender || 'æœªè®¾ç½®'}`)
                      .fontSize(13)
                      .fontColor('rgba(255,255,255,0.6)')
                      .opacity(this.textOpacity)
                      .textAlign(TextAlign.Start)
                  }
                  .layoutWeight(1)
                  .justifyContent(FlexAlign.Start)
                }
                .padding({ left: 20, right: 20, top: 20, bottom: 20 })
              }
              .width('100%')
              .backgroundColor('rgba(255, 255, 255, 0.03)')
              .borderRadius(20)
              .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
              .shadow({ radius: 12, color: '#00000030', offsetX: 0, offsetY: 4 })
              .layoutWeight(1)
              .margin({ right: 12 })

              // å³ä¾§ï¼šæŒ‰é’®ç»„
              Column() {
                // æŸ¥æ‰¾æŒ‰é’®
                Stack() {
                  // æŒ‰é’®èƒŒæ™¯å‘å…‰æ•ˆæœ
                  Column()
                    .width('100%')
                    .height('100%')
                    .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
                    .borderRadius(12)
                    .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
                  
                  Column() {
                    Text('ğŸ”')
                      .fontSize(20)
                      .fontColor('#ffffff')
                      .opacity(this.textOpacity)
                  }
                  .width('100%')
                  .height('100%')
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                }
                .width(50)
                .height(50)
                .backgroundColor('rgba(255, 255, 255, 0.03)')
                .borderRadius(12)
                .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
                .shadow({ radius: 6, color: '#00000020', offsetX: 0, offsetY: 2 })
                .onClick(() => {
                  let uiContext: UIContext = this.getUIContext();
                  let router = uiContext.getRouter();
                  router.pushUrl({ url: 'pages/searchpage' });
                })
                .margin({ bottom: 8 })

                // è®¾ç½®æŒ‰é’®
                Stack() {
                  // æŒ‰é’®èƒŒæ™¯å‘å…‰æ•ˆæœ
                  Column()
                    .width('100%')
                    .height('100%')
                    .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
                    .borderRadius(12)
                    .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
                  
                  Column() {
                    Image($r('app.media.setting'))
                      .width(20)
                      .height(20)
                      .fillColor('#ffffff')
                      .opacity(this.textOpacity)
                  }
                  .width('100%')
                  .height('100%')
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                }
                .width(50)
                .height(50)
                .backgroundColor('rgba(255, 255, 255, 0.03)')
                .borderRadius(12)
                .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
                .shadow({ radius: 6, color: '#00000020', offsetX: 0, offsetY: 2 })
                .onClick(() => {
                  let uiContext: UIContext = this.getUIContext();
                  let router = uiContext.getRouter();
                  router.pushUrl({ url: 'pages/ProfilePage' });
                })
              }
            }
            .width('100%')
            .margin({ top: 20, left: 16, right: 16, bottom: 16 })

            // 2. ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡
            Stack() {
              // ç»Ÿè®¡å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
              Column()
                .width('100%')
                .height('auto')
                .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
                .borderRadius(16)
                .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
              
              Row() {
                // åŠ¨æ€æ•°é‡
                Column() {
                  Text(this.userStats?.dynamicCount?.toString() || '0')
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ffffff')
                    .opacity(this.textOpacity)
                  Text('åŠ¨æ€')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.7)')
                    .opacity(this.textOpacity)
                }
                .layoutWeight(1)
                .justifyContent(FlexAlign.Center)

                // åˆ†éš”çº¿
                Column()
                  .width(1)
                  .height(40)
                  .backgroundColor('rgba(255,255,255,0.2)')
                  .margin({ left: 16, right: 16 })

                // å…³æ³¨æ•°é‡
                Column() {
                  Text(this.userStats?.followingCount?.toString() || '0')
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ffffff')
                    .opacity(this.textOpacity)
                  Text('å…³æ³¨')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.7)')
                    .opacity(this.textOpacity)
                }
                .layoutWeight(1)
                .justifyContent(FlexAlign.Center)

                // åˆ†éš”çº¿
                Column()
                  .width(1)
                  .height(40)
                  .backgroundColor('rgba(255,255,255,0.2)')
                  .margin({ left: 16, right: 16 })

                // ç²‰ä¸æ•°é‡
                Column() {
                  Text(this.userStats?.followerCount?.toString() || '0')
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ffffff')
                    .opacity(this.textOpacity)
                  Text('ç²‰ä¸')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.7)')
                    .opacity(this.textOpacity)
                }
                .layoutWeight(1)
                .justifyContent(FlexAlign.Center)
              }
              .padding({ top: 20, bottom: 20 })
            }
            .width('100%')
            .backgroundColor('rgba(255, 255, 255, 0.03)')
            .borderRadius(16)
            .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
            .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
            .margin({ left: 16, right: 16, bottom: 16 })
          }

          // ä¸‹åŠéƒ¨åˆ†ï¼šæ ‡ç­¾é¡µåˆ‡æ¢
          Column() {
            // æ ‡ç­¾é¡µåˆ‡æ¢æŒ‰é’®
            Row() {
              Text('åŠ¨æ€')
                .fontSize(16)
                .fontWeight(this.selectedTab === 'dynamic' ? FontWeight.Bold : FontWeight.Normal)
                .fontColor(this.selectedTab === 'dynamic' ? '#ffffff' : 'rgba(255, 255, 255, 0.6)')
                .opacity(this.textOpacity)
                .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                .backgroundColor(this.selectedTab === 'dynamic' ? 'rgba(255, 255, 255, 0.1)' : 'transparent')
                .borderRadius(20)
                .onClick(() => {
                  // åŒå‡»æ£€æµ‹ï¼šå¦‚æœä¸¤æ¬¡ç‚¹å‡»é—´éš”å°äº300msï¼Œåˆ™è®¤ä¸ºæ˜¯åŒå‡»
                  const currentTime = Date.now();
                  if (currentTime - this.lastClickTime < 300) {
                    // åŒå‡»äº‹ä»¶ï¼šè·³è½¬åˆ°dynamiclisté¡µé¢
                    let uiContext: UIContext = this.getUIContext();
                    let router = uiContext.getRouter();
                    router.pushUrl({ url: 'pages/DynamicList' });
                    this.lastClickTime = 0; // é‡ç½®ç‚¹å‡»æ—¶é—´
                  } else {
                    // å•å‡»äº‹ä»¶ï¼šåˆ‡æ¢åˆ°åŠ¨æ€æ ‡ç­¾é¡µå¹¶æ˜¾ç¤ºåŠ¨æ€å†…å®¹
                    this.selectedTab = 'dynamic';
                    this.lastClickTime = currentTime;
                  }
                })
              
              Text('é˜æ¥¼')
                .fontSize(16)
                .fontWeight(this.selectedTab === 'attic' ? FontWeight.Bold : FontWeight.Normal)
                .fontColor(this.selectedTab === 'attic' ? '#ffffff' : 'rgba(255, 255, 255, 0.6)')
                .opacity(this.textOpacity)
                .padding({ left: 20, right: 20, top: 12, bottom: 12 })
                .backgroundColor(this.selectedTab === 'attic' ? 'rgba(255, 255, 255, 0.1)' : 'transparent')
                .borderRadius(20)
                .onClick(() => {
                  this.selectedTab = 'attic';
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceEvenly)
            .padding({ left: 16, right: 16, bottom: 16 })

            // åŠ¨æ€æ ‡ç­¾é¡µå†…å®¹
            if (this.selectedTab === 'dynamic') {
              this.buildDynamicContent()
            }

            // é˜æ¥¼æ ‡ç­¾é¡µå†…å®¹
            if (this.selectedTab === 'attic') {
              this.buildAtticContent()
            }
          }
        }
        .width('100%')
        .padding({ bottom: 20 })
      }
      .width('100%')
      .height('100%')
      .scrollBar(BarState.Off)

      // å¤´åƒæŸ¥çœ‹å™¨ - å…¨å±æ˜¾ç¤ºå¤´åƒ
      if (this.showAvatarViewer) {
        Stack({ alignContent: Alignment.Center }) {
          // åŠé€æ˜èƒŒæ™¯
          Column() {
            Blank()
              .width('100%')
              .height('100%')
              .backgroundColor('#000000')
              .opacity(0.9)
              .onClick(() => this.closeAvatarViewer())
          }
          .width('100%')
          .height('100%')

          // å¤´åƒæŸ¥çœ‹å™¨å†…å®¹
          Column() {
            // å…³é—­æŒ‰é’®
            Row() {
              Button() {
                Image($r('app.media.return'))
                  .width(24)
                  .height(24)
                  .fillColor('#fff')
              }
              .width(40)
              .height(40)
              .backgroundColor('rgba(0,0,0,0.5)')
              .borderRadius(20)
              .onClick(() => this.closeAvatarViewer())
            }
            .width('100%')
            .justifyContent(FlexAlign.End)
            .margin({ bottom: 20 })

            // å¤§å°ºå¯¸å¤´åƒæ˜¾ç¤º
            Image(this.userAvatar)
              .width(300)
              .height(300)
              .borderRadius(150)
              .border({ width: 6, color: 'rgba(255,255,255,0.3)' })
              .objectFit(ImageFit.Cover)
              .margin({ bottom: 20 })

            // æ“ä½œæŒ‰é’®
            Row() {
              Button('ç¼–è¾‘å¤´åƒ')
                .width(120)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.2)')
                .fontColor('#fff')
                .borderRadius(22)
                .onClick(() => {
                  this.closeAvatarViewer();
                  setTimeout(() => {
                    let uiContext: UIContext = this.getUIContext();
                    let router = uiContext.getRouter();
                    router.pushUrl({ url: 'pages/infopage' });
                  }, 300);
                })
            }
            .justifyContent(FlexAlign.Center)
          }
          .width('90%')
          .padding(24)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }
    }
    .width('100%')
    .height('100%')
  }

  // æ„å»ºåŠ¨æ€å†…å®¹
  @Builder
  buildDynamicContent() {
    Column() {
      if (this.latestDynamic) {
        // æœ€æ–°åŠ¨æ€å¡ç‰‡
        Stack() {
          // åŠ¨æ€å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
          Column()
            .width('100%')
            .height('auto')
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
            .borderRadius(16)
            .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
          
          Column() {
            // åŠ¨æ€å¤´éƒ¨ä¿¡æ¯
            Row() {
              // åŠ¨æ€ä¸­çš„å¤´åƒæ˜¾ç¤º - ä½¿ç”¨ç»Ÿä¸€çš„æ–¹æ³•
              Image(this.getAvatarUrl())
                .width(40)
                .height(40)
                .borderRadius(20)
                .margin({ right: 12 })
                .objectFit(ImageFit.Cover)
              
              Column() {
                Text(this.yourname)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')
                  .opacity(this.textOpacity)
                Text(this.formatTime(this.latestDynamic.createTime))
                  .fontSize(12)
                  .fontColor('rgba(255,255,255,0.6)')
                  .opacity(this.textOpacity)
              }
              .layoutWeight(1)
              .justifyContent(FlexAlign.Start)
            }
            .margin({ bottom: 12 })

            // åŠ¨æ€å†…å®¹
            Text(this.latestDynamic.content)
              .fontSize(14)
              .fontColor('#ffffff')
              .opacity(this.textOpacity)
              .textAlign(TextAlign.Start)
              .margin({ bottom: 12 })

            // åŠ¨æ€åº•éƒ¨æ“ä½œæ 
            Row() {
              Text('â¤ï¸')
                .fontSize(16)
                .margin({ right: 8 })
              Text('ğŸ’¬')
                .fontSize(16)
                .margin({ right: 8 })
              Text('ğŸ“¤')
                .fontSize(16)
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
          }
          .padding({ left: 16, right: 16, top: 16, bottom: 16 })
        }
        .width('100%')
        .backgroundColor('rgba(255, 255, 255, 0.03)')
        .borderRadius(16)
        .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
        .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
        .margin({ left: 16, right: 16, bottom: 12 })
        .onClick(() => {
          // ç‚¹å‡»åŠ¨æ€å¡ç‰‡æ—¶è·³è½¬åˆ°dynamiclisté¡µé¢
          let uiContext: UIContext = this.getUIContext();
          let router = uiContext.getRouter();
          router.pushUrl({ url: 'pages/DynamicList' });
        })
      } else {
        // ç©ºçŠ¶æ€
        Stack() {
          // ç©ºçŠ¶æ€èƒŒæ™¯å‘å…‰æ•ˆæœ
          Column()
            .width('100%')
            .height('auto')
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
            .borderRadius(16)
            .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
          
          Column() {
            Text('ğŸ“')
              .fontSize(48)
              .margin({ bottom: 16 })
            Text('è¿˜æ²¡æœ‰åŠ¨æ€')
              .fontSize(16)
              .fontColor('#ffffff')
              .opacity(this.textOpacity)
              .margin({ bottom: 8 })
            Text('å‘å¸ƒä½ çš„ç¬¬ä¸€æ¡åŠ¨æ€å§')
              .fontSize(14)
              .fontColor('rgba(255,255,255,0.6)')
              .opacity(this.textOpacity)
          }
          .padding({ top: 40, bottom: 40 })
        }
        .width('100%')
        .backgroundColor('rgba(255, 255, 255, 0.03)')
        .borderRadius(16)
        .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
        .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
        .margin({ left: 16, right: 16, bottom: 12 })
        .onClick(() => {
          // ç‚¹å‡»ç©ºçŠ¶æ€æ—¶è·³è½¬åˆ°dynamiclisté¡µé¢
          let uiContext: UIContext = this.getUIContext();
          let router = uiContext.getRouter();
          router.pushUrl({ url: 'pages/DynamicList' });
        })
      }
    }
  }

  // æ„å»ºé˜æ¥¼å†…å®¹
  @Builder
  buildAtticContent() {
    Column() {
      // é˜æ¥¼å­æ ‡ç­¾é¡µ
      Row() {
        Text('æ™ºèƒ½ä½“')
          .fontSize(14)
          .fontWeight(this.selectedAtticTab === 'æ™ºèƒ½ä½“' ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedAtticTab === 'æ™ºèƒ½ä½“' ? '#ffffff' : 'rgba(255, 255, 255, 0.6)')
          .opacity(this.textOpacity)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .backgroundColor(this.selectedAtticTab === 'æ™ºèƒ½ä½“' ? 'rgba(255, 255, 255, 0.1)' : 'transparent')
          .borderRadius(16)
          .onClick(() => {
            // åŒå‡»æ£€æµ‹ï¼šå¦‚æœä¸¤æ¬¡ç‚¹å‡»é—´éš”å°äº300msï¼Œåˆ™è®¤ä¸ºæ˜¯åŒå‡»
            const currentTime = Date.now();
            if (currentTime - this.lastAtticClickTime < 300) {
              // åŒå‡»äº‹ä»¶ï¼šè·³è½¬åˆ°myairoleé¡µé¢
              let uiContext: UIContext = this.getUIContext();
              let router = uiContext.getRouter();
              router.pushUrl({ url: 'pages/myairole' });
              this.lastAtticClickTime = 0; // é‡ç½®ç‚¹å‡»æ—¶é—´
            } else {
              // å•å‡»äº‹ä»¶ï¼šåˆ‡æ¢åˆ°æ™ºèƒ½ä½“æ ‡ç­¾é¡µå¹¶æ˜¾ç¤ºæ™ºèƒ½ä½“å†…å®¹
              this.selectedAtticTab = 'æ™ºèƒ½ä½“';
              this.lastAtticClickTime = currentTime;
            }
          })
        
        Text('æ”¶è—')
          .fontSize(14)
          .fontWeight(this.selectedAtticTab === 'æ”¶è—' ? FontWeight.Bold : FontWeight.Normal)
          .fontColor(this.selectedAtticTab === 'æ”¶è—' ? '#ffffff' : 'rgba(255, 255, 255, 0.6)')
          .opacity(this.textOpacity)
          .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          .backgroundColor(this.selectedAtticTab === 'æ”¶è—' ? 'rgba(255, 255, 255, 0.1)' : 'transparent')
          .borderRadius(16)
          .onClick(() => {
            // åŒå‡»æ£€æµ‹ï¼šå¦‚æœä¸¤æ¬¡ç‚¹å‡»é—´éš”å°äº300msï¼Œåˆ™è®¤ä¸ºæ˜¯åŒå‡»
            const currentTime = Date.now();
            if (currentTime - this.lastAtticClickTime < 300) {
              // åŒå‡»äº‹ä»¶ï¼šè·³è½¬åˆ°æ”¶è—é¡µé¢ï¼ˆè¿™é‡Œå¯ä»¥æ ¹æ®å®é™…é¡µé¢è°ƒæ•´ï¼‰
              let uiContext: UIContext = this.getUIContext();
              let router = uiContext.getRouter();
              router.pushUrl({ url: 'pages/FeaturedList' });
              this.lastAtticClickTime = 0; // é‡ç½®ç‚¹å‡»æ—¶é—´
            } else {
              // å•å‡»äº‹ä»¶ï¼šåˆ‡æ¢åˆ°æ”¶è—æ ‡ç­¾é¡µå¹¶æ˜¾ç¤ºæ”¶è—å†…å®¹
              this.selectedAtticTab = 'æ”¶è—';
              this.lastAtticClickTime = currentTime;
            }
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceEvenly)
      .padding({ left: 16, right: 16, bottom: 16 })

      // æ™ºèƒ½ä½“å†…å®¹
      if (this.selectedAtticTab === 'æ™ºèƒ½ä½“') {
        Stack() {
          // æ™ºèƒ½ä½“èƒŒæ™¯å‘å…‰æ•ˆæœ
          Column()
            .width('100%')
            .height('auto')
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
            .borderRadius(16)
            .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
          
          Column() {
            Text('ğŸ¤–')
              .fontSize(48)
              .margin({ bottom: 16 })
            Text('æˆ‘çš„æ™ºèƒ½ä½“')
              .fontSize(16)
              .fontColor('#ffffff')
              .opacity(this.textOpacity)
              .margin({ bottom: 8 })
            Text('åˆ›å»ºå’Œç®¡ç†ä½ çš„AIæ™ºèƒ½ä½“')
              .fontSize(14)
              .fontColor('rgba(255,255,255,0.6)')
              .opacity(this.textOpacity)
          }
          .padding({ top: 40, bottom: 40 })
        }
        .width('100%')
        .backgroundColor('rgba(255, 255, 255, 0.03)')
        .borderRadius(16)
        .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
        .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
        .margin({ left: 16, right: 16, bottom: 12 })
      }

      // æ”¶è—å†…å®¹
      if (this.selectedAtticTab === 'æ”¶è—') {
        Stack() {
          // æ”¶è—èƒŒæ™¯å‘å…‰æ•ˆæœ
          Column()
            .width('100%')
            .height('auto')
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
            .borderRadius(16)
            .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
          
          Column() {
            Text('â­')
              .fontSize(48)
              .margin({ bottom: 16 })
            Text('æˆ‘çš„æ”¶è—')
              .fontSize(16)
              .fontColor('#ffffff')
              .opacity(this.textOpacity)
              .margin({ bottom: 8 })
            Text('æŸ¥çœ‹ä½ æ”¶è—çš„å†…å®¹')
              .fontSize(14)
              .fontColor('rgba(255,255,255,0.6)')
              .opacity(this.textOpacity)
          }
          .padding({ top: 40, bottom: 40 })
        }
        .width('100%')
        .backgroundColor('rgba(255, 255, 255, 0.03)')
        .borderRadius(16)
        .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
        .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
        .margin({ left: 16, right: 16, bottom: 12 })
      }
    }
  }
} 