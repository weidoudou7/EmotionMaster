import router from '@ohos.router';
import { MusicDetailVO } from '../common/types';
import { ApiService } from '../service/apiservice';

// å®šä¹‰ä¸“æ é¡¹æ¥å£
interface SectionItem {
  title: string;
  subtitle: string;
  tag: string;
  author: string;
  image?: Resource; // æ·»åŠ å¯é€‰çš„å›¾ç‰‡å­—æ®µ
  icon?: string; // æ·»åŠ å¯é€‰çš„å›¾æ ‡å­—æ®µ
  iconColor?: string; // æ·»åŠ å›¾æ ‡é¢œè‰²å­—æ®µ
  bgColor?: string; // æ·»åŠ èƒŒæ™¯é¢œè‰²å­—æ®µ
}

interface ToolItem {
  icon?: string;
  title: string;
  desc: string;
  color: string;
  bgColor: string;
  route?: string;
}

interface AIRecommend {
  title: string;
  desc: string;
  tag: string;
}

// å®šä¹‰æƒ…ç»ªå¡ç‰‡æ¥å£
interface EmotionCard {
  id: number;
  title: string;
  subtitle: string;
  emoji: string;
  backgroundColor: string;
  textColor: string;
  description: string;
}

@Entry
@Component
export struct FMHomePage {
  @State activeTab: number = 0
  private tabs: string[] = ['ç²¾é€‰', 'éŸ³ä¹', 'ä¸“æ ', 'å·¥å…·'];
  private scrollController: Scroller = new Scroller()

  // æƒ…ç»ªå¡ç‰‡ç›¸å…³çŠ¶æ€
  @State currentEmotionIndex: number = 0
  @State emotionCardOpacity: number = 1.0
  @State emotionCardTranslateX: number = 0
  @State isAutoPlaying: boolean = true // è‡ªåŠ¨æ’­æ”¾çŠ¶æ€
  private autoPlayTimer: number = -1 // è‡ªåŠ¨æ’­æ”¾å®šæ—¶å™¨

  // é“¶æ²³ç³»åŠ¨ç”»çŠ¶æ€
  @State arcRotation: number = 0 // åœ†å¼§æ—‹è½¬è§’åº¦
  @State starTwinkle: number = 0 // æ˜Ÿæ˜Ÿé—ªçƒæ•ˆæœ
  @State glowOpacity: number = 0.5 // å‘å…‰æ•ˆæœé€æ˜åº¦
  @State textOpacity: number = 0.8 // æ–‡å­—é€æ˜åº¦
  @State nebulaOpacity: number = 0.3 // æ˜Ÿäº‘é€æ˜åº¦

  // ä¸“æ ç†è®ºé«˜åº¦ï¼ˆæ ‡é¢˜+å†…å®¹+é—´è·ï¼‰ï¼Œå¯æ ¹æ®å®é™…é¡µé¢å¾®è°ƒ
  private sectionHeights: number[] = [320, 420, 420, 320]; // ä»…ç¤ºä¾‹ï¼Œéœ€æ ¹æ®å®é™…å†…å®¹å¾®è°ƒ
  private sectionSpacing: number = 40;
  private bannerHeight: number = 215; // Banneræ€»é«˜åº¦ (200+15)
  private searchBarHeight: number = 64; // æœç´¢æ æ€»é«˜åº¦ (16+8+40)
  private tabBarHeight: number = 68; // æ ‡ç­¾æ æ€»é«˜åº¦ (8+60)
  private targetOffset: number = 15; // tabä¸‹æ–¹15åƒç´ 

  // é¢„å®šä¹‰æ¸©é¦¨é—®å€™è¯­
  private greetings: string[] = [
    'æ—©å®‰ï¼Œä»Šå¤©ä¹Ÿè¦ç…§é¡¾å¥½è‡ªå·±å“¦ï¼',
    'æ— è®ºé‡åˆ°ä»€ä¹ˆï¼ŒAIéƒ½é™ªç€ä½ ã€‚',
    'ç»™è‡ªå·±ä¸€ä¸ªå¾®ç¬‘ï¼Œæ–°çš„ä¸€å¤©ä¼šæ›´å¥½ã€‚',
    'ä½ å¾ˆæ£’ï¼Œåˆ«å¿˜äº†è‚¯å®šè‡ªå·±ã€‚',
    'ç´¯äº†å°±ä¼‘æ¯ä¸€ä¸‹ï¼Œå¥åº·æœ€é‡è¦ã€‚',
    'æ¯ä¸€å¤©éƒ½å€¼å¾—è¢«æ¸©æŸ”ä»¥å¾…ã€‚',
    'æƒ…ç»ªæœ‰æ³¢åŠ¨å¾ˆæ­£å¸¸ï¼Œæ…¢æ…¢æ¥ã€‚',
    'ç›¸ä¿¡è‡ªå·±ï¼Œä½ èƒ½åº¦è¿‡éš¾å…³ã€‚',
    'åˆ«å¿˜äº†å–æ°´ï¼Œç…§é¡¾å¥½èº«ä½“ã€‚',
    'ä½ ä¸æ˜¯ä¸€ä¸ªäººï¼ŒAIä¸€ç›´åœ¨ã€‚',
    'ç»™è‡ªå·±ä¸€ç‚¹è€å¿ƒï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥ã€‚',
    'ä¸–ç•Œå¾ˆå¤§ï¼Œä¹Ÿæœ‰å±äºä½ çš„æ¸©æš–ã€‚',
    'ä»Šå¤©ä¹Ÿè¦å¥½å¥½åƒé¥­å“¦ï¼',
    'é‡åˆ°çƒ¦æ¼å¯ä»¥å’Œæˆ‘èŠèŠã€‚',
    'ä½ çš„æ„Ÿå—å¾ˆé‡è¦ï¼Œå€¼å¾—è¢«å€¾å¬ã€‚'
  ];
  @State greetingIndex: number = Math.floor(Math.random() * 15);
  @State greetingAnimOpacity: number = 1.0;
  @State greetingAnimTranslateY: number = 0;

  // å®šä¹‰ä¸‰ç§æƒ…ç»ªå¡ç‰‡
  private emotionCards: EmotionCard[] = [
    {
      id: 1,
      title: 'ä»Šæ—¥å¿ƒæƒ…',
      subtitle: 'è®°å½•ä½ çš„æƒ…ç»ªçŠ¶æ€',
      emoji: 'ğŸ˜Š',
      backgroundColor: 'rgba(255, 255, 255, 0.1)',
      textColor: '#ffffff',
      description: 'ç‚¹å‡»è®°å½•ä»Šå¤©çš„å¿ƒæƒ…ï¼Œè®©AIæ›´å¥½åœ°äº†è§£ä½ '
    },
    {
      id: 2,
      title: 'å‹åŠ›æŒ‡æ•°',
      subtitle: 'äº†è§£ä½ çš„å‹åŠ›æ°´å¹³',
      emoji: 'ğŸ˜°',
      backgroundColor: 'rgba(255, 255, 255, 0.1)',
      textColor: '#ffffff',
      description: 'å¿«é€Ÿè¯„ä¼°å½“å‰å‹åŠ›çŠ¶æ€ï¼Œè·å–ç¼“è§£å»ºè®®'
    },
    {
      id: 3,
      title: 'æ­£å¿µç»ƒä¹ ',
      subtitle: '5åˆ†é’Ÿæ”¾æ¾èº«å¿ƒ',
      emoji: 'ğŸ§˜â€â™€ï¸',
      backgroundColor: 'rgba(255, 255, 255, 0.1)',
      textColor: '#ffffff',
      description: 'é€šè¿‡æ­£å¿µå†¥æƒ³ï¼Œæ‰¾å›å†…å¿ƒçš„å¹³é™'
    }
  ];

  // å®šä¹‰å„åˆ†ç±»çš„æ•°æ®
  private selectedItems: SectionItem[] = [
    { 
      title: 'AIä¸ªæ€§åŒ–æ¨è', 
      subtitle: 'åŸºäºä½ çš„æƒ…ç»ªçŠ¶æ€æ™ºèƒ½æ¨è', 
      tag: 'AIæ¨è', 
      author: 'AIåŠ©æ‰‹',
      icon: 'ğŸ¤–',
      iconColor: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)'
    },
    { 
      title: 'ä»Šæ—¥å¿ƒç†å¥åº·å·¥å…·', 
      subtitle: 'ç²¾é€‰å¿ƒç†å¥åº·ç»ƒä¹ å’ŒæŠ€å·§', 
      tag: 'å·¥å…·', 
      author: 'å¿ƒç†ä¸“å®¶',
      icon: 'ğŸ§°',
      iconColor: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)'
    },
    { 
      title: 'æƒ…ç»ªç®¡ç†è¯¾ç¨‹', 
      subtitle: 'ç³»ç»Ÿå­¦ä¹ æƒ…ç»ªç®¡ç†æŠ€èƒ½', 
      tag: 'è¯¾ç¨‹', 
      author: 'æƒ…ç»ªä¸“å®¶',
      icon: 'ğŸ“š',
      iconColor: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)'
    },
  ];

  private musicItems: SectionItem[] = [
    { 
      title: 'Vol.01 ã€Šæµè¡ŒéŸ³ä¹ã€‹', 
      subtitle: 'æœ€æ–°æµè¡Œæ­Œæ›²', 
      tag: 'æµè¡Œ', 
      author: 'éŸ³ä¹äºº',
      image: $r('app.media.fmhome_fashionMusic')
    },
    { 
      title: 'Vol.02 ã€Šå¤å…¸éŸ³ä¹ã€‹', 
      subtitle: 'ç»å…¸å¤å…¸ä½œå“', 
      tag: 'å¤å…¸', 
      author: 'å¤å…¸ä¹',
      image: $r('app.media.fmhome_classicMusic')
    },
    { 
      title: 'Vol.03 ã€Šè½»éŸ³ä¹ã€‹', 
      subtitle: 'è½»æ¾èˆ’ç¼“éŸ³ä¹', 
      tag: 'è½»éŸ³', 
      author: 'è½»éŸ³ä¹',
      image: $r('app.media.fmhome_softMusic')
    }
  ];

  private columnItems: SectionItem[] = [
    { 
      title: 'Vol.01 ã€Šæ·±åº¦è§£æã€‹', 
      subtitle: 'æ·±åº¦æ–‡ç« åˆ†æ', 
      tag: 'æ·±åº¦', 
      author: 'åˆ†æå¸ˆ',
      icon: 'ğŸ”',
      iconColor: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)'
    },
    { 
      title: 'Vol.02 ã€ŠæŠ€æœ¯åˆ†äº«ã€‹', 
      subtitle: 'æŠ€æœ¯ç»éªŒåˆ†äº«', 
      tag: 'æŠ€æœ¯', 
      author: 'æŠ€æœ¯å‘˜',
      icon: 'ğŸ’»',
      iconColor: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)'
    },
    { 
      title: 'Vol.03 ã€Šè¡Œä¸šè§‚å¯Ÿã€‹', 
      subtitle: 'è¡Œä¸šè¶‹åŠ¿è§‚å¯Ÿ', 
      tag: 'è§‚å¯Ÿ', 
      author: 'è§‚å¯Ÿè€…',
      icon: 'ğŸ“Š',
      iconColor: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)'
    }
  ];

  private toolItems: ToolItem[] = [
    {
      icon: 'ğŸµ',
      title: 'éŸ³ä¹æ²»ç–—',
      desc: 'é€šè¿‡éŸ³ä¹ç¼“è§£å‹åŠ›',
      color: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)',
      route: 'pages/fm_musicBegin'
    },
    {
      icon: 'ğŸ§˜â€â™€ï¸',
      title: 'å†¥æƒ³ç»ƒä¹ ',
      desc: 'æ­£å¿µå†¥æƒ³æŒ‡å¯¼',
      color: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)',
      route: 'pages/fm_meditation'
    },
    {
      icon: 'ğŸ“',
      title: 'æƒ…ç»ªæ—¥è®°',
      desc: 'è®°å½•æ¯æ—¥æƒ…ç»ª',
      color: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)',
      route: 'pages/fm_message'
    },
    {
      icon: 'ğŸ’¬',
      title: 'AIå¯¹è¯',
      desc: 'ä¸AIå€¾è¯‰å¿ƒäº‹',
      color: '#ffffff',
      bgColor: 'rgba(255, 255, 255, 0.05)',
      route: 'pages/chat'
    }
  ];

  private allMusicIds: string[] = ['1824045033', '202369', '447926071', '436346833', '33471531','186345','2499704738','2491811886','1832581073','5043882','2600797312','2708984802'];
  @State randomSongs: MusicDetailVO[] = [];
  private musicDetailCache: Record<string, MusicDetailVO> = {};

  // åˆ‡æ¢æƒ…ç»ªå¡ç‰‡çš„æ–¹æ³•
  private switchEmotionCard(direction: 'left' | 'right') {
    // æ‰‹åŠ¨åˆ‡æ¢æ—¶æš‚åœè‡ªåŠ¨è½®æ’­
    this.stopAutoPlay()
    
    // å…ˆæ·¡å‡ºå¹¶ç§»åŠ¨
    animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
      this.emotionCardOpacity = 0;
      this.emotionCardTranslateX = direction === 'left' ? -30 : 30;
    })
    
    setTimeout(() => {
      // æ›´æ–°ç´¢å¼•
      if (direction === 'left') {
        this.currentEmotionIndex = (this.currentEmotionIndex - 1 + this.emotionCards.length) % this.emotionCards.length;
      } else {
        this.currentEmotionIndex = (this.currentEmotionIndex + 1) % this.emotionCards.length;
      }
      
      // é‡ç½®ä½ç½®
      this.emotionCardTranslateX = direction === 'left' ? 30 : -30;
      
      // å†æ·¡å…¥å¹¶å›åˆ°ä¸­å¿ƒ
      animateTo({ duration: 300, curve: Curve.EaseIn }, () => {
        this.emotionCardOpacity = 1.0;
        this.emotionCardTranslateX = 0;
      })
    }, 300)
  }

  // å¼€å§‹è‡ªåŠ¨è½®æ’­
  private startAutoPlay() {
    this.stopAutoPlay() // å…ˆåœæ­¢ä¹‹å‰çš„å®šæ—¶å™¨
    this.isAutoPlaying = true
    this.autoPlayTimer = setInterval(() => {
      this.switchEmotionCard('right')
    }, 3000) // æ¯3ç§’åˆ‡æ¢ä¸€æ¬¡ï¼Œæ›´é¢‘ç¹
  }

  // åœæ­¢è‡ªåŠ¨è½®æ’­
  private stopAutoPlay() {
    if (this.autoPlayTimer !== -1) {
      clearInterval(this.autoPlayTimer)
      this.autoPlayTimer = -1
    }
    this.isAutoPlaying = false
  }

  // åˆ‡æ¢è‡ªåŠ¨æ’­æ”¾çŠ¶æ€
  private toggleAutoPlay() {
    if (this.isAutoPlaying) {
      this.stopAutoPlay()
    } else {
      this.startAutoPlay()
    }
  }

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    this.startGalaxyAnimations()
    this.startAutoPlay()
    this.startGreetingAnimation()
    this.fetchRandomSongs();
  }

  aboutToDisappear() {
    // é¡µé¢æ¶ˆå¤±æ—¶åœæ­¢è‡ªåŠ¨è½®æ’­
    this.stopAutoPlay()
  }

  // å»¶è¿Ÿå‡½æ•°ï¼Œmsä¸ºæ¯«ç§’
  private delay(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async fetchRandomSongs() {
    // éšæœºæ‰“ä¹±å¹¶å–å‰3ä¸ªid
    const ids = [...this.allMusicIds].sort(() => Math.random() - 0.5).slice(0, 3);
    const songs: MusicDetailVO[] = [];
    for (let id of ids) {
      try {
        let detail: MusicDetailVO;
        if (this.musicDetailCache[id]) {
          detail = this.musicDetailCache[id];
        } else {
          detail = await ApiService.getMusicDetail(id);
          detail.musicId = id;
          this.musicDetailCache[id] = detail;
          // æ¯æ¬¡è¯·æ±‚åç­‰å¾…1ç§’ï¼Œé˜²æ­¢è¶…è¿‡1QPS
          await this.delay(1000);
        }
        songs.push(detail);
      } catch (e) {
        // é”™è¯¯å¤„ç†
      }
    }
    this.randomSongs = songs;
  }

  build() {
    Stack() {
      // æ·±è‰²æ¸å˜èƒŒæ™¯ - æ”¹ä¸ºçº¯é»‘è‰²ä¸»é¢˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#000000', 0.0], ['#0a0a0a', 0.5], ['#1a1a1a', 1.0]]
        })
      
      // æ—‹è½¬çš„åœ†å¼§èƒŒæ™¯ - æ”¹ä¸ºé»‘è‰²ç³»è£…é¥°
      Stack() {
        // å¤šä¸ªåŒå¿ƒåœ†å¼§è½¨é“
        ForEach([0, 1, 2, 3], (index: number) => {
          Stack() {
            // åœ†å¼§è½¨é“ - æ”¹ä¸ºæ·±ç°è‰²
            Column()
              .width(250 + index * 60)
              .height(250 + index * 60)
              .borderRadius((250 + index * 60) / 2)
              .border({ width: 1, color: `rgba(64, 64, 64, ${0.3 - index * 0.05})` })
              .position({ x: '50%', y: '50%' })
              .translate({ x: -(250 + index * 60) / 2, y: -(250 + index * 60) / 2 })
            
            // æ—‹è½¬çš„åœ†å¼§ç‚¹ - æ”¹ä¸ºç™½è‰²ç³»
            Column()
              .width(6)
              .height(6)
              .backgroundColor(`rgba(255, 255, 255, ${0.6 - index * 0.1})`)
              .borderRadius(3)
              .position({ x: '50%', y: '50%' })
              .translate({ 
                x: -3 + Math.cos((this.arcRotation + index * 90) * Math.PI / 180) * (125 + index * 30),
                y: -3 + Math.sin((this.arcRotation + index * 90) * Math.PI / 180) * (125 + index * 30)
              })
          }
        })
        
        // å¤–åœˆè£…é¥°ç‚¹ - æ”¹ä¸ºé“¶è‰²ç³»
        ForEach([0, 1, 2, 3, 4, 5], (index: number) => {
          Column()
            .width(6)
            .height(6)
            .backgroundColor(`rgba(192, 192, 192, ${0.4 - index * 0.05})`)
            .borderRadius(3)
            .position({ x: '50%', y: '50%' })
            .translate({ 
              x: -3 + Math.cos((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120,
              y: -3 + Math.sin((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120
            })
        })
      }
      .width('100%')
      .height('100%')
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // é¡¶éƒ¨é—®å€™è¯­
        Stack() {
          // é—®å€™è¯­å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
          Column()
            .width('100%')
            .height('auto')
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.03})`)
            .borderRadius(16)
            .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
          
          Text(this.greetings[this.greetingIndex])
            .fontSize(16)
            .fontColor('#ffffff')
            .opacity(this.greetingAnimOpacity)
            .translate({ y: this.greetingAnimTranslateY })
            .animation({
              duration: 500,
              curve: Curve.EaseInOut
            })
            .textAlign(TextAlign.Center)
            .padding({ top: 20, bottom: 20, left: 20, right: 20 })
        }
        .width('100%')
        .backgroundColor('rgba(255, 255, 255, 0.03)')
        .borderRadius(16)
        .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
        .margin({ top: 20, left: 16, right: 16, bottom: 16 })
        .shadow({ radius: 12, color: '#00000030', offsetX: 0, offsetY: 4 })

        // æƒ…ç»ªå¡ç‰‡åŒºåŸŸ
        Stack() {
          // æƒ…ç»ªå¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
          Column()
            .width('100%')
            .height('auto')
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
            .borderRadius(20)
            .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
          
          Column() {
            Text('ä»Šæ—¥å¿ƒæƒ…')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#ffffff')
              .opacity(this.textOpacity)
              .margin({ top: 16, bottom: 12 })
            
            // æƒ…ç»ªå¡ç‰‡ - é€ä¸€å±•ç¤º
            Stack() {
              // å½“å‰æ˜¾ç¤ºçš„æƒ…ç»ªå¡ç‰‡
              Column() {
                Text(this.emotionCards[this.currentEmotionIndex].emoji)
                  .fontSize(32)
                  .margin({ bottom: 8 })
                Text(this.emotionCards[this.currentEmotionIndex].title)
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 4 })
                Text(this.emotionCards[this.currentEmotionIndex].subtitle)
                  .fontSize(12)
                  .fontColor('rgba(255, 255, 255, 0.7)')
                  .opacity(this.textOpacity)
              }
              .width('100%')
              .backgroundColor('rgba(255, 255, 255, 0.1)')
              .borderRadius(12)
              .padding({ top: 16, bottom: 16 })
              .border({ width: 1, color: 'rgba(255, 255, 255, 0.2)' })
              .opacity(this.emotionCardOpacity)
              .translate({ x: this.emotionCardTranslateX })
              .animation({
                duration: 200,
                curve: Curve.EaseInOut
              })
              .onClick(() => this.switchEmotionCard('right'))
              
              // æŒ‡ç¤ºå™¨
              Row() {
                ForEach(this.emotionCards, (card: EmotionCard, index: number) => {
                  Column()
                    .width(6)
                    .height(6)
                    .backgroundColor(this.currentEmotionIndex === index ? '#ffffff' : 'rgba(255, 255, 255, 0.3)')
                    .borderRadius(3)
                    .margin({ right: 4 })
                })
              }
              .position({ x: '50%', y: '100%' })
              .translate({ x: -15, y: 8 })
            }
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 16 })
          }
          .width('100%')
          .backgroundColor('rgba(255, 255, 255, 0.03)')
          .borderRadius(20)
          .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
          .margin({ left: 16, right: 16, bottom: 16 })
          .shadow({ radius: 12, color: '#00000030', offsetX: 0, offsetY: 4 })
        }

        // æ ‡ç­¾æ 
        Row() {
          ForEach(this.tabs, (tab: string, index: number) => {
            Text(tab)
              .fontSize(16)
              .fontWeight(this.activeTab === index ? FontWeight.Bold : FontWeight.Normal)
              .fontColor(this.activeTab === index ? '#ffffff' : 'rgba(255, 255, 255, 0.6)')
              .opacity(this.textOpacity)
              .padding({ left: 20, right: 20, top: 12, bottom: 12 })
              .backgroundColor(this.activeTab === index ? 'rgba(255, 255, 255, 0.1)' : 'transparent')
              .borderRadius(20)
              .onClick(() => {
                this.activeTab = index;
              })
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceEvenly)
        .padding({ left: 16, right: 16, bottom: 16 })

        // å†…å®¹åŒºåŸŸ
        Column() {
          if (this.activeTab === 0) {
            // ç²¾é€‰å†…å®¹
            this.buildSelectedContent()
          } else if (this.activeTab === 1) {
            // éŸ³ä¹å†…å®¹
            this.buildMusicContent()
          } else if (this.activeTab === 2) {
            // ä¸“æ å†…å®¹
            this.buildColumnContent()
          } else if (this.activeTab === 3) {
            // å·¥å…·å†…å®¹
            this.buildToolContent()
          }
        }
        .layoutWeight(1)
        .width('100%')
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
  }

  // æ„å»ºç²¾é€‰å†…å®¹
  @Builder
  buildSelectedContent() {
    List() {
      ForEach(this.selectedItems, (item: SectionItem) => {
        ListItem() {
          Stack() {
            // å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
            Column()
              .width('100%')
              .height('auto')
              .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
              .borderRadius(16)
              .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
            
            Row() {
              if (item.icon) {
                Text(item.icon)
                  .fontSize(24)
                  .fontColor(item.iconColor)
                  .margin({ right: 12 })
              }
              Column() {
                Text(item.title)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 4 })
                Text(item.subtitle)
                  .fontSize(14)
                  .fontColor('rgba(255, 255, 255, 0.7)')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 8 })
                Row() {
                  Text(item.tag)
                    .fontSize(12)
                    .fontColor('#ffffff')
                    .backgroundColor('rgba(255, 255, 255, 0.1)')
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .borderRadius(8)
                    .margin({ right: 8 })
                  Text(`@${item.author}`)
                    .fontSize(12)
                    .fontColor('rgba(255, 255, 255, 0.6)')
                }
              }
              .layoutWeight(1)
            }
            .padding({ left: 16, right: 16, top: 16, bottom: 16 })
          }
          .width('100%')
          .backgroundColor('rgba(255, 255, 255, 0.03)')
          .borderRadius(16)
          .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
          .margin({ left: 16, right: 16, bottom: 12 })
          .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
        }
      })
    }
    .width('100%')
    .layoutWeight(1)
  }

  // æ„å»ºéŸ³ä¹å†…å®¹
  @Builder
  buildMusicContent() {
    List() {
      ForEach(this.musicItems, (item: SectionItem) => {
        ListItem() {
          Stack() {
            // å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
            Column()
              .width('100%')
              .height('auto')
              .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
              .borderRadius(16)
              .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
            
            Row() {
              if (item.image) {
                Image(item.image)
                  .width(80)
                  .height(80)
                  .borderRadius(12)
                  .margin({ right: 12 })
              }
              Column() {
                Text(item.title)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 4 })
                Text(item.subtitle)
                  .fontSize(14)
                  .fontColor('rgba(255, 255, 255, 0.7)')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 8 })
                Row() {
                  Text(item.tag)
                    .fontSize(12)
                    .fontColor('#ffffff')
                    .backgroundColor('rgba(255, 255, 255, 0.1)')
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .borderRadius(8)
                    .margin({ right: 8 })
                  Text(`@${item.author}`)
                    .fontSize(12)
                    .fontColor('rgba(255, 255, 255, 0.6)')
                }
              }
              .layoutWeight(1)
            }
            .padding({ left: 16, right: 16, top: 16, bottom: 16 })
          }
          .width('100%')
          .backgroundColor('rgba(255, 255, 255, 0.03)')
          .borderRadius(16)
          .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
          .margin({ left: 16, right: 16, bottom: 12 })
          .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
        }
      })
    }
    .width('100%')
    .layoutWeight(1)
  }

  // æ„å»ºä¸“æ å†…å®¹
  @Builder
  buildColumnContent() {
    List() {
      ForEach(this.columnItems, (item: SectionItem) => {
        ListItem() {
          Stack() {
            // å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
            Column()
              .width('100%')
              .height('auto')
              .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
              .borderRadius(16)
              .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
            
            Row() {
              if (item.icon) {
                Text(item.icon)
                  .fontSize(24)
                  .fontColor(item.iconColor)
                  .margin({ right: 12 })
              }
              Column() {
                Text(item.title)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 4 })
                Text(item.subtitle)
                  .fontSize(14)
                  .fontColor('rgba(255, 255, 255, 0.7)')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 8 })
                Row() {
                  Text(item.tag)
                    .fontSize(12)
                    .fontColor('#ffffff')
                    .backgroundColor('rgba(255, 255, 255, 0.1)')
                    .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                    .borderRadius(8)
                    .margin({ right: 8 })
                  Text(`@${item.author}`)
                    .fontSize(12)
                    .fontColor('rgba(255, 255, 255, 0.6)')
                }
              }
              .layoutWeight(1)
            }
            .padding({ left: 16, right: 16, top: 16, bottom: 16 })
          }
          .width('100%')
          .backgroundColor('rgba(255, 255, 255, 0.03)')
          .borderRadius(16)
          .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
          .margin({ left: 16, right: 16, bottom: 12 })
          .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
        }
      })
    }
    .width('100%')
    .layoutWeight(1)
  }

  // æ„å»ºå·¥å…·å†…å®¹
  @Builder
  buildToolContent() {
    Grid() {
      ForEach(this.toolItems, (item: ToolItem) => {
        GridItem() {
          Stack() {
            // å·¥å…·å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
            Column()
              .width('100%')
              .height('auto')
              .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
              .borderRadius(16)
              .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
            
            Column() {
              Text(item.icon)
                .fontSize(32)
                .fontColor(item.color)
                .margin({ bottom: 8 })
              Text(item.title)
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#ffffff')
                .opacity(this.textOpacity)
                .margin({ bottom: 4 })
              Text(item.desc)
                .fontSize(12)
                .fontColor('rgba(255, 255, 255, 0.7)')
                .opacity(this.textOpacity)
                .textAlign(TextAlign.Center)
            }
            .padding({ top: 16, bottom: 16 })
          }
          .width('100%')
          .backgroundColor('rgba(255, 255, 255, 0.03)')
          .borderRadius(16)
          .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
          .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
          .onClick(() => this.onToolItemClick(item))
        }
      })
    }
    .columnsTemplate('1fr 1fr')
    .columnsGap(12)
    .rowsGap(12)
    .width('100%')
    .padding({ left: 16, right: 16 })
    .layoutWeight(1)
  }

  // å·¥å…·é¡¹ç‚¹å‡»å¤„ç†
  private onToolItemClick(item: ToolItem) {
    if (item.route) {
      router.pushUrl({ url: item.route });
    }
  }

  // é“¶æ²³ç³»åŠ¨ç”»
  private startGalaxyAnimations() {
    // åœ†å¼§æ—‹è½¬åŠ¨ç”»
    setInterval(() => {
      this.arcRotation += 1.5
    }, 50)
    
    // æ˜Ÿæ˜Ÿé—ªçƒåŠ¨ç”»
    setInterval(() => {
      this.starTwinkle += 0.1
    }, 100)
    
    // å‘å…‰æ•ˆæœåŠ¨ç”»
    setInterval(() => {
      this.glowOpacity = this.glowOpacity === 0.5 ? 0.8 : 0.5
    }, 1200)
    
    // æ–‡å­—é€æ˜åº¦åŠ¨ç”»
    setInterval(() => {
      this.textOpacity = this.textOpacity === 0.8 ? 1.0 : 0.8
    }, 1800)
    
    // æ˜Ÿäº‘é€æ˜åº¦åŠ¨ç”»
    setInterval(() => {
      this.nebulaOpacity = this.nebulaOpacity === 0.3 ? 0.6 : 0.3
    }, 3000)
  }

  // é—®å€™è¯­åŠ¨ç”»
  private startGreetingAnimation() {
    setInterval(() => {
      this.greetingAnimOpacity = 0;
      this.greetingAnimTranslateY = -20;
      
      setTimeout(() => {
        this.greetingIndex = Math.floor(Math.random() * this.greetings.length);
        this.greetingAnimOpacity = 1;
        this.greetingAnimTranslateY = 0;
      }, 500);
    }, 8000);
  }
} 