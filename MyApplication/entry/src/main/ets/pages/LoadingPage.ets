import router from '@ohos.router'
import { ApiService } from '../service/apiservice'
import http from '@ohos.net.http'

interface RouteParams {
  description: string;
  styles: string[];
}

@Entry
@Component
export struct LoadingPage {
  @State private progress: number = 0
  @State private currentStyle: string = ''
  @State private generatedUrls: string[] = []
  @State private successfulStyles: string[] = []
  @State private isGenerating: boolean = true
  @State private hasError: boolean = false
  @State private currentBgUrl: string = ''
  @State private lineRotation: number = 0
  @State private lineScale: number = 1.0
  @State private glowOpacity: number = 0.5
  @State private textOpacity: number = 0.8
  @State private arcRotation: number = 0
  @State private preloadImageUrls: string[] = []

  private description: string = ''
  private styles: string[] = ['å¤é£', 'èµ›åš', 'å¡é€š', 'åŠ¨æ¼«', 'Qç‰ˆ']

  aboutToAppear() {
    const params = router.getParams() as RouteParams
    this.description = params.description || ''
    this.styles = params.styles || ['å¤é£', 'èµ›åš', 'å¡é€š', 'åŠ¨æ¼«', 'Qç‰ˆ']
    
    this.startAnimations()
    this.startGeneration()
  }

  private startAnimations() {
    // åœ†å¼§æ—‹è½¬åŠ¨ç”»
    setInterval(() => {
      this.arcRotation += 3
    }, 50)
    
    // çº¿æ¡ç¼©æ”¾åŠ¨ç”»
    setInterval(() => {
      this.lineScale = this.lineScale === 1.0 ? 1.2 : 1.0
    }, 1000)
    
    // å‘å…‰æ•ˆæœåŠ¨ç”»
    setInterval(() => {
      this.glowOpacity = this.glowOpacity === 0.5 ? 0.8 : 0.5
    }, 800)
    
    // æ–‡å­—é€æ˜åº¦åŠ¨ç”»
    setInterval(() => {
      this.textOpacity = this.textOpacity === 0.8 ? 1.0 : 0.8
    }, 1200)
  }

  private preloadImage(url: string): void {
    // å°†URLæ·»åŠ åˆ°é¢„åŠ è½½åˆ—è¡¨ä¸­ï¼ŒImageç»„ä»¶ä¼šè‡ªåŠ¨åŠ è½½
    this.preloadImageUrls.push(url)
  }

  private async startGeneration() {
    this.isGenerating = true
    this.hasError = false
    this.generatedUrls = []
    this.successfulStyles = []
    this.preloadImageUrls = []
    this.progress = 0
    this.currentBgUrl = ''

    for (let i = 0; i < this.styles.length; i++) {
      const style = this.styles[i]
      this.currentStyle = style
      
      try {
        const imageUrl = await ApiService.generateFigure(this.description, style)
        if (imageUrl && imageUrl.trim() !== '' && !imageUrl.includes('ç”Ÿæˆå›¾ç‰‡æ—¶å‡ºç°é”™è¯¯')) {
          this.generatedUrls.push(imageUrl)
          this.successfulStyles.push(style)
          this.currentBgUrl = imageUrl
          // ç«‹å³ä½¿ç”¨Imageç»„ä»¶é¢„åŠ è½½è¿™ä¸ªURL
          this.preloadImage(imageUrl)
          // åªæœ‰åœ¨æˆåŠŸç”Ÿæˆå›¾ç‰‡åæ‰å¢åŠ è¿›åº¦
          this.progress = (this.successfulStyles.length / this.styles.length) * 100
        }
      } catch (error) {
        console.error(`ç”Ÿæˆ${style}é£æ ¼å›¾ç‰‡å¤±è´¥:`, error)
      }
    }

    this.isGenerating = false
    
    if (this.generatedUrls.length === 0) {
      this.hasError = true
      return
    }

    setTimeout(() => {
      router.replaceUrl({
        url: 'pages/FigureResult',
        params: {
          imageUrls: this.generatedUrls,
          styles: this.successfulStyles,
          description: this.description
        }
      })
    }, 1000)
  }

  build() {
    Stack() {
      // æ·±è‰²æ¸å˜èƒŒæ™¯ - æ”¹ä¸ºçº¯é»‘è‰²ä¸»é¢˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#000000', 0.0], ['#0a0a0a', 0.5], ['#1a1a1a', 1.0]]
        })
      
      // æ—‹è½¬çš„åœ†å¼§èƒŒæ™¯ - æ”¹ä¸ºé»‘è‰²ç³»è£…é¥°
      Stack() {
        // å¤šä¸ªåŒå¿ƒåœ†å¼§è½¨é“
        ForEach([0, 1, 2, 3], (index: number) => {
          Stack() {
            // åœ†å¼§è½¨é“ - æ”¹ä¸ºæ·±ç°è‰²
            Column()
              .width(150 + index * 50)
              .height(150 + index * 50)
              .borderRadius((150 + index * 50) / 2)
              .border({ width: 1, color: `rgba(64, 64, 64, ${0.3 - index * 0.05})` })
              .position({ x: '50%', y: '50%' })
              .translate({ x: -(150 + index * 50) / 2, y: -(150 + index * 50) / 2 })
            
            // æ—‹è½¬çš„åœ†å¼§ç‚¹ - æ”¹ä¸ºç™½è‰²ç³»
            Column()
              .width(10)
              .height(10)
              .backgroundColor(`rgba(255, 255, 255, ${0.6 - index * 0.1})`)
              .borderRadius(5)
              .position({ x: '50%', y: '50%' })
              .translate({ 
                x: -5 + Math.cos((this.arcRotation + index * 90) * Math.PI / 180) * (75 + index * 25),
                y: -5 + Math.sin((this.arcRotation + index * 90) * Math.PI / 180) * (75 + index * 25)
              })
          }
        })
        
        // å¤–åœˆè£…é¥°ç‚¹ - æ”¹ä¸ºé“¶è‰²ç³»
        ForEach([0, 1, 2, 3, 4, 5], (index: number) => {
          Column()
            .width(6)
            .height(6)
            .backgroundColor(`rgba(192, 192, 192, ${0.4 - index * 0.05})`)
            .borderRadius(3)
            .position({ x: '50%', y: '50%' })
            .translate({ 
              x: -3 + Math.cos((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120,
              y: -3 + Math.sin((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120
            })
        })
      }
      .width('100%')
      .height('100%')
      
      // éšè—çš„é¢„åŠ è½½å›¾ç‰‡åŒºåŸŸ
      Stack() {
        ForEach(this.preloadImageUrls, (url: string, index: number) => {
          Image(url)
            .width(1)
            .height(1)
            .opacity(0)
            .position({ x: -1000, y: -1000 })
        })
      }
      .width(0)
      .height(0)
      .opacity(0)
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // é¡¶éƒ¨é—´è·
        Blank().height(100)
        
        // ä¸­å¿ƒåŠ¨ç”»åŒºåŸŸ
        Stack() {
          // å¤–åœˆå‘å…‰æ•ˆæœ - æ”¹ä¸ºç™½è‰²å‘å…‰
          Column()
            .width(200)
            .height(200)
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.05})`)
            .borderRadius(100)
            .border({ width: 2, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.2})` })
          
          // å†…åœˆ
          Column()
            .width(160)
            .height(160)
            .backgroundColor('rgba(255, 255, 255, 0.03)')
            .borderRadius(80)
            .border({ width: 1, color: 'rgba(255, 255, 255, 0.08)' })
          
          // ä¸­å¿ƒå›¾æ ‡
          Text('ğŸ¨')
            .fontSize(60)
            .fontColor('#fff')
            .opacity(this.textOpacity)
        }
        .margin({ bottom: 40 })
        
        // æ ‡é¢˜åŒºåŸŸ
        Column() {
          Text('AI åˆ›ä½œä¸­')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#fff')
            .opacity(this.textOpacity)
            .margin({ bottom: 8 })
          
          Text('æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆç‹¬ç‰¹çš„è§’è‰²å½¢è±¡')
            .fontSize(16)
            .fontColor('rgba(255, 255, 255, 0.7)')
            .opacity(this.textOpacity)
            .margin({ bottom: 50 })
        }
        .alignItems(HorizontalAlign.Center)
        
        // è¿›åº¦æ˜¾ç¤ºåŒºåŸŸ
        Column() {
          // å½“å‰é£æ ¼æ˜¾ç¤º - æ”¹ä¸ºç™½è‰²
          if (this.isGenerating && this.currentStyle) {
            Text(`æ­£åœ¨ç”Ÿæˆ: ${this.currentStyle}é£æ ¼`)
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#ffffff')
              .margin({ bottom: 25 })
          }
          
          // ç°ä»£åŒ–è¿›åº¦æ¡
          Stack() {
            // èƒŒæ™¯æ¡
            Column()
              .width('70%')
              .height(6)
              .backgroundColor('rgba(255, 255, 255, 0.1)')
              .borderRadius(3)
            
            // è¿›åº¦æ¡ - æ”¹ä¸ºç™½è‰²ï¼Œå®½åº¦éœ€è¦ç›¸å¯¹äº70%çš„å®¹å™¨è®¡ç®—
            Column()
              .width(`${this.progress * 0.7}%`)
              .height(6)
              .backgroundColor('#ffffff')
              .borderRadius(3)
          }
          .margin({ bottom: 15 })
          
          // è¿›åº¦ç™¾åˆ†æ¯” - æ”¹ä¸ºç™½è‰²
          Text(`${Math.round(this.progress)}%`)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ffffff')
            .margin({ bottom: 30 })
          
          // æˆåŠŸè®¡æ•°
          if (this.successfulStyles.length > 0) {
            Row() {
              Text('âœ¨')
                .fontSize(18)
                .margin({ right: 8 })
              Text(`å·²ç”Ÿæˆ ${this.successfulStyles.length} å¼ å›¾ç‰‡`)
                .fontSize(15)
                .fontColor('rgba(255, 255, 255, 0.9)')
            }
            .margin({ bottom: 30 })
          }
        }
        .alignItems(HorizontalAlign.Center)
        
        // åº•éƒ¨æç¤ºåŒºåŸŸ
        Column() {
          if (this.isGenerating) {
            Text('è¯·ç¨å€™ï¼ŒAIæ­£åœ¨ç²¾å¿ƒåˆ›ä½œæ‚¨çš„ä¸“å±è§’è‰²...')
              .fontSize(14)
              .fontColor('rgba(255, 255, 255, 0.6)')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 20 })
            
            // åŠ¨æ€åŠ è½½ç‚¹ - æ”¹ä¸ºç™½è‰²
            Row() {
              ForEach([0, 1, 2], (index: number) => {
                Column()
                  .width(6)
                  .height(6)
                  .backgroundColor('#ffffff')
                  .borderRadius(3)
                  .margin({ right: 8 })
                  .opacity(0.5 + (index * 0.2))
              })
            }
          }
          
          // é”™è¯¯å¤„ç†
          if (this.hasError) {
            Column() {
              Text('âŒ ç”Ÿæˆå¤±è´¥')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#ff6b6b')
                .margin({ bottom: 12 })
              
              Text('æ‰€æœ‰é£æ ¼å›¾ç‰‡ç”Ÿæˆéƒ½å¤±è´¥äº†')
                .fontSize(14)
                .fontColor('rgba(255, 255, 255, 0.7)')
                .textAlign(TextAlign.Center)
                .margin({ bottom: 25 })
              
              Button('é‡æ–°ç”Ÿæˆ')
                .width(150)
                .height(48)
                .backgroundColor('#ffffff')
                .fontColor('#000000')
                .fontWeight(FontWeight.Bold)
                .borderRadius(24)
                .onClick(() => this.startGeneration())
            }
            .alignItems(HorizontalAlign.Center)
          }
        }
        .alignItems(HorizontalAlign.Center)
        
        // åº•éƒ¨é—´è·
        Blank().layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
  }
} 