import router from '@ohos.router'
import { ApiService } from '../service/apiservice'
import http from '@ohos.net.http'

interface RouteParams {
  description: string;
  styles: string[];
}

@Entry
@Component
export struct LoadingPage {
  @State private progress: number = 0
  @State private currentStyle: string = ''
  @State private generatedUrls: string[] = []
  @State private successfulStyles: string[] = []
  @State private isGenerating: boolean = true
  @State private hasError: boolean = false
  @State private currentBgUrl: string = ''
  @State private lineRotation: number = 0
  @State private lineScale: number = 1.0
  @State private glowOpacity: number = 0.5
  @State private textOpacity: number = 0.8
  @State private arcRotation: number = 0

  private description: string = ''
  private styles: string[] = ['Âè§È£é', 'ËµõÂçö', 'Âç°ÈÄö', 'Âä®Êº´', 'QÁâà']

  aboutToAppear() {
    const params = router.getParams() as RouteParams
    this.description = params.description || ''
    this.styles = params.styles || ['Âè§È£é', 'ËµõÂçö', 'Âç°ÈÄö', 'Âä®Êº´', 'QÁâà']
    
    this.startAnimations()
    this.startGeneration()
  }

  private startAnimations() {
    // ÂúÜÂºßÊóãËΩ¨Âä®Áîª
    setInterval(() => {
      this.arcRotation += 3
    }, 50)
    
    // Á∫øÊù°Áº©ÊîæÂä®Áîª
    setInterval(() => {
      this.lineScale = this.lineScale === 1.0 ? 1.2 : 1.0
    }, 1000)
    
    // ÂèëÂÖâÊïàÊûúÂä®Áîª
    setInterval(() => {
      this.glowOpacity = this.glowOpacity === 0.5 ? 0.8 : 0.5
    }, 800)
    
    // ÊñáÂ≠óÈÄèÊòéÂ∫¶Âä®Áîª
    setInterval(() => {
      this.textOpacity = this.textOpacity === 0.8 ? 1.0 : 0.8
    }, 1200)
  }

  private async preloadImages(urls: string[]): Promise<void> {
    const promises = urls.map(url => {
      const httpRequest = http.createHttp();
      return httpRequest.request(url, {
        method: http.RequestMethod.GET,
        readTimeout: 10000,
        connectTimeout: 5000
      }).then(() => httpRequest.destroy())
        .catch(() => httpRequest.destroy());
    });
    await Promise.all(promises);
  }

  private async startGeneration() {
    this.isGenerating = true
    this.hasError = false
    this.generatedUrls = []
    this.successfulStyles = []
    this.progress = 0
    this.currentBgUrl = ''

    for (let i = 0; i < this.styles.length; i++) {
      const style = this.styles[i]
      this.currentStyle = style
      
      try {
        const imageUrl = await ApiService.generateFigure(this.description, style)
        if (imageUrl && imageUrl.trim() !== '' && !imageUrl.includes('ÁîüÊàêÂõæÁâáÊó∂Âá∫Áé∞ÈîôËØØ')) {
          this.generatedUrls.push(imageUrl)
          this.successfulStyles.push(style)
          this.currentBgUrl = imageUrl
          // Âè™ÊúâÂú®ÊàêÂäüÁîüÊàêÂõæÁâáÂêéÊâçÂ¢ûÂä†ËøõÂ∫¶
          this.progress = (this.successfulStyles.length / this.styles.length) * 100
        }
      } catch (error) {
        console.error(`ÁîüÊàê${style}È£éÊ†ºÂõæÁâáÂ§±Ë¥•:`, error)
      }
    }

    await this.preloadImages(this.generatedUrls);

    this.isGenerating = false
    
    if (this.generatedUrls.length === 0) {
      this.hasError = true
      return
    }

    setTimeout(() => {
      router.replaceUrl({
        url: 'pages/FigureResult',
        params: {
          imageUrls: this.generatedUrls,
          styles: this.successfulStyles,
          description: this.description
        }
      })
    }, 1000)
  }

  build() {
    Stack() {
      // Ê∑±Ëâ≤Ê∏êÂèòËÉåÊôØ - Êîπ‰∏∫Á∫ØÈªëËâ≤‰∏ªÈ¢ò
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#000000', 0.0], ['#0a0a0a', 0.5], ['#1a1a1a', 1.0]]
        })
      
      // ÊóãËΩ¨ÁöÑÂúÜÂºßËÉåÊôØ - Êîπ‰∏∫ÈªëËâ≤Á≥ªË£ÖÈ•∞
      Stack() {
        // Â§ö‰∏™ÂêåÂøÉÂúÜÂºßËΩ®ÈÅì
        ForEach([0, 1, 2, 3], (index: number) => {
          Stack() {
            // ÂúÜÂºßËΩ®ÈÅì - Êîπ‰∏∫Ê∑±ÁÅ∞Ëâ≤
            Column()
              .width(150 + index * 50)
              .height(150 + index * 50)
              .borderRadius((150 + index * 50) / 2)
              .border({ width: 1, color: `rgba(64, 64, 64, ${0.3 - index * 0.05})` })
              .position({ x: '50%', y: '50%' })
              .translate({ x: -(150 + index * 50) / 2, y: -(150 + index * 50) / 2 })
            
            // ÊóãËΩ¨ÁöÑÂúÜÂºßÁÇπ - Êîπ‰∏∫ÁôΩËâ≤Á≥ª
            Column()
              .width(10)
              .height(10)
              .backgroundColor(`rgba(255, 255, 255, ${0.6 - index * 0.1})`)
              .borderRadius(5)
              .position({ x: '50%', y: '50%' })
              .translate({ 
                x: -5 + Math.cos((this.arcRotation + index * 90) * Math.PI / 180) * (75 + index * 25),
                y: -5 + Math.sin((this.arcRotation + index * 90) * Math.PI / 180) * (75 + index * 25)
              })
          }
        })
        
        // Â§ñÂúàË£ÖÈ•∞ÁÇπ - Êîπ‰∏∫Èì∂Ëâ≤Á≥ª
        ForEach([0, 1, 2, 3, 4, 5], (index: number) => {
          Column()
            .width(6)
            .height(6)
            .backgroundColor(`rgba(192, 192, 192, ${0.4 - index * 0.05})`)
            .borderRadius(3)
            .position({ x: '50%', y: '50%' })
            .translate({ 
              x: -3 + Math.cos((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120,
              y: -3 + Math.sin((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120
            })
        })
      }
      .width('100%')
      .height('100%')
      
      // ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü
      Column() {
        // È°∂ÈÉ®Èó¥Ë∑ù
        Blank().height(100)
        
        // ‰∏≠ÂøÉÂä®ÁîªÂå∫Âüü
        Stack() {
          // Â§ñÂúàÂèëÂÖâÊïàÊûú - Êîπ‰∏∫ÁôΩËâ≤ÂèëÂÖâ
          Column()
            .width(200)
            .height(200)
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.05})`)
            .borderRadius(100)
            .border({ width: 2, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.2})` })
          
          // ÂÜÖÂúà
          Column()
            .width(160)
            .height(160)
            .backgroundColor('rgba(255, 255, 255, 0.03)')
            .borderRadius(80)
            .border({ width: 1, color: 'rgba(255, 255, 255, 0.08)' })
          
          // ‰∏≠ÂøÉÂõæÊ†á
          Text('üé®')
            .fontSize(60)
            .fontColor('#fff')
            .opacity(this.textOpacity)
        }
        .margin({ bottom: 40 })
        
        // Ê†áÈ¢òÂå∫Âüü
        Column() {
          Text('AI Âàõ‰Ωú‰∏≠')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#fff')
            .opacity(this.textOpacity)
            .margin({ bottom: 8 })
          
          Text('Ê≠£Âú®‰∏∫ÊÇ®ÁîüÊàêÁã¨ÁâπÁöÑËßíËâ≤ÂΩ¢Ë±°')
            .fontSize(16)
            .fontColor('rgba(255, 255, 255, 0.7)')
            .opacity(this.textOpacity)
            .margin({ bottom: 50 })
        }
        .alignItems(HorizontalAlign.Center)
        
        // ËøõÂ∫¶ÊòæÁ§∫Âå∫Âüü
        Column() {
          // ÂΩìÂâçÈ£éÊ†ºÊòæÁ§∫ - Êîπ‰∏∫ÁôΩËâ≤
          if (this.isGenerating && this.currentStyle) {
            Text(`Ê≠£Âú®ÁîüÊàê: ${this.currentStyle}È£éÊ†º`)
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#ffffff')
              .margin({ bottom: 25 })
          }
          
          // Áé∞‰ª£ÂåñËøõÂ∫¶Êù°
          Stack() {
            // ËÉåÊôØÊù°
            Column()
              .width('70%')
              .height(6)
              .backgroundColor('rgba(255, 255, 255, 0.1)')
              .borderRadius(3)
            
            // ËøõÂ∫¶Êù° - Êîπ‰∏∫ÁôΩËâ≤ÔºåÂÆΩÂ∫¶ÈúÄË¶ÅÁõ∏ÂØπ‰∫é70%ÁöÑÂÆπÂô®ËÆ°ÁÆó
            Column()
              .width(`${this.progress * 0.7}%`)
              .height(6)
              .backgroundColor('#ffffff')
              .borderRadius(3)
          }
          .margin({ bottom: 15 })
          
          // ËøõÂ∫¶ÁôæÂàÜÊØî - Êîπ‰∏∫ÁôΩËâ≤
          Text(`${Math.round(this.progress)}%`)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#ffffff')
            .margin({ bottom: 30 })
          
          // ÊàêÂäüËÆ°Êï∞
          if (this.successfulStyles.length > 0) {
            Row() {
              Text('‚ú®')
                .fontSize(18)
                .margin({ right: 8 })
              Text(`Â∑≤ÁîüÊàê ${this.successfulStyles.length} Âº†ÂõæÁâá`)
                .fontSize(15)
                .fontColor('rgba(255, 255, 255, 0.9)')
            }
            .margin({ bottom: 30 })
          }
        }
        .alignItems(HorizontalAlign.Center)
        
        // Â∫ïÈÉ®ÊèêÁ§∫Âå∫Âüü
        Column() {
          if (this.isGenerating) {
            Text('ËØ∑Á®çÂÄôÔºåAIÊ≠£Âú®Á≤æÂøÉÂàõ‰ΩúÊÇ®ÁöÑ‰∏ìÂ±ûËßíËâ≤...')
              .fontSize(14)
              .fontColor('rgba(255, 255, 255, 0.6)')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 20 })
            
            // Âä®ÊÄÅÂä†ËΩΩÁÇπ - Êîπ‰∏∫ÁôΩËâ≤
            Row() {
              ForEach([0, 1, 2], (index: number) => {
                Column()
                  .width(6)
                  .height(6)
                  .backgroundColor('#ffffff')
                  .borderRadius(3)
                  .margin({ right: 8 })
                  .opacity(0.5 + (index * 0.2))
              })
            }
          }
          
          // ÈîôËØØÂ§ÑÁêÜ
          if (this.hasError) {
            Column() {
              Text('‚ùå ÁîüÊàêÂ§±Ë¥•')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#ff6b6b')
                .margin({ bottom: 12 })
              
              Text('ÊâÄÊúâÈ£éÊ†ºÂõæÁâáÁîüÊàêÈÉΩÂ§±Ë¥•‰∫Ü')
                .fontSize(14)
                .fontColor('rgba(255, 255, 255, 0.7)')
                .textAlign(TextAlign.Center)
                .margin({ bottom: 25 })
              
              Button('ÈáçÊñ∞ÁîüÊàê')
                .width(150)
                .height(48)
                .backgroundColor('#ffffff')
                .fontColor('#000000')
                .fontWeight(FontWeight.Bold)
                .borderRadius(24)
                .onClick(() => this.startGeneration())
            }
            .alignItems(HorizontalAlign.Center)
          }
        }
        .alignItems(HorizontalAlign.Center)
        
        // Â∫ïÈÉ®Èó¥Ë∑ù
        Blank().layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
  }
} 