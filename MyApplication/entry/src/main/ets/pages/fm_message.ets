import router from '@ohos.router'
import { fetchWeather } from '../model/WeatherService';
import { ApiService } from '../service/apiservice';
import { Conversation, AiRole } from '../common/types';
import { getUserId } from '../common/constants';

class WeatherInfo {
  city: string = 'åŠ è½½ä¸­';
  temperature: string = '--Â°';
  icon: string = 'â“';
  desc: string = 'åŠ è½½ä¸­';
}
class MessageItem {
  avatar: Resource = $r('app.media.splash');
  name: string = '';
  desc: string = '';
  time: string = '';
  followed: boolean = false;
  unread: number = 0;
  isOfficial?: boolean = false;
  isSystem?: boolean = false;
}
@Entry
@Component
export struct MessagePage {
  @State weatherInfo: WeatherInfo = new WeatherInfo();
  @State currentTime: string = '';
  @State currentDate: string = '';
  @State private conversations: Conversation[] = [];
  @State private aiRoleMap: Record<number, AiRole> = {};
  @State arcRotation: number = 0 // åœ†å¼§æ—‹è½¬è§’åº¦
  @State starTwinkle: number = 0 // æ˜Ÿæ˜Ÿé—ªçƒæ•ˆæœ
  @State glowOpacity: number = 0.5 // å‘å…‰æ•ˆæœé€æ˜åº¦
  @State textOpacity: number = 0.8 // æ–‡å­—é€æ˜åº¦
  @State nebulaOpacity: number = 0.3 // æ˜Ÿäº‘é€æ˜åº¦
  private timerId: number = -1;

  aboutToAppear() {
    this.startGalaxyAnimations()
    this.getWeatherByLocation();
    this.updateDateTime();
    this.loadConversations();
    this.timerId = setInterval(() => {
      this.updateDateTime();
    }, 1000);
  }

  private startGalaxyAnimations() {
    // åœ†å¼§æ—‹è½¬åŠ¨ç”»
    setInterval(() => {
      this.arcRotation += 1.5
    }, 50)
    
    // æ˜Ÿæ˜Ÿé—ªçƒåŠ¨ç”»
    setInterval(() => {
      this.starTwinkle += 0.1
    }, 100)
    
    // å‘å…‰æ•ˆæœåŠ¨ç”»
    setInterval(() => {
      this.glowOpacity = this.glowOpacity === 0.5 ? 0.8 : 0.5
    }, 1200)
    
    // æ–‡å­—é€æ˜åº¦åŠ¨ç”»
    setInterval(() => {
      this.textOpacity = this.textOpacity === 0.8 ? 1.0 : 0.8
    }, 1800)
    
    // æ˜Ÿäº‘é€æ˜åº¦åŠ¨ç”»
    setInterval(() => {
      this.nebulaOpacity = this.nebulaOpacity === 0.3 ? 0.6 : 0.3
    }, 3000)
  }

  // æ–°å¢ï¼šé¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°å¯¹è¯åˆ—è¡¨
  onPageShow() {
    console.log('Messageé¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°å¯¹è¯åˆ—è¡¨');
    this.loadConversations();
  }

  aboutToDisappear() {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
  }

  updateDateTime() {
    const now = new Date();
    
    // æ ¼å¼åŒ–æ—¶é—´ HH:MM
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    this.currentTime = `${hours}:${minutes}`;
    
    // æ ¼å¼åŒ–æ—¥æœŸå’Œæ˜ŸæœŸ
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const weekday = weekdays[now.getDay()];
    this.currentDate = `${year}å¹´${month}æœˆ${day}æ—¥ ${weekday}`;
  }

  async getWeatherByLocation() {
    const data = await fetchWeather('101200101'); // æ­¦æ±‰
    console.log('fetchWeatherè¿”å›:', JSON.stringify(data));
    if (data && data.status === 200 && data.data && data.cityInfo) {
      this.weatherInfo.city = data.cityInfo.city;
      this.weatherInfo.temperature = data.data.wendu + 'Â°';
      this.weatherInfo.desc = data.data.forecast && data.data.forecast.length > 0 ? data.data.forecast[0].type : '';
      this.weatherInfo.icon = this.iconMap(this.weatherInfo.desc);
    } else {
      this.weatherInfo.city = 'è·å–å¤±è´¥';
      this.weatherInfo.temperature = '--Â°';
      this.weatherInfo.desc = 'å¤©æ°”è·å–å¤±è´¥';
      this.weatherInfo.icon = 'âŒ';
    }
  }

  iconMap(desc: string): string {
    switch (desc) {
      case 'æ™´': return 'â˜€ï¸';
      case 'å¤šäº‘': return 'ğŸŒ¤ï¸';
      case 'é˜´': return 'â˜ï¸';
      case 'å°é›¨': return 'ğŸŒ§ï¸';
      case 'ä¸­é›¨': return 'ğŸŒ§ï¸';
      case 'å¤§é›¨': return 'â›ˆï¸';
      case 'é›·é˜µé›¨': return 'â›ˆï¸';
      case 'é›ª': return 'â„ï¸';
      case 'é›¾': return 'ğŸŒ«ï¸';
      default: return 'â“';
    }
  }

  async loadConversations() {
    try {
      // è·å–å…¨å±€ç”¨æˆ·ID
      const userId = getUserId();
      
      // æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æœ‰æ•ˆ
      if (userId === null) {
        console.warn('ç”¨æˆ·IDä¸ºç©ºï¼Œæ— æ³•åŠ è½½å¯¹è¯åˆ—è¡¨');
        this.conversations = [];
        this.aiRoleMap = {};
        return;
      }
      
      console.log('ä½¿ç”¨ç”¨æˆ·IDåŠ è½½å¯¹è¯åˆ—è¡¨:', userId);
      const conversations = await ApiService.getConversationsByUserId(userId);
      this.conversations = conversations;
      
      // æ‰¹é‡è·å–AIè§’è‰²ä¿¡æ¯
      const aiRoleIds = Array.from(new Set(conversations.map(c => c.aiRoleId)));
      const aiRoleMap: Record<number, AiRole> = {};
      for (const id of aiRoleIds) {
        try {
          aiRoleMap[id] = await ApiService.getAiRoleById(id);
        } catch (e) {
          console.error('è·å–AIè§’è‰²ä¿¡æ¯å¤±è´¥ï¼Œè§’è‰²ID:', id, e);
          // å¤±è´¥åˆ™è·³è¿‡
        }
      }
      this.aiRoleMap = aiRoleMap;
      
      console.log('æˆåŠŸåŠ è½½å¯¹è¯åˆ—è¡¨ï¼Œå¯¹è¯æ•°é‡:', conversations.length);
    } catch (e) {
      console.error('åŠ è½½ä¼šè¯å¤±è´¥', e);
      this.conversations = [];
      this.aiRoleMap = {};
    }
  }

  build(): void {
    Stack() {
      // æ·±è‰²æ¸å˜èƒŒæ™¯ - æ”¹ä¸ºçº¯é»‘è‰²ä¸»é¢˜
      Column()
        .width('100%')
        .height('100%')
        .linearGradient({
          direction: GradientDirection.Bottom,
          colors: [['#000000', 0.0], ['#0a0a0a', 0.5], ['#1a1a1a', 1.0]]
        })
      
      // æ—‹è½¬çš„åœ†å¼§èƒŒæ™¯ - æ”¹ä¸ºé»‘è‰²ç³»è£…é¥°
      Stack() {
        // å¤šä¸ªåŒå¿ƒåœ†å¼§è½¨é“
        ForEach([0, 1, 2, 3], (index: number) => {
          Stack() {
            // åœ†å¼§è½¨é“ - æ”¹ä¸ºæ·±ç°è‰²
            Column()
              .width(250 + index * 60)
              .height(250 + index * 60)
              .borderRadius((250 + index * 60) / 2)
              .border({ width: 1, color: `rgba(64, 64, 64, ${0.3 - index * 0.05})` })
              .position({ x: '50%', y: '50%' })
              .translate({ x: -(250 + index * 60) / 2, y: -(250 + index * 60) / 2 })
            
            // æ—‹è½¬çš„åœ†å¼§ç‚¹ - æ”¹ä¸ºç™½è‰²ç³»
            Column()
              .width(6)
              .height(6)
              .backgroundColor(`rgba(255, 255, 255, ${0.6 - index * 0.1})`)
              .borderRadius(3)
              .position({ x: '50%', y: '50%' })
              .translate({ 
                x: -3 + Math.cos((this.arcRotation + index * 90) * Math.PI / 180) * (125 + index * 30),
                y: -3 + Math.sin((this.arcRotation + index * 90) * Math.PI / 180) * (125 + index * 30)
              })
          }
        })
        
        // å¤–åœˆè£…é¥°ç‚¹ - æ”¹ä¸ºé“¶è‰²ç³»
        ForEach([0, 1, 2, 3, 4, 5], (index: number) => {
          Column()
            .width(6)
            .height(6)
            .backgroundColor(`rgba(192, 192, 192, ${0.4 - index * 0.05})`)
            .borderRadius(3)
            .position({ x: '50%', y: '50%' })
            .translate({ 
              x: -3 + Math.cos((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120,
              y: -3 + Math.sin((this.arcRotation * 0.5 + index * 60) * Math.PI / 180) * 120
            })
        })
      }
      .width('100%')
      .height('100%')
      
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        // å¤©æ°”å¡ç‰‡éƒ¨åˆ†
        Stack() {
          // å¤©æ°”å¡ç‰‡èƒŒæ™¯å‘å…‰æ•ˆæœ
          Column()
            .width('100%')
            .height(160)
            .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.05})`)
            .borderRadius(24)
            .border({ width: 2, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.2})` })
          
          Column() {
            // ä¸ŠåŠéƒ¨åˆ†ï¼šæ¸©åº¦ã€åŸå¸‚ã€å¤©æ°”æè¿°å’Œå›¾æ ‡
            Row() {
              // å·¦ä¾§ï¼šæ¸©åº¦
              Text(this.weatherInfo.temperature)
                .fontSize(42)
                .fontWeight(FontWeight.Bold)
                .fontColor('#ffffff')
                .opacity(this.textOpacity)
                .margin({ left: 20, top: 16, bottom: 0, right: 0 })
              
              // ä¸­é—´ï¼šåŸå¸‚å’Œå¤©æ°”æè¿°
              Column() {
                Text(this.weatherInfo.city)
                  .fontSize(16)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ffffff')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 4 })
                Text(this.weatherInfo.desc)
                  .fontSize(14)
                  .fontColor('rgba(255, 255, 255, 0.9)')
                  .opacity(this.textOpacity)
                  .margin({ bottom: 0 })
              }
              .alignItems(HorizontalAlign.Start)
              .margin({ left: 16, top: 16, bottom: 0, right: 0 })
              
              // å³ä¾§ï¼šå¤©æ°”å›¾æ ‡
              Blank().layoutWeight(1)
              Text(this.weatherInfo.icon)
                .fontSize(36)
                .fontColor('#ffffff')
                .opacity(this.textOpacity)
                .margin({ right: 20, top: 16, bottom: 0 })
            }
            .width('100%')
            .height(60)
            
            // ä¸‹åŠéƒ¨åˆ†ï¼šæ—¶é—´æ—¥æœŸ
            Column() {
              Text(this.currentTime)
                .fontSize(24)
                .fontColor('#ffffff')
                .fontWeight(FontWeight.Bold)
                .opacity(this.textOpacity)
                .margin({ top: 8, bottom: 4 })
              Text(this.currentDate)
                .fontSize(13)
                .fontColor('rgba(255, 255, 255, 0.8)')
                .opacity(this.textOpacity)
                .margin({ bottom: 16 })
            }
            .alignItems(HorizontalAlign.Center)
            .width('100%')
          }
          .width('100%')
          .height(160)
          .backgroundColor('rgba(255, 255, 255, 0.03)')
          .borderRadius(24)
          .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
          .margin({ left: 12, right: 12, top: 12, bottom: 16 })
          .shadow({ radius: 16, color: '#00000040', offsetX: 0, offsetY: 6 })
        }
        
        // æ¶ˆæ¯åˆ—è¡¨
        if (this.conversations.length > 0) {
          List() {
            ForEach(this.conversations, (conv: Conversation, idx: number) => {
              ListItem() {
                Stack() {
                  // æ¶ˆæ¯å¡ç‰‡èƒŒæ™¯å‘å…‰
                  Column()
                    .width('100%')
                    .height(80)
                    .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.02})`)
                    .borderRadius(16)
                    .border({ width: 1, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.1})` })
                  
                  Row() {
                    Image(this.aiRoleMap[conv.aiRoleId]?.avatarUrl)
                      .width(48)
                      .height(48)
                      .borderRadius(24)
                      .border({ width: 2, color: 'rgba(255, 255, 255, 0.2)' })
                      .margin({ left: 16, right: 12 })
                    Column({ space: 4 }) {
                      Text(conv.title)
                        .fontSize(16)
                        .fontColor('#ffffff')
                        .fontWeight(FontWeight.Bold)
                        .opacity(this.textOpacity)
                      Text('') // å¯æ‰©å±•ä¸ºæ‘˜è¦
                        .fontSize(13)
                        .fontColor('rgba(255, 255, 255, 0.7)')
                        .maxLines(1)
                        .margin({ top: 2 })
                    }
                    .layoutWeight(1)
                    Column() {
                      Text(conv.lastActive ? conv.lastActive.replace('T', ' ').slice(0, 16) : '')
                        .fontSize(12)
                        .fontColor('rgba(255, 255, 255, 0.6)')
                        .margin({ bottom: 8 })
                    }
                    .alignItems(HorizontalAlign.End)
                    .margin({ right: 16 })
                  }
                  .width('100%')
                  .height(80)
                  .backgroundColor('rgba(255, 255, 255, 0.03)')
                  .borderRadius(16)
                  .border({ width: 1, color: 'rgba(255, 255, 255, 0.1)' })
                  .margin({ left: 12, right: 12, bottom: 8 })
                  .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 2 })
                }
                .onClick(() => {
                  const aiRole = this.aiRoleMap[conv.aiRoleId];
                  console.log('è§’è‰²ID:', aiRole.id);
                  router.pushUrl({
                    url: 'pages/chat',
                    params: {
                      figureImageUrl: aiRole?.avatarUrl ,
                      figureType: aiRole?.roleType ,
                      figureName: aiRole?.roleName ,
                      isFromCreateFigure: false,
                      description: aiRole?.roleDescription ,
                      createdAiRoleId: aiRole?.id
                    }
                  });
                })
              }
            }, (conv: Conversation) => conv.id.toString())
          }
          .width('100%')
          .layoutWeight(1)
        } else {
          // ç©ºçŠ¶æ€æ˜¾ç¤º
          Column() {
            // å‘å…‰åœ†åœˆ
            Stack() {
              Column()
                .width(140)
                .height(140)
                .backgroundColor(`rgba(255, 255, 255, ${this.glowOpacity * 0.05})`)
                .borderRadius(70)
                .border({ width: 2, color: `rgba(255, 255, 255, ${this.glowOpacity * 0.2})` })
              
              Text('ğŸ’¬')
                .fontSize(70)
                .fontColor('#ffffff')
                .opacity(this.textOpacity)
            }
            .margin({ top: 100, bottom: 24 })
            
            Text('æš‚æ— å¯¹è¯è®°å½•')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#ffffff')
              .opacity(this.textOpacity)
              .margin({ bottom: 12 })
            
            Text('å¼€å§‹ä¸AIè§’è‰²èŠå¤©ï¼Œåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªå¯¹è¯å§ï¼')
              .fontSize(14)
              .fontColor('rgba(255, 255, 255, 0.7)')
              .textAlign(TextAlign.Center)
              .opacity(this.textOpacity)
              .margin({ left: 40, right: 40 })
          }
          .width('100%')
          .layoutWeight(1)
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
        }
        Blank().height(56)
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
  }
} 