import router from '@ohos.router'
import { fetchWeather } from '../model/WeatherService';
import { ApiService } from '../service/apiservice';
import { Conversation, AiRole } from '../common/types';
import { getUserId } from '../common/constants';

class WeatherInfo {
  city: string = 'åŠ è½½ä¸­';
  temperature: string = '--Â°';
  icon: string = 'â“';
  desc: string = 'åŠ è½½ä¸­';
}
class MessageItem {
  avatar: Resource = $r('app.media.splash');
  name: string = '';
  desc: string = '';
  time: string = '';
  followed: boolean = false;
  unread: number = 0;
  isOfficial?: boolean = false;
  isSystem?: boolean = false;
}
@Entry
@Component
export struct MessagePage {
  @State weatherInfo: WeatherInfo = new WeatherInfo();
  @State currentTime: string = '';
  @State currentDate: string = '';
  @State private conversations: Conversation[] = [];
  @State private aiRoleMap: Record<number, AiRole> = {};
  private timerId: number = -1;

  aboutToAppear() {
    this.getWeatherByLocation();
    this.updateDateTime();
    this.loadConversations();
    this.timerId = setInterval(() => {
      this.updateDateTime();
    }, 1000);
  }

  // æ–°å¢ï¼šé¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°å¯¹è¯åˆ—è¡¨
  onPageShow() {
    console.log('Messageé¡µé¢æ˜¾ç¤ºï¼Œåˆ·æ–°å¯¹è¯åˆ—è¡¨');
    this.loadConversations();
  }

  aboutToDisappear() {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
  }

  updateDateTime() {
    const now = new Date();
    
    // æ ¼å¼åŒ–æ—¶é—´ HH:MM
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    this.currentTime = `${hours}:${minutes}`;
    
    // æ ¼å¼åŒ–æ—¥æœŸå’Œæ˜ŸæœŸ
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const weekday = weekdays[now.getDay()];
    this.currentDate = `${year}å¹´${month}æœˆ${day}æ—¥ ${weekday}`;
  }

  async getWeatherByLocation() {
    const data = await fetchWeather('101200101'); // æ­¦æ±‰
    console.log('fetchWeatherè¿”å›:', JSON.stringify(data));
    if (data && data.status === 200 && data.data && data.cityInfo) {
      this.weatherInfo.city = data.cityInfo.city;
      this.weatherInfo.temperature = data.data.wendu + 'Â°';
      this.weatherInfo.desc = data.data.forecast && data.data.forecast.length > 0 ? data.data.forecast[0].type : '';
      this.weatherInfo.icon = this.iconMap(this.weatherInfo.desc);
    } else {
      this.weatherInfo.city = 'è·å–å¤±è´¥';
      this.weatherInfo.temperature = '--Â°';
      this.weatherInfo.desc = 'å¤©æ°”è·å–å¤±è´¥';
      this.weatherInfo.icon = 'âŒ';
    }
  }

  iconMap(desc: string): string {
    switch (desc) {
      case 'æ™´': return 'â˜€ï¸';
      case 'å¤šäº‘': return 'ğŸŒ¤ï¸';
      case 'é˜´': return 'â˜ï¸';
      case 'å°é›¨': return 'ğŸŒ§ï¸';
      case 'ä¸­é›¨': return 'ğŸŒ§ï¸';
      case 'å¤§é›¨': return 'â›ˆï¸';
      case 'é›·é˜µé›¨': return 'â›ˆï¸';
      case 'é›ª': return 'â„ï¸';
      case 'é›¾': return 'ğŸŒ«ï¸';
      default: return 'â“';
    }
  }

  async loadConversations() {
    try {
      // è·å–å…¨å±€ç”¨æˆ·ID
      const userId = getUserId();
      
      // æ£€æŸ¥ç”¨æˆ·IDæ˜¯å¦æœ‰æ•ˆ
      if (userId === null) {
        console.warn('ç”¨æˆ·IDä¸ºç©ºï¼Œæ— æ³•åŠ è½½å¯¹è¯åˆ—è¡¨');
        this.conversations = [];
        this.aiRoleMap = {};
        return;
      }
      
      console.log('ä½¿ç”¨ç”¨æˆ·IDåŠ è½½å¯¹è¯åˆ—è¡¨:', userId);
      const conversations = await ApiService.getConversationsByUserId(userId);
      this.conversations = conversations;
      
      // æ‰¹é‡è·å–AIè§’è‰²ä¿¡æ¯
      const aiRoleIds = Array.from(new Set(conversations.map(c => c.aiRoleId)));
      const aiRoleMap: Record<number, AiRole> = {};
      for (const id of aiRoleIds) {
        try {
          aiRoleMap[id] = await ApiService.getAiRoleById(id);
        } catch (e) {
          console.error('è·å–AIè§’è‰²ä¿¡æ¯å¤±è´¥ï¼Œè§’è‰²ID:', id, e);
          // å¤±è´¥åˆ™è·³è¿‡
        }
      }
      this.aiRoleMap = aiRoleMap;
      
      console.log('æˆåŠŸåŠ è½½å¯¹è¯åˆ—è¡¨ï¼Œå¯¹è¯æ•°é‡:', conversations.length);
    } catch (e) {
      console.error('åŠ è½½ä¼šè¯å¤±è´¥', e);
      this.conversations = [];
      this.aiRoleMap = {};
    }
  }

  build(): void {
    Column() {
      // å¤©æ°”å¡ç‰‡éƒ¨åˆ†
      Stack() {
        Column() {
          Row() {
            Text(this.weatherInfo.temperature)
              .fontSize(48)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .margin({ left: 16, top: 10, bottom: 4, right: 8 })
            Column() {
              Text(this.weatherInfo.city)
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#fff')
                .margin({ bottom: 1 })
              Text(this.weatherInfo.desc)
                .fontSize(13)
                .fontColor('#fff')
                .margin({ bottom: 1 })
            }
            .margin({ top: 10 })
            Blank().layoutWeight(1)
            Column() {
              Text(this.weatherInfo.icon)
                .fontSize(32)
                .margin({ top: 4, right: 12 })
            }
          }
          
          // å½“å‰æ—¶é—´æ—¥æœŸ
          Column() {
            Text(this.currentTime)
              .fontSize(20)
              .fontColor('#fff')
              .fontWeight(FontWeight.Bold)
              .margin({ top: 8, bottom: 4 })
            Text(this.currentDate)
              .fontSize(12)
              .fontColor('#fff')
              .opacity(0.9)
              .margin({ bottom: 8 })
          }
          .alignItems(HorizontalAlign.Center)
        }
        .width('100%')
        .height(140)
        .backgroundColor('rgba(34,34,34,0.7)')
        .borderRadius(24)
        .margin({ left: 8, right: 8, top: 8, bottom: 12 })
        .shadow({ radius: 8, color: '#00000022', offsetX: 0, offsetY: 2 })
      }
      // æ¶ˆæ¯åˆ—è¡¨
      if (this.conversations.length > 0) {
        List() {
          ForEach(this.conversations, (conv: Conversation, idx: number) => {
            ListItem() {
              Row() {
                Image(this.aiRoleMap[conv.aiRoleId]?.avatarUrl)
                  .width(48)
                  .height(48)
                  .borderRadius(24)
                  .margin({ left: 16, right: 12 })
                Column({ space: 4 }) {
                  Text(conv.title)
                    .fontSize(16)
                    .fontColor('#fff')
                    .fontWeight(FontWeight.Bold)
                  Text('') // å¯æ‰©å±•ä¸ºæ‘˜è¦
                    .fontSize(13)
                    .fontColor('#bbb')
                    .maxLines(1)
                    .margin({ top: 2 })
                }
                .layoutWeight(1)
                Column() {
                  Text(conv.lastActive ? conv.lastActive.replace('T', ' ').slice(0, 16) : '')
                    .fontSize(12)
                    .fontColor('#888')
                    .margin({ bottom: 8 })
                }
                .alignItems(HorizontalAlign.End)
                .margin({ right: 16 })
              }
              .height(64)
              .backgroundColor('rgba(34,34,34,0)')
            }
            .onClick(() => {
              const aiRole = this.aiRoleMap[conv.aiRoleId];
              console.log('è§’è‰²ID:', aiRole.id);
              router.pushUrl({
                url: 'pages/chat',
                params: {
                  figureImageUrl: aiRole?.avatarUrl ,
                  figureType: aiRole?.roleType ,
                  figureName: aiRole?.roleName ,
                  isFromCreateFigure: false,
                  description: aiRole?.roleDescription ,
                  createdAiRoleId: aiRole?.id
                }
              });
            })
          }, (conv: Conversation) => conv.id.toString())
        }
        .width('100%')
        .backgroundColor('#181818')
        .layoutWeight(1)
      } else {
        // ç©ºçŠ¶æ€æ˜¾ç¤º
        Column() {
          Image($r('app.media.splash'))
            .width(120)
            .height(120)
            .margin({ top: 100, bottom: 20 })
            .opacity(0.5)
          Text('æš‚æ— å¯¹è¯è®°å½•')
            .fontSize(16)
            .fontColor('#888')
            .margin({ bottom: 8 })
          Text('å¼€å§‹ä¸AIè§’è‰²èŠå¤©ï¼Œåˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªå¯¹è¯å§ï¼')
            .fontSize(14)
            .fontColor('#666')
            .textAlign(TextAlign.Center)
            .margin({ left: 40, right: 40 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#181818')
      }
      Blank().height(56)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#181818')
  }
} 