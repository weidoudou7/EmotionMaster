import { fetchWeather } from '../model/WeatherService';

class WeatherInfo {
  city: string = 'åŠ è½½ä¸­';
  temperature: string = '--Â°';
  icon: string = 'â“';
  desc: string = 'åŠ è½½ä¸­';
}
class MessageItem {
  avatar: Resource = $r('app.media.splash');
  name: string = '';
  desc: string = '';
  time: string = '';
  followed: boolean = false;
  unread: number = 0;
  isOfficial?: boolean = false;
  isSystem?: boolean = false;
}

@Entry
@Component
export struct MessagePage {
  @State weatherInfo: WeatherInfo = new WeatherInfo();
  @State currentTime: string = '';
  @State currentDate: string = '';
  private messages: MessageItem[] = [
    (() => { let m = new MessageItem(); m.avatar = $r('app.media.splash'); m.name = 'è°¢åŽŒä¹‹'; m.desc = 'ï¼ˆèƒƒé‡Œä¸€é˜µç»žç—›ï¼Œé¢ä¸Šæ¸—å‡ºç»†æ±—ï¼Œå’¬ç€ç‰™è¯´é“ï¼‰...'; m.time = 'æ˜ŸæœŸå››'; m.followed = true; m.unread = 0; return m; })(),
    (() => { let m = new MessageItem(); m.avatar = $r('app.media.splash'); m.name = 'èƒ½çŒœå‡ºä½ å¦/æŽ¨'; m.desc = '[ç³»ç»Ÿæ¶ˆæ¯]è§£é”"å¾®ç¬‘"æ—¶åˆ»ï¼Œå¯åœ¨è¯¦æƒ…æŸ¥çœ‹ åŽ»æŸ¥çœ‹'; m.time = 'æ˜ŸæœŸå››'; m.followed = false; m.unread = 0; return m; })(),
    (() => { let m = new MessageItem(); m.avatar = $r('app.media.splash'); m.name = 'æ˜Ÿè‹¥ï¼ˆAIåŠ©æ‰‹ï¼‰'; m.desc = 'æ ¹æ®æœç´¢ææ–™ï¼Œä»¥ä¸‹æ˜¯æ­¦æ±‰å¸‚2025å¹´6æœˆ27æ—¥çš„...'; m.time = 'æ˜ŸæœŸå››'; m.followed = false; m.unread = 0; m.isOfficial = true; return m; })(),
    (() => { let m = new MessageItem(); m.avatar = $r('app.media.splash'); m.name = 'ç³»ç»Ÿé€šçŸ¥'; m.desc = 'ðŸ“»æ¬¢è¿Žæ–°äººä¸»æ’­ã€Œæ­¦åª›å¨˜ã€å…¥é©»æ˜Ÿé‡Žï¼'; m.time = 'æ˜ŸæœŸä¸€'; m.followed = false; m.unread = 0; m.isSystem = true; return m; })(),
  ];
  private timerId: number = -1;

  aboutToAppear() {
    this.getWeatherByLocation();
    this.updateDateTime();
    // å¯åŠ¨å®šæ—¶å™¨ï¼Œæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ—¶é—´
    this.timerId = setInterval(() => {
      this.updateDateTime();
    }, 1000); //
  }

  aboutToDisappear() {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.timerId !== -1) {
      clearInterval(this.timerId);
      this.timerId = -1;
    }
  }

  updateDateTime() {
    const now = new Date();
    
    // æ ¼å¼åŒ–æ—¶é—´ HH:MM
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    this.currentTime = `${hours}:${minutes}`;
    
    // æ ¼å¼åŒ–æ—¥æœŸå’Œæ˜ŸæœŸ
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    const weekdays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
    const weekday = weekdays[now.getDay()];
    this.currentDate = `${year}å¹´${month}æœˆ${day}æ—¥ ${weekday}`;
  }

  async getWeatherByLocation() {
    const data = await fetchWeather('101200101'); // æ­¦æ±‰
    console.log('fetchWeatherè¿”å›ž:', JSON.stringify(data));
    if (data && data.status === 200 && data.data && data.cityInfo) {
      this.weatherInfo.city = data.cityInfo.city;
      this.weatherInfo.temperature = data.data.wendu + 'Â°';
      this.weatherInfo.desc = data.data.forecast && data.data.forecast.length > 0 ? data.data.forecast[0].type : '';
      this.weatherInfo.icon = this.iconMap(this.weatherInfo.desc);
    } else {
      this.weatherInfo.city = 'èŽ·å–å¤±è´¥';
      this.weatherInfo.temperature = '--Â°';
      this.weatherInfo.desc = 'å¤©æ°”èŽ·å–å¤±è´¥';
      this.weatherInfo.icon = 'âŒ';
    }
  }

  iconMap(desc: string): string {
    switch (desc) {
      case 'æ™´': return 'â˜€ï¸';
      case 'å¤šäº‘': return 'ðŸŒ¤ï¸';
      case 'é˜´': return 'â˜ï¸';
      case 'å°é›¨': return 'ðŸŒ§ï¸';
      case 'ä¸­é›¨': return 'ðŸŒ§ï¸';
      case 'å¤§é›¨': return 'â›ˆï¸';
      case 'é›·é˜µé›¨': return 'â›ˆï¸';
      case 'é›ª': return 'â„ï¸';
      case 'é›¾': return 'ðŸŒ«ï¸';
      default: return 'â“';
    }
  }

  build(): void {
    Column() {
      // å¤©æ°”å¡ç‰‡éƒ¨åˆ†
      Stack() {
        Column() {
          Row() {
            Text(this.weatherInfo.temperature)
              .fontSize(64)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .margin({ left: 24, top: 18, bottom: 8, right: 12 })
            Column() {
              Text(this.weatherInfo.city)
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#fff')
                .margin({ bottom: 2 })
              Text(this.weatherInfo.desc)
                .fontSize(16)
                .fontColor('#fff')
                .margin({ bottom: 2 })
            }
            .margin({ top: 18 })
            Blank().width('1fr')
            Column() {
              Text(this.weatherInfo.icon)
                .fontSize(48)
                .margin({ top: 8, right: 24 })
            }
          }
          
          // å½“å‰æ—¶é—´æ—¥æœŸ
          Column() {
            Text(this.currentTime)
              .fontSize(32)
              .fontColor('#fff')
              .fontWeight(FontWeight.Bold)
              .margin({ top: 16, bottom: 8 })
            Text(this.currentDate)
              .fontSize(16)
              .fontColor('#fff')
              .opacity(0.9)
              .margin({ bottom: 16 })
          }
          .alignItems(HorizontalAlign.Center)
        }
        .width('100%')
        .height(200)
        .backgroundColor('#7ec6f5')
        .linearGradient({
          angle: 90,
          colors: [[0x7ec6f5, 1], [0x4a90e2, 1]]
        })
        .borderRadius(32)
        .margin({ left: 12, right: 12, top: 12, bottom: 18 })
        .shadow({ radius: 12, color: '#00000022', offsetX: 0, offsetY: 4 })
      }
      // æ¶ˆæ¯åˆ—è¡¨
      List() {
        ForEach(this.messages, (msg: MessageItem, idx: number) => {
          ListItem() {
            Row() {
              Image(msg.avatar)
                .width(48)
                .height(48)
                .borderRadius(24)
                .margin({ left: 16, right: 12 })
              Column({ space: 4 }) {
                Row() {
                  Text(msg.name)
                    .fontSize(16)
                    .fontColor(msg.isOfficial ? '#0D9FFB' : (msg.isSystem ? '#1976D2' : '#fff'))
                    .fontWeight(FontWeight.Bold)
                  if (msg.followed) {
                    Text('å·²å…³æ³¨')
                      .fontSize(12)
                      .fontColor('#888')
                      .margin({ left: 8 })
                  }
                  if (msg.isOfficial) {
                    Text('å®˜æ–¹åŠ©æ‰‹')
                      .fontSize(12)
                      .fontColor('#0D9FFB')
                      .backgroundColor('#222')
                      .margin({ left: 8 })
                      .borderRadius(6)
                      .padding({ left: 4, right: 4 })
                  }
                }
                Text(msg.desc)
                  .fontSize(13)
                  .fontColor('#bbb')
                  .maxLines(1)
                  .margin({ top: 2 })
              }
              .layoutWeight(1)
              Column() {
                Text(msg.time)
                  .fontSize(12)
                  .fontColor('#888')
                  .margin({ bottom: 8 })
                if (msg.unread > 0) {
                  Text(msg.unread.toString())
                    .fontSize(10)
                    .fontColor('#fff')
                    .backgroundColor('#FF5252')
                    .borderRadius(8)
                    .width(16)
                    .height(16)
                    .textAlign(TextAlign.Center)
                }
              }
              .alignItems(HorizontalAlign.End)
              .margin({ right: 16 })
            }
            .height(64)
            .backgroundColor('rgba(34,34,34,0)')
          }
        }, (msg: MessageItem) => msg.name + msg.time)
      }
      .width('100%')
      .backgroundColor('#181818')
      .layoutWeight(1)
      Blank().height(56)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#181818')
  }
} 