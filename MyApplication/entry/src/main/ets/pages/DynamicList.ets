// DynamicList.ets
// åŠ¨æ€å±•ç¤ºé¡µé¢

import { globalUserData } from '../models/userdata';
import { ApiService } from '../service/apiservice';
import { Dynamic, CreateDynamicRequest } from '../common/types';
import { NetworkUtils } from '../common/utils';
import { Config } from '../common/config';
import promptAction from '@ohos.promptAction';
import { BottomNavBar } from './BottomNavBar';
import preferences from '@ohos.data.preferences';
import picker from '@ohos.file.picker';
import fs from '@ohos.file.fs';

// ç±»å‹å£°æ˜
interface ErrorWithCode {
  code?: number;
}
@Entry
@Component
struct DynamicList {
  @State dynamics: Dynamic[] = []; // åŠ¨æ€åˆ—è¡¨
  @State isLoading: boolean = false; // åŠ è½½çŠ¶æ€
  @State isRefreshing: boolean = false; // åˆ·æ–°çŠ¶æ€
  @State userUID: string = globalUserData.userUID;
  @State showAllDynamics: boolean = false; // æ˜¯å¦æ˜¾ç¤ºæ‰€æœ‰åŠ¨æ€ï¼ˆåŒ…æ‹¬ç§å¯†ï¼‰
  @State isNetworkConnected: boolean = true; // ç½‘ç»œè¿æ¥çŠ¶æ€

  // å‘å¸ƒç›¸å…³çŠ¶æ€
  @State showPublishModal: boolean = false; // æ˜¯å¦æ˜¾ç¤ºå‘å¸ƒå¼¹çª—
  @State publishContent: string = ''; // å‘å¸ƒå†…å®¹
  @State publishImages: string[] = []; // å‘å¸ƒå›¾ç‰‡
  @State isLocalMode: boolean = false; // æ˜¯å¦ä¸ºæœ¬åœ°æ¨¡å¼
  @State isPublishing: boolean = false; // æ˜¯å¦æ­£åœ¨å‘å¸ƒ
  @State localDynamics: Dynamic[] = []; // æœ¬åœ°åŠ¨æ€åˆ—è¡¨
  @State showImagePickerModal: boolean = false; // æ˜¯å¦æ˜¾ç¤ºå›¾ç‰‡é€‰æ‹©å¼¹çª—

  // å¤´åƒæŸ¥çœ‹å™¨çŠ¶æ€
  @State showAvatarViewer: boolean = false; // æ˜¾ç¤ºå¤´åƒæŸ¥çœ‹å™¨
  @State currentAvatarUrl: string = ''; // å½“å‰æŸ¥çœ‹çš„å¤´åƒURL

  // é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  aboutToAppear() {
    this.checkNetworkConnection();
    this.loadDynamics();
    this.loadLocalDynamics().then(() => {
      console.log('æœ¬åœ°åŠ¨æ€åŠ è½½å®Œæˆ');
    }).catch((error: string) => {
      console.error('æœ¬åœ°åŠ¨æ€åŠ è½½å¤±è´¥:', error);
    });
  }

  // æ£€æŸ¥ç½‘ç»œè¿æ¥
  async checkNetworkConnection(): Promise<void> {
    this.isNetworkConnected = await NetworkUtils.checkNetworkConnection();
  }

  // åŠ è½½åŠ¨æ€
  async loadDynamics(): Promise<void> {
    if (!this.isNetworkConnected) {
      return;
    }

    if (this.isLoading) return;

    try {
      this.isLoading = true;
      const dynamics = this.showAllDynamics
        ? await ApiService.getUserDynamics(this.userUID)
        : await ApiService.getUserPublicDynamics(this.userUID);
      
      // æŒ‰æ—¶é—´é¡ºåºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      this.dynamics = dynamics.sort((a, b) => {
        const timeA = new Date(a.createTime).getTime();
        const timeB = new Date(b.createTime).getTime();
        return timeB - timeA;
      });
      
      // ä¿å­˜æœ€æ–°åŠ¨æ€åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¾› yourpage ä½¿ç”¨
      if (this.dynamics.length > 0) {
        await this.saveLatestDynamic(this.dynamics[0]);
      }
    } catch (error) {
      console.error('åŠ è½½åŠ¨æ€å¤±è´¥:', error);
      promptAction.showToast({ message: 'åŠ è½½åŠ¨æ€å¤±è´¥' });
    } finally {
      this.isLoading = false;
    }
  }

  // ä¿å­˜æœ€æ–°åŠ¨æ€åˆ°æœ¬åœ°å­˜å‚¨
  async saveLatestDynamic(dynamic: Dynamic): Promise<void> {
    try {
      const context = getContext(this);
      const preferencesHelper = await preferences.getPreferences(context, 'userData');
      await preferencesHelper.put('latestDynamic', JSON.stringify(dynamic));
      await preferencesHelper.flush();
    } catch (error) {
      console.error('ä¿å­˜æœ€æ–°åŠ¨æ€å¤±è´¥:', error);
    }
  }

  // åŠ è½½æœ¬åœ°åŠ¨æ€
  async loadLocalDynamics(): Promise<void> {
    try {
      const context = getContext(this);
      const preferencesHelper = await preferences.getPreferences(context, 'localDynamics');
      const localDynamicsStr = await preferencesHelper.get('dynamics', '[]') as string;
      this.localDynamics = JSON.parse(localDynamicsStr);
    } catch (error) {
      console.error('åŠ è½½æœ¬åœ°åŠ¨æ€å¤±è´¥:', error);
      this.localDynamics = [];
    }
  }

  // ä¿å­˜æœ¬åœ°åŠ¨æ€
  async saveLocalDynamics(): Promise<void> {
    try {
      const context = getContext(this);
      const preferencesHelper = await preferences.getPreferences(context, 'localDynamics');
      await preferencesHelper.put('dynamics', JSON.stringify(this.localDynamics));
      await preferencesHelper.flush();
    } catch (error) {
      console.error('ä¿å­˜æœ¬åœ°åŠ¨æ€å¤±è´¥:', error);
    }
  }

  // åˆ·æ–°åŠ¨æ€
  async refreshDynamics(): Promise<void> {
    if (!this.isNetworkConnected) {
      this.isRefreshing = false;
      return;
    }

    if (this.isRefreshing) return;

    try {
      this.isRefreshing = true;
      await this.loadDynamics();
      promptAction.showToast({ message: 'åˆ·æ–°æˆåŠŸ' });
    } catch (error) {
      console.error('åˆ·æ–°åŠ¨æ€å¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ·æ–°å¤±è´¥' });
    } finally {
      this.isRefreshing = false;
    }
  }

  // ç‚¹èµåŠ¨æ€
  async likeDynamic(dynamic: Dynamic): Promise<void> {
    if (!this.isNetworkConnected) {
      NetworkUtils.showNetworkError();
      return;
    }

    try {
      await ApiService.likeDynamic(dynamic.id);
      // æ›´æ–°æœ¬åœ°æ•°æ®
      const index = this.dynamics.findIndex(d => d.id === dynamic.id);
      if (index !== -1) {
        this.dynamics[index].likeCount += 1;
      }
      promptAction.showToast({ message: 'ç‚¹èµæˆåŠŸ' });
    } catch (error) {
      console.error('ç‚¹èµå¤±è´¥:', error);
      promptAction.showToast({ message: 'ç‚¹èµå¤±è´¥' });
    }
  }

  // å–æ¶ˆç‚¹èµåŠ¨æ€
  async unlikeDynamic(dynamic: Dynamic): Promise<void> {
    if (!this.isNetworkConnected) {
      NetworkUtils.showNetworkError();
      return;
    }

    try {
      await ApiService.unlikeDynamic(dynamic.id);
      // æ›´æ–°æœ¬åœ°æ•°æ®
      const index = this.dynamics.findIndex(d => d.id === dynamic.id);
      if (index !== -1 && this.dynamics[index].likeCount > 0) {
        this.dynamics[index].likeCount -= 1;
      }
      promptAction.showToast({ message: 'å–æ¶ˆç‚¹èµæˆåŠŸ' });
    } catch (error) {
      console.error('å–æ¶ˆç‚¹èµå¤±è´¥:', error);
      promptAction.showToast({ message: 'å–æ¶ˆç‚¹èµå¤±è´¥' });
    }
  }

  // åˆ é™¤åŠ¨æ€
  async deleteDynamic(dynamic: Dynamic): Promise<void> {
    if (!this.isNetworkConnected) {
      NetworkUtils.showNetworkError();
      return;
    }

    try {
      await ApiService.deleteDynamic(dynamic.id, this.userUID);
      // ä»åˆ—è¡¨ä¸­ç§»é™¤
      this.dynamics = this.dynamics.filter(d => d.id !== dynamic.id);
      promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
    } catch (error) {
      console.error('åˆ é™¤åŠ¨æ€å¤±è´¥:', error);
      promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥' });
    }
  }

  // åˆ é™¤æœ¬åœ°åŠ¨æ€
  async deleteLocalDynamic(dynamic: Dynamic): Promise<void> {
    this.localDynamics = this.localDynamics.filter(d => d.id !== dynamic.id);
    await this.saveLocalDynamics();
    promptAction.showToast({ message: 'åˆ é™¤æˆåŠŸ' });
  }

  // æ˜¾ç¤ºå¤´åƒæŸ¥çœ‹å™¨
  showAvatarViewerDialog(avatarUrl: string) {
    this.currentAvatarUrl = avatarUrl;
    this.showAvatarViewer = true;
  }

  // å…³é—­å¤´åƒæŸ¥çœ‹å™¨
  closeAvatarViewer() {
    this.showAvatarViewer = false;
    this.currentAvatarUrl = '';
  }

  // å‘å¸ƒåŠ¨æ€
  async publishDynamic(): Promise<void> {
    console.log('ğŸš€ å¼€å§‹å‘å¸ƒåŠ¨æ€...');
    console.log('ğŸš€ å‘å¸ƒå†…å®¹:', this.publishContent);
    console.log('ğŸš€ ç½‘ç»œçŠ¶æ€:', this.isNetworkConnected);
    
    if (this.publishContent.trim() === '') {
      promptAction.showToast({ message: 'è¯·è¾“å…¥åŠ¨æ€å†…å®¹' });
      return;
    }

    if (this.isPublishing) {
      console.log('âš ï¸ æ­£åœ¨å‘å¸ƒä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');
      return;
    }

    try {
      this.isPublishing = true;

      if (this.isNetworkConnected) {
        console.log('ğŸŒ è”ç½‘å‘å¸ƒæ¨¡å¼');
        // è”ç½‘å‘å¸ƒ
        const request: CreateDynamicRequest = {
          content: this.publishContent.trim(),
          images: this.publishImages,
          isPrivate: false
        };

        console.log('ğŸ“¤ å‘é€è¯·æ±‚:', JSON.stringify(request));
        const newDynamic = await ApiService.createDynamic(this.userUID, request);
        console.log('âœ… å‘å¸ƒæˆåŠŸï¼Œè¿”å›æ•°æ®:', JSON.stringify(newDynamic));
        
        // æ·»åŠ åˆ°åŠ¨æ€åˆ—è¡¨å¼€å¤´
        this.dynamics.unshift(newDynamic);
        console.log('ğŸ“ å·²æ·»åŠ åˆ°åŠ¨æ€åˆ—è¡¨ï¼Œå½“å‰åˆ—è¡¨é•¿åº¦:', this.dynamics.length);
        
        // ä¿å­˜æœ€æ–°åŠ¨æ€åˆ°æœ¬åœ°å­˜å‚¨
        await this.saveLatestDynamic(newDynamic);
        console.log('ğŸ’¾ å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        
        promptAction.showToast({ message: 'å‘å¸ƒæˆåŠŸ' });
      } else {
        console.log('ğŸ“± æœ¬åœ°å‘å¸ƒæ¨¡å¼');
        // æœ¬åœ°å‘å¸ƒ
        const localDynamic: Dynamic = {
          id: Date.now().toString(),
          userUID: this.userUID,
          content: this.publishContent.trim(),
          images: this.publishImages,
          likeCount: 0,
          commentCount: 0,
          isPrivate: false,
          createTime: new Date().toISOString(),
          updateTime: new Date().toISOString()
        };

        this.localDynamics.unshift(localDynamic);
        await this.saveLocalDynamics();
        console.log('ğŸ“ æœ¬åœ°å‘å¸ƒæˆåŠŸï¼Œå½“å‰æœ¬åœ°åŠ¨æ€æ•°é‡:', this.localDynamics.length);
        
        promptAction.showToast({ message: 'æœ¬åœ°å‘å¸ƒæˆåŠŸ' });
      }

      // æ¸…ç©ºå‘å¸ƒå†…å®¹
      this.publishContent = '';
      this.publishImages = [];
      this.showPublishModal = false;
      console.log('ğŸ§¹ å·²æ¸…ç©ºå‘å¸ƒå†…å®¹');

      // è‡ªåŠ¨åˆ·æ–°é¡µé¢
      console.log('ğŸ”„ å¼€å§‹åˆ·æ–°åŠ¨æ€åˆ—è¡¨...');
      await this.refreshDynamics();
      console.log('âœ… åŠ¨æ€å‘å¸ƒæµç¨‹å®Œæˆ');
      
    } catch (error) {
      console.error('âŒ å‘å¸ƒåŠ¨æ€å¤±è´¥:', error);
      console.error('âŒ é”™è¯¯è¯¦æƒ…:', JSON.stringify(error));
      promptAction.showToast({ message: `å‘å¸ƒå¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}` });
    } finally {
      this.isPublishing = false;
      console.log('ğŸ å‘å¸ƒçŠ¶æ€é‡ç½®å®Œæˆ');
    }
  }

  // é€‰æ‹©å›¾ç‰‡
  async selectImages(): Promise<void> {
    try {
      const photoPicker = new picker.PhotoViewPicker();
      const photoSelectOptions: picker.PhotoSelectOptions = {
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 9 - this.publishImages.length
      };

      const photoView = await photoPicker.select(photoSelectOptions);
      const uris = photoView.photoUris;

      for (let i = 0; i < uris.length; i++) {
        const uri = uris[i];
        const fileName = `dynamic_${Date.now()}_${i}.jpg`;
        const destPath = `file:///data/storage/el2/base/haps/entry/files/${fileName}`;
        
        await fs.copyFile(uri, destPath);
        this.publishImages.push(destPath);
      }
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
      promptAction.showToast({ message: 'é€‰æ‹©å›¾ç‰‡å¤±è´¥' });
    }
  }

  // ç§»é™¤å›¾ç‰‡
  removeImage(index: number): void {
    this.publishImages.splice(index, 1);
  }

  // æ ¼å¼åŒ–æ—¶é—´
  formatTime(timeString: string): string {
    const date = new Date(timeString);
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    
    const minutes = Math.floor(diff / (1000 * 60));
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    if (minutes < 1) return 'åˆšåˆš';
    if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
    if (hours < 24) return `${hours}å°æ—¶å‰`;
    if (days < 7) return `${days}å¤©å‰`;
    
    return date.toLocaleDateString();
  }

  // å¤„ç†å¤´åƒURL - æ”¹ä¸ºé¢„è§ˆå™¨æ ·å¼
  getAvatarUrl(avatarUrl: string | undefined): Resource | string {
    if (!avatarUrl || avatarUrl === '/avatars/default.png') {
      return $r('app.media.image');
    }
    
    // å¤„ç†å¤´åƒURL - å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œæ‹¼æ¥å®Œæ•´URL
    if (avatarUrl && avatarUrl.startsWith('/')) {
      const baseUrl = Config.getApiBaseUrl().replace('/api', '');
      const fullUrl = baseUrl + avatarUrl;
      console.log('ğŸ‘¤ [DynamicList] å¤„ç†åçš„å¤´åƒURL:', fullUrl);
      return fullUrl;
    }
    
    return avatarUrl;
  }

  build() {
    Stack() {
      // æ¸å˜èƒŒæ™¯ - ä¸ yourpage ä¿æŒä¸€è‡´
      Column() {
        Blank().width('100%').height('100%')
          .linearGradient({
            direction: GradientDirection.Bottom,
            colors: [['#1a1a2e', 0.0], ['#16213e', 0.3], ['#0f3460', 0.7], ['#533483', 1.0]]
          })
      }
      .width('100%')
      .height('100%')
      
      // è£…é¥°æ€§èƒŒæ™¯å…ƒç´  - ä¸ yourpage ä¿æŒä¸€è‡´
      Column() {
        // é¡¶éƒ¨è£…é¥°å…ƒç´ 
        Row() {
          Image($r('app.media.deroration_1'))
            .width(200)
            .height(200)
            .opacity(0.1)
            .position({ x: -100, y: -50 })
          Image($r('app.media.deroration_2'))
            .width(150)
            .height(150)
            .opacity(0.08)
            .position({ x: 300, y: -30 })
        }
        .width('100%')
        .height(60)
        
        Blank().layoutWeight(1)
        
        // åº•éƒ¨è£…é¥°å…ƒç´ 
        Row() {
          Image($r('app.media.deroration_3'))
            .width(180)
            .height(180)
            .opacity(0.08)
            .position({ x: -80, y: 20 })
          Image($r('app.media.deroration_4'))
            .width(120)
            .height(120)
            .opacity(0.1)
            .position({ x: 320, y: 40 })
        }
        .width('100%')
        .height(80)
      }
      .width('100%')
      .height('100%')
      .position({ x: 0, y: 0 })
      .zIndex(1)
      
      // ä¸»ä½“å†…å®¹
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          // è¿”å›æŒ‰é’®
          Button() {
            Image($r('app.media.return'))
              .width(24)
              .height(24)
              .fillColor('#fff')
          }
          .width(40)
          .height(40)
          .backgroundColor('rgba(128,128,128,0)')
          .borderRadius(20)
          .margin({ left: 16 })
          .onClick(() => {
            let uiContext: UIContext = this.getUIContext();
            let router = uiContext.getRouter();
            router.back();
          })
          
          // é¡µé¢æ ‡é¢˜
          Text('æˆ‘çš„åŠ¨æ€')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#fff')
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
            .margin({ right: 56 }) // ä¸ºè¿”å›æŒ‰é’®ç•™å‡ºç©ºé—´
          
          // å‘å¸ƒæŒ‰é’®
          Button() {
            Image($r('app.media.plus_icon'))
              .width(24)
              .height(24)
              .fillColor('#fff')
          }
          .width(40)
          .height(40)
          .backgroundColor('rgba(128,128,128,0.3)')
          .borderRadius(20)
          .margin({ right: 16 })
          .onClick(() => {
            this.showPublishModal = true;
          })
        }
        .width('100%')
        .height(60)
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)
        
        // åŠ¨æ€åˆ—è¡¨
        Refresh({ refreshing: this.isRefreshing, offset: 120, friction: 100 }) {
          List() {
            if (this.isLoading) {
              // åŠ è½½çŠ¶æ€
              ListItem() {
                Column() {
                  LoadingProgress()
                    .width(40)
                    .height(40)
                    .color('#fff')
                  Text('åŠ è½½ä¸­...')
                    .fontSize(16)
                    .fontColor('rgba(255,255,255,0.8)')
                    .margin({ top: 16 })
                }
                .width('100%')
                .height(200)
                .justifyContent(FlexAlign.Center)
              }
            } else if (this.dynamics.length === 0 && this.localDynamics.length === 0) {
              // ç©ºçŠ¶æ€
              ListItem() {
                Column() {
                  Image($r('app.media.dynamic'))
                    .width(80)
                    .height(80)
                    .opacity(0.3)
                    .margin({ bottom: 16 })
                  Text('è¿˜æ²¡æœ‰åŠ¨æ€')
                    .fontSize(16)
                    .fontColor('rgba(255,255,255,0.5)')
                    .textAlign(TextAlign.Center)
                  Text('ç‚¹å‡»å³ä¸Šè§’å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€å§')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.4)')
                    .textAlign(TextAlign.Center)
                    .margin({ top: 8 })
                }
                .width('100%')
                .height(300)
                .justifyContent(FlexAlign.Center)
              }
            } else {
              // åŠ¨æ€åˆ—è¡¨
              ForEach([...this.dynamics, ...this.localDynamics], (dynamic: Dynamic) => {
                ListItem() {
                  this.DynamicCard(dynamic)
                }
              })
            }
          }
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(255,255,255,0.05)')
          .borderRadius(16)
          .margin({ left: 16, right: 16, bottom: 16 })
          .padding(16)
        }
        .onRefreshing(() => {
          this.refreshDynamics();
        })
        .layoutWeight(1)
      }
      .width('100%')
      .height('100%')
      .zIndex(2)
      
      // å‘å¸ƒå¼¹çª—
      if (this.showPublishModal) {
        this.PublishModal()
      }

      // å¤´åƒæŸ¥çœ‹å™¨ - å…¨å±æ˜¾ç¤ºå¤´åƒ
      if (this.showAvatarViewer) {
        Stack({ alignContent: Alignment.Center }) {
          // åŠé€æ˜èƒŒæ™¯
          Column() {
            Blank()
              .width('100%')
              .height('100%')
              .backgroundColor('#000000')
              .opacity(0.9)
              .onClick(() => this.closeAvatarViewer())
          }
          .width('100%')
          .height('100%')

          // å¤´åƒæŸ¥çœ‹å™¨å†…å®¹
          Column() {
            // å…³é—­æŒ‰é’®
            Row() {
              Button() {
                Image($r('app.media.return'))
                  .width(24)
                  .height(24)
                  .fillColor('#fff')
              }
              .width(40)
              .height(40)
              .backgroundColor('rgba(0,0,0,0.5)')
              .borderRadius(20)
              .onClick(() => this.closeAvatarViewer())
            }
            .width('100%')
            .justifyContent(FlexAlign.End)
            .margin({ bottom: 20 })

            // å¤§å°ºå¯¸å¤´åƒæ˜¾ç¤º
            Image(this.currentAvatarUrl)
              .width(300)
              .height(300)
              .borderRadius(150)
              .border({ width: 6, color: 'rgba(255,255,255,0.3)' })
              .objectFit(ImageFit.Cover)
              .margin({ bottom: 20 })

            // æ“ä½œæŒ‰é’®
            Row() {
              Button('æŸ¥çœ‹ç”¨æˆ·')
                .width(120)
                .height(44)
                .backgroundColor('rgba(255,255,255,0.2)')
                .fontColor('#fff')
                .borderRadius(22)
                .onClick(() => {
                  this.closeAvatarViewer();
                  setTimeout(() => {
                    let uiContext: UIContext = this.getUIContext();
                    let router = uiContext.getRouter();
                    router.pushUrl({ url: 'pages/yourpage' });
                  }, 300);
                })
            }
            .justifyContent(FlexAlign.Center)
          }
          .width('90%')
          .padding(24)
        }
        .width('100%')
        .height('100%')
        .position({ x: 0, y: 0 })
        .zIndex(999)
      }
    }
  }

  @Builder
  DynamicCard(dynamic: Dynamic) {
    Column() {
      // ç”¨æˆ·ä¿¡æ¯ - æ”¹ä¸ºé¢„è§ˆå™¨æ ·å¼æ˜¾ç¤ºå¤´åƒ
      Row() {
        // å¤´åƒæ˜¾ç¤º - åƒé¢„è§ˆå™¨ä¸€æ ·æ˜¾ç¤º
        Stack() {
          // å¤´åƒå›¾ç‰‡ - å¤§å°ºå¯¸æ˜¾ç¤º
          Image(this.getAvatarUrl(dynamic.userAvatar))
            .width(50)
            .height(50)
            .borderRadius(25)
            .backgroundColor('rgba(255,255,255,0.1)')
            .border({ width: 2, color: 'rgba(255,255,255,0.3)' })
            .objectFit(ImageFit.Cover)
            .onClick(() => {
              // ç‚¹å‡»å¤´åƒæ˜¾ç¤ºæŸ¥çœ‹å™¨
              const avatarUrl = this.getAvatarUrl(dynamic.userAvatar);
              if (typeof avatarUrl === 'string') {
                this.showAvatarViewerDialog(avatarUrl);
              }
            })
        }
        
        Column() {
          Text(dynamic.userName || globalUserData.userName)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#fff')
          Text(this.formatTime(dynamic.createTime))
            .fontSize(12)
            .fontColor('rgba(255,255,255,0.6)')
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: 12 })
        .layoutWeight(1)
        
        // åˆ é™¤æŒ‰é’®ï¼ˆä»…å¯¹è‡ªå·±çš„åŠ¨æ€æ˜¾ç¤ºï¼‰
        if (dynamic.userUID === this.userUID) {
          Button() {
            Image($r('app.media.menu_icon'))
              .width(16)
              .height(16)
              .fillColor('rgba(255,255,255,0.6)')
          }
          .width(32)
          .height(32)
          .backgroundColor('rgba(255,255,255,0.1)')
          .borderRadius(16)
          .onClick(() => {
            if (this.localDynamics.some(d => d.id === dynamic.id)) {
              this.deleteLocalDynamic(dynamic);
            } else {
              this.deleteDynamic(dynamic);
            }
          })
        }
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // åŠ¨æ€å†…å®¹
      Text(dynamic.content)
        .fontSize(16)
        .fontColor('#fff')
        .textAlign(TextAlign.Start)
        .width('100%')
        .margin({ bottom: 12 })
      
      // å›¾ç‰‡å±•ç¤º
      if (dynamic.images && dynamic.images.length > 0) {
        Grid() {
          ForEach(dynamic.images, (image: string, index: number) => {
            GridItem() {
              Image(image)
                .width('100%')
                .height(120)
                .borderRadius(8)
                .objectFit(ImageFit.Cover)
            }
          })
        }
        .columnsTemplate('1fr 1fr 1fr')
        .columnsGap(8)
        .rowsGap(8)
        .width('100%')
        .margin({ bottom: 12 })
      }
      
      // æ“ä½œæ 
      Row() {
        // ç‚¹èµæŒ‰é’®
        Row() {
          Text('â¤ï¸')
            .fontSize(16)
            .margin({ right: 4 })
          Text(dynamic.likeCount?.toString() || '0')
            .fontSize(14)
            .fontColor('rgba(255,255,255,0.8)')
        }
        .onClick(() => {
          if (this.localDynamics.some(d => d.id === dynamic.id)) {
            // æœ¬åœ°åŠ¨æ€ä¸æ”¯æŒç‚¹èµ
            promptAction.showToast({ message: 'æœ¬åœ°åŠ¨æ€æš‚ä¸æ”¯æŒç‚¹èµ' });
          } else {
            this.likeDynamic(dynamic);
          }
        })
        
        // è¯„è®ºæŒ‰é’®
        Row() {
          Text('ğŸ’¬')
            .fontSize(16)
            .margin({ right: 4 })
          Text(dynamic.commentCount?.toString() || '0')
            .fontSize(14)
            .fontColor('rgba(255,255,255,0.8)')
        }
        .margin({ left: 20 })
        .onClick(() => {
          promptAction.showToast({ message: 'è¯„è®ºåŠŸèƒ½å¼€å‘ä¸­' });
        })
        
        // åˆ†äº«æŒ‰é’®
        Row() {
          Text('ğŸ“¤')
            .fontSize(16)
        }
        .margin({ left: 20 })
        .onClick(() => {
          promptAction.showToast({ message: 'åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­' });
        })
      }
      .width('100%')
      .justifyContent(FlexAlign.Start)
    }
    .width('100%')
    .padding(16)
    .backgroundColor('rgba(255,255,255,0.05)')
    .borderRadius(12)
    .margin({ bottom: 12 })
  }

  @Builder
  PublishModal() {
    Stack({ alignContent: Alignment.Center }) {
      // åŠé€æ˜èƒŒæ™¯
      Column() {
        Blank()
          .width('100%')
          .height('100%')
          .backgroundColor('#000000')
          .opacity(0.6)
          .onClick(() => {
            this.showPublishModal = false;
          })
      }
      .width('100%')
      .height('100%')

      // å‘å¸ƒå¼¹çª—å†…å®¹
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text('å‘å¸ƒåŠ¨æ€')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#fff')
            .layoutWeight(1)
          
          Button() {
            Image($r('app.media.return'))
              .width(20)
              .height(20)
              .fillColor('#fff')
          }
          .width(32)
          .height(32)
          .backgroundColor('rgba(255,255,255,0.1)')
          .borderRadius(16)
          .onClick(() => {
            this.showPublishModal = false;
          })
        }
        .width('100%')
        .margin({ bottom: 20 })

        // å†…å®¹è¾“å…¥æ¡†
        TextArea({
          text: this.publishContent,
          placeholder: 'åˆ†äº«ä½ çš„æƒ³æ³•...'
        })
          .width('100%')
          .height(120)
          .backgroundColor('rgba(255,255,255,0.1)')
          .borderRadius(12)
          .padding(16)
          .fontSize(16)
          .fontColor('#fff')
          .placeholderColor('rgba(255,255,255,0.5)')
          .onChange((value: string) => {
            this.publishContent = value;
          })
          .margin({ bottom: 16 })

        // å›¾ç‰‡é€‰æ‹©åŒºåŸŸ
        if (this.publishImages.length > 0) {
          Grid() {
            ForEach(this.publishImages, (image: string, index: number) => {
              GridItem() {
                Stack() {
                  Image(image)
                    .width('100%')
                    .height(80)
                    .borderRadius(8)
                    .objectFit(ImageFit.Cover)
                  
                  // åˆ é™¤æŒ‰é’®
                  Button() {
                    Text('Ã—')
                      .fontSize(16)
                      .fontColor('#fff')
                  }
                  .width(24)
                  .height(24)
                  .backgroundColor('rgba(0,0,0,0.6)')
                  .borderRadius(12)
                  .position({ x: '85%', y: '15%' })
                  .onClick(() => {
                    this.removeImage(index);
                  })
                }
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr')
          .columnsGap(8)
          .rowsGap(8)
          .width('100%')
          .margin({ bottom: 16 })
        }

        // æ“ä½œæŒ‰é’®
        Row() {
          Button() {
            Text('ğŸ“·')
              .fontSize(16)
          }
          .width(44)
          .height(44)
          .backgroundColor('rgba(255,255,255,0.1)')
          .borderRadius(22)
          .onClick(() => {
            this.selectImages();
          })

          Button('å‘å¸ƒ')
            .width(100)
            .height(44)
            .backgroundColor(this.isPublishing ? 'rgba(255,255,255,0.3)' : 'rgba(255,255,255,0.2)')
            .fontColor('#fff')
            .borderRadius(22)
            .margin({ left: 'auto' })
            .onClick(() => {
              if (!this.isPublishing) {
                this.publishDynamic();
              }
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
      }
      .width('90%')
      .backgroundColor('rgba(0,0,0,0.8)')
      .borderRadius(20)
      .padding(24)
      .backdropBlur(20)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(999)
  }
} 