import promptAction from '@ohos.promptAction';
import router from '@ohos.router';
import { ApiService } from '../service/apiservice';
import { CommentItem } from '../common/types';
import { globalUserData } from '../models/userdata';

// è·¯ç”±å‚æ•°æ¥å£
interface CommentPageParams {
  aiRoleId?: number;
  aiRoleName?: string;
  aiRoleAvatar?: string;
  aiRoleType?: string;
  aiRoleDescription?: string;
  currentUserId?: number;
}

@Entry
@Component
export struct ChatCommentPage {
  @State private comments: CommentItem[] = [];
  @State private likedComments: Set<number> = new Set(); // å·²ç‚¹èµè¯„è®ºidé›†åˆ
  @State private likeCounts: Record<number, number> = {};
  @State private heartScales: Record<number, number> = {}; // çˆ±å¿ƒç¼©æ”¾çŠ¶æ€
  @State private commentText: string = ''; // è¾“å…¥æ¡†æ–‡æœ¬
  @State private aiRoleId: number = 1; // AIè§’è‰²IDï¼Œä»è·¯ç”±å‚æ•°è·å–
  @State private currentUserId: number = 1; // å½“å‰ç”¨æˆ·IDï¼Œä»è·¯ç”±å‚æ•°è·å–
  
  // AIè§’è‰²ä¿¡æ¯
  @State private aiRoleName: string = 'AIè§’è‰²';
  @State private aiRoleAvatar: string = '';
  @State private aiRoleType: string = 'default';
  @State private aiRoleDescription: string = '';

  @State private replyToComment: CommentItem | null = null; // å½“å‰æ­£åœ¨å›å¤çš„è¯„è®º
  @State private isActive: boolean = true; // é¡µé¢æ´»è·ƒæ ‡è®°
  @State private refreshKey: number = 0; // å¼ºåˆ¶åˆ·æ–°é”®

  aboutToAppear() {
    this.isActive = true;
    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as CommentPageParams;
    if (params) {
      // ä¿®æ­£ï¼šaiRoleIdå¿…é¡»ç”¨è·¯ç”±å‚æ•°ï¼Œä¸èƒ½å†™æ­»
      if (typeof params.aiRoleId === 'number') {
        this.aiRoleId = params.aiRoleId;
      } else if (typeof params.aiRoleId === 'string' && params.aiRoleId !== '') {
        this.aiRoleId = parseInt(params.aiRoleId);
      }
      if (typeof params.currentUserId === 'number') {
        this.currentUserId = params.currentUserId;
      } else if (typeof params.currentUserId === 'string' && params.currentUserId !== '') {
        this.currentUserId = parseInt(params.currentUserId);
      }
      this.aiRoleName = params.aiRoleName || 'AIè§’è‰²';
      this.aiRoleAvatar = params.aiRoleAvatar || '';
      this.aiRoleType = params.aiRoleType || 'default';
      this.aiRoleDescription = params.aiRoleDescription || '';
      console.info(`[è¯„è®º] è·¯ç”±å‚æ•° aiRoleId=${this.aiRoleId}, currentUserId=${this.currentUserId}`);
    }
    this.loadAllComments();
  }

  aboutToDisappear() {
    this.isActive = false;
  }

  // åŠ è½½æ‰€æœ‰è¯„è®ºï¼ˆåŒ…æ‹¬ä¸»è¯„è®ºå’Œå›å¤ï¼‰
  private async loadAllComments() {
    if (!this.isActive) return;
    try {
      console.info(`[è¯„è®º] å¼€å§‹åŠ è½½æ‰€æœ‰è¯„è®ºï¼ŒaiRoleId=${this.aiRoleId}`);
      const result = await ApiService.getCommentsByAiRoleId(this.aiRoleId, 1, 1000); // ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ä¸»è¯„è®º
      const mainComments = result.comments;
      console.info(`[è¯„è®º] åŠ è½½ä¸»è¯„è®ºå®Œæˆï¼Œæ•°é‡=${mainComments.length}`);
      
              // ä¸ºæ¯ä¸ªä¸»è¯„è®ºåŠ è½½æ‰€æœ‰å›å¤
        for (const mainComment of mainComments) {
          try {
            const replyResult = await ApiService.getRepliesByRootCommentId(mainComment.id, 1, 1000); // ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰å›å¤
            mainComment.replies = replyResult.replies || [];
            mainComment.replyTotal = replyResult.totalCount || 0;
            console.info(`[è¯„è®º] ä¸»è¯„è®º${mainComment.id}åŠ è½½å›å¤å®Œæˆï¼Œæ•°é‡=${mainComment.replies.length}`);
            // è°ƒè¯•ï¼šæ‰“å°å›å¤è¯¦æƒ…
            if (mainComment.replies && mainComment.replies.length > 0) {
              mainComment.replies.forEach((reply, index) => {
                console.info(`[è¯„è®º] å›å¤${index + 1}: ID=${reply.id}, å†…å®¹=${reply.content}`);
              });
            }
          } catch (error) {
            console.error(`[è¯„è®º] åŠ è½½ä¸»è¯„è®º${mainComment.id}çš„å›å¤å¤±è´¥:`, error);
            mainComment.replies = [];
            mainComment.replyTotal = 0;
          }
        }
      
      // ç«‹å³æ›´æ–°UIçŠ¶æ€ï¼Œç¡®ä¿æ•°æ®èƒ½åŠæ—¶æ˜¾ç¤º
      if (this.isActive) {
        // å…ˆæ¸…ç©ºæ•°ç»„ï¼Œç„¶åé‡æ–°èµ‹å€¼ï¼Œç¡®ä¿UIèƒ½æ£€æµ‹åˆ°å˜åŒ–
        this.comments = [];
        setTimeout(() => {
          if (!this.isActive) return;
          this.comments = mainComments;
          this.comments.forEach(item => {
            this.likeCounts[item.id] = item.likeCount;
            this.heartScales[item.id] = 1;
            this.checkUserLikedStatus(item.id);
            // ä¸ºå›å¤ä¹Ÿè®¾ç½®ç‚¹èµçŠ¶æ€
            if (item.replies && Array.isArray(item.replies)) {
              item.replies.forEach(reply => {
                this.likeCounts[reply.id] = reply.likeCount;
                this.heartScales[reply.id] = 1;
                this.checkUserLikedStatus(reply.id);
              });
            }
          });
          console.info(`[è¯„è®º] UIçŠ¶æ€æ›´æ–°å®Œæˆï¼Œä¸»è¯„è®ºæ•°é‡=${this.comments.length}`);
          // æ‰“å°æ¯ä¸ªä¸»è¯„è®ºçš„å›å¤æ•°é‡ï¼Œç”¨äºè°ƒè¯•
          this.comments.forEach(item => {
            console.info(`[è¯„è®º] ä¸»è¯„è®º${item.id}æœ‰${item.replies ? item.replies.length : 0}æ¡å›å¤`);
          });
          // å¼ºåˆ¶è§¦å‘UIé‡æ–°æ¸²æŸ“
          this.refreshKey++;
        }, 50);
      }
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('[è¯„è®º] åŠ è½½è¯„è®ºå¤±è´¥:', error);
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'åŠ è½½è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•' });
          }
        } catch (error) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
        }
      }, 100);
    }
  }

  // æ£€æŸ¥ç”¨æˆ·ç‚¹èµçŠ¶æ€
  private async checkUserLikedStatus(commentId: number) {
    try {
      const result = await ApiService.checkUserLikedComment(commentId, this.currentUserId);
      if (result.isLiked) {
        setTimeout(() => {
          if (!this.isActive) return;
          this.likedComments.add(commentId);
        }, 100);
      }
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('æ£€æŸ¥ç‚¹èµçŠ¶æ€å¤±è´¥:', error);
      }, 100);
    }
  }

  // å‘å¸ƒè¯„è®ºæ–¹æ³•
  private async publishComment() {
    if (!this.isActive || !this.commentText.trim()) {
      setTimeout(() => {
        if (!this.isActive) return;
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'è¯·è¾“å…¥è¯„è®ºå†…å®¹' });
          }
        } catch (error) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
        }
      }, 100);
      return;
    }
    try {
      const result = await ApiService.publishComment(this.aiRoleId, this.currentUserId, this.commentText.trim());
      // ç«‹å³æ¸…ç†è¾“å…¥çŠ¶æ€
      if (this.isActive) {
        this.commentText = '';
      }
      // å‘å¸ƒæˆåŠŸååˆ·æ–°æ•´ä¸ªè¯„è®ºåˆ—è¡¨
      await this.loadAllComments();
      setTimeout(() => {
        if (!this.isActive) return;
        try {
          if (this.isActive) {
            promptAction.showToast({ message: result.message });
          }
        } catch (error) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
        }
      }, 100);
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('å‘å¸ƒè¯„è®ºå¤±è´¥:', error);
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'å‘å¸ƒè¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•' });
          }
        } catch (toastError) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', toastError);
        }
      }, 100);
    }
  }

  // ç‚¹èµè¯„è®º
  private async likeComment(commentId: number) {
    try {
      if (this.likedComments.has(commentId)) {
        const result = await ApiService.unlikeComment(commentId, this.currentUserId);
        if (result.success) {
                setTimeout(() => {
        if (!this.isActive) return;
        this.likedComments.delete(commentId);
        this.likeCounts[commentId] = Math.max(this.likeCounts[commentId] - 1, 0);
      }, 100);
        }
      } else {
        const result = await ApiService.likeComment(commentId, this.currentUserId);
        if (result.success) {
                  setTimeout(() => {
          if (!this.isActive) return;
          this.likedComments.add(commentId);
          this.likeCounts[commentId] = (this.likeCounts[commentId] || 0) + 1;
        }, 100);
        }
      }
      setTimeout(() => {
        if (!this.isActive) return;
        this.heartScales[commentId] = 1.3;
        setTimeout(() => {
          if (!this.isActive) return;
          this.heartScales[commentId] = 1;
        }, 200);
      }, 100);
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('ç‚¹èµæ“ä½œå¤±è´¥:', error);
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•' });
          }
        } catch (error) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
        }
      }, 100);
    }
  }

  // åˆ é™¤è¯„è®º
  private async deleteComment(commentId: number) {
    try {
      const result = await ApiService.deleteComment(commentId, this.currentUserId);
      setTimeout(async () => {
        if (!this.isActive) return;
        if (result.success) {
          await this.loadAllComments();
          try {
            if (this.isActive) {
              promptAction.showToast({ message: result.message });
            }
          } catch (error) {
            console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
          }
        } else {
          try {
            if (this.isActive) {
              promptAction.showToast({ message: result.message });
            }
          } catch (error) {
            console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
          }
        }
      }, 100);
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•' });
          }
        } catch (error) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
        }
      }, 100);
    }
  }

  // æ ¼å¼åŒ–æ—¶é—´
  private formatTime(dateString: string): string {
    try {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now.getTime() - date.getTime();
      
      const minutes = Math.floor(diff / (1000 * 60));
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      
      if (minutes < 1) return 'åˆšåˆš';
      if (minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
      if (hours < 24) return `${hours}å°æ—¶å‰`;
      if (days < 30) return `${days}å¤©å‰`;
      
      return date.toLocaleDateString();
    } catch (error) {
      return 'æœªçŸ¥æ—¶é—´';
    }
  }

  // å‘å¸ƒå›å¤æ–¹æ³•
  private async publishReply() {
    if (!this.isActive || !this.replyToComment) return;
    try {
      const rootId = this.replyToComment.rootCommentId || this.replyToComment.id;
      const toId = this.replyToComment.id;
      const res = await ApiService.replyComment(
        this.aiRoleId,
        this.currentUserId,
        this.commentText.trim(),
        rootId,
        toId
      );
      // ç«‹å³æ¸…ç†è¾“å…¥çŠ¶æ€
      if (this.isActive) {
        this.commentText = '';
        this.replyToComment = null;
      }
      // å›å¤æˆåŠŸååˆ·æ–°æ•´ä¸ªè¯„è®ºåˆ—è¡¨
      await this.loadAllComments();
      // ä½¿ç”¨setTimeoutç¡®ä¿UIä¸Šä¸‹æ–‡å­˜åœ¨
      setTimeout(() => {
        if (!this.isActive) return;
        // ä½¿ç”¨try-catchåŒ…è£¹showToastè°ƒç”¨
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'å›å¤æˆåŠŸ' });
          }
        } catch (error) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
        }
      }, 100);
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('å›å¤è¯„è®ºå¤±è´¥:', error);
        // ä½¿ç”¨try-catchåŒ…è£¹showToastè°ƒç”¨
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'å›å¤è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•' });
          }
        } catch (toastError) {
          console.error('æ˜¾ç¤ºToastå¤±è´¥:', toastError);
        }
      }, 100);
    }
  }

  build() {
    Stack() {
      Column() {
        // é¡¶éƒ¨æ 
        Row() {
          Button('<')
            .backgroundColor('transparent')
            .fontColor('#fff')
            .fontSize(24)
            .onClick(() => {
              router.back();
            })
          Blank().width(8)
          Text(`${this.aiRoleName}çš„è¯„è®ºåŒº`)
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#fff')
            .layoutWeight(1)
          Button('...')
            .backgroundColor('transparent')
            .fontColor('#fff')
            .fontSize(20)
            .onClick(() => setTimeout(() => { 
              if (!this.isActive) return; 
              try {
                if (this.isActive) {
                  promptAction.showToast({ message: 'åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­' }); 
                }
              } catch (error) {
                console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
              }
            }, 100))
        }
        .padding({ left: 12, right: 12, top: 12, bottom: 8 })
        .alignItems(VerticalAlign.Center)

        // æ»šåŠ¨å†…å®¹åŒºï¼ˆåŒ…å«ç”¨æˆ·ä¿¡æ¯å’Œè¯„è®ºåˆ—è¡¨ï¼‰
        List() {
          // AIè§’è‰²ä¿¡æ¯å¡ç‰‡
          ListItem() {
            Row() {
              Image(this.aiRoleAvatar || 'https://img.zcool.cn/community/01b6c95d5b2e2fa801216518a8e3e2.jpg')
                .width(64).height(64)
                .borderRadius(32)
                .objectFit(ImageFit.Cover)
              Column() {
                Text(this.aiRoleName)
                  .fontSize(22)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#fff')
                  .margin({ bottom: 2 })
                Text(`${this.aiRoleType}é£æ ¼è§’è‰²`)
                  .fontSize(14)
                  .fontColor('rgba(255,255,255,0.7)')
                  .margin({ bottom: 2 })
                Row() {
                  Text('ç±»å‹ï¼š')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.7)')
                  Text(this.aiRoleType)
                    .fontSize(14)
                    .fontColor('#FFD700')
                    .fontWeight(FontWeight.Bold)
                    .margin({ left: 2 })
                }
              }
              .margin({ left: 12, right: 8 })
              .alignItems(HorizontalAlign.Start)
              Blank().layoutWeight(1)
              Column() {
                Button('è¿”å›èŠå¤©')
                  .fontColor('#FFD700')
                  .fontSize(16)
                  .border({ width: 1, color: '#FFD700' })
                  .borderRadius(20)
                  .backgroundColor('transparent')
                  .width(80)
                  .height(36)
                  .onClick(() => {
                    router.back();
                  })
              }
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          }
          
          // è¯„è®ºæ€»æ•°
          ListItem() {
            Text(`å…¨éƒ¨è¯„è®º ${this.comments.length}`)
              .fontSize(15)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .margin({ left: 5, top: 8, bottom: 8 })
          }
          
          // è¯„è®ºåˆ—è¡¨
          if (this.comments.length === 0) {
            ListItem() {
              Row() {
                Text('æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~')
                  .fontSize(16)
                  .fontColor('rgba(255,255,255,0.6)')
                  .margin({ top: 24, bottom: 24 })
                  .width('100%')
                  .textAlign(TextAlign.Center)
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
            }
          }
          ForEach(this.comments, (item: CommentItem, idx: number) => {
            ListItem() {
              Column() {
                // ä¸»è¯„è®º
                Row() {
                  Image(item.profileImage || 'https://img.zcool.cn/community/01b6c95d5b2e2fa801216518a8e3e2.jpg')
                    .width(44).height(44)
                    .borderRadius(22)
                  Column() {
                    Row() {
                      Text(item.username || 'æœªçŸ¥ç”¨æˆ·')
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#fff')
                      if (item.isAuthor) {
                        Text('ä½œè€…')
                          .fontSize(12)
                          .fontColor('#FFD700')
                          .margin({ left: 4 })
                      }
                      if (item.isTop) {
                        Text('ç½®é¡¶')
                          .fontSize(12)
                          .fontColor('#fff')
                          .backgroundColor('#333')
                          .borderRadius(8)
                          .margin({ left: 4 })
                      }
                    }
                    Text(item.content)
                      .fontSize(15)
                      .fontColor('#fff')
                      .margin({ top: 2, bottom: 2, right: 16 })
                      .textOverflow({ overflow: TextOverflow.Clip })
                      .width('100%')
                    Row() {
                      Text(this.formatTime(item.createdAt))
                        .fontSize(12)
                        .fontColor('rgba(255,255,255,0.5)')
                      Text('å›å¤')
                        .fontSize(12)
                        .fontColor('rgba(255,255,255,0.5)')
                        .margin({ left: 8 })
                        .onClick(() => {
                          this.replyToComment = item;
                          this.commentText = '';
                        })
                      Blank().layoutWeight(1)
                      // çˆ±å¿ƒç‚¹èµ
                      Text(this.likedComments.has(item.id) ? 'â¤ï¸' : 'ğŸ¤')
                        .fontSize(18)
                        .margin({ right: 2 })
                        .scale({ x: this.heartScales[item.id] || 1, y: this.heartScales[item.id] || 1 })
                        .animation({
                          duration: 200,
                          curve: Curve.EaseInOut
                        })
                        .onClick(() => this.likeComment(item.id))
                      Text(this.likeCounts[item.id] !== undefined ? this.likeCounts[item.id].toString() : item.likeCount.toString())
                        .fontSize(12)
                        .fontColor('rgba(255,255,255,0.5)')
                        .margin({ right: 16 })
                    }
                  }
                  .margin({ left: 10, right: 0 })
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)
                  .width('100%')
                }
                .width('100%')
                .padding({ top: 10, bottom: 10, left: 16, right: 0 })
                
                                // æ¸²æŸ“æ‰€æœ‰å›å¤
                if (item.replies && Array.isArray(item.replies) && item.replies.length > 0) {
                  ForEach(item.replies, (reply: CommentItem, ridx: number) => {
                    Row() {
                      Image(reply.profileImage || 'https://img.zcool.cn/community/01b6c95d5b2e2fa801216518a8e3e2.jpg')
                        .width(32).height(32)
                        .borderRadius(16)
                      Column() {
                        Row() {
                          Text(reply.username || 'æœªçŸ¥ç”¨æˆ·')
                            .fontSize(14)
                            .fontColor('#FFD700')
                          if (reply.isAuthor) {
                            Text('ä½œè€…')
                              .fontSize(11)
                              .fontColor('#FFD700')
                              .margin({ left: 4 })
                          }
                        }
                        Text(reply.content)
                          .fontSize(14)
                          .fontColor('#fff')
                          .margin({ top: 2, bottom: 2, right: 16 })
                          .textOverflow({ overflow: TextOverflow.Clip })
                          .width('100%')
                        Row() {
                          Text(this.formatTime(reply.createdAt))
                            .fontSize(11)
                            .fontColor('rgba(255,255,255,0.5)')
                          Text('å›å¤')
                            .fontSize(11)
                            .fontColor('rgba(255,255,255,0.5)')
                            .margin({ left: 8 })
                            .onClick(() => {
                              this.replyToComment = reply;
                              this.commentText = '';
                            })
                          Blank().layoutWeight(1)
                          Text(this.likedComments.has(reply.id) ? 'â¤ï¸' : 'ğŸ¤')
                            .fontSize(15)
                            .margin({ right: 2 })
                            .scale({ x: this.heartScales[reply.id] || 1, y: this.heartScales[reply.id] || 1 })
                            .animation({
                              duration: 200,
                              curve: Curve.EaseInOut
                            })
                            .onClick(() => this.likeComment(reply.id))
                          Text(this.likeCounts[reply.id] !== undefined ? this.likeCounts[reply.id].toString() : reply.likeCount.toString())
                            .fontSize(11)
                            .fontColor('rgba(255,255,255,0.5)')
                            .margin({ right: 16 })
                        }
                      }
                      .margin({ left: 10, right: 0 })
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)
                      .width('100%')
                    }
                    .width('100%')
                    .padding({ top: 6, bottom: 6, left: 60, right: 0 }) // ç¼©è¿›æ˜¾ç¤º
                  }, (reply: CommentItem) => reply.id.toString())
                }
              }
            }
          }, (item: CommentItem) => item.id.toString())
        }
        .width('100%')
        .layoutWeight(1)

        // å‘é€æ¡†ä¸Šæ–¹æ˜¾ç¤º"æ­£åœ¨å›å¤"
        if (this.replyToComment) {
          Row() {
            Text(`æ­£åœ¨å›å¤ @${this.replyToComment.username}ï¼š`)
              .fontSize(13)
              .fontColor('#FFD700')
            Button('å–æ¶ˆ')
              .fontSize(12)
              .fontColor('#fff')
              .backgroundColor('transparent')
              .onClick(() => {
                this.replyToComment = null;
                this.commentText = '';
              })
          }
          .margin({ bottom: 4 })
        }
        // å‘é€æ¡†
        Row() {
          TextInput({ 
            placeholder: this.replyToComment ? `å›å¤ @${this.replyToComment.username}` : 'å‘é€å–„æ„çš„è¯„è®º',
            text: this.commentText
          })
            .width('60%')
            .height(40)
            .backgroundColor('rgba(255, 254, 254, 0.05)')
            .fontColor('#fffcfcfc')
            .borderRadius(20)
            .padding({ left: 20 })
            .onChange((value: string) => {
              this.commentText = value;
            })
          Blank().width(8)
          Button('ğŸ˜Š')
            .backgroundColor('transparent')
            .fontColor('#fff')
            .width(40)
            .height(40)
            .onClick(() => setTimeout(() => { 
              if (!this.isActive) return; 
              try {
                if (this.isActive) {
                  promptAction.showToast({ message: 'åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­' }); 
                }
              } catch (error) {
                console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
              }
            }, 100))
          Blank().width(8)
          Button('ğŸ–¼ï¸')
            .backgroundColor('transparent')
            .fontColor('#fff')
            .width(40)
            .height(40)
            .onClick(() => setTimeout(() => { 
              if (!this.isActive) return; 
              try {
                if (this.isActive) {
                  promptAction.showToast({ message: 'åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­' }); 
                }
              } catch (error) {
                console.error('æ˜¾ç¤ºToastå¤±è´¥:', error);
              }
            }, 100))
          Blank().width(8)
          Button('å‘é€')
            .backgroundColor(this.commentText.trim() ? '#FFD700' : 'rgba(255,255,255,0.3)')
            .fontColor(this.commentText.trim() ? '#000' : 'rgba(255,255,255,0.5)')
            .borderRadius(20)
            .width(50)
            .height(40)
            .onClick(() => {
              if (this.commentText.trim()) {
                if (this.replyToComment) {
                  this.publishReply();
                } else {
                  this.publishComment();
                }
              }
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 16 })
        .zIndex(10)
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#181818')
  }
} 