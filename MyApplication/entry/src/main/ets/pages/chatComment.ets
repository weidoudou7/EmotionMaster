import promptAction from '@ohos.promptAction';
import router from '@ohos.router';
import { ApiService } from '../service/apiservice';
import { CommentItem } from '../common/types';
import { globalUserData } from '../models/userdata';

// Ë∑ØÁî±ÂèÇÊï∞Êé•Âè£
interface CommentPageParams {
  aiRoleId?: number;
  aiRoleName?: string;
  aiRoleAvatar?: string;
  aiRoleType?: string;
  aiRoleDescription?: string;
  currentUserId?: number;
}

@Entry
@Component
export struct ChatCommentPage {
  @State private comments: CommentItem[] = [];
  @State private likedComments: Set<number> = new Set(); // Â∑≤ÁÇπËµûËØÑËÆ∫idÈõÜÂêà
  @State private likeCounts: Record<number, number> = {};
  @State private heartScales: Record<number, number> = {}; // Áà±ÂøÉÁº©ÊîæÁä∂ÊÄÅ
  @State private commentText: string = ''; // ËæìÂÖ•Ê°ÜÊñáÊú¨
  @State private aiRoleId: number = 1; // AIËßíËâ≤IDÔºå‰ªéË∑ØÁî±ÂèÇÊï∞Ëé∑Âèñ
  @State private currentUserId: number = 1; // ÂΩìÂâçÁî®Êà∑IDÔºå‰ªéË∑ØÁî±ÂèÇÊï∞Ëé∑Âèñ
  
  // AIËßíËâ≤‰ø°ÊÅØ
  @State private aiRoleName: string = 'AIËßíËâ≤';
  @State private aiRoleAvatar: string = '';
  @State private aiRoleType: string = 'default';
  @State private aiRoleDescription: string = '';

  @State private replyToComment: CommentItem | null = null; // ÂΩìÂâçÊ≠£Âú®ÂõûÂ§çÁöÑËØÑËÆ∫
  @State private isActive: boolean = true; // È°µÈù¢Ê¥ªË∑ÉÊ†áËÆ∞
  @State private refreshKey: number = 0; // Âº∫Âà∂Âà∑Êñ∞ÈîÆ
  @State private pendingDeleteCommentId: number | null = null; // ÂæÖÂà†Èô§ÁöÑËØÑËÆ∫ID
  @State private deleteConfirmTimeout: number | null = null; // Âà†Èô§Á°ÆËÆ§Ë∂ÖÊó∂ÂÆöÊó∂Âô®

  @State totalCount:number = 0;

  aboutToAppear() {
    this.isActive = true;
    // Ëé∑ÂèñË∑ØÁî±ÂèÇÊï∞
    const params = router.getParams() as CommentPageParams;
    if (params) {
      // ‰øÆÊ≠£ÔºöaiRoleIdÂøÖÈ°ªÁî®Ë∑ØÁî±ÂèÇÊï∞Ôºå‰∏çËÉΩÂÜôÊ≠ª
      if (typeof params.aiRoleId === 'number') {
        this.aiRoleId = params.aiRoleId;
      } else if (typeof params.aiRoleId === 'string' && params.aiRoleId !== '') {
        this.aiRoleId = parseInt(params.aiRoleId);
      }
      if (typeof params.currentUserId === 'number') {
        this.currentUserId = params.currentUserId;
      } else if (typeof params.currentUserId === 'string' && params.currentUserId !== '') {
        this.currentUserId = parseInt(params.currentUserId);
      }
      this.aiRoleName = params.aiRoleName || 'AIËßíËâ≤';
      this.aiRoleAvatar = params.aiRoleAvatar || '';
      this.aiRoleType = params.aiRoleType || 'default';
      this.aiRoleDescription = params.aiRoleDescription || '';
      console.info(`[ËØÑËÆ∫] Ë∑ØÁî±ÂèÇÊï∞ aiRoleId=${this.aiRoleId}, currentUserId=${this.currentUserId}`);
    }
    this.loadAllComments();
  }

  aboutToDisappear() {
    this.isActive = false;
    // Ê∏ÖÁêÜÂà†Èô§Á°ÆËÆ§ÂÆöÊó∂Âô®
    if (this.deleteConfirmTimeout !== null) {
      clearTimeout(this.deleteConfirmTimeout);
      this.deleteConfirmTimeout = null;
    }
  }

  // Âä†ËΩΩÊâÄÊúâËØÑËÆ∫ÔºàÂåÖÊã¨‰∏ªËØÑËÆ∫ÂíåÂõûÂ§çÔºâ
  private async loadAllComments() {
    if (!this.isActive) return;
    try {
      console.info(`[ËØÑËÆ∫] ÂºÄÂßãÂä†ËΩΩÊâÄÊúâËØÑËÆ∫ÔºåaiRoleId=${this.aiRoleId}`);
      const result = await ApiService.getCommentsByAiRoleId(this.aiRoleId, 1, 1000); // ‰∏ÄÊ¨°ÊÄßÂä†ËΩΩÊâÄÊúâ‰∏ªËØÑËÆ∫
      const mainComments = result.comments;
      console.info(`[ËØÑËÆ∫] Âä†ËΩΩ‰∏ªËØÑËÆ∫ÂÆåÊàêÔºåÊï∞Èáè=${mainComments.length}`);

              // ‰∏∫ÊØè‰∏™‰∏ªËØÑËÆ∫Âä†ËΩΩÊâÄÊúâÂõûÂ§ç
        for (const mainComment of mainComments) {
          try {
            const replyResult = await ApiService.getRepliesByRootCommentId(mainComment.id, 1, 1000); // ‰∏ÄÊ¨°ÊÄßÂä†ËΩΩÊâÄÊúâÂõûÂ§ç
            mainComment.replies = replyResult.replies || [];
            mainComment.replyTotal = replyResult.totalCount || 0;
            console.info(`[ËØÑËÆ∫] ‰∏ªËØÑËÆ∫${mainComment.id}Âä†ËΩΩÂõûÂ§çÂÆåÊàêÔºåÊï∞Èáè=${mainComment.replies.length}`);
            // Ë∞ÉËØïÔºöÊâìÂç∞ÂõûÂ§çËØ¶ÊÉÖ
            if (mainComment.replies && mainComment.replies.length > 0) {
              mainComment.replies.forEach((reply, index) => {
                console.info(`[ËØÑËÆ∫] ÂõûÂ§ç${index + 1}: ID=${reply.id}, ÂÜÖÂÆπ=${reply.content}`);
              });
            }
          } catch (error) {
            console.error(`[ËØÑËÆ∫] Âä†ËΩΩ‰∏ªËØÑËÆ∫${mainComment.id}ÁöÑÂõûÂ§çÂ§±Ë¥•:`, error);
            mainComment.replies = [];
            mainComment.replyTotal = 0;
          }
        }
      
      // Á´ãÂç≥Êõ¥Êñ∞UIÁä∂ÊÄÅÔºåÁ°Æ‰øùÊï∞ÊçÆËÉΩÂèäÊó∂ÊòæÁ§∫
      if (this.isActive) {
        // ÂÖàÊ∏ÖÁ©∫Êï∞ÁªÑÔºåÁÑ∂ÂêéÈáçÊñ∞ËµãÂÄºÔºåÁ°Æ‰øùUIËÉΩÊ£ÄÊµãÂà∞ÂèòÂåñ
        this.comments = [];
        // ‰ΩøÁî®setTimeoutÁ°Æ‰øùUIËÉΩÊ£ÄÊµãÂà∞Êï∞ÁªÑÂèòÂåñ
        setTimeout(() => {
          if (!this.isActive) return;
          this.comments = mainComments;
          this.comments.forEach(item => {
            this.likeCounts[item.id] = item.likeCount;
            this.heartScales[item.id] = 1;
            this.checkUserLikedStatus(item.id);
            // ‰∏∫ÂõûÂ§ç‰πüËÆæÁΩÆÁÇπËµûÁä∂ÊÄÅ
            if (item.replies && Array.isArray(item.replies)) {
              item.replies.forEach(reply => {
                this.likeCounts[reply.id] = reply.likeCount;
                this.heartScales[reply.id] = 1;
                this.checkUserLikedStatus(reply.id);
              });
            }
          });
          console.info(`[ËØÑËÆ∫] UIÁä∂ÊÄÅÊõ¥Êñ∞ÂÆåÊàêÔºå‰∏ªËØÑËÆ∫Êï∞Èáè=${this.comments.length}`);
          // ÊâìÂç∞ÊØè‰∏™‰∏ªËØÑËÆ∫ÁöÑÂõûÂ§çÊï∞ÈáèÔºåÁî®‰∫éË∞ÉËØï
          this.comments.forEach(item => {
            console.info(`[ËØÑËÆ∫] ‰∏ªËØÑËÆ∫${item.id}Êúâ${item.replies ? item.replies.length : 0}Êù°ÂõûÂ§ç`);
          });
          // Âº∫Âà∂Ëß¶ÂèëUIÈáçÊñ∞Ê∏≤Êüì
          this.refreshKey++;
        }, 10);
      }
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('[ËØÑËÆ∫] Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•:', error);
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï' });
          }
        } catch (error) {
          console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', error);
        }
      }, 100);
    }
  }

  // Ê£ÄÊü•Áî®Êà∑ÁÇπËµûÁä∂ÊÄÅ
  private async checkUserLikedStatus(commentId: number) {
    try {
      const result = await ApiService.checkUserLikedComment(commentId, this.currentUserId);
      if (result.isLiked) {
        setTimeout(() => {
          if (!this.isActive) return;
          this.likedComments.add(commentId);
        }, 100);
      }
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('Ê£ÄÊü•ÁÇπËµûÁä∂ÊÄÅÂ§±Ë¥•:', error);
      }, 100);
    }
  }

  // ÂèëÂ∏ÉËØÑËÆ∫ÊñπÊ≥ï
  private async publishComment() {
    if (!this.isActive || !this.commentText.trim()) {
      setTimeout(() => {
        if (!this.isActive) return;
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'ËØ∑ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ' });
          }
        } catch (error) {
          console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', error);
        }
      }, 100);
      return;
    }
    try {
      const result = await ApiService.publishComment(this.aiRoleId, this.currentUserId, this.commentText.trim());
      // Á´ãÂç≥Ê∏ÖÁêÜËæìÂÖ•Áä∂ÊÄÅ
      if (this.isActive) {
        this.commentText = '';
      }
      // ÂèëÂ∏ÉÊàêÂäüÂêéÂà∑Êñ∞Êï¥‰∏™ËØÑËÆ∫ÂàóË°®
      await this.loadAllComments();
      setTimeout(() => {
        if (!this.isActive) return;
        try {
          if (this.isActive) {
            promptAction.showToast({ message: result.message });
          }
        } catch (error) {
          console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', error);
        }
      }, 100);
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('ÂèëÂ∏ÉËØÑËÆ∫Â§±Ë¥•:', error);
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'ÂèëÂ∏ÉËØÑËÆ∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï' });
          }
        } catch (toastError) {
          console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', toastError);
        }
      }, 100);
    }
  }

  // ÁÇπËµûËØÑËÆ∫
  private async likeComment(commentId: number) {
    try {
      if (this.likedComments.has(commentId)) {
        const result = await ApiService.unlikeComment(commentId, this.currentUserId);
        if (result.success) {
                setTimeout(() => {
        if (!this.isActive) return;
        this.likedComments.delete(commentId);
        this.likeCounts[commentId] = Math.max(this.likeCounts[commentId] - 1, 0);
      }, 100);
        }
      } else {
        const result = await ApiService.likeComment(commentId, this.currentUserId);
        if (result.success) {
                  setTimeout(() => {
          if (!this.isActive) return;
          this.likedComments.add(commentId);
          this.likeCounts[commentId] = (this.likeCounts[commentId] || 0) + 1;
        }, 100);
        }
      }
      setTimeout(() => {
        if (!this.isActive) return;
        this.heartScales[commentId] = 1.3;
        setTimeout(() => {
          if (!this.isActive) return;
          this.heartScales[commentId] = 1;
        }, 200);
      }, 100);
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('ÁÇπËµûÊìç‰ΩúÂ§±Ë¥•:', error);
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï' });
          }
        } catch (error) {
          console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', error);
        }
      }, 100);
    }
  }

  // Âà†Èô§ËØÑËÆ∫ÔºàÂèåÂáªÁ°ÆËÆ§Ôºâ
  private async deleteComment(commentId: number) {
    // Â¶ÇÊûúÂ∑≤ÁªèÊúâÂæÖÂà†Èô§ÁöÑËØÑËÆ∫Ôºå‰∏îÊòØÂêå‰∏Ä‰∏™ËØÑËÆ∫ÔºåÂàôÊâßË°åÂà†Èô§
    if (this.pendingDeleteCommentId === commentId) {
      // Ê∏ÖÁêÜÂÆöÊó∂Âô®
      if (this.deleteConfirmTimeout !== null) {
        clearTimeout(this.deleteConfirmTimeout);
        this.deleteConfirmTimeout = null;
      }
      
      // ÈáçÁΩÆÂæÖÂà†Èô§Áä∂ÊÄÅ
      this.pendingDeleteCommentId = null;
      
      // ÊâßË°åÂà†Èô§Êìç‰Ωú
      try {
        console.info(`[Âà†Èô§] ÂºÄÂßãÂà†Èô§ËØÑËÆ∫ID=${commentId}`);
        const result = await ApiService.deleteComment(commentId, this.currentUserId);
        console.info(`[Âà†Èô§] Âà†Èô§ÁªìÊûú:`, result);
        if (result.success) {
          // Á´ãÂç≥Ê∏ÖÁêÜÁõ∏ÂÖ≥Áä∂ÊÄÅ
          this.likedComments.delete(commentId);
          this.likeCounts[commentId] = 0;
          this.heartScales[commentId] = 1;
          console.info(`[Âà†Èô§] Ê∏ÖÁêÜÁä∂ÊÄÅÂÆåÊàêÔºåÂºÄÂßãÂà∑Êñ∞ËØÑËÆ∫ÂàóË°®`);
          
          // Á´ãÂç≥Ê∏ÖÁ©∫ËØÑËÆ∫Êï∞ÁªÑÔºåÂº∫Âà∂UIÊõ¥Êñ∞
          this.comments = [];
          
          // Á´ãÂç≥Âà∑Êñ∞ËØÑËÆ∫ÂàóË°®
          await this.loadAllComments();
          console.info(`[Âà†Èô§] ËØÑËÆ∫ÂàóË°®Âà∑Êñ∞ÂÆåÊàê`);
          
          // Âº∫Âà∂Ëß¶ÂèëUIÈáçÊñ∞Ê∏≤Êüì
          this.refreshKey++;
          
          // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
          setTimeout(() => {
            if (!this.isActive) return;
            try {
              if (this.isActive) {
                promptAction.showToast({ message: 'Âà†Èô§ÊàêÂäü' });
              }
            } catch (error) {
              console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', error);
            }
          }, 100);
        } else {
          setTimeout(() => {
            if (!this.isActive) return;
            try {
              if (this.isActive) {
                promptAction.showToast({ message: result.message || 'Âà†Èô§Â§±Ë¥•' });
              }
            } catch (error) {
              console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', error);
            }
          }, 100);
        }
      } catch (error) {
        setTimeout(() => {
          if (!this.isActive) return;
          console.error('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•:', error);
          try {
            if (this.isActive) {
              promptAction.showToast({ message: 'Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï' });
            }
          } catch (error) {
            console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', error);
          }
        }, 100);
      }
      return;
    }
    
    // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÂà†Èô§ÔºåËÆæÁΩÆÂæÖÂà†Èô§Áä∂ÊÄÅ
    this.pendingDeleteCommentId = commentId;
    
    // ÊòæÁ§∫Á°ÆËÆ§ÊèêÁ§∫
    try {
      if (this.isActive) {
        promptAction.showToast({ message: 'ÂÜçÊåâ‰∏ÄÊ¨°Âà†Èô§' });
      }
    } catch (error) {
      console.error('ÊòæÁ§∫Á°ÆËÆ§ÊèêÁ§∫Â§±Ë¥•:', error);
    }
    
    // ËÆæÁΩÆ3ÁßíË∂ÖÊó∂ÔºåË∂ÖÊó∂ÂêéÈáçÁΩÆÁä∂ÊÄÅ
    this.deleteConfirmTimeout = setTimeout(() => {
      if (this.isActive) {
        this.pendingDeleteCommentId = null;
        this.deleteConfirmTimeout = null;
      }
    }, 3000);
  }

  // Ê†ºÂºèÂåñÊó∂Èó¥
  private formatTime(dateString: string): string {
    try {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now.getTime() - date.getTime();
      
      const minutes = Math.floor(diff / (1000 * 60));
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      
      if (minutes < 1) return 'ÂàöÂàö';
      if (minutes < 60) return `${minutes}ÂàÜÈíüÂâç`;
      if (hours < 24) return `${hours}Â∞èÊó∂Ââç`;
      if (days < 30) return `${days}Â§©Ââç`;
      
      return date.toLocaleDateString();
    } catch (error) {
      return 'Êú™Áü•Êó∂Èó¥';
    }
  }

  // ÂèëÂ∏ÉÂõûÂ§çÊñπÊ≥ï
  private async publishReply() {
    if (!this.isActive || !this.replyToComment) return;
    try {
      const rootId = this.replyToComment.rootCommentId || this.replyToComment.id;
      const toId = this.replyToComment.id;
      const res = await ApiService.replyComment(
        this.aiRoleId,
        this.currentUserId,
        this.commentText.trim(),
        rootId,
        toId
      );
      // Á´ãÂç≥Ê∏ÖÁêÜËæìÂÖ•Áä∂ÊÄÅ
      if (this.isActive) {
        this.commentText = '';
        this.replyToComment = null;
      }
      // ÂõûÂ§çÊàêÂäüÂêéÂà∑Êñ∞Êï¥‰∏™ËØÑËÆ∫ÂàóË°®
      await this.loadAllComments();
      // ‰ΩøÁî®setTimeoutÁ°Æ‰øùUI‰∏ä‰∏ãÊñáÂ≠òÂú®
      setTimeout(() => {
        if (!this.isActive) return;
        // ‰ΩøÁî®try-catchÂåÖË£πshowToastË∞ÉÁî®
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'ÂõûÂ§çÊàêÂäü' });
          }
        } catch (error) {
          console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', error);
        }
      }, 100);
    } catch (error) {
      setTimeout(() => {
        if (!this.isActive) return;
        console.error('ÂõûÂ§çËØÑËÆ∫Â§±Ë¥•:', error);
        // ‰ΩøÁî®try-catchÂåÖË£πshowToastË∞ÉÁî®
        try {
          if (this.isActive) {
            promptAction.showToast({ message: 'ÂõûÂ§çËØÑËÆ∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï' });
          }
        } catch (toastError) {
          console.error('ÊòæÁ§∫ToastÂ§±Ë¥•:', toastError);
        }
      }, 100);
    }
  }

  build() {
    Stack() {
      Column() {
        // È°∂ÈÉ®Ê†è
        Row() {
          Button('‚Äπ')
            .backgroundColor('transparent')
            .fontColor('#fff')
            .fontSize(24)
            .onClick(() => {
              router.back();
            })
          Blank().width(8)
          Text(`${this.aiRoleName}ÁöÑËØÑËÆ∫Âå∫`)
            .fontSize(22)
            .fontWeight(FontWeight.Bold)
            .fontColor('#fff')
            .layoutWeight(1)
        }
        .padding({ left: 12, right: 12, top: 12, bottom: 8 })
        .alignItems(VerticalAlign.Center)

        // ÊªöÂä®ÂÜÖÂÆπÂå∫ÔºàÂåÖÂê´Áî®Êà∑‰ø°ÊÅØÂíåËØÑËÆ∫ÂàóË°®Ôºâ
        List() {
          // AIËßíËâ≤‰ø°ÊÅØÂç°Áâá
          ListItem() {
            Row() {
              Image(this.aiRoleAvatar || 'https://img.zcool.cn/community/01b6c95d5b2e2fa801216518a8e3e2.jpg')
                .width(64).height(64)
                .borderRadius(32)
                .objectFit(ImageFit.Cover)
              Column() {
                Text(this.aiRoleName)
                  .fontSize(22)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#fff')
                  .margin({ bottom: 2 })
                Text(`${this.aiRoleType}È£éÊ†ºËßíËâ≤`)
                  .fontSize(14)
                  .fontColor('rgba(255,255,255,0.7)')
                  .margin({ bottom: 2 })
                Row() {
                  Text('Á±ªÂûãÔºö')
                    .fontSize(14)
                    .fontColor('rgba(255,255,255,0.7)')
                  Text(this.aiRoleType)
                    .fontSize(14)
                    .fontColor('#FFD700')
                    .fontWeight(FontWeight.Bold)
                    .margin({ left: 2 })
                }
              }
              .margin({ left: 12, right: 8 })
              .alignItems(HorizontalAlign.Start)
              Blank().layoutWeight(1)
              Column() {
                Button('ËøîÂõûËÅäÂ§©')
                  .fontColor('#FFD700')
                  .fontSize(16)
                  .border({ width: 1, color: '#FFD700' })
                  .borderRadius(20)
                  .backgroundColor('transparent')
                  .width(80)
                  .height(36)
                  .onClick(() => {
                    router.back();
                  })
              }
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
            }
            .padding({ left: 16, right: 16, top: 8, bottom: 8 })
          }
          
          // ËØÑËÆ∫ÊÄªÊï∞
          ListItem() {
            Text(`ÂÖ®ÈÉ®ËØÑËÆ∫ ${this.comments.length}`)
              .fontSize(15)
              .fontWeight(FontWeight.Bold)
              .fontColor('#fff')
              .margin({ left: 5, top: 8, bottom: 8 })
          }
          
          // ËØÑËÆ∫ÂàóË°®
          if (this.comments.length === 0) {
            ListItem() {
              Row() {
                Text('ÊöÇÊó†ËØÑËÆ∫ÔºåÂø´Êù•Êä¢Ê≤ôÂèëÂêß~')
                  .fontSize(16)
                  .fontColor('rgba(255,255,255,0.6)')
                  .margin({ top: 24, bottom: 24 })
                  .width('100%')
                  .textAlign(TextAlign.Center)
              }
              .width('100%')
              .justifyContent(FlexAlign.Center)
            }
          }
          ForEach(this.comments, (item: CommentItem, idx: number) => {
            ListItem() {
              Column() {
                // ‰∏ªËØÑËÆ∫
                Row() {
                  Image(item.profileImage || 'https://img.zcool.cn/community/01b6c95d5b2e2fa801216518a8e3e2.jpg')
                    .width(44).height(44)
                    .borderRadius(22)
                  Column() {
                    Row() {
                      Text(item.username || 'Êú™Áü•Áî®Êà∑')
                        .fontSize(16)
                        .fontWeight(FontWeight.Bold)
                        .fontColor('#fff')
                      if (item.isAuthor) {
                        Text('‰ΩúËÄÖ')
                          .fontSize(12)
                          .fontColor('#FFD700')
                          .margin({ left: 4 })
                      }
                      if (item.isTop) {
                        Text('ÁΩÆÈ°∂')
                          .fontSize(12)
                          .fontColor('#fff')
                          .backgroundColor('#333')
                          .borderRadius(8)
                          .margin({ left: 4 })
                      }
                    }
                    Text(item.content)
                      .fontSize(15)
                      .fontColor('#fff')
                      .margin({ top: 2, bottom: 2, right: 16 })
                      .textOverflow({ overflow: TextOverflow.Clip })
                      .width('100%')
                    Row() {
                      Text(this.formatTime(item.createdAt))
                        .fontSize(12)
                        .fontColor('rgba(255,255,255,0.5)')
                      Text('ÂõûÂ§ç')
                        .fontSize(12)
                        .fontColor('rgba(255,255,255,0.5)')
                        .margin({ left: 8 })
                        .onClick(() => {
                          this.replyToComment = item;
                          this.commentText = '';
                        })
                      // Âà†Èô§‰∏ªËØÑËÆ∫ÊåâÈíÆÔºàÂè™ÊúâËØÑËÆ∫‰ΩúËÄÖÂèØ‰ª•Âà†Èô§Ôºâ
                      if (item.userId === this.currentUserId) {
                        Text('Âà†Èô§')
                          .fontSize(12)
                          .fontColor(this.pendingDeleteCommentId === item.id ? '#FF6B6B' : 'rgba(255,255,255,0.5)')
                          .fontWeight(this.pendingDeleteCommentId === item.id ? FontWeight.Bold : FontWeight.Normal)
                          .margin({ left: 8 })
                          .onClick(() => this.deleteComment(item.id))
                      }
                      Blank().layoutWeight(1)
                      // Áà±ÂøÉÁÇπËµû
                      Text(this.likedComments.has(item.id) ? '‚ù§Ô∏è' : 'ü§ç')
                        .fontSize(18)
                        .margin({ right: 2 })
                        .scale({ x: this.heartScales[item.id] || 1, y: this.heartScales[item.id] || 1 })
                        .animation({
                          duration: 200,
                          curve: Curve.EaseInOut
                        })
                        .onClick(() => this.likeComment(item.id))
                      Text(this.likeCounts[item.id] !== undefined ? this.likeCounts[item.id].toString() : item.likeCount.toString())
                        .fontSize(12)
                        .fontColor('rgba(255,255,255,0.5)')
                        .margin({ right: 16 })
                    }
                  }
                  .margin({ left: 10, right: 0 })
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)
                  .width('100%')
                }
                .width('100%')
                .padding({ top: 10, bottom: 10, left: 16, right: 0 })
                
                                // Ê∏≤ÊüìÊâÄÊúâÂõûÂ§ç
                if (item.replies && Array.isArray(item.replies) && item.replies.length > 0) {
                  ForEach(item.replies, (reply: CommentItem, ridx: number) => {
                    Row() {
                      Image(reply.profileImage || 'https://img.zcool.cn/community/01b6c95d5b2e2fa801216518a8e3e2.jpg')
                        .width(32).height(32)
                        .borderRadius(16)
                      Column() {
                        Row() {
                          Text(reply.username || 'Êú™Áü•Áî®Êà∑')
                            .fontSize(14)
                            .fontColor('#FFD700')
                          if (reply.isAuthor) {
                            Text('‰ΩúËÄÖ')
                              .fontSize(11)
                              .fontColor('#FFD700')
                              .margin({ left: 4 })
                          }
                        }
                        Text(reply.content)
                          .fontSize(14)
                          .fontColor('#fff')
                          .margin({ top: 2, bottom: 2, right: 16 })
                          .textOverflow({ overflow: TextOverflow.Clip })
                          .width('100%')
                        Row() {
                          Text(this.formatTime(reply.createdAt))
                            .fontSize(11)
                            .fontColor('rgba(255,255,255,0.5)')
                          Text('ÂõûÂ§ç')
                            .fontSize(11)
                            .fontColor('rgba(255,255,255,0.5)')
                            .margin({ left: 8 })
                            .onClick(() => {
                              this.replyToComment = reply;
                              this.commentText = '';
                            })
                          // Âà†Èô§ÂõûÂ§çÊåâÈíÆÔºàÂè™ÊúâÂõûÂ§ç‰ΩúËÄÖÂèØ‰ª•Âà†Èô§Ôºâ
                          if (reply.userId === this.currentUserId) {
                            Text('Âà†Èô§')
                              .fontSize(11)
                              .fontColor(this.pendingDeleteCommentId === reply.id ? '#FF6B6B' : 'rgba(255,255,255,0.5)')
                              .fontWeight(this.pendingDeleteCommentId === reply.id ? FontWeight.Bold : FontWeight.Normal)
                              .margin({ left: 8 })
                              .onClick(() => this.deleteComment(reply.id))
                          }
                          Blank().layoutWeight(1)
                          Text(this.likedComments.has(reply.id) ? '‚ù§Ô∏è' : 'ü§ç')
                            .fontSize(15)
                            .margin({ right: 2 })
                            .scale({ x: this.heartScales[reply.id] || 1, y: this.heartScales[reply.id] || 1 })
                            .animation({
                              duration: 200,
                              curve: Curve.EaseInOut
                            })
                            .onClick(() => this.likeComment(reply.id))
                          Text(this.likeCounts[reply.id] !== undefined ? this.likeCounts[reply.id].toString() : reply.likeCount.toString())
                            .fontSize(11)
                            .fontColor('rgba(255,255,255,0.5)')
                            .margin({ right: 16 })
                        }
                      }
                      .margin({ left: 10, right: 0 })
                      .alignItems(HorizontalAlign.Start)
                      .layoutWeight(1)
                      .width('100%')
                    }
                    .width('100%')
                    .padding({ top: 6, bottom: 6, left: 60, right: 0 }) // Áº©ËøõÊòæÁ§∫
                  }, (reply: CommentItem) => reply.id.toString())
                }
              }
            }
          }, (item: CommentItem) => item.id.toString())
        }
        .width('100%')
        .layoutWeight(1)

        // ÂèëÈÄÅÊ°Ü‰∏äÊñπÊòæÁ§∫"Ê≠£Âú®ÂõûÂ§ç"
        if (this.replyToComment) {
          Row() {
            Text(`Ê≠£Âú®ÂõûÂ§ç @${this.replyToComment.username}Ôºö`)
              .fontSize(13)
              .fontColor('#FFD700')
            Button('ÂèñÊ∂à')
              .fontSize(12)
              .fontColor('#fff')
              .backgroundColor('transparent')
              .onClick(() => {
                this.replyToComment = null;
                this.commentText = '';
              })
          }
          .margin({ bottom: 4 })
        }
        // ÂèëÈÄÅÊ°Ü
        Row() {
          TextInput({ 
            placeholder: this.replyToComment ? `ÂõûÂ§ç @${this.replyToComment.username}` : 'ÂèëÈÄÅÂñÑÊÑèÁöÑËØÑËÆ∫',
            text: this.commentText
          })
            .height(40)
            .backgroundColor('rgba(255, 254, 254, 0.05)')
            .fontColor('#fffcfcfc')
            .borderRadius(20)
            .padding({ left: 20 })
            .onChange((value: string) => {
              this.commentText = value;
            })
            .layoutWeight(1)

          Blank().width(8)

          Button('ÂèëÈÄÅ')
            .backgroundColor(this.commentText.trim() ? '#FFD700' : 'rgba(255,255,255,0.3)')
            .fontColor(this.commentText.trim() ? '#000' : 'rgba(255,255,255,0.5)')
            .borderRadius(20)
            .width(50)
            .height(40)
            .onClick(() => {
              if (this.commentText.trim()) {
                if (this.replyToComment) {
                  this.publishReply();
                } else {
                  this.publishComment();
                }
              }
            })
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8, bottom: 16 })
        .zIndex(10)
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#181818')
  }
} 