# å¤´åƒä¸Šä¼ ä¸æ˜¾ç¤ºè°ƒè¯•æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†è¯¦ç»†çš„è°ƒè¯•æ­¥éª¤ï¼Œå¸®åŠ©è§£å†³å¤´åƒä¸Šä¼ åå‰ç«¯æ— æ³•æ˜¾ç¤ºçš„é—®é¢˜ã€‚æˆ‘ä»¬å·²ç»åœ¨å‰ç«¯å’Œåç«¯æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œå¯ä»¥è¿½è¸ªæ•´ä¸ªå¤´åƒå¤„ç†æµç¨‹ã€‚

## è°ƒè¯•æ­¥éª¤

### 1. å¯åŠ¨åç«¯æœåŠ¡å¹¶è§‚å¯Ÿæ—¥å¿—

å¯åŠ¨åç«¯æœåŠ¡åï¼Œè§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºã€‚å½“è¿›è¡Œå¤´åƒä¸Šä¼ æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ä»¥ä¸‹æ—¥å¿—ï¼š

#### åç«¯æ—¥å¿—ç¤ºä¾‹ï¼š
```
ğŸ–¼ï¸ ========== å¤´åƒä¸Šä¼ Base64è¯·æ±‚å¼€å§‹ ==========
ğŸ–¼ï¸ ç”¨æˆ·UID: test-user-123
ğŸ–¼ï¸ å›¾ç‰‡æ•°æ®é•¿åº¦: 12345
ğŸ–¼ï¸ å›¾ç‰‡æ•°æ®å‰ç¼€: data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...

ğŸ–¼ï¸ [Service] å¼€å§‹å¤„ç†Base64å¤´åƒä¸Šä¼ 
ğŸ–¼ï¸ [Service] ç”¨æˆ·UID: test-user-123
ğŸ–¼ï¸ [Service] Base64å¤´éƒ¨ä¿¡æ¯: data:image/jpeg;base64
ğŸ–¼ï¸ [Service] Base64æ•°æ®é•¿åº¦: 12345
ğŸ–¼ï¸ [Service] æ£€æµ‹åˆ°çš„æ–‡ä»¶æ‰©å±•å: .jpg
ğŸ–¼ï¸ [Service] ç”Ÿæˆçš„æ–‡ä»¶å: test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Service] è§£ç åçš„å›¾ç‰‡å­—èŠ‚æ•°: 9234
ğŸ–¼ï¸ [Service] ä¸Šä¼ ç›®å½•è·¯å¾„: /path/to/uploads/avatars/
ğŸ–¼ï¸ [Service] å®Œæ•´æ–‡ä»¶è·¯å¾„: /path/to/uploads/avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Service] æ–‡ä»¶å†™å…¥æˆåŠŸï¼Œæ–‡ä»¶å¤§å°: 9234 å­—èŠ‚
ğŸ–¼ï¸ [Service] ç”Ÿæˆçš„ç›¸å¯¹URL: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Service] æ‰¾åˆ°ç”¨æˆ·ï¼Œæ›´æ–°å¤´åƒURL
ğŸ–¼ï¸ [Service] ç”¨æˆ·å¤´åƒURLå·²æ›´æ–°åˆ°æ•°æ®åº“
ğŸ–¼ï¸ [Service] å¤´åƒä¸Šä¼ å®Œæˆï¼Œè¿”å›URL: /avatars/test-user-123_abc123def456.jpg

ğŸ–¼ï¸ åç«¯ç”Ÿæˆçš„ç›¸å¯¹URL: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ å‰ç«¯éœ€è¦æ‹¼æ¥çš„å®Œæ•´URLç¤ºä¾‹: http://localhost:8080/avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ è¿”å›ç»™å‰ç«¯çš„URL: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ ========== å¤´åƒä¸Šä¼ Base64è¯·æ±‚æˆåŠŸ ==========
```

### 2. è§‚å¯Ÿå‰ç«¯æ—¥å¿—

åœ¨å‰ç«¯è¿›è¡Œå¤´åƒä¸Šä¼ æ—¶ï¼Œè§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼š

#### å‰ç«¯æ—¥å¿—ç¤ºä¾‹ï¼š
```
ğŸ–¼ï¸ [Frontend] å¼€å§‹å¤´åƒä¸Šä¼ æµç¨‹
ğŸ–¼ï¸ [Frontend] é€‰æ‹©çš„å›¾ç‰‡URI: file:///data/storage/el2/base/haps/entry/files/...
ğŸ–¼ï¸ [Frontend] Base64æ•°æ®é•¿åº¦: 12345
ğŸ–¼ï¸ [Frontend] Base64æ•°æ®å‰ç¼€: data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ...

ğŸ–¼ï¸ [ApiService] å¼€å§‹ä¸Šä¼ å¤´åƒ
ğŸ–¼ï¸ [ApiService] ç”¨æˆ·UID: test-user-123
ğŸ–¼ï¸ [ApiService] å›¾ç‰‡æ•°æ®é•¿åº¦: 12345
ğŸ–¼ï¸ [ApiService] è¯·æ±‚URL: http://localhost:8080/user/test-user-123/avatar/base64
ğŸ–¼ï¸ [ApiService] åç«¯å“åº”: {success: true, data: "/avatars/test-user-123_abc123def456.jpg", message: "å¤´åƒä¸Šä¼ æˆåŠŸ"}
ğŸ–¼ï¸ [ApiService] å“åº”æˆåŠŸçŠ¶æ€: true
ğŸ–¼ï¸ [ApiService] å“åº”æ•°æ®: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [ApiService] å“åº”æ¶ˆæ¯: å¤´åƒä¸Šä¼ æˆåŠŸ
ğŸ–¼ï¸ [ApiService] æ›´æ–°å…¨å±€ç”¨æˆ·å¤´åƒ: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [ApiService] å¤´åƒä¸Šä¼ æˆåŠŸï¼Œè¿”å›URL: /avatars/test-user-123_abc123def456.jpg

ğŸ–¼ï¸ [Frontend] åç«¯è¿”å›çš„åŸå§‹ç»“æœ: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Frontend] è§£æåçš„å“åº”å¯¹è±¡: {data: "/avatars/test-user-123_abc123def456.jpg"}
ğŸ–¼ï¸ [Frontend] ä»å“åº”ä¸­æå–çš„URL: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Frontend] æ£€æµ‹åˆ°ç›¸å¯¹è·¯å¾„ï¼Œè¿›è¡Œæ‹¼æ¥
ğŸ–¼ï¸ [Frontend] åŸºç¡€URL: http://localhost:8080
ğŸ–¼ï¸ [Frontend] ç›¸å¯¹è·¯å¾„: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Frontend] æ‹¼æ¥åçš„å®Œæ•´URL: http://localhost:8080/avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Frontend] è®¾ç½®æ–°çš„å¤´åƒURL: http://localhost:8080/avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Frontend] userAvatarå·²æ›´æ–°ä¸º: http://localhost:8080/avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Frontend] å¼€å§‹åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
ğŸ–¼ï¸ [Frontend] å¤´åƒä¸Šä¼ æµç¨‹å®Œæˆ

ğŸ‘¤ [ApiService] å¼€å§‹è·å–ç”¨æˆ·ä¿¡æ¯
ğŸ‘¤ [ApiService] ç”¨æˆ·UID: test-user-123
ğŸ‘¤ [ApiService] è¯·æ±‚URL: http://localhost:8080/user/test-user-123
ğŸ‘¤ [ApiService] åç«¯å“åº”: {success: true, data: {userName: "æµ‹è¯•ç”¨æˆ·", userAvatar: "/avatars/test-user-123_abc123def456.jpg", ...}}
ğŸ‘¤ [ApiService] å“åº”æˆåŠŸçŠ¶æ€: true
ğŸ‘¤ [ApiService] ç”¨æˆ·å¤´åƒURL: /avatars/test-user-123_abc123def456.jpg
ğŸ‘¤ [ApiService] æ›´æ–°å…¨å±€ç”¨æˆ·ä¿¡æ¯
ğŸ‘¤ [ApiService] ç”¨æˆ·ä¿¡æ¯è·å–æˆåŠŸ

ğŸ‘¤ [Frontend] å¼€å§‹åŠ è½½ç”¨æˆ·ä¿¡æ¯
ğŸ‘¤ [Frontend] ç”¨æˆ·UID: test-user-123
ğŸ‘¤ [Frontend] è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯: {userName: "æµ‹è¯•ç”¨æˆ·", userAvatar: "/avatars/test-user-123_abc123def456.jpg", ...}
ğŸ‘¤ [Frontend] å¤„ç†å¤´åƒæ˜¾ç¤ºé€»è¾‘
ğŸ‘¤ [Frontend] åç«¯è¿”å›çš„å¤´åƒURL: /avatars/test-user-123_abc123def456.jpg
ğŸ‘¤ [Frontend] æ£€æµ‹åˆ°æœ‰æ•ˆå¤´åƒURLï¼Œä½¿ç”¨åç«¯å¤´åƒ
ğŸ‘¤ [Frontend] è®¾ç½®userAvatarä¸º: /avatars/test-user-123_abc123def456.jpg
ğŸ‘¤ [Frontend] æœ€ç»ˆuserAvatarå€¼: /avatars/test-user-123_abc123def456.jpg
ğŸ‘¤ [Frontend] ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆ

ğŸ–¼ï¸ [Image] å¤´åƒç»„ä»¶æ¸²æŸ“ï¼ŒURL: /avatars/test-user-123_abc123def456.jpg
ğŸ–¼ï¸ [Image] å¤´åƒç»„ä»¶ç±»å‹: string
```

### 3. å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜1ï¼šåç«¯è¿”å›çš„URLæ ¼å¼ä¸æ­£ç¡®
**ç—‡çŠ¶ï¼š** åç«¯æ—¥å¿—ä¸­æ˜¾ç¤ºçš„URLä¸æ˜¯ä»¥ `/avatars/` å¼€å¤´
**è§£å†³ï¼š** æ£€æŸ¥ `UserServiceImpl.uploadAvatarBase64()` æ–¹æ³•ä¸­çš„URLç”Ÿæˆé€»è¾‘

#### é—®é¢˜2ï¼šå‰ç«¯URLæ‹¼æ¥é”™è¯¯
**ç—‡çŠ¶ï¼š** å‰ç«¯æ—¥å¿—ä¸­æ‹¼æ¥åçš„å®Œæ•´URLæ ¼å¼ä¸æ­£ç¡®
**è§£å†³ï¼š** æ£€æŸ¥ `Config.getApiBaseUrl()` è¿”å›çš„å€¼ï¼Œç¡®ä¿æ²¡æœ‰å¤šä½™çš„æ–œæ 

#### é—®é¢˜3ï¼šå›¾ç‰‡æ–‡ä»¶æœªæˆåŠŸä¿å­˜
**ç—‡çŠ¶ï¼š** åç«¯æ—¥å¿—æ˜¾ç¤ºæ–‡ä»¶å†™å…¥æˆåŠŸï¼Œä½†å®é™…æ–‡ä»¶ä¸å­˜åœ¨
**è§£å†³ï¼š** æ£€æŸ¥ `AVATAR_UPLOAD_PATH` é…ç½®ï¼Œç¡®ä¿ç›®å½•æœ‰å†™å…¥æƒé™

#### é—®é¢˜4ï¼šé™æ€èµ„æºè®¿é—®é…ç½®é”™è¯¯
**ç—‡çŠ¶ï¼š** å›¾ç‰‡URLå¯è®¿é—®ï¼Œä½†è¿”å›404é”™è¯¯
**è§£å†³ï¼š** æ£€æŸ¥ `WebConfig.java` ä¸­çš„é™æ€èµ„æºæ˜ å°„é…ç½®

#### é—®é¢˜5ï¼šå‰ç«¯Imageç»„ä»¶æ— æ³•åŠ è½½
**ç—‡çŠ¶ï¼š** å‰ç«¯æ—¥å¿—æ˜¾ç¤º `[Image] å¤´åƒåŠ è½½å¤±è´¥`
**è§£å†³ï¼š** æ£€æŸ¥URLæ˜¯å¦åŒ…å«æ­£ç¡®çš„åè®®å’ŒåŸŸå

### 4. ä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯

è¿è¡Œæä¾›çš„æµ‹è¯•è„šæœ¬ï¼š
```bash
cd backend
python test_avatar_upload.py
```

æµ‹è¯•è„šæœ¬ä¼šï¼š
1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·
2. ä¸Šä¼ æµ‹è¯•å¤´åƒ
3. éªŒè¯å¤´åƒURLå¯è®¿é—®æ€§
4. æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ›´æ–°

### 5. æ‰‹åŠ¨éªŒè¯æ­¥éª¤

#### 5.1 éªŒè¯åç«¯æ–‡ä»¶å­˜å‚¨
æ£€æŸ¥ `uploads/avatars/` ç›®å½•æ˜¯å¦å­˜åœ¨ä¸Šä¼ çš„æ–‡ä»¶ï¼š
```bash
ls -la uploads/avatars/
```

#### 5.2 éªŒè¯é™æ€èµ„æºè®¿é—®
åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®å¤´åƒURLï¼š
```
http://localhost:8080/avatars/[filename]
```

#### 5.3 éªŒè¯æ•°æ®åº“æ›´æ–°
æ£€æŸ¥ç”¨æˆ·è¡¨ä¸­çš„ `userAvatar` å­—æ®µæ˜¯å¦æ­£ç¡®æ›´æ–°ã€‚

### 6. è°ƒè¯•æ£€æŸ¥æ¸…å•

- [ ] åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] å¤´åƒä¸Šä¼ æ¥å£è¿”å›200çŠ¶æ€ç 
- [ ] åç«¯æ—¥å¿—æ˜¾ç¤ºæ–‡ä»¶æˆåŠŸä¿å­˜
- [ ] åç«¯è¿”å›çš„URLæ ¼å¼æ­£ç¡®ï¼ˆä»¥ `/avatars/` å¼€å¤´ï¼‰
- [ ] å‰ç«¯æ­£ç¡®è§£æåç«¯å“åº”
- [ ] å‰ç«¯æ­£ç¡®æ‹¼æ¥å®Œæ•´URL
- [ ] é™æ€èµ„æºæ˜ å°„é…ç½®æ­£ç¡®
- [ ] å›¾ç‰‡æ–‡ä»¶å®é™…å­˜åœ¨äºæœåŠ¡å™¨
- [ ] æµè§ˆå™¨å¯ç›´æ¥è®¿é—®å›¾ç‰‡URL
- [ ] å‰ç«¯Imageç»„ä»¶æ¥æ”¶åˆ°æ­£ç¡®çš„URL

### 7. å¸¸è§è§£å†³æ–¹æ¡ˆ

#### 7.1 å¦‚æœåç«¯URLç”Ÿæˆé”™è¯¯
ä¿®æ”¹ `UserServiceImpl.java` ä¸­çš„URLç”Ÿæˆé€»è¾‘ï¼š
```java
String avatarUrl = "/avatars/" + filename;
```

#### 7.2 å¦‚æœå‰ç«¯URLæ‹¼æ¥é”™è¯¯
æ£€æŸ¥ `Config.getApiBaseUrl()` é…ç½®ï¼Œç¡®ä¿è¿”å›æ­£ç¡®çš„æœåŠ¡å™¨åœ°å€ã€‚

#### 7.3 å¦‚æœé™æ€èµ„æºæ— æ³•è®¿é—®
æ£€æŸ¥ `WebConfig.java` ä¸­çš„é…ç½®ï¼š
```java
registry.addResourceHandler("/avatars/**")
        .addResourceLocations("file:uploads/avatars/");
```

#### 7.4 å¦‚æœå‰ç«¯Imageç»„ä»¶æ— æ³•åŠ è½½
ç¡®ä¿URLåŒ…å«å®Œæ•´çš„åè®®å’ŒåŸŸåï¼Œä¾‹å¦‚ï¼š
```
http://localhost:8080/avatars/filename.jpg
```

## æ€»ç»“

é€šè¿‡è§‚å¯Ÿè¯¦ç»†çš„æ—¥å¿—è¾“å‡ºï¼Œå¯ä»¥å‡†ç¡®å®šä½å¤´åƒä¸Šä¼ å’Œæ˜¾ç¤ºè¿‡ç¨‹ä¸­çš„é—®é¢˜ã€‚é‡ç‚¹å…³æ³¨ï¼š
1. åç«¯URLç”Ÿæˆé€»è¾‘
2. å‰ç«¯URLæ‹¼æ¥è¿‡ç¨‹
3. é™æ€èµ„æºè®¿é—®é…ç½®
4. æ–‡ä»¶å®é™…å­˜å‚¨ä½ç½®

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›å®Œæ•´çš„æ—¥å¿—è¾“å‡ºï¼Œä»¥ä¾¿è¿›ä¸€æ­¥åˆ†æã€‚ 